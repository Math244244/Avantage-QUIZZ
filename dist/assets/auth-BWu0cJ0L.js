import{initializeApp as se}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as ne,GoogleAuthProvider as ie,signInWithPopup as ae,signOut as ce,onAuthStateChanged as le}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getFirestore as ue,doc as y,getDoc as I,Timestamp as f,addDoc as $,collection as k,runTransaction as de,setDoc as fe,where as C,orderBy as B,limit as me,query as T,startAfter as he,getDocs as O,updateDoc as F}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{getDatabase as ge}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();function pe(e){if(!e||typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function j(e){return pe(e)}function L(e,t="info",r=3e3){const o=W(),s=we(e,t);return o.appendChild(s),setTimeout(()=>s.classList.add("show"),10),r>0&&setTimeout(()=>{A(s)},r),s}function W(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.className="fixed top-4 right-4 z-50 flex flex-col gap-3",document.body.appendChild(e)),e}function we(e,t){const r=document.createElement("div");r.className=`toast toast-${t} transform translate-x-full transition-all duration-300`,t==="error"?(r.setAttribute("role","alert"),r.setAttribute("aria-live","assertive")):(r.setAttribute("role","status"),r.setAttribute("aria-live","polite")),r.setAttribute("aria-atomic","true");const o=Q(t);return r.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${o.borderColor} p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                ${o.icon}
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${j(e)}</p>
            </div>
            <button class="toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors" aria-label="Fermer la notification">
                <svg aria-hidden="true" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `,r.querySelector(".toast-close").addEventListener("click",()=>A(r)),r}function Q(e){const t={success:{borderColor:"border-green-500",icon:`<div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>`},error:{borderColor:"border-red-500",icon:`<div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>`},warning:{borderColor:"border-yellow-500",icon:`<div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>`},info:{borderColor:"border-blue-500",icon:`<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>`}};return t[e]||t.info}function A(e){e.classList.remove("show"),e.classList.add("translate-x-full"),setTimeout(()=>{e.remove();const t=document.getElementById("toast-container");t&&t.children.length===0&&t.remove()},300)}const Ne={success:(e,t)=>L(e,"success",t),error:(e,t)=>L(e,"error",t),warning:(e,t)=>L(e,"warning",t),info:(e,t)=>L(e,"info",t)};function $e(e){const t=W(),r=document.createElement("div");return r.className="toast toast-loading transform translate-x-full transition-all duration-300",r.setAttribute("data-loading","true"),r.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 border-indigo-500 p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${j(e)}</p>
            </div>
        </div>
    `,t.appendChild(r),setTimeout(()=>r.classList.add("show"),10),r}function Be(e,t,r="success"){if(!e||!e.getAttribute("data-loading"))return;const o=Q(r),s=e.classList.contains("show");e.className=`toast toast-${r} transform transition-all duration-300${s?" show":""}`,e.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${o.borderColor} p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                ${o.icon}
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${j(t)}</p>
            </div>
            <button class="toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `,e.removeAttribute("data-loading"),e.querySelector(".toast-close").addEventListener("click",()=>A(e)),setTimeout(()=>A(e),3e3)}if(typeof document<"u"){const e=document.createElement("style");e.textContent=`
        .toast.show {
            transform: translateX(0) !important;
        }
        
        @media (max-width: 640px) {
            #toast-container {
                left: 1rem;
                right: 1rem;
                top: 1rem;
            }
            
            .toast > div {
                min-width: auto !important;
                width: 100%;
            }
        }
    `,document.head.appendChild(e)}const p=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="192.168.1.1"||window.location.port==="3200",P={log:(...e)=>{p&&console.log(...e)},error:(...e)=>{console.error(...e)},warn:(...e)=>{p&&console.warn(...e)},info:(...e)=>{p&&console.info(...e)},group:(...e)=>{p&&console.group(...e)},groupEnd:()=>{p&&console.groupEnd()},table:(...e)=>{p&&console.table(...e)}};console.log(p?"üîß Mode d√©veloppement - Logs activ√©s":"üöÄ Mode production - Logs d√©sactiv√©s (sauf erreurs)");const H={apiKey:"AIzaSyD8w7Em_xdMGplscfGLrnM72vmm4z5ZTr0",authDomain:"avantage-quizz.firebaseapp.com",databaseURL:"https://avantage-quizz-default-rtdb.firebaseio.com",projectId:"avantage-quizz",storageBucket:"avantage-quizz.firebasestorage.app",messagingSenderId:"919472910099",appId:"1:919472910099:web:e17d4c1cdc7a04c6cab4e6"},D=se(H),m=ne(D),u=ue(D);ge(D);P.log("‚úÖ Firebase initialis√© avec succ√®s");P.log("üìä Projet:",H.projectId);P.log("üîê Services: Authentication, Firestore, Realtime Database");const Oe=Object.freeze(Object.defineProperty({__proto__:null,app:D,auth:m,db:u},Symbol.toStringTag,{value:"Module"})),ve="modulepreload",ye=function(e){return"/"+e},_={},be=function(t,r,o){let s=Promise.resolve();if(r&&r.length>0){let l=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),a=n?.nonce||n?.getAttribute("nonce");s=l(r.map(c=>{if(c=ye(c),c in _)return;_[c]=!0;const d=c.endsWith(".css"),g=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${g}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":ve,d||(h.as="script"),h.crossOrigin="",h.href=c,a&&h.setAttribute("nonce",a),document.head.appendChild(h),d)return new Promise((re,oe)=>{h.addEventListener("load",re),h.addEventListener("error",()=>oe(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return s.then(n=>{for(const a of n||[])a.status==="rejected"&&i(a.reason);return t().catch(i)})};class G{constructor(t,r){this.maxRequests=t,this.windowMs=r,this.requests=[]}async check(){const t=Date.now();if(this.requests=this.requests.filter(r=>t-r<this.windowMs),this.requests.length>=this.maxRequests){const r=this.requests[0],o=this.windowMs-(t-r);throw new Error(`Trop de requ√™tes. Veuillez patienter ${Math.ceil(o/1e3)} secondes.`)}this.requests.push(t)}reset(){this.requests=[]}getRemainingRequests(){const t=Date.now();return this.requests=this.requests.filter(r=>t-r<this.windowMs),Math.max(0,this.maxRequests-this.requests.length)}}const xe=new G(100,6e4),Ee=new G(50,6e4);async function V(e,t={}){const r=t.isWrite?Ee:xe;try{return await r.check(),await e()}catch(o){throw o.message.includes("Trop de requ√™tes")&&console.warn("‚ö†Ô∏è Rate limit atteint:",o.message),o}}async function b(e){return V(e,{isWrite:!1})}async function E(e){return V(e,{isWrite:!0})}const M="default";let U=null,N=0;const Le=300*1e3;async function S(e=null){const t=e||m.currentUser;if(!t)return console.warn("‚ö†Ô∏è Aucun utilisateur connect√©, utilisation du clientId par d√©faut"),M;const r=Date.now();if(U&&r<N)return U;try{const o=y(u,"users",t.uid),s=await b(()=>I(o));if(s.exists()){let n=s.data().clientId;return n||(n=q(t.email)),U=n,N=r+Le,n}else{const i=q(t.email);return console.log("üîÑ Profil utilisateur non trouv√©, clientId d√©termin√© √† partir de l'email:",i),i}}catch(o){return console.error("‚ùå Erreur r√©cup√©ration clientId:",o),q(t.email)}}function q(e){if(!e)return M;const t=e.split("@")[1];return{}[t]||M}const x=new Map,R={users:600*1e3,quizResults:300*1e3,questions:1800*1e3,stats:120*1e3,monthlyProgress:600*1e3,annualProgress:900*1e3,default:300*1e3};function Ce(e){return R[e]||R.default}function K(e=[]){return e.filter(Boolean).join("::")}function J(e){const t=x.get(e);return t?Date.now()>t.expireAt?(x.delete(e),null):t.value:null}function X(e,t,r=R.default){const o=typeof r=="string"?Ce(r):r;x.set(e,{value:t,expireAt:Date.now()+o,dataType:typeof r=="string"?r:null})}function v(e){x.forEach((t,r)=>{r.startsWith(e)&&x.delete(r)})}async function Fe(e){try{const t={...e,importedAt:f.now()};await E(()=>$(k(u,"importLogs"),t)),console.log("Log import cree")}catch(t){console.error("Erreur creation log import:",t)}}async function Ae(e){try{const t={...e,timestamp:f.now()};await E(()=>$(k(u,"auditLogs"),t)),console.log("Log audit cree")}catch(t){console.error("Erreur creation log audit:",t)}}const w={users:"users"};async function Z(e){try{const t=y(u,w.users,e.uid),r=await S(e),o={uid:e.uid,email:e.email,displayName:e.displayName,photoURL:e.photoURL,lastLogin:f.now(),updatedAt:f.now(),clientId:r},s=await b(()=>I(t));return s.exists()?s.data().clientId||(o.clientId=r,console.log("üîÑ Migration: Ajout du clientId au profil utilisateur existant")):(o.createdAt=f.now(),o.totalQuizzes=0,o.averageScore=0,o.currentStreak=0,o.longestStreak=0,o.role="user",console.log("üë§ Cr√©ation du profil utilisateur:",e.email)),await E(()=>fe(t,o,{merge:!0})),console.log("‚úÖ Profil utilisateur sauvegard√©"),o}catch(t){throw console.error("‚ùå Erreur cr√©ation utilisateur:",t),t}}async function Y(e){try{const t=y(u,w.users,e),r=await b(()=>I(t));return r.exists()?r.data():null}catch(t){throw console.error("‚ùå Erreur r√©cup√©ration profil:",t),t}}async function Ie(e,t){if(isNaN(t)||t<0||t>100)throw console.error("‚ùå Score invalide pour mise √† jour des stats:",t),new Error(`Score invalide: ${t}. Doit √™tre entre 0 et 100.`);try{await de(u,async r=>{const o=y(u,w.users,e),s=await r.get(o);if(!s.exists())throw new Error("Utilisateur non trouv√©");const i=s.data(),n=(i.totalQuizzes||0)+1,l=((i.averageScore||0)*(n-1)+t)/n,c=Math.round(l);if(isNaN(c)||c<0||c>100)throw console.error("‚ùå Moyenne calcul√©e invalide:",c),new Error(`Erreur de calcul de la moyenne: ${c}`);r.update(o,{totalQuizzes:n,averageScore:c,lastQuizDate:f.now(),updatedAt:f.now()})}),console.log("üìä Statistiques mises √† jour"),v("users"),v("users-stats")}catch(r){throw console.error("‚ùå Erreur mise √† jour statistiques:",r),r}}async function ke(e){const{getUserQuizResults:t}=await be(async()=>{const{getUserQuizResults:r}=await import("./quiz-service-DQw7ERxG.js").then(o=>o.q);return{getUserQuizResults:r}},[]);try{const r=await t(e,12);let o=0;const s=new Set;for(const l of r)l.score>=60&&s.add(l.month);const i=Array.from(s).sort().reverse();for(let l=0;l<i.length&&(o++,l<i.length-1);l++);const n=y(u,w.users,e),a=await b(()=>I(n));if(a.exists()){const l=a.data(),c=Math.max(o,l.longestStreak||0);await E(()=>F(n,{currentStreak:o,longestStreak:c,updatedAt:f.now()})),console.log(`üî• S√©rie mise √† jour: ${o} mois`),v("users"),v("users-stats")}return o}catch(r){throw console.error("‚ùå Erreur mise √† jour s√©rie:",r),r}}async function De(){try{const e=m.currentUser;return e?(await Y(e.uid))?.role==="admin":!1}catch(e){return console.error("‚ùå Erreur v√©rification admin:",e),!1}}async function ee(e={}){const t=K(["users",JSON.stringify(e||{})]),r=J(t);if(r)return r;try{const o=await S(),s=[C("clientId","==",o)];e.role&&s.push(C("role","==",e.role)),s.push(B("createdAt","desc"));const i=T(k(u,w.users),...s),n=await b(()=>O(i)),a=[];return n.forEach(l=>{a.push({id:l.id,...l.data()})}),console.log(`üë• ${a.length} utilisateurs charg√©s`),X(t,a,"users"),a}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration utilisateurs:",o),o}}async function Se(e={},t=20,r=null){try{const o=await S(),s=[C("clientId","==",o)];e.role&&s.push(C("role","==",e.role)),s.push(B("createdAt","desc")),s.push(me(t+1));let i=T(k(u,w.users),...s);r&&(i=T(i,he(r)));const n=await b(()=>O(i)),a=[];let l=null,c=!1;return n.forEach((d,g)=>{g<t?a.push({id:d.id,...d.data()}):c=!0}),n.docs.length>0&&a.length===t&&(l=n.docs[t-1]),console.log(`üë• ${a.length} utilisateurs charg√©s (pagination)`),{users:a,lastDoc:l,hasMore:c}}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration utilisateurs pagin√©s:",o),o}}async function Ue(e,t){try{const r=m.currentUser;if(!r)throw new Error("Utilisateur non connect√©");if(!["user","admin"].includes(t))throw new Error('R√¥le invalide - doit √™tre "user" ou "admin"');const o=y(u,w.users,e);return await E(()=>F(o,{role:t,updatedAt:f.now()})),console.log(`‚úÖ R√¥le mis √† jour pour ${e}: ${t}`),await Ae({action:"UPDATE_USER_ROLE",targetUserId:e,newRole:t,adminId:r.uid,adminEmail:r.email}),v("users"),v("users-stats"),!0}catch(r){throw console.error("‚ùå Erreur mise √† jour r√¥le:",r),r}}async function qe(){const e=await S(),t=K(["users-stats",e]),r=J(t);if(r)return r;try{const o=await ee(),s={total:o.length,admins:o.filter(n=>n.role==="admin").length,regularUsers:o.filter(n=>n.role!=="admin").length,activeLastWeek:0,averageScore:0,totalQuizzes:0},i=new Date;return i.setDate(i.getDate()-7),o.forEach(n=>{n.lastLogin&&n.lastLogin.toDate()>i&&s.activeLastWeek++,s.totalQuizzes+=n.totalQuizzes||0,s.averageScore+=n.averageScore||0}),s.averageScore=s.total>0?Math.round(s.averageScore/s.total):0,X(t,s,"stats"),s}catch(o){throw console.error("‚ùå Erreur statistiques utilisateurs:",o),o}}const We=Object.freeze(Object.defineProperty({__proto__:null,createOrUpdateUser:Z,getAllUsers:ee,getAllUsersPaginated:Se,getUserProfile:Y,getUsersStats:qe,isCurrentUserAdmin:De,updateStreak:ke,updateUserRole:Ue,updateUserStats:Ie},Symbol.toStringTag,{value:"Module"})),te=new ie;te.setCustomParameters({prompt:"select_account"});let z=!1;async function Qe(){if(z)return console.warn("‚ö†Ô∏è Connexion d√©j√† en cours, veuillez patienter..."),null;z=!0;try{console.log("üîê Tentative de connexion Google...");const t=(await ae(m,te)).user;return console.log("‚úÖ Authentification r√©ussie:",t.displayName),console.log("üìß Email:",t.email),await Z(t),t}catch(e){console.error("‚ùå Erreur de connexion:",e);let t="Erreur lors de la connexion. Veuillez r√©essayer.";if(e.code==="auth/popup-closed-by-user")t="Connexion annul√©e. Veuillez r√©essayer.";else if(e.code==="auth/popup-blocked")t="Pop-up bloqu√©e. Autorisez les pop-ups pour ce site.";else if(e.code==="auth/unauthorized-domain")t="Domaine non autoris√©. Configurez Firebase Authentication.";else if(e.code==="auth/cancelled-popup-request")return console.warn("‚ö†Ô∏è Requ√™te de popup annul√©e (clic multiple)"),null;throw e.code!=="auth/cancelled-popup-request"&&alert(t),e}finally{setTimeout(()=>{z=!1},2e3)}}async function He(){try{const e=m.currentUser?.displayName||"Utilisateur";await ce(m),console.log("‚úÖ D√©connexion r√©ussie:",e)}catch(e){throw console.error("‚ùå Erreur de d√©connexion:",e),e}}function Ge(e){return le(m,t=>{t?console.log("üë§ Utilisateur connect√©:",t.email):console.log("üë§ Aucun utilisateur connect√©"),e(t)})}function ze(){return m.currentUser}async function Ve(e){if(!e)return;if(e.role==="admin"){const r=document.getElementById("nav-admin-item");r&&r.classList.remove("hidden");const o=document.getElementById("admin-badge-nav");o&&o.classList.remove("hidden"),console.log("Admin UI elements shown")}}function Te(){return localStorage.getItem("authMode")==="demo"}function Me(){try{const e=localStorage.getItem("demoUser");return e?JSON.parse(e):null}catch(e){return console.error("‚ùå Erreur lecture utilisateur d√©mo:",e),null}}function Ke(){return Te()?Me():ze()}export{Te as A,Me as B,D as C,$e as D,Qe as E,Be as F,Ke as G,Ve as H,Oe as I,We as J,be as _,ke as a,ee as b,Z as c,Se as d,Ue as e,qe as f,Y as g,Fe as h,De as i,Ae as j,K as k,J as l,v as m,u as n,b as o,m as p,E as q,S as r,X as s,Ge as t,Ie as u,Ne as v,j as w,ze as x,He as y,P as z};
//# sourceMappingURL=auth-BWu0cJ0L.js.map
