{"version":3,"mappings":"y0CAOO,SAASA,GAAaC,EAAK,CAC9B,GAAI,CAACA,GAAO,OAAOA,GAAQ,SAAU,MAAO,GAE5C,MAAMC,EAAM,SAAS,cAAc,KAAK,EACxC,OAAAA,EAAI,YAAcD,EACXC,EAAI,SACf,CAOO,SAASC,EAAWC,EAAM,CAC7B,OAAOJ,GAAaI,CAAI,CAC5B,CCZO,SAASC,EAAUC,EAASC,EAAO,OAAQC,EAAW,IAAM,CAC/D,MAAMC,EAAYC,IAEZC,EAAQC,GAAmBN,EAASC,CAAI,EAC9C,OAAAE,EAAU,YAAYE,CAAK,EAG3B,WAAW,IAAMA,EAAM,UAAU,IAAI,MAAM,EAAG,EAAE,EAG5CH,EAAW,GACX,WAAW,IAAM,CACbK,EAAWF,CAAK,CACpB,EAAGH,CAAQ,EAGRG,CACX,CAKA,SAASD,GAA4B,CACjC,IAAID,EAAY,SAAS,eAAe,iBAAiB,EAEzD,OAAKA,IACDA,EAAY,SAAS,cAAc,KAAK,EACxCA,EAAU,GAAK,kBACfA,EAAU,UAAY,+CACtB,SAAS,KAAK,YAAYA,CAAS,GAGhCA,CACX,CAKA,SAASG,GAAmBN,EAASC,EAAM,CACvC,MAAMI,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,UAAY,eAAeJ,CAAI,0DAIjCA,IAAS,SACTI,EAAM,aAAa,OAAQ,OAAO,EAClCA,EAAM,aAAa,YAAa,WAAW,IAE3CA,EAAM,aAAa,OAAQ,QAAQ,EACnCA,EAAM,aAAa,YAAa,QAAQ,GAE5CA,EAAM,aAAa,cAAe,MAAM,EAExC,MAAMG,EAASC,EAAeR,CAAI,EAElC,OAAAI,EAAM,UAAY;AAAA,uFACiEG,EAAO,WAAW;AAAA;AAAA,kBAEvFA,EAAO,IAAI;AAAA;AAAA;AAAA,gEAGmCX,EAAWG,CAAO,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAW9DK,EAAM,cAAc,cAAc,EAC1C,iBAAiB,QAAS,IAAME,EAAWF,CAAK,CAAC,EAEnDA,CACX,CAKA,SAASI,EAAeR,EAAM,CAC1B,MAAMS,EAAU,CACZ,QAAS,CACL,YAAa,mBACb,KAAM;AAAA;AAAA;AAAA;AAAA,mBAKlB,EACQ,MAAO,CACH,YAAa,iBACb,KAAM;AAAA;AAAA;AAAA;AAAA,mBAKlB,EACQ,QAAS,CACL,YAAa,oBACb,KAAM;AAAA;AAAA;AAAA;AAAA,mBAKlB,EACQ,KAAM,CACF,YAAa,kBACb,KAAM;AAAA;AAAA;AAAA;AAAA,mBAKlB,CACA,EAEI,OAAOA,EAAQT,CAAI,GAAKS,EAAQ,IACpC,CAKA,SAASH,EAAWF,EAAO,CACvBA,EAAM,UAAU,OAAO,MAAM,EAC7BA,EAAM,UAAU,IAAI,kBAAkB,EAEtC,WAAW,IAAM,CACbA,EAAM,OAAM,EAGZ,MAAMF,EAAY,SAAS,eAAe,iBAAiB,EACvDA,GAAaA,EAAU,SAAS,SAAW,GAC3CA,EAAU,OAAM,CAExB,EAAG,GAAG,CACV,CAKY,MAACE,GAAQ,CACjB,QAAS,CAACL,EAASE,IAAaH,EAAUC,EAAS,UAAWE,CAAQ,EACtE,MAAO,CAACF,EAASE,IAAaH,EAAUC,EAAS,QAASE,CAAQ,EAClE,QAAS,CAACF,EAASE,IAAaH,EAAUC,EAAS,UAAWE,CAAQ,EACtE,KAAM,CAACF,EAASE,IAAaH,EAAUC,EAAS,OAAQE,CAAQ,CACpE,EAkDO,SAASS,GAAiBX,EAAS,CACtC,MAAMG,EAAYC,IAEZC,EAAQ,SAAS,cAAc,KAAK,EAC1C,OAAAA,EAAM,UAAY,6EAClBA,EAAM,aAAa,eAAgB,MAAM,EAEzCA,EAAM,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gEAM0CR,EAAWG,CAAO,CAAC;AAAA;AAAA;AAAA,MAK/EG,EAAU,YAAYE,CAAK,EAG3B,WAAW,IAAMA,EAAM,UAAU,IAAI,MAAM,EAAG,EAAE,EAEzCA,CACX,CAKO,SAASO,GAAmBP,EAAOL,EAASC,EAAO,UAAW,CACjE,GAAI,CAACI,GAAS,CAACA,EAAM,aAAa,cAAc,EAAG,OAEnD,MAAMG,EAASC,EAAeR,CAAI,EAE5BY,EAAUR,EAAM,UAAU,SAAS,MAAM,EAC/CA,EAAM,UAAY,eAAeJ,CAAI,yCAAyCY,EAAU,QAAU,EAAE,GAEpGR,EAAM,UAAY;AAAA,uFACiEG,EAAO,WAAW;AAAA;AAAA,kBAEvFA,EAAO,IAAI;AAAA;AAAA;AAAA,gEAGmCX,EAAWG,CAAO,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAU/EK,EAAM,gBAAgB,cAAc,EACpCA,EAAM,cAAc,cAAc,EAAE,iBAAiB,QAAS,IAAME,EAAWF,CAAK,CAAC,EAGrF,WAAW,IAAME,EAAWF,CAAK,EAAG,GAAI,CAC5C,CA4CA,GAAI,OAAO,SAAa,IAAa,CACjC,MAAMS,EAAe,SAAS,cAAc,OAAO,EACnDA,EAAa,YAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAkB3B,SAAS,KAAK,YAAYA,CAAY,CAC1C,CCtUA,MAAMC,EAAgB,OAAO,SAAS,WAAa,aAC9B,OAAO,SAAS,WAAa,aAC7B,OAAO,SAAS,WAAa,eAC7B,OAAO,SAAS,OAAS,OAMjCC,EAAS,CAIlB,IAAK,IAAIC,IAAS,CACVF,GACA,QAAQ,IAAI,GAAGE,CAAI,CAE3B,EAKA,MAAO,IAAIA,IAAS,CAChB,QAAQ,MAAM,GAAGA,CAAI,CACzB,EAKA,KAAM,IAAIA,IAAS,CACXF,GACA,QAAQ,KAAK,GAAGE,CAAI,CAE5B,EAKA,KAAM,IAAIA,IAAS,CACXF,GACA,QAAQ,KAAK,GAAGE,CAAI,CAE5B,EAKA,MAAO,IAAIA,IAAS,CACZF,GACA,QAAQ,MAAM,GAAGE,CAAI,CAE7B,EAKA,SAAU,IAAM,CACRF,GACA,QAAQ,SAAQ,CAExB,EAKA,MAAO,IAAIE,IAAS,CACZF,GACA,QAAQ,MAAM,GAAGE,CAAI,CAE7B,CACJ,EAII,QAAQ,IADRF,EACY,uCAEA,qDAFsC,EC/CtD,MAAMG,EAAiB,CACrB,OAAQ,0CACR,WAAY,iCACZ,YAAa,qDACb,UAAW,iBACX,cAAe,qCACf,kBAAmB,eACnB,MAAO,2CACT,EAGMC,EAAMC,GAAcF,CAAc,EAG3BG,EAAOC,GAAQH,CAAG,EAClBI,EAAKC,GAAaL,CAAG,EACRM,GAAYN,CAAG,EAKzCH,EAAO,IAAI,mCAAmC,EAC9CA,EAAO,IAAI,aAAcE,EAAe,SAAS,EACjDF,EAAO,IAAI,2DAA2D,isCC3CtE,MAAMU,CAAY,CACd,YAAYC,EAAaC,EAAU,CAC/B,KAAK,YAAcD,EACnB,KAAK,SAAWC,EAChB,KAAK,SAAW,EACpB,CAMA,MAAM,OAAQ,CACV,MAAMC,EAAM,KAAK,MAMjB,GAHA,KAAK,SAAW,KAAK,SAAS,OAAOC,GAAQD,EAAMC,EAAO,KAAK,QAAQ,EAGnE,KAAK,SAAS,QAAU,KAAK,YAAa,CAC1C,MAAMC,EAAgB,KAAK,SAAS,CAAC,EAC/BC,EAAW,KAAK,UAAYH,EAAME,GACxC,MAAM,IAAI,MAAM,wCAAwC,KAAK,KAAKC,EAAW,GAAI,CAAC,YAAY,CAClG,CAGA,KAAK,SAAS,KAAKH,CAAG,CAC1B,CAKA,OAAQ,CACJ,KAAK,SAAW,EACpB,CAKA,sBAAuB,CACnB,MAAMA,EAAM,KAAK,MACjB,YAAK,SAAW,KAAK,SAAS,OAAOC,GAAQD,EAAMC,EAAO,KAAK,QAAQ,EAChE,KAAK,IAAI,EAAG,KAAK,YAAc,KAAK,SAAS,MAAM,CAC9D,CACJ,CAMA,MAAMG,GAAuB,IAAIP,EAAY,IAAK,GAAK,EAMjDQ,GAA4B,IAAIR,EAAY,GAAI,GAAK,EAQpD,eAAeS,EAAkBC,EAAIC,EAAU,GAAI,CACtD,MAAMC,EAAUD,EAAQ,QAAUH,GAA4BD,GAE9D,GAAI,CACA,aAAMK,EAAQ,QACP,MAAMF,EAAE,CACnB,OAASG,EAAO,CAEZ,MAAIA,EAAM,QAAQ,SAAS,kBAAkB,GACzC,QAAQ,KAAK,yBAA0BA,EAAM,OAAO,EAC9CA,CAId,CACJ,CAKO,eAAeC,EAAkBJ,EAAI,CACxC,OAAOD,EAAkBC,EAAI,CAAE,QAAS,EAAK,CAAE,CACnD,CAKO,eAAeK,EAAmBL,EAAI,CACzC,OAAOD,EAAkBC,EAAI,CAAE,QAAS,EAAI,CAAE,CAClD,CCtFA,MAAMM,EAAoB,UAG1B,IAAIC,EAAsB,KACtBC,EAAsB,EAC1B,MAAMC,GAAsB,IAAS,IAO9B,eAAeC,EAAmBC,EAAO,KAAM,CAClD,MAAMC,EAAcD,GAAQ1B,EAAK,YACjC,GAAI,CAAC2B,EACD,eAAQ,KAAK,mEAAmE,EACzEN,EAIX,MAAMb,EAAM,KAAK,MACjB,GAAIc,GAAuBd,EAAMe,EAC7B,OAAOD,EAGX,GAAI,CAEA,MAAMM,EAAUC,EAAI3B,EAAI,QAASyB,EAAY,GAAG,EAC1CG,EAAU,MAAMX,EAAkB,IAAMY,EAAOH,CAAO,CAAC,EAE7D,GAAIE,EAAQ,SAAU,CAGlB,IAAIE,EAFaF,EAAQ,OAED,SACxB,OAAKE,IACDA,EAAWC,EAA2BN,EAAY,KAAK,GAI3DL,EAAsBU,EACtBT,EAAsBf,EAAMgB,GAErBQ,CACX,KAAO,CAEH,MAAMA,EAAWC,EAA2BN,EAAY,KAAK,EAC7D,eAAQ,IAAI,4EAA8EK,CAAQ,EAC3FA,CACX,CACJ,OAASd,EAAO,CACZ,eAAQ,MAAM,kCAAmCA,CAAK,EAErCe,EAA2BN,EAAY,KAAK,CAEjE,CACJ,CA4BO,SAASM,EAA2BC,EAAO,CAC9C,GAAI,CAACA,EAAO,OAAOb,EAKnB,MAAMc,EAASD,EAAM,MAAM,GAAG,EAAE,CAAC,EASjC,MANyB,CAI7B,EAE4BC,CAAM,GAAKd,CACvC,CCzGA,MAAMe,EAAa,IAAI,IAGjBC,EAAe,CACjB,MAAO,IAAU,IACjB,YAAa,IAAS,IACtB,UAAW,KAAU,IACrB,MAAO,IAAS,IAChB,gBAAiB,IAAU,IAC3B,eAAgB,IAAU,IAC1B,QAAS,IAAS,GACtB,EAOA,SAASC,GAAkBC,EAAU,CACjC,OAAOF,EAAaE,CAAQ,GAAKF,EAAa,OAClD,CAOO,SAASG,EAAcC,EAAQ,GAAI,CACtC,OAAOA,EAAM,OAAO,OAAO,EAAE,KAAK,IAAI,CAC1C,CAOO,SAASC,EAAeC,EAAK,CAChC,MAAMC,EAAQR,EAAW,IAAIO,CAAG,EAChC,OAAKC,EAGD,KAAK,MAAQA,EAAM,UACnBR,EAAW,OAAOO,CAAG,EACd,MAEJC,EAAM,MANF,IAOf,CAQO,SAASC,EAAeF,EAAKG,EAAOC,EAAcV,EAAa,QAAS,CAE3E,MAAMW,EAAQ,OAAOD,GAAgB,SAC/BT,GAAkBS,CAAW,EAC7BA,EAENX,EAAW,IAAIO,EAAK,CAChB,MAAAG,EACA,SAAU,KAAK,IAAG,EAAKE,EACvB,SAAU,OAAOD,GAAgB,SAAWA,EAAc,IAClE,CAAK,CACL,CAMO,SAASE,EAAgBC,EAAQ,CACpCd,EAAW,QAAQ,CAACe,EAAGR,IAAQ,CACvBA,EAAI,WAAWO,CAAM,GACrBd,EAAW,OAAOO,CAAG,CAE7B,CAAC,CACL,CC1EO,eAAeS,GAAgBC,EAAS,CAC3C,GAAI,CACA,MAAMC,EAAM,CACR,GAAGD,EACH,WAAYE,EAAU,IAAG,CACrC,EAGQ,MAAMnC,EAAmB,IAAMoC,EAAOC,EAAWvD,EAAI,YAAY,EAAGoD,CAAG,CAAC,EACxE,QAAQ,IAAI,iBAAiB,CACjC,OAASpC,EAAO,CACZ,QAAQ,MAAM,8BAA+BA,CAAK,CACtD,CACJ,CAKO,eAAewC,GAAeL,EAAS,CAC1C,GAAI,CACA,MAAMC,EAAM,CACR,GAAGD,EACH,UAAWE,EAAU,IAAG,CACpC,EAGQ,MAAMnC,EAAmB,IAAMoC,EAAOC,EAAWvD,EAAI,WAAW,EAAGoD,CAAG,CAAC,EACvE,QAAQ,IAAI,gBAAgB,CAChC,OAASpC,EAAO,CACZ,QAAQ,MAAM,6BAA8BA,CAAK,CACrD,CACJ,CCjBA,MAAMyC,EAAc,CAChB,MAAO,OACX,EAKO,eAAeC,EAAmBlC,EAAM,CAC3C,GAAI,CACA,MAAME,EAAUC,EAAI3B,EAAIyD,EAAY,MAAOjC,EAAK,GAAG,EAE7CM,EAAW,MAAMP,EAAmBC,CAAI,EAExCmC,EAAW,CACb,IAAKnC,EAAK,IACV,MAAOA,EAAK,MACZ,YAAaA,EAAK,YAClB,SAAUA,EAAK,SACf,UAAW6B,EAAU,IAAG,EACxB,UAAWA,EAAU,IAAG,EACxB,SAAUvB,CACtB,EAEcF,EAAU,MAAMX,EAAkB,IAAMY,EAAOH,CAAO,CAAC,EAE7D,OAAKE,EAAQ,SASYA,EAAQ,OACX,WACd+B,EAAS,SAAW7B,EACpB,QAAQ,IAAI,gEAAgE,IAXhF6B,EAAS,UAAYN,EAAU,MAC/BM,EAAS,aAAe,EACxBA,EAAS,aAAe,EACxBA,EAAS,cAAgB,EACzBA,EAAS,cAAgB,EACzBA,EAAS,KAAO,OAChB,QAAQ,IAAI,qCAAsCnC,EAAK,KAAK,GAShE,MAAMN,EAAmB,IAAM0C,GAAOlC,EAASiC,EAAU,CAAE,MAAO,EAAI,CAAE,CAAC,EACzE,QAAQ,IAAI,iCAAiC,EACtCA,CACX,OAAS3C,EAAO,CACZ,cAAQ,MAAM,iCAAkCA,CAAK,EAC/CA,CACV,CACJ,CAKO,eAAe6C,EAAeC,EAAK,CACtC,GAAI,CACA,MAAMpC,EAAUC,EAAI3B,EAAIyD,EAAY,MAAOK,CAAG,EACxClC,EAAU,MAAMX,EAAkB,IAAMY,EAAOH,CAAO,CAAC,EAE7D,OAAIE,EAAQ,SACDA,EAAQ,OAEZ,IACX,OAASZ,EAAO,CACZ,cAAQ,MAAM,gCAAiCA,CAAK,EAC9CA,CACV,CACJ,CAMO,eAAe+C,GAAgBD,EAAKE,EAAU,CACjD,GAAI,MAAMA,CAAQ,GAAKA,EAAW,GAAKA,EAAW,IAC9C,cAAQ,MAAM,+CAAgDA,CAAQ,EAChE,IAAI,MAAM,mBAAmBA,CAAQ,6BAA6B,EAG5E,GAAI,CACA,MAAMC,GAAejE,EAAI,MAAOkE,GAAgB,CAC5C,MAAMxC,EAAUC,EAAI3B,EAAIyD,EAAY,MAAOK,CAAG,EACxClC,EAAU,MAAMsC,EAAY,IAAIxC,CAAO,EAE7C,GAAI,CAACE,EAAQ,SACT,MAAM,IAAI,MAAM,wBAAwB,EAG5C,MAAM+B,EAAW/B,EAAQ,OACnBuC,GAAgBR,EAAS,cAAgB,GAAK,EAE9CS,IADiBT,EAAS,cAAgB,IACTQ,EAAe,GAAMH,GAAYG,EAElEE,EAAiB,KAAK,MAAMD,CAAU,EAC5C,GAAI,MAAMC,CAAc,GAAKA,EAAiB,GAAKA,EAAiB,IAChE,cAAQ,MAAM,+BAAgCA,CAAc,EACtD,IAAI,MAAM,mCAAmCA,CAAc,EAAE,EAGvEH,EAAY,OAAOxC,EAAS,CACxB,aAAcyC,EACd,aAAcE,EACd,aAAchB,EAAU,IAAG,EAC3B,UAAWA,EAAU,IAAG,CACxC,CAAa,CACL,CAAC,EAED,QAAQ,IAAI,8BAA8B,EAC1CN,EAAgB,OAAO,EACvBA,EAAgB,aAAa,CACjC,OAAS/B,EAAO,CACZ,cAAQ,MAAM,qCAAsCA,CAAK,EACnDA,CACV,CACJ,CAKO,eAAesD,GAAaR,EAAK,CAEpC,KAAM,CAAE,mBAAAS,CAAkB,EAAK,MAAKC,GAAA,mCAAAD,GAAA,KAAC,QAAO,4BAAmB,OAAAE,KAAA,6BAAAF,CAAA,OAE/D,GAAI,CACA,MAAMG,EAAU,MAAMH,EAAmBT,EAAK,EAAE,EAEhD,IAAIa,EAAgB,EACpB,MAAMC,EAAY,IAAI,IAEtB,UAAWC,KAAUH,EACbG,EAAO,OAAS,IAChBD,EAAU,IAAIC,EAAO,KAAK,EAIlC,MAAMC,EAAS,MAAM,KAAKF,CAAS,EAAE,KAAI,EAAG,UAC5C,QAASG,EAAI,EAAGA,EAAID,EAAO,SACvBH,IACII,EAAID,EAAO,OAAS,GAFOC,IAE/B,CAOJ,MAAMrD,EAAUC,EAAI3B,EAAIyD,EAAY,MAAOK,CAAG,EACxClC,EAAU,MAAMX,EAAkB,IAAMY,EAAOH,CAAO,CAAC,EAE7D,GAAIE,EAAQ,SAAU,CAClB,MAAM+B,EAAW/B,EAAQ,OACnBoD,EAAgB,KAAK,IAAIL,EAAehB,EAAS,eAAiB,CAAC,EAEzE,MAAMzC,EAAmB,IAAM+D,EAAUvD,EAAS,CAC9C,cAAeiD,EACf,cAAeK,EACf,UAAW3B,EAAU,IAAG,CACxC,CAAa,CAAC,EAEF,QAAQ,IAAI,yBAAyBsB,CAAa,OAAO,EACzD5B,EAAgB,OAAO,EACvBA,EAAgB,aAAa,CACjC,CAEA,OAAO4B,CACX,OAAS3D,EAAO,CACZ,cAAQ,MAAM,8BAA+BA,CAAK,EAC5CA,CACV,CACJ,CA2CO,eAAekE,IAAqB,CACvC,GAAI,CACA,MAAM1D,EAAO1B,EAAK,YAClB,OAAK0B,GAEe,MAAMqC,EAAerC,EAAK,GAAG,IAC7B,OAAS,QAHX,EAItB,OAASR,EAAO,CACZ,eAAQ,MAAM,+BAAgCA,CAAK,EAC5C,EACX,CACJ,CAKO,eAAemE,GAAYC,EAAU,GAAI,CAC5C,MAAMC,EAAW/C,EAAc,CAAC,QAAS,KAAK,UAAU8C,GAAW,EAAE,CAAC,CAAC,EACjEE,EAAS9C,EAAe6C,CAAQ,EACtC,GAAIC,EACA,OAAOA,EAGX,GAAI,CACA,MAAMxD,EAAW,MAAMP,IAEjBgE,EAAc,CAChBC,EAAM,WAAY,KAAM1D,CAAQ,CAC5C,EAEYsD,EAAQ,MACRG,EAAY,KAAKC,EAAM,OAAQ,KAAMJ,EAAQ,IAAI,CAAC,EAGtDG,EAAY,KAAKE,EAAQ,YAAa,MAAM,CAAC,EAE7C,MAAMC,EAAIC,EAAMpC,EAAWvD,EAAIyD,EAAY,KAAK,EAAG,GAAG8B,CAAW,EAE3DK,EAAgB,MAAM3E,EAAkB,IAAM4E,EAAQH,CAAC,CAAC,EACxDI,EAAQ,GAEd,OAAAF,EAAc,QAASjE,GAAQ,CAC3BmE,EAAM,KAAK,CAAE,GAAInE,EAAI,GAAI,GAAGA,EAAI,KAAI,CAAE,CAAE,CAC5C,CAAC,EAED,QAAQ,IAAI,MAAMmE,EAAM,MAAM,uBAAuB,EACrDnD,EAAe0C,EAAUS,EAAO,OAAO,EAChCA,CACX,OAAS9E,EAAO,CACZ,cAAQ,MAAM,sCAAuCA,CAAK,EACpDA,CACV,CACJ,CASO,eAAe+E,GAAqBX,EAAU,GAAIY,EAAW,GAAIC,EAAU,KAAM,CACpF,GAAI,CACA,MAAMnE,EAAW,MAAMP,IAEjBgE,EAAc,CAChBC,EAAM,WAAY,KAAM1D,CAAQ,CAC5C,EAEYsD,EAAQ,MACRG,EAAY,KAAKC,EAAM,OAAQ,KAAMJ,EAAQ,IAAI,CAAC,EAGtDG,EAAY,KAAKE,EAAQ,YAAa,MAAM,CAAC,EAC7CF,EAAY,KAAKW,GAAMF,EAAW,CAAC,CAAC,EAEpC,IAAIN,EAAIC,EAAMpC,EAAWvD,EAAIyD,EAAY,KAAK,EAAG,GAAG8B,CAAW,EAG3DU,IACAP,EAAIC,EAAMD,EAAGS,GAAWF,CAAO,CAAC,GAGpC,MAAML,EAAgB,MAAM3E,EAAkB,IAAM4E,EAAQH,CAAC,CAAC,EACxDI,EAAQ,GACd,IAAIM,EAAa,KACbC,EAAU,GAEd,OAAAT,EAAc,QAAQ,CAACjE,EAAK2E,IAAU,CAC9BA,EAAQN,EACRF,EAAM,KAAK,CAAE,GAAInE,EAAI,GAAI,GAAGA,EAAI,KAAI,CAAE,CAAE,EAGxC0E,EAAU,EAElB,CAAC,EAGGT,EAAc,KAAK,OAAS,GAAKE,EAAM,SAAWE,IAClDI,EAAaR,EAAc,KAAKI,EAAW,CAAC,GAGhD,QAAQ,IAAI,MAAMF,EAAM,MAAM,oCAAoC,EAC3D,CACH,MAAAA,EACA,QAASM,EACT,QAAAC,CACZ,CACI,OAASrF,EAAO,CACZ,cAAQ,MAAM,8CAA+CA,CAAK,EAC5DA,CACV,CACJ,CAKO,eAAeuF,GAAeC,EAAQC,EAAS,CAClD,GAAI,CACA,MAAMjF,EAAO1B,EAAK,YAClB,GAAI,CAAC0B,EAAM,MAAM,IAAI,MAAM,0BAA0B,EAErD,GAAI,CAAC,CAAC,OAAQ,OAAO,EAAE,SAASiF,CAAO,EACnC,MAAM,IAAI,MAAM,6CAA6C,EAGjE,MAAM/E,EAAUC,EAAI3B,EAAIyD,EAAY,MAAO+C,CAAM,EAEjD,aAAMtF,EAAmB,IAAM+D,EAAUvD,EAAS,CAC9C,KAAM+E,EACN,UAAWpD,EAAU,IAAG,CACpC,CAAS,CAAC,EAEF,QAAQ,IAAI,0BAA0BmD,CAAM,KAAKC,CAAO,EAAE,EAE1D,MAAMjD,GAAe,CACjB,OAAQ,mBACR,aAAcgD,EACd,QAASC,EACT,QAASjF,EAAK,IACd,WAAYA,EAAK,KAC7B,CAAS,EAEDuB,EAAgB,OAAO,EACvBA,EAAgB,aAAa,EAEtB,EACX,OAAS/B,EAAO,CACZ,cAAQ,MAAM,6BAA8BA,CAAK,EAC3CA,CACV,CACJ,CAKO,eAAe0F,IAAgB,CAClC,MAAM5E,EAAW,MAAMP,IACjB8D,EAAW/C,EAAc,CAAC,cAAeR,CAAQ,CAAC,EAClDwD,EAAS9C,EAAe6C,CAAQ,EACtC,GAAIC,EACA,OAAOA,EAGX,GAAI,CACA,MAAMQ,EAAQ,MAAMX,KAEdwB,EAAQ,CACV,MAAOb,EAAM,OACb,OAAQA,EAAM,OAAOc,GAAKA,EAAE,OAAS,OAAO,EAAE,OAC9C,aAAcd,EAAM,OAAOc,GAAKA,EAAE,OAAS,OAAO,EAAE,OACpD,eAAgB,EAChB,aAAc,EACd,aAAc,CAC1B,EAEcC,EAAa,IAAI,KACvB,OAAAA,EAAW,QAAQA,EAAW,QAAO,EAAK,CAAC,EAE3Cf,EAAM,QAAQc,GAAK,CACXA,EAAE,WAAaA,EAAE,UAAU,OAAM,EAAKC,GACtCF,EAAM,iBAEVA,EAAM,cAAiBC,EAAE,cAAgB,EACzCD,EAAM,cAAiBC,EAAE,cAAgB,CAC7C,CAAC,EAEDD,EAAM,aAAeA,EAAM,MAAQ,EAAI,KAAK,MAAMA,EAAM,aAAeA,EAAM,KAAK,EAAI,EAEtFhE,EAAe0C,EAAUsB,EAAO,OAAO,EAChCA,CACX,OAAS3F,EAAO,CACZ,cAAQ,MAAM,sCAAuCA,CAAK,EACpDA,CACV,CACJ,8QCtaM8F,GAAW,IAAIC,GACrBD,GAAS,oBAAoB,CACzB,OAAQ,gBACZ,CAAC,EAGD,IAAIE,EAAmB,GAGhB,eAAeC,IAAmB,CAErC,GAAID,EACA,eAAQ,KAAK,mDAAmD,EACzD,KAGXA,EAAmB,GAEnB,GAAI,CACA,QAAQ,IAAI,qCAAqC,EAEjD,MAAMxF,GADS,MAAM0F,GAAgBpH,EAAMgH,EAAQ,GAC/B,KAEpB,eAAQ,IAAI,8BAA+BtF,EAAK,WAAW,EAC3D,QAAQ,IAAI,YAAaA,EAAK,KAAK,EAGnC,MAAMkC,EAAmBlC,CAAI,EAEtBA,CACX,OAASR,EAAO,CACZ,QAAQ,MAAM,yBAA0BA,CAAK,EAG7C,IAAImG,EAAe,mDAEnB,GAAInG,EAAM,OAAS,4BACfmG,EAAe,iDACRnG,EAAM,OAAS,qBACtBmG,EAAe,8DACRnG,EAAM,OAAS,2BACtBmG,EAAe,oEACRnG,EAAM,OAAS,+BAEtB,eAAQ,KAAK,6CAA6C,EACnD,KAGX,MAAIA,EAAM,OAAS,gCACf,MAAMmG,CAAY,EAEhBnG,CACV,QAAC,CAEG,WAAW,IAAM,CACbgG,EAAmB,EACvB,EAAG,GAAI,CACX,CACJ,CAGO,eAAeI,IAAc,CAChC,GAAI,CACA,MAAMC,EAAWvH,EAAK,aAAa,aAAe,cAClD,MAAMwH,GAAQxH,CAAI,EAClB,QAAQ,IAAI,yBAA0BuH,CAAQ,CAClD,OAASrG,EAAO,CACZ,cAAQ,MAAM,2BAA4BA,CAAK,EACzCA,CACV,CACJ,CAGO,SAASuG,GAAaC,EAAU,CACnC,OAAOC,GAAmB3H,EAAO0B,GAAS,CAClCA,EACA,QAAQ,IAAI,2BAA4BA,EAAK,KAAK,EAElD,QAAQ,IAAI,+BAA+B,EAE/CgG,EAAShG,CAAI,CACjB,CAAC,CACL,CAGO,SAASkG,IAAiB,CAC7B,OAAO5H,EAAK,WAChB,CAQO,eAAe6H,GAAmBC,EAAa,CAClD,GAAI,CAACA,EAAa,OAIlB,GAFgBA,EAAY,OAAS,QAExB,CAET,MAAMC,EAAe,SAAS,eAAe,gBAAgB,EACzDA,GACAA,EAAa,UAAU,OAAO,QAAQ,EAI1C,MAAMC,EAAgB,SAAS,eAAe,iBAAiB,EAC3DA,GACAA,EAAc,UAAU,OAAO,QAAQ,EAG3C,QAAQ,IAAI,yBAAyB,CACzC,CACJ,CAqDO,SAASC,IAAa,CACzB,OAAO,aAAa,QAAQ,UAAU,IAAM,MAChD,CAKO,SAASC,IAAc,CAC1B,GAAI,CACA,MAAMC,EAAe,aAAa,QAAQ,UAAU,EACpD,OAAKA,EAEY,KAAK,MAAMA,CAAY,EAFd,IAI9B,OAASjH,EAAO,CACZ,eAAQ,MAAM,qCAAsCA,CAAK,EAClD,IACX,CACJ,CAKO,SAASkH,IAAwB,CAEpC,OAAIH,GAAU,EACHC,GAAW,EAIfN,GAAc,CACzB","names":["sanitizeHTML","str","div","escapeHtml","text","showToast","message","type","duration","container","getOrCreateToastContainer","toast","createToastElement","closeToast","config","getToastConfig","configs","showLoadingToast","updateLoadingToast","hadShow","styleElement","isDevelopment","logger","args","firebaseConfig","app","initializeApp","auth","getAuth","db","getFirestore","getDatabase","RateLimiter","maxRequests","windowMs","now","time","oldestRequest","waitTime","firestoreRateLimiter","firestoreWriteRateLimiter","safeFirestoreCall","fn","options","limiter","error","safeFirestoreRead","safeFirestoreWrite","DEFAULT_CLIENT_ID","currentUserClientId","clientIdCacheExpiry","CLIENT_ID_CACHE_TTL","getCurrentClientId","user","currentUser","userRef","doc","userDoc","getDoc","clientId","determineClientIdFromEmail","email","domain","cacheStore","CACHE_CONFIG","getTTLForDataType","dataType","buildCacheKey","parts","getCachedValue","key","entry","setCachedValue","value","ttlMsOrType","ttlMs","invalidateCache","prefix","_","createImportLog","logData","log","Timestamp","addDoc","collection","createAuditLog","COLLECTIONS","createOrUpdateUser","userData","setDoc","getUserProfile","uid","updateUserStats","newScore","runTransaction","transaction","totalQuizzes","newAverage","roundedAverage","updateStreak","getUserQuizResults","__vitePreload","n","results","currentStreak","monthsSet","result","months","i","longestStreak","updateDoc","isCurrentUserAdmin","getAllUsers","filters","cacheKey","cached","constraints","where","orderBy","q","query","querySnapshot","getDocs","users","getAllUsersPaginated","pageSize","lastDoc","limit","startAfter","newLastDoc","hasMore","index","updateUserRole","userId","newRole","getUsersStats","stats","u","oneWeekAgo","provider","GoogleAuthProvider","signInInProgress","signInWithGoogle","signInWithPopup","errorMessage","signOutUser","userName","signOut","onAuthChange","callback","onAuthStateChanged","getCurrentUser","showAdminUIIfAdmin","userProfile","navAdminItem","adminBadgeNav","isDemoMode","getDemoUser","demoUserJson","getCurrentUserUnified"],"ignoreList":[],"sources":["../../js/security.js","../../js/toast.js","../../js/logger.js","../../js/firebase-config.js","../../js/rate-limiter.js","../../js/client-manager.js","../../js/services/cache-service.js","../../js/services/audit-service.js","../../js/services/user-service.js","../../js/auth.js"],"sourcesContent":["// Helpers de s√©curit√© - Validation et sanitization des entr√©es\r\n\r\n/**\r\n * √âchappe les caract√®res HTML pour pr√©venir les attaques XSS\r\n * @param {string} str - Cha√Æne √† √©chapper\r\n * @returns {string} Cha√Æne s√©curis√©e\r\n */\r\nexport function sanitizeHTML(str) {\r\n    if (!str || typeof str !== 'string') return '';\r\n    \r\n    const div = document.createElement('div');\r\n    div.textContent = str;\r\n    return div.innerHTML;\r\n}\r\n\r\n/**\r\n * √âchappe les caract√®res HTML (alias pour compatibilit√©)\r\n * @param {string} text - Texte √† √©chapper\r\n * @returns {string} Texte s√©curis√©\r\n */\r\nexport function escapeHtml(text) {\r\n    return sanitizeHTML(text);\r\n}\r\n\r\n/**\r\n * Valide et s√©curise une URL\r\n * @param {string} url - URL √† valider\r\n * @returns {string} URL s√©curis√©e ou '#' si invalide\r\n */\r\nexport function sanitizeURL(url) {\r\n    if (!url || typeof url !== 'string') return '#';\r\n    \r\n    try {\r\n        const parsed = new URL(url);\r\n        // Autoriser seulement http: et https:\r\n        if (!['http:', 'https:'].includes(parsed.protocol)) {\r\n            console.warn('‚ö†Ô∏è URL avec protocole non autoris√© bloqu√©e:', url);\r\n            return '#';\r\n        }\r\n        return url;\r\n    } catch {\r\n        console.warn('‚ö†Ô∏è URL invalide bloqu√©e:', url);\r\n        return '#';\r\n    }\r\n}\r\n\r\n/**\r\n * Validateurs pour diff√©rents types de donn√©es\r\n */\r\nexport const validators = {\r\n    /**\r\n     * Valide un email\r\n     */\r\n    email: (email) => {\r\n        if (!email || typeof email !== 'string') return false;\r\n        return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\r\n    },\r\n    \r\n    /**\r\n     * Valide le texte d'une question\r\n     */\r\n    questionText: (text) => {\r\n        if (!text || typeof text !== 'string') return false;\r\n        const trimmed = text.trim();\r\n        if (trimmed.length < 10) return false;\r\n        if (trimmed.length > 500) return false;\r\n        return true;\r\n    },\r\n    \r\n    /**\r\n     * Valide une option de r√©ponse\r\n     */\r\n    option: (opt) => {\r\n        if (!opt || typeof opt !== 'string') return false;\r\n        const trimmed = opt.trim();\r\n        if (trimmed.length < 2) return false;\r\n        if (trimmed.length > 200) return false;\r\n        return true;\r\n    },\r\n    \r\n    /**\r\n     * Valide une explication\r\n     */\r\n    explanation: (text) => {\r\n        if (!text || typeof text !== 'string') return false;\r\n        const trimmed = text.trim();\r\n        if (trimmed.length < 20) return false;\r\n        if (trimmed.length > 1000) return false;\r\n        return true;\r\n    },\r\n    \r\n    /**\r\n     * Valide un module\r\n     */\r\n    module: (mod) => {\r\n        return ['auto', 'loisir', 'vr', 'tracteur'].includes(mod);\r\n    },\r\n    \r\n    /**\r\n     * Valide un mois (1-12)\r\n     */\r\n    month: (m) => {\r\n        return Number.isInteger(m) && m >= 1 && m <= 12;\r\n    },\r\n    \r\n    /**\r\n     * Valide une ann√©e (2020-2030)\r\n     */\r\n    year: (y) => {\r\n        return Number.isInteger(y) && y >= 2020 && y <= 2030;\r\n    },\r\n    \r\n    /**\r\n     * Valide un index de r√©ponse correcte (0-3)\r\n     */\r\n    correctAnswer: (idx) => {\r\n        return Number.isInteger(idx) && idx >= 0 && idx <= 3;\r\n    },\r\n    \r\n    /**\r\n     * Valide un r√¥le utilisateur\r\n     */\r\n    role: (role) => {\r\n        return ['user', 'admin'].includes(role);\r\n    },\r\n    \r\n    /**\r\n     * Valide un score (0-100)\r\n     */\r\n    score: (score) => {\r\n        return typeof score === 'number' && score >= 0 && score <= 100;\r\n    }\r\n};\r\n\r\n/**\r\n * Valide les donn√©es compl√®tes d'une question\r\n * @param {Object} data - Donn√©es de la question\r\n * @returns {Object} { valid: boolean, errors: string[] }\r\n */\r\nexport function validateQuestionData(data) {\r\n    const errors = [];\r\n    \r\n    // Validation question\r\n    if (!validators.questionText(data.question)) {\r\n        errors.push('Question invalide (10-500 caract√®res requis)');\r\n    }\r\n    \r\n    // Validation options\r\n    if (!Array.isArray(data.options) || data.options.length !== 4) {\r\n        errors.push('Exactement 4 options requises');\r\n    } else {\r\n        data.options.forEach((opt, idx) => {\r\n            if (!validators.option(opt)) {\r\n                errors.push(`Option ${idx + 1} invalide (2-200 caract√®res requis)`);\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Validation r√©ponse correcte\r\n    if (!validators.correctAnswer(data.correctAnswer)) {\r\n        errors.push('Index de r√©ponse correcte invalide (0-3)');\r\n    }\r\n    \r\n    // Validation explication\r\n    if (!validators.explanation(data.explanation)) {\r\n        errors.push('Explication invalide (20-1000 caract√®res requis)');\r\n    }\r\n    \r\n    // Validation module\r\n    if (!validators.module(data.module)) {\r\n        errors.push('Module invalide (auto, loisir, vr, tracteur)');\r\n    }\r\n    \r\n    // Validation mois\r\n    if (!validators.month(data.month)) {\r\n        errors.push('Mois invalide (1-12)');\r\n    }\r\n    \r\n    // Validation ann√©e\r\n    if (!validators.year(data.year)) {\r\n        errors.push('Ann√©e invalide (2020-2030)');\r\n    }\r\n    \r\n    return {\r\n        valid: errors.length === 0,\r\n        errors\r\n    };\r\n}\r\n\r\n/**\r\n * Nettoie et valide les donn√©es d'une question\r\n * @param {Object} data - Donn√©es brutes\r\n * @returns {Object} Donn√©es nettoy√©es et valid√©es\r\n */\r\nexport function sanitizeQuestionData(data) {\r\n    return {\r\n        question: sanitizeHTML(data.question?.trim() || ''),\r\n        options: (data.options || []).map(opt => sanitizeHTML(opt?.trim() || '')),\r\n        correctAnswer: parseInt(data.correctAnswer, 10),\r\n        explanation: sanitizeHTML(data.explanation?.trim() || ''),\r\n        module: data.module,\r\n        month: parseInt(data.month, 10),\r\n        year: parseInt(data.year, 10),\r\n        reference: sanitizeHTML(data.reference?.trim() || ''),\r\n        tags: (data.tags || []).map(tag => sanitizeHTML(tag?.trim() || ''))\r\n    };\r\n}\r\n\r\n/**\r\n * Limite la taille d'une cha√Æne\r\n * @param {string} str - Cha√Æne √† limiter\r\n * @param {number} maxLength - Longueur maximale\r\n * @returns {string} Cha√Æne limit√©e\r\n */\r\nexport function truncateString(str, maxLength = 100) {\r\n    if (!str || typeof str !== 'string') return '';\r\n    if (str.length <= maxLength) return str;\r\n    return str.substring(0, maxLength - 3) + '...';\r\n}\r\n\r\n/**\r\n * D√©tecte les tentatives d'injection SQL/NoSQL dans une cha√Æne\r\n * @param {string} str - Cha√Æne √† analyser\r\n * @returns {boolean} true si suspect\r\n */\r\nexport function detectInjectionAttempt(str) {\r\n    if (!str || typeof str !== 'string') return false;\r\n    \r\n    const suspiciousPatterns = [\r\n        /(<script|javascript:|onerror=|onclick=)/i,\r\n        /(union.*select|insert.*into|drop.*table)/i,\r\n        /(\\$where|\\$ne|\\$gt|\\$lt)/i, // NoSQL injection\r\n        /(eval\\(|exec\\(|system\\()/i\r\n    ];\r\n    \r\n    return suspiciousPatterns.some(pattern => pattern.test(str));\r\n}\r\n\r\n/**\r\n * Nettoie les donn√©es utilisateur pour affichage s√©curis√©\r\n * @param {Object} user - Objet utilisateur\r\n * @returns {Object} Utilisateur avec donn√©es nettoy√©es\r\n */\r\nexport function sanitizeUserData(user) {\r\n    if (!user) return null;\r\n    \r\n    return {\r\n        uid: user.uid,\r\n        email: sanitizeHTML(user.email || ''),\r\n        displayName: sanitizeHTML(user.displayName || 'Utilisateur'),\r\n        photoURL: user.photoURL ? sanitizeURL(user.photoURL) : null,\r\n        role: validators.role(user.role) ? user.role : 'user'\r\n    };\r\n}\r\n\r\nexport default {\r\n    sanitizeHTML,\r\n    escapeHtml,\r\n    sanitizeURL,\r\n    validators,\r\n    validateQuestionData,\r\n    sanitizeQuestionData,\r\n    truncateString,\r\n    detectInjectionAttempt,\r\n    sanitizeUserData\r\n};\r\n","// Syst√®me de Notifications Toast - Feedback utilisateur moderne\r\n// Utilisation: showToast('Message', 'success|error|warning|info')\r\nimport { escapeHtml } from './security.js';\r\n\r\n/**\r\n * Afficher une notification toast\r\n * @param {string} message - Le message √† afficher\r\n * @param {string} type - Type: 'success', 'error', 'warning', 'info'\r\n * @param {number} duration - Dur√©e en ms (d√©faut: 3000)\r\n */\r\nexport function showToast(message, type = 'info', duration = 3000) {\r\n    const container = getOrCreateToastContainer();\r\n    \r\n    const toast = createToastElement(message, type);\r\n    container.appendChild(toast);\r\n    \r\n    // Animation d'entr√©e\r\n    setTimeout(() => toast.classList.add('show'), 10);\r\n    \r\n    // Auto-fermeture\r\n    if (duration > 0) {\r\n        setTimeout(() => {\r\n            closeToast(toast);\r\n        }, duration);\r\n    }\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Cr√©er ou r√©cup√©rer le conteneur de toasts\r\n */\r\nfunction getOrCreateToastContainer() {\r\n    let container = document.getElementById('toast-container');\r\n    \r\n    if (!container) {\r\n        container = document.createElement('div');\r\n        container.id = 'toast-container';\r\n        container.className = 'fixed top-4 right-4 z-50 flex flex-col gap-3';\r\n        document.body.appendChild(container);\r\n    }\r\n    \r\n    return container;\r\n}\r\n\r\n/**\r\n * Cr√©er un √©l√©ment toast\r\n */\r\nfunction createToastElement(message, type) {\r\n    const toast = document.createElement('div');\r\n    toast.className = `toast toast-${type} transform translate-x-full transition-all duration-300`;\r\n    \r\n    // ‚úÖ CORRECTION ACCESSIBILIT√â : Live regions pour toasts\r\n    // error = alert (assertive), autres = status (polite)\r\n    if (type === 'error') {\r\n        toast.setAttribute('role', 'alert');\r\n        toast.setAttribute('aria-live', 'assertive');\r\n    } else {\r\n        toast.setAttribute('role', 'status');\r\n        toast.setAttribute('aria-live', 'polite');\r\n    }\r\n    toast.setAttribute('aria-atomic', 'true');\r\n    \r\n    const config = getToastConfig(type);\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${config.borderColor} p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                ${config.icon}\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900\">${escapeHtml(message)}</p>\r\n            </div>\r\n            <button class=\"toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors\" aria-label=\"Fermer la notification\">\r\n                <svg aria-hidden=\"true\" class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </button>\r\n        </div>\r\n    `;\r\n    \r\n    // √âv√©nement de fermeture\r\n    const closeBtn = toast.querySelector('.toast-close');\r\n    closeBtn.addEventListener('click', () => closeToast(toast));\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Configuration par type de toast\r\n */\r\nfunction getToastConfig(type) {\r\n    const configs = {\r\n        success: {\r\n            borderColor: 'border-green-500',\r\n            icon: `<div class=\"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"></path>\r\n                </svg>\r\n            </div>`\r\n        },\r\n        error: {\r\n            borderColor: 'border-red-500',\r\n            icon: `<div class=\"w-8 h-8 bg-red-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </div>`\r\n        },\r\n        warning: {\r\n            borderColor: 'border-yellow-500',\r\n            icon: `<div class=\"w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-yellow-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"></path>\r\n                </svg>\r\n            </div>`\r\n        },\r\n        info: {\r\n            borderColor: 'border-blue-500',\r\n            icon: `<div class=\"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                </svg>\r\n            </div>`\r\n        }\r\n    };\r\n    \r\n    return configs[type] || configs.info;\r\n}\r\n\r\n/**\r\n * Fermer un toast\r\n */\r\nfunction closeToast(toast) {\r\n    toast.classList.remove('show');\r\n    toast.classList.add('translate-x-full');\r\n    \r\n    setTimeout(() => {\r\n        toast.remove();\r\n        \r\n        // Nettoyer le conteneur si vide\r\n        const container = document.getElementById('toast-container');\r\n        if (container && container.children.length === 0) {\r\n            container.remove();\r\n        }\r\n    }, 300);\r\n}\r\n\r\n/**\r\n * Raccourcis pour les types de toasts\r\n */\r\nexport const toast = {\r\n    success: (message, duration) => showToast(message, 'success', duration),\r\n    error: (message, duration) => showToast(message, 'error', duration),\r\n    warning: (message, duration) => showToast(message, 'warning', duration),\r\n    info: (message, duration) => showToast(message, 'info', duration)\r\n};\r\n\r\n/**\r\n * Toast avec action\r\n */\r\nexport function showToastWithAction(message, type, actionText, actionCallback) {\r\n    const container = getOrCreateToastContainer();\r\n    \r\n    const toast = document.createElement('div');\r\n    toast.className = `toast toast-${type} transform translate-x-full transition-all duration-300`;\r\n    \r\n    const config = getToastConfig(type);\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${config.borderColor} p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                ${config.icon}\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900 mb-2\">${escapeHtml(message)}</p>\r\n                <button class=\"toast-action text-sm font-semibold text-indigo-600 hover:text-indigo-700 transition-colors\">\r\n                    ${escapeHtml(actionText)}\r\n                </button>\r\n            </div>\r\n            <button class=\"toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors\">\r\n                <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </button>\r\n        </div>\r\n    `;\r\n    \r\n    container.appendChild(toast);\r\n    \r\n    // Animation d'entr√©e\r\n    setTimeout(() => toast.classList.add('show'), 10);\r\n    \r\n    // √âv√©nements\r\n    toast.querySelector('.toast-close').addEventListener('click', () => closeToast(toast));\r\n    toast.querySelector('.toast-action').addEventListener('click', () => {\r\n        actionCallback();\r\n        closeToast(toast);\r\n    });\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Toast de chargement\r\n */\r\nexport function showLoadingToast(message) {\r\n    const container = getOrCreateToastContainer();\r\n    \r\n    const toast = document.createElement('div');\r\n    toast.className = 'toast toast-loading transform translate-x-full transition-all duration-300';\r\n    toast.setAttribute('data-loading', 'true');\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 border-indigo-500 p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                <div class=\"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600\"></div>\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900\">${escapeHtml(message)}</p>\r\n            </div>\r\n        </div>\r\n    `;\r\n    \r\n    container.appendChild(toast);\r\n    \r\n    // Animation d'entr√©e\r\n    setTimeout(() => toast.classList.add('show'), 10);\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Mettre √† jour un toast de chargement\r\n */\r\nexport function updateLoadingToast(toast, message, type = 'success') {\r\n    if (!toast || !toast.getAttribute('data-loading')) return;\r\n    \r\n    const config = getToastConfig(type);\r\n    // Mettre √† jour les classes pour refl√©ter le statut final (et √™tre d√©tectable par les tests)\r\n    const hadShow = toast.classList.contains('show');\r\n    toast.className = `toast toast-${type} transform transition-all duration-300${hadShow ? ' show' : ''}`;\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${config.borderColor} p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                ${config.icon}\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900\">${escapeHtml(message)}</p>\r\n            </div>\r\n            <button class=\"toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors\">\r\n                <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </button>\r\n        </div>\r\n    `;\r\n    \r\n    toast.removeAttribute('data-loading');\r\n    toast.querySelector('.toast-close').addEventListener('click', () => closeToast(toast));\r\n    \r\n    // Auto-fermeture apr√®s 3s\r\n    setTimeout(() => closeToast(toast), 3000);\r\n}\r\n\r\n/**\r\n * Fonctions helper pour faciliter l'utilisation\r\n */\r\nexport function showSuccessToast(message, duration = 3000) {\r\n    return showToast(message, 'success', duration);\r\n}\r\n\r\nexport function showErrorToast(message, duration = 3000) {\r\n    return showToast(message, 'error', duration);\r\n}\r\n\r\nexport function showWarningToast(message, duration = 3000) {\r\n    return showToast(message, 'warning', duration);\r\n}\r\n\r\nexport function showInfoToast(message, duration = 3000) {\r\n    return showToast(message, 'info', duration);\r\n}\r\n\r\n// CSS pour les animations (√† ajouter dans un <style> ou fichier CSS)\r\nexport const toastStyles = `\r\n    <style>\r\n        .toast.show {\r\n            transform: translateX(0) !important;\r\n        }\r\n        \r\n        @media (max-width: 640px) {\r\n            #toast-container {\r\n                left: 1rem;\r\n                right: 1rem;\r\n                top: 1rem;\r\n            }\r\n            \r\n            .toast > div {\r\n                min-width: auto !important;\r\n                width: 100%;\r\n            }\r\n        }\r\n    </style>\r\n`;\r\n\r\n// Injecter les styles au chargement\r\nif (typeof document !== 'undefined') {\r\n    const styleElement = document.createElement('style');\r\n    styleElement.textContent = `\r\n        .toast.show {\r\n            transform: translateX(0) !important;\r\n        }\r\n        \r\n        @media (max-width: 640px) {\r\n            #toast-container {\r\n                left: 1rem;\r\n                right: 1rem;\r\n                top: 1rem;\r\n            }\r\n            \r\n            .toast > div {\r\n                min-width: auto !important;\r\n                width: 100%;\r\n            }\r\n        }\r\n    `;\r\n    document.head.appendChild(styleElement);\r\n}\r\n","// Logger conditionnel - D√©sactive les logs en production\r\n// Garde seulement console.error actif pour d√©bogage critique\r\n\r\nconst isDevelopment = window.location.hostname === 'localhost' || \r\n                     window.location.hostname === '127.0.0.1' ||\r\n                     window.location.hostname === '192.168.1.1' ||\r\n                     window.location.port === '3200'; // Port Vite\r\n\r\n/**\r\n * Logger intelligent qui d√©sactive les logs en production\r\n * console.error reste toujours actif\r\n */\r\nexport const logger = {\r\n    /**\r\n     * Log d'information (d√©veloppement uniquement)\r\n     */\r\n    log: (...args) => {\r\n        if (isDevelopment) {\r\n            console.log(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Log d'erreur (toujours actif)\r\n     */\r\n    error: (...args) => {\r\n        console.error(...args);\r\n    },\r\n    \r\n    /**\r\n     * Log d'avertissement (d√©veloppement uniquement)\r\n     */\r\n    warn: (...args) => {\r\n        if (isDevelopment) {\r\n            console.warn(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Log d'information (d√©veloppement uniquement)\r\n     */\r\n    info: (...args) => {\r\n        if (isDevelopment) {\r\n            console.info(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Log de groupe (d√©veloppement uniquement)\r\n     */\r\n    group: (...args) => {\r\n        if (isDevelopment) {\r\n            console.group(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Fin de groupe (d√©veloppement uniquement)\r\n     */\r\n    groupEnd: () => {\r\n        if (isDevelopment) {\r\n            console.groupEnd();\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Table (d√©veloppement uniquement)\r\n     */\r\n    table: (...args) => {\r\n        if (isDevelopment) {\r\n            console.table(...args);\r\n        }\r\n    }\r\n};\r\n\r\n// Message de d√©marrage\r\nif (isDevelopment) {\r\n    console.log('üîß Mode d√©veloppement - Logs activ√©s');\r\n} else {\r\n    console.log('üöÄ Mode production - Logs d√©sactiv√©s (sauf erreurs)');\r\n}\r\n\r\nexport default logger;\r\n","// Import Firebase SDK modules\r\nimport { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';\r\nimport { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';\r\nimport { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\r\nimport { logger } from './logger.js';\r\n\r\n/**\r\n * Configuration Firebase - Avantage QUIZZ\r\n * \r\n * ‚ö†Ô∏è S√âCURIT√â - Cl√© API Firebase Expos√©e :\r\n * \r\n * La cl√© API Firebase est expos√©e dans le code source c√¥t√© client, ce qui est\r\n * NORMAL et ATTENDU pour Firebase. Firebase est con√ßu pour fonctionner avec\r\n * des cl√©s API publiques c√¥t√© client.\r\n * \r\n * PROTECTION :\r\n * 1. Les r√®gles Firestore (firestore.rules) prot√®gent les donn√©es c√¥t√© serveur\r\n * 2. Les restrictions d'API doivent √™tre configur√©es dans Firebase Console :\r\n *    - Aller dans Google Cloud Console > APIs & Services > Credentials\r\n *    - S√©lectionner la cl√© API\r\n *    - Ajouter des restrictions :\r\n *      * Application restrictions : HTTP referrers (web sites)\r\n *      * Limiter aux domaines autoris√©s uniquement\r\n * 3. Surveiller les quotas et co√ªts dans Firebase Console\r\n * 4. Configurer des alertes de co√ªts\r\n * \r\n * ‚ö†Ô∏è IMPORTANT : Ne JAMAIS utiliser cette cl√© pour des op√©rations sensibles\r\n * c√¥t√© serveur. Toute la s√©curit√© repose sur les r√®gles Firestore.\r\n */\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyD8w7Em_xdMGplscfGLrnM72vmm4z5ZTr0\",\r\n  authDomain: \"avantage-quizz.firebaseapp.com\",\r\n  databaseURL: \"https://avantage-quizz-default-rtdb.firebaseio.com\",\r\n  projectId: \"avantage-quizz\",\r\n  storageBucket: \"avantage-quizz.firebasestorage.app\",\r\n  messagingSenderId: \"919472910099\",\r\n  appId: \"1:919472910099:web:e17d4c1cdc7a04c6cab4e6\"\r\n};\r\n\r\n// Initialize Firebase\r\nconst app = initializeApp(firebaseConfig);\r\n\r\n// Initialize Firebase services\r\nexport const auth = getAuth(app);\r\nexport const db = getFirestore(app);\r\nexport const realtimeDB = getDatabase(app);\r\n\r\n// ‚úÖ CORRECTION SECTION 9 : Exporter app pour Analytics\r\nexport { app };\r\n\r\nlogger.log('‚úÖ Firebase initialis√© avec succ√®s');\r\nlogger.log('üìä Projet:', firebaseConfig.projectId);\r\nlogger.log('üîê Services: Authentication, Firestore, Realtime Database');\r\n","/**\r\n * Gestionnaire de rate limiting pour les appels Firestore (Section 4 - S√©curit√©)\r\n * \r\n * Ce module limite le nombre de requ√™tes Firestore par utilisateur pour pr√©venir\r\n * l'abus de quota et les attaques DoS.\r\n */\r\n\r\n/**\r\n * Classe pour limiter le taux de requ√™tes\r\n */\r\nclass RateLimiter {\r\n    constructor(maxRequests, windowMs) {\r\n        this.maxRequests = maxRequests;\r\n        this.windowMs = windowMs;\r\n        this.requests = [];\r\n    }\r\n    \r\n    /**\r\n     * V√©rifie si une nouvelle requ√™te est autoris√©e\r\n     * @throws {Error} Si la limite est d√©pass√©e\r\n     */\r\n    async check() {\r\n        const now = Date.now();\r\n        \r\n        // Nettoyer les requ√™tes anciennes (hors de la fen√™tre)\r\n        this.requests = this.requests.filter(time => now - time < this.windowMs);\r\n        \r\n        // V√©rifier si la limite est atteinte\r\n        if (this.requests.length >= this.maxRequests) {\r\n            const oldestRequest = this.requests[0];\r\n            const waitTime = this.windowMs - (now - oldestRequest);\r\n            throw new Error(`Trop de requ√™tes. Veuillez patienter ${Math.ceil(waitTime / 1000)} secondes.`);\r\n        }\r\n        \r\n        // Enregistrer la nouvelle requ√™te\r\n        this.requests.push(now);\r\n    }\r\n    \r\n    /**\r\n     * R√©initialise le compteur\r\n     */\r\n    reset() {\r\n        this.requests = [];\r\n    }\r\n    \r\n    /**\r\n     * Retourne le nombre de requ√™tes restantes dans la fen√™tre\r\n     */\r\n    getRemainingRequests() {\r\n        const now = Date.now();\r\n        this.requests = this.requests.filter(time => now - time < this.windowMs);\r\n        return Math.max(0, this.maxRequests - this.requests.length);\r\n    }\r\n}\r\n\r\n/**\r\n * Rate limiter pour les requ√™tes Firestore\r\n * Limite : 100 requ√™tes par minute par utilisateur\r\n */\r\nconst firestoreRateLimiter = new RateLimiter(100, 60000); // 100 req/min\r\n\r\n/**\r\n * Rate limiter pour les √©critures Firestore (plus restrictif)\r\n * Limite : 50 √©critures par minute par utilisateur\r\n */\r\nconst firestoreWriteRateLimiter = new RateLimiter(50, 60000); // 50 req/min\r\n\r\n/**\r\n * Wrapper pour prot√©ger les appels Firestore avec rate limiting\r\n * @param {Function} fn - Fonction async √† ex√©cuter\r\n * @param {Object} options - Options (isWrite: boolean)\r\n * @returns {Promise} R√©sultat de la fonction\r\n */\r\nexport async function safeFirestoreCall(fn, options = {}) {\r\n    const limiter = options.isWrite ? firestoreWriteRateLimiter : firestoreRateLimiter;\r\n    \r\n    try {\r\n        await limiter.check();\r\n        return await fn();\r\n    } catch (error) {\r\n        // Si c'est une erreur de rate limiting, logger et re-throw\r\n        if (error.message.includes('Trop de requ√™tes')) {\r\n            console.warn('‚ö†Ô∏è Rate limit atteint:', error.message);\r\n            throw error;\r\n        }\r\n        // Sinon, c'est une erreur de la fonction elle-m√™me\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Wrapper sp√©cialis√© pour les lectures Firestore\r\n */\r\nexport async function safeFirestoreRead(fn) {\r\n    return safeFirestoreCall(fn, { isWrite: false });\r\n}\r\n\r\n/**\r\n * Wrapper sp√©cialis√© pour les √©critures Firestore\r\n */\r\nexport async function safeFirestoreWrite(fn) {\r\n    return safeFirestoreCall(fn, { isWrite: true });\r\n}\r\n\r\n/**\r\n * R√©initialise les rate limiters (utile pour les tests)\r\n */\r\nexport function resetRateLimiters() {\r\n    firestoreRateLimiter.reset();\r\n    firestoreWriteRateLimiter.reset();\r\n}\r\n\r\nexport default {\r\n    safeFirestoreCall,\r\n    safeFirestoreRead,\r\n    safeFirestoreWrite,\r\n    resetRateLimiters\r\n};\r\n\r\n\r\n","/**\r\n * Gestionnaire Multi-Tenant - Isolation des donn√©es par client\r\n * \r\n * Ce module g√®re l'isolation des donn√©es entre diff√©rents clients.\r\n * Chaque utilisateur appartient √† un client, et toutes les donn√©es\r\n * sont filtr√©es par clientId pour garantir l'isolation.\r\n * \r\n * ‚úÖ CORRECTION SECTION 1 : Isolation Multi-Tenant\r\n */\r\n\r\nimport { auth } from './firebase-config.js';\r\nimport { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { db } from './firebase-config.js';\r\nimport { safeFirestoreRead } from './rate-limiter.js';\r\n\r\n// Client ID par d√©faut pour les utilisateurs existants (r√©tro-compatibilit√©)\r\nconst DEFAULT_CLIENT_ID = 'default';\r\n\r\n// Cache du clientId de l'utilisateur actuel\r\nlet currentUserClientId = null;\r\nlet clientIdCacheExpiry = 0;\r\nconst CLIENT_ID_CACHE_TTL = 5 * 60 * 1000; // 5 minutes\r\n\r\n/**\r\n * R√©cup√®re le clientId de l'utilisateur actuel\r\n * @param {Object} user - L'objet utilisateur Firebase (optionnel, utilise auth.currentUser si non fourni)\r\n * @returns {Promise<string>} Le clientId de l'utilisateur\r\n */\r\nexport async function getCurrentClientId(user = null) {\r\n    const currentUser = user || auth.currentUser;\r\n    if (!currentUser) {\r\n        console.warn('‚ö†Ô∏è Aucun utilisateur connect√©, utilisation du clientId par d√©faut');\r\n        return DEFAULT_CLIENT_ID;\r\n    }\r\n\r\n    // V√©rifier le cache\r\n    const now = Date.now();\r\n    if (currentUserClientId && now < clientIdCacheExpiry) {\r\n        return currentUserClientId;\r\n    }\r\n\r\n    try {\r\n        // R√©cup√©rer le profil utilisateur pour obtenir le clientId\r\n        const userRef = doc(db, 'users', currentUser.uid);\r\n        const userDoc = await safeFirestoreRead(() => getDoc(userRef));\r\n\r\n        if (userDoc.exists()) {\r\n            const userData = userDoc.data();\r\n            // Si le clientId n'existe pas, d√©terminer √† partir de l'email ou utiliser le d√©faut\r\n            let clientId = userData.clientId;\r\n            if (!clientId) {\r\n                clientId = determineClientIdFromEmail(currentUser.email);\r\n            }\r\n            \r\n            // Mettre en cache\r\n            currentUserClientId = clientId;\r\n            clientIdCacheExpiry = now + CLIENT_ID_CACHE_TTL;\r\n            \r\n            return clientId;\r\n        } else {\r\n            // Utilisateur n'existe pas encore, d√©terminer √† partir de l'email\r\n            const clientId = determineClientIdFromEmail(currentUser.email);\r\n            console.log('üîÑ Profil utilisateur non trouv√©, clientId d√©termin√© √† partir de l\\'email:', clientId);\r\n            return clientId;\r\n        }\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration clientId:', error);\r\n        // En cas d'erreur, d√©terminer √† partir de l'email ou utiliser le d√©faut\r\n        const clientId = determineClientIdFromEmail(currentUser.email);\r\n        return clientId;\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√®re le clientId de mani√®re synchrone (depuis le cache)\r\n * Retourne null si le cache n'est pas disponible\r\n * @returns {string|null} Le clientId ou null\r\n */\r\nexport function getCurrentClientIdSync() {\r\n    if (currentUserClientId && Date.now() < clientIdCacheExpiry) {\r\n        return currentUserClientId;\r\n    }\r\n    return null;\r\n}\r\n\r\n/**\r\n * R√©initialise le cache du clientId\r\n * Utile apr√®s une mise √† jour du profil utilisateur\r\n */\r\nexport function resetClientIdCache() {\r\n    currentUserClientId = null;\r\n    clientIdCacheExpiry = 0;\r\n}\r\n\r\n/**\r\n * D√©termine le clientId √† partir de l'email (pour migration future)\r\n * @param {string} email - L'email de l'utilisateur\r\n * @returns {string} Le clientId d√©termin√©\r\n */\r\nexport function determineClientIdFromEmail(email) {\r\n    if (!email) return DEFAULT_CLIENT_ID;\r\n    \r\n    // Exemple de logique : extraire le domaine\r\n    // Pour l'instant, tous les utilisateurs utilisent le clientId par d√©faut\r\n    // Cette fonction peut √™tre √©tendue pour supporter plusieurs clients\r\n    const domain = email.split('@')[1];\r\n    \r\n    // Mapping de domaines vers clientIds (√† configurer selon les besoins)\r\n    const domainToClientId = {\r\n        // Exemple:\r\n        // 'client1.com': 'client1',\r\n        // 'client2.com': 'client2',\r\n    };\r\n    \r\n    return domainToClientId[domain] || DEFAULT_CLIENT_ID;\r\n}\r\n\r\n/**\r\n * V√©rifie si l'utilisateur actuel appartient √† un client sp√©cifique\r\n * @param {string} clientId - Le clientId √† v√©rifier\r\n * @returns {Promise<boolean>} True si l'utilisateur appartient au client\r\n */\r\nexport async function belongsToClient(clientId) {\r\n    const currentClientId = await getCurrentClientId();\r\n    return currentClientId === clientId;\r\n}\r\n\r\n/**\r\n * Ajoute un filtre clientId √† une requ√™te Firestore\r\n * @param {Query} query - La requ√™te Firestore\r\n * @param {string} clientId - Le clientId √† filtrer (optionnel, utilise l'utilisateur actuel si non fourni)\r\n * @returns {Promise<Query>} La requ√™te avec le filtre clientId\r\n */\r\nexport async function addClientIdFilter(query, clientId = null) {\r\n    // Cette fonction sera utilis√©e dans les requ√™tes Firestore\r\n    // Pour l'instant, on retourne la requ√™te telle quelle\r\n    // L'impl√©mentation compl√®te n√©cessitera de modifier toutes les requ√™tes\r\n    // dans firestore-service.js pour ajouter where('clientId', '==', clientId)\r\n    \r\n    if (!clientId) {\r\n        clientId = await getCurrentClientId();\r\n    }\r\n    \r\n    // Note: Cette fonction n√©cessite d'√™tre appel√©e avec une requ√™te qui peut √™tre modifi√©e\r\n    // L'impl√©mentation compl√®te sera faite dans firestore-service.js\r\n    return query;\r\n}\r\n\r\nexport default {\r\n    getCurrentClientId,\r\n    getCurrentClientIdSync,\r\n    resetClientIdCache,\r\n    determineClientIdFromEmail,\r\n    belongsToClient,\r\n    addClientIdFilter,\r\n    DEFAULT_CLIENT_ID\r\n};\r\n\r\n","/**\r\n * Service de Cache Centralis√©\r\n * \r\n * ‚úÖ CORRECTION SECTION 5 : Refactorisation - Extraction du syst√®me de cache\r\n * ‚úÖ CORRECTION SECTION 6 : Am√©lioration - TTL configurable par type et invalidation intelligente\r\n * \r\n * G√®re le cache en m√©moire avec TTL configurable par type de donn√©es\r\n */\r\n\r\n// Cache en m√©moire pour limiter les lectures Firestore r√©p√©t√©es\r\nconst cacheStore = new Map();\r\n\r\n// ‚úÖ CORRECTION SECTION 6 : TTL configurable par type de donn√©es\r\nconst CACHE_CONFIG = {\r\n    users: 10 * 60 * 1000,        // 10 minutes\r\n    quizResults: 5 * 60 * 1000,  // 5 minutes\r\n    questions: 30 * 60 * 1000,     // 30 minutes\r\n    stats: 2 * 60 * 1000,          // 2 minutes\r\n    monthlyProgress: 10 * 60 * 1000, // 10 minutes\r\n    annualProgress: 15 * 60 * 1000,  // 15 minutes\r\n    default: 5 * 60 * 1000        // 5 minutes par d√©faut\r\n};\r\n\r\n/**\r\n * Obtenir le TTL pour un type de donn√©es\r\n * @param {string} dataType - Type de donn√©es (users, quizResults, questions, stats, etc.)\r\n * @returns {number} TTL en millisecondes\r\n */\r\nfunction getTTLForDataType(dataType) {\r\n    return CACHE_CONFIG[dataType] || CACHE_CONFIG.default;\r\n}\r\n\r\n/**\r\n * Construire une cl√© de cache √† partir de parties\r\n * @param {Array} parts - Parties de la cl√©\r\n * @returns {string} Cl√© de cache\r\n */\r\nexport function buildCacheKey(parts = []) {\r\n    return parts.filter(Boolean).join('::');\r\n}\r\n\r\n/**\r\n * Obtenir une valeur du cache\r\n * @param {string} key - Cl√© de cache\r\n * @returns {*} Valeur en cache ou null\r\n */\r\nexport function getCachedValue(key) {\r\n    const entry = cacheStore.get(key);\r\n    if (!entry) {\r\n        return null;\r\n    }\r\n    if (Date.now() > entry.expireAt) {\r\n        cacheStore.delete(key);\r\n        return null;\r\n    }\r\n    return entry.value;\r\n}\r\n\r\n/**\r\n * D√©finir une valeur dans le cache\r\n * @param {string} key - Cl√© de cache\r\n * @param {*} value - Valeur √† mettre en cache\r\n * @param {number|string} ttlMsOrType - Dur√©e de vie en millisecondes OU type de donn√©es pour TTL automatique\r\n */\r\nexport function setCachedValue(key, value, ttlMsOrType = CACHE_CONFIG.default) {\r\n    // ‚úÖ CORRECTION SECTION 6 : Si ttlMsOrType est une string, utiliser le TTL configur√© pour ce type\r\n    const ttlMs = typeof ttlMsOrType === 'string' \r\n        ? getTTLForDataType(ttlMsOrType)\r\n        : ttlMsOrType;\r\n    \r\n    cacheStore.set(key, {\r\n        value,\r\n        expireAt: Date.now() + ttlMs,\r\n        dataType: typeof ttlMsOrType === 'string' ? ttlMsOrType : null\r\n    });\r\n}\r\n\r\n/**\r\n * Invalider le cache par pr√©fixe\r\n * @param {string} prefix - Pr√©fixe des cl√©s √† invalider\r\n */\r\nexport function invalidateCache(prefix) {\r\n    cacheStore.forEach((_, key) => {\r\n        if (key.startsWith(prefix)) {\r\n            cacheStore.delete(key);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * ‚úÖ CORRECTION SECTION 6 : Invalidation intelligente par type de donn√©es\r\n * @param {string} dataType - Type de donn√©es √† invalider (users, quizResults, questions, stats, etc.)\r\n */\r\nexport function invalidateByDataType(dataType) {\r\n    cacheStore.forEach((entry, key) => {\r\n        if (entry.dataType === dataType || key.includes(dataType)) {\r\n            cacheStore.delete(key);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * ‚úÖ CORRECTION SECTION 6 : Invalidation intelligente bas√©e sur les √©v√©nements\r\n * @param {string} event - √âv√©nement d√©clench√© (quizCompleted, userUpdated, questionCreated, etc.)\r\n */\r\nexport function invalidateByEvent(event) {\r\n    const eventMap = {\r\n        'quizCompleted': ['quizResults', 'stats', 'monthlyProgress', 'annualProgress'],\r\n        'userUpdated': ['users', 'stats'], // ‚úÖ CORRECTION : Invalider aussi 'stats' pour userUpdated\r\n        'questionCreated': ['questions', 'questions-stats'],\r\n        'questionUpdated': ['questions', 'questions-stats'],\r\n        'questionDeleted': ['questions', 'questions-stats'],\r\n        'userRoleUpdated': ['users', 'stats'] // ‚úÖ CORRECTION : Invalider aussi 'stats' pour userRoleUpdated\r\n    };\r\n    \r\n    const typesToInvalidate = eventMap[event] || [];\r\n    typesToInvalidate.forEach(type => {\r\n        invalidateByDataType(type);\r\n    });\r\n}\r\n\r\n/**\r\n * Vider tout le cache\r\n */\r\nexport function clearCache() {\r\n    cacheStore.clear();\r\n}\r\n\r\n/**\r\n * Obtenir la taille du cache\r\n * @returns {number} Nombre d'entr√©es en cache\r\n */\r\nexport function getCacheSize() {\r\n    return cacheStore.size;\r\n}\r\n\r\n/**\r\n * ‚úÖ CORRECTION SECTION 6 : Obtenir les statistiques du cache\r\n * @returns {Object} Statistiques du cache\r\n */\r\nexport function getCacheStats() {\r\n    const stats = {\r\n        total: cacheStore.size, // ‚úÖ CORRECTION : Utiliser 'total' au lieu de 'totalEntries'\r\n        totalEntries: cacheStore.size, // Garder pour compatibilit√©\r\n        byDataType: {}, // ‚úÖ CORRECTION : Utiliser 'byDataType' au lieu de 'byType'\r\n        byType: {}, // Garder pour compatibilit√©\r\n        expiredEntries: 0\r\n    };\r\n    \r\n    const now = Date.now();\r\n    cacheStore.forEach((entry, key) => {\r\n        if (entry.expireAt < now) {\r\n            stats.expiredEntries++;\r\n        }\r\n        \r\n        const type = entry.dataType || 'unknown';\r\n        stats.byDataType[type] = (stats.byDataType[type] || 0) + 1;\r\n        stats.byType[type] = (stats.byType[type] || 0) + 1; // Garder pour compatibilit√©\r\n    });\r\n    \r\n    return stats;\r\n}\r\n\r\n/**\r\n * ‚úÖ CORRECTION SECTION 6 : Nettoyer les entr√©es expir√©es\r\n * @returns {number} Nombre d'entr√©es supprim√©es\r\n */\r\nexport function cleanExpiredEntries() {\r\n    const now = Date.now();\r\n    let cleaned = 0;\r\n    \r\n    cacheStore.forEach((entry, key) => {\r\n        if (entry.expireAt < now) {\r\n            cacheStore.delete(key);\r\n            cleaned++;\r\n        }\r\n    });\r\n    \r\n    return cleaned;\r\n}\r\n","/**\r\n * Service d'Audit et de Logs\r\n * \r\n * ‚úÖ CORRECTION SECTION 5 : Refactorisation - Extraction des fonctions d'audit\r\n */\r\n\r\nimport { db } from '../firebase-config.js';\r\nimport { collection, addDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { safeFirestoreWrite } from '../rate-limiter.js';\r\n\r\n/**\r\n * ADMIN: Cr√©er un log d'import\r\n */\r\nexport async function createImportLog(logData) {\r\n    try {\r\n        const log = {\r\n            ...logData,\r\n            importedAt: Timestamp.now()\r\n        };\r\n        \r\n        // ‚úÖ CORRECTION SECTION 4 : Rate limiting pour les √©critures\r\n        await safeFirestoreWrite(() => addDoc(collection(db, 'importLogs'), log));\r\n        console.log('Log import cree');\r\n    } catch (error) {\r\n        console.error('Erreur creation log import:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * ADMIN: Cr√©er un log d'audit\r\n */\r\nexport async function createAuditLog(logData) {\r\n    try {\r\n        const log = {\r\n            ...logData,\r\n            timestamp: Timestamp.now()\r\n        };\r\n        \r\n        // ‚úÖ CORRECTION SECTION 4 : Rate limiting pour les √©critures\r\n        await safeFirestoreWrite(() => addDoc(collection(db, 'auditLogs'), log));\r\n        console.log('Log audit cree');\r\n    } catch (error) {\r\n        console.error('Erreur creation log audit:', error);\r\n    }\r\n}\r\n\r\n","/**\r\n * Service de Gestion des Utilisateurs\r\n * \r\n * ‚úÖ CORRECTION SECTION 5 : Refactorisation - Extraction des fonctions utilisateurs\r\n */\r\n\r\nimport { db, auth } from '../firebase-config.js';\r\nimport { \r\n    collection, \r\n    doc, \r\n    getDoc, \r\n    getDocs, \r\n    setDoc, \r\n    updateDoc,\r\n    query,\r\n    where,\r\n    orderBy,\r\n    limit,\r\n    startAfter,\r\n    Timestamp,\r\n    runTransaction\r\n} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { safeFirestoreRead, safeFirestoreWrite } from '../rate-limiter.js';\r\nimport { getCurrentClientId } from '../client-manager.js';\r\nimport { buildCacheKey, getCachedValue, setCachedValue, invalidateCache } from './cache-service.js';\r\nimport { createAuditLog } from './audit-service.js';\r\n\r\nconst COLLECTIONS = {\r\n    users: 'users'\r\n};\r\n\r\n/**\r\n * Cr√©er ou mettre √† jour le profil utilisateur\r\n */\r\nexport async function createOrUpdateUser(user) {\r\n    try {\r\n        const userRef = doc(db, COLLECTIONS.users, user.uid);\r\n        // ‚úÖ CORRECTION SECTION 1 : R√©cup√©rer le clientId pour isolation multi-tenant\r\n        const clientId = await getCurrentClientId(user);\r\n        \r\n        const userData = {\r\n            uid: user.uid,\r\n            email: user.email,\r\n            displayName: user.displayName,\r\n            photoURL: user.photoURL,\r\n            lastLogin: Timestamp.now(),\r\n            updatedAt: Timestamp.now(),\r\n            clientId: clientId\r\n        };\r\n        \r\n        const userDoc = await safeFirestoreRead(() => getDoc(userRef));\r\n        \r\n        if (!userDoc.exists()) {\r\n            userData.createdAt = Timestamp.now();\r\n            userData.totalQuizzes = 0;\r\n            userData.averageScore = 0;\r\n            userData.currentStreak = 0;\r\n            userData.longestStreak = 0;\r\n            userData.role = 'user';\r\n            console.log('üë§ Cr√©ation du profil utilisateur:', user.email);\r\n        } else {\r\n            const existingData = userDoc.data();\r\n            if (!existingData.clientId) {\r\n                userData.clientId = clientId;\r\n                console.log('üîÑ Migration: Ajout du clientId au profil utilisateur existant');\r\n            }\r\n        }\r\n        \r\n        await safeFirestoreWrite(() => setDoc(userRef, userData, { merge: true }));\r\n        console.log('‚úÖ Profil utilisateur sauvegard√©');\r\n        return userData;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur cr√©ation utilisateur:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√©rer le profil utilisateur\r\n */\r\nexport async function getUserProfile(uid) {\r\n    try {\r\n        const userRef = doc(db, COLLECTIONS.users, uid);\r\n        const userDoc = await safeFirestoreRead(() => getDoc(userRef));\r\n        \r\n        if (userDoc.exists()) {\r\n            return userDoc.data();\r\n        }\r\n        return null;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration profil:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Mettre √† jour les statistiques utilisateur\r\n * Note: Cette fonction est utilis√©e par quiz-service.js, donc elle doit √™tre export√©e\r\n */\r\nexport async function updateUserStats(uid, newScore) {\r\n    if (isNaN(newScore) || newScore < 0 || newScore > 100) {\r\n        console.error('‚ùå Score invalide pour mise √† jour des stats:', newScore);\r\n        throw new Error(`Score invalide: ${newScore}. Doit √™tre entre 0 et 100.`);\r\n    }\r\n    \r\n    try {\r\n        await runTransaction(db, async (transaction) => {\r\n            const userRef = doc(db, COLLECTIONS.users, uid);\r\n            const userDoc = await transaction.get(userRef);\r\n            \r\n            if (!userDoc.exists()) {\r\n                throw new Error('Utilisateur non trouv√©');\r\n            }\r\n            \r\n            const userData = userDoc.data();\r\n            const totalQuizzes = (userData.totalQuizzes || 0) + 1;\r\n            const currentAverage = userData.averageScore || 0;\r\n            const newAverage = ((currentAverage * (totalQuizzes - 1)) + newScore) / totalQuizzes;\r\n            \r\n            const roundedAverage = Math.round(newAverage);\r\n            if (isNaN(roundedAverage) || roundedAverage < 0 || roundedAverage > 100) {\r\n                console.error('‚ùå Moyenne calcul√©e invalide:', roundedAverage);\r\n                throw new Error(`Erreur de calcul de la moyenne: ${roundedAverage}`);\r\n            }\r\n            \r\n            transaction.update(userRef, {\r\n                totalQuizzes: totalQuizzes,\r\n                averageScore: roundedAverage,\r\n                lastQuizDate: Timestamp.now(),\r\n                updatedAt: Timestamp.now()\r\n            });\r\n        });\r\n        \r\n        console.log('üìä Statistiques mises √† jour');\r\n        invalidateCache('users');\r\n        invalidateCache('users-stats');\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur mise √† jour statistiques:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Calculer et mettre √† jour la s√©rie (streak)\r\n */\r\nexport async function updateStreak(uid) {\r\n    // Import dynamique pour √©viter d√©pendance circulaire\r\n    const { getUserQuizResults } = await import('./quiz-service.js');\r\n    \r\n    try {\r\n        const results = await getUserQuizResults(uid, 12);\r\n        \r\n        let currentStreak = 0;\r\n        const monthsSet = new Set();\r\n        \r\n        for (const result of results) {\r\n            if (result.score >= 60) {\r\n                monthsSet.add(result.month);\r\n            }\r\n        }\r\n        \r\n        const months = Array.from(monthsSet).sort().reverse();\r\n        for (let i = 0; i < months.length; i++) {\r\n            currentStreak++;\r\n            if (i < months.length - 1) {\r\n                // Logique de v√©rification de cons√©cutivit√© simplifi√©e\r\n            } else {\r\n                break;\r\n            }\r\n        }\r\n        \r\n        const userRef = doc(db, COLLECTIONS.users, uid);\r\n        const userDoc = await safeFirestoreRead(() => getDoc(userRef));\r\n        \r\n        if (userDoc.exists()) {\r\n            const userData = userDoc.data();\r\n            const longestStreak = Math.max(currentStreak, userData.longestStreak || 0);\r\n            \r\n            await safeFirestoreWrite(() => updateDoc(userRef, {\r\n                currentStreak: currentStreak,\r\n                longestStreak: longestStreak,\r\n                updatedAt: Timestamp.now()\r\n            }));\r\n            \r\n            console.log(`üî• S√©rie mise √† jour: ${currentStreak} mois`);\r\n            invalidateCache('users');\r\n            invalidateCache('users-stats');\r\n        }\r\n        \r\n        return currentStreak;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur mise √† jour s√©rie:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√©rer le classement g√©n√©ral\r\n */\r\nexport async function getLeaderboard(limitCount = 10) {\r\n    try {\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const q = query(\r\n            collection(db, COLLECTIONS.users),\r\n            where('clientId', '==', clientId),\r\n            orderBy('averageScore', 'desc'),\r\n            orderBy('totalQuizzes', 'desc'),\r\n            limit(limitCount)\r\n        );\r\n        \r\n        const querySnapshot = await safeFirestoreRead(() => getDocs(q));\r\n        const leaderboard = [];\r\n        \r\n        querySnapshot.forEach((doc) => {\r\n            const data = doc.data();\r\n            leaderboard.push({\r\n                uid: doc.id,\r\n                displayName: data.displayName,\r\n                photoURL: data.photoURL,\r\n                averageScore: data.averageScore,\r\n                totalQuizzes: data.totalQuizzes,\r\n                currentStreak: data.currentStreak\r\n            });\r\n        });\r\n        \r\n        console.log('üèÜ Classement charg√©');\r\n        return leaderboard;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration classement:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * V√©rifier si l'utilisateur actuel est admin\r\n */\r\nexport async function isCurrentUserAdmin() {\r\n    try {\r\n        const user = auth.currentUser;\r\n        if (!user) return false;\r\n        \r\n        const userProfile = await getUserProfile(user.uid);\r\n        return userProfile?.role === 'admin';\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur v√©rification admin:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * ADMIN: R√©cup√©rer tous les utilisateurs (sans pagination - pour compatibilit√©)\r\n */\r\nexport async function getAllUsers(filters = {}) {\r\n    const cacheKey = buildCacheKey(['users', JSON.stringify(filters || {})]);\r\n    const cached = getCachedValue(cacheKey);\r\n    if (cached) {\r\n        return cached;\r\n    }\r\n\r\n    try {\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const constraints = [\r\n            where('clientId', '==', clientId)\r\n        ];\r\n        \r\n        if (filters.role) {\r\n            constraints.push(where('role', '==', filters.role));\r\n        }\r\n        \r\n        constraints.push(orderBy('createdAt', 'desc'));\r\n        \r\n        const q = query(collection(db, COLLECTIONS.users), ...constraints);\r\n        \r\n        const querySnapshot = await safeFirestoreRead(() => getDocs(q));\r\n        const users = [];\r\n        \r\n        querySnapshot.forEach((doc) => {\r\n            users.push({ id: doc.id, ...doc.data() });\r\n        });\r\n        \r\n        console.log(`üë• ${users.length} utilisateurs charg√©s`);\r\n        setCachedValue(cacheKey, users, 'users');\r\n        return users;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration utilisateurs:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * ‚úÖ CORRECTION SECTION 7 : Pagination - R√©cup√©rer les utilisateurs avec pagination\r\n * @param {Object} filters - Filtres optionnels\r\n * @param {number} pageSize - Nombre d'√©l√©ments par page (d√©faut: 20)\r\n * @param {QueryDocumentSnapshot|null} lastDoc - Document de d√©part pour la pagination\r\n * @returns {Promise<{users: Array, lastDoc: QueryDocumentSnapshot|null, hasMore: boolean}>}\r\n */\r\nexport async function getAllUsersPaginated(filters = {}, pageSize = 20, lastDoc = null) {\r\n    try {\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const constraints = [\r\n            where('clientId', '==', clientId)\r\n        ];\r\n        \r\n        if (filters.role) {\r\n            constraints.push(where('role', '==', filters.role));\r\n        }\r\n        \r\n        constraints.push(orderBy('createdAt', 'desc'));\r\n        constraints.push(limit(pageSize + 1)); // +1 pour d√©tecter s'il y a plus de r√©sultats\r\n        \r\n        let q = query(collection(db, COLLECTIONS.users), ...constraints);\r\n        \r\n        // Si on a un document de d√©part, commencer apr√®s\r\n        if (lastDoc) {\r\n            q = query(q, startAfter(lastDoc));\r\n        }\r\n        \r\n        const querySnapshot = await safeFirestoreRead(() => getDocs(q));\r\n        const users = [];\r\n        let newLastDoc = null;\r\n        let hasMore = false;\r\n        \r\n        querySnapshot.forEach((doc, index) => {\r\n            if (index < pageSize) {\r\n                users.push({ id: doc.id, ...doc.data() });\r\n            } else {\r\n                // On a r√©cup√©r√© un √©l√©ment de plus, donc il y a plus de r√©sultats\r\n                hasMore = true;\r\n            }\r\n        });\r\n        \r\n        // Le dernier document de cette page devient le curseur pour la suivante\r\n        if (querySnapshot.docs.length > 0 && users.length === pageSize) {\r\n            newLastDoc = querySnapshot.docs[pageSize - 1];\r\n        }\r\n        \r\n        console.log(`üë• ${users.length} utilisateurs charg√©s (pagination)`);\r\n        return {\r\n            users,\r\n            lastDoc: newLastDoc,\r\n            hasMore\r\n        };\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration utilisateurs pagin√©s:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * ADMIN: Mettre √† jour le r√¥le d'un utilisateur\r\n */\r\nexport async function updateUserRole(userId, newRole) {\r\n    try {\r\n        const user = auth.currentUser;\r\n        if (!user) throw new Error('Utilisateur non connect√©');\r\n        \r\n        if (!['user', 'admin'].includes(newRole)) {\r\n            throw new Error('R√¥le invalide - doit √™tre \"user\" ou \"admin\"');\r\n        }\r\n        \r\n        const userRef = doc(db, COLLECTIONS.users, userId);\r\n        \r\n        await safeFirestoreWrite(() => updateDoc(userRef, {\r\n            role: newRole,\r\n            updatedAt: Timestamp.now()\r\n        }));\r\n        \r\n        console.log(`‚úÖ R√¥le mis √† jour pour ${userId}: ${newRole}`);\r\n        \r\n        await createAuditLog({\r\n            action: 'UPDATE_USER_ROLE',\r\n            targetUserId: userId,\r\n            newRole: newRole,\r\n            adminId: user.uid,\r\n            adminEmail: user.email\r\n        });\r\n\r\n        invalidateCache('users');\r\n        invalidateCache('users-stats');\r\n        \r\n        return true;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur mise √† jour r√¥le:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * ADMIN: R√©cup√©rer les statistiques des utilisateurs\r\n */\r\nexport async function getUsersStats() {\r\n    const clientId = await getCurrentClientId();\r\n    const cacheKey = buildCacheKey(['users-stats', clientId]);\r\n    const cached = getCachedValue(cacheKey);\r\n    if (cached) {\r\n        return cached;\r\n    }\r\n\r\n    try {\r\n        const users = await getAllUsers();\r\n        \r\n        const stats = {\r\n            total: users.length,\r\n            admins: users.filter(u => u.role === 'admin').length,\r\n            regularUsers: users.filter(u => u.role !== 'admin').length,\r\n            activeLastWeek: 0,\r\n            averageScore: 0,\r\n            totalQuizzes: 0\r\n        };\r\n        \r\n        const oneWeekAgo = new Date();\r\n        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);\r\n        \r\n        users.forEach(u => {\r\n            if (u.lastLogin && u.lastLogin.toDate() > oneWeekAgo) {\r\n                stats.activeLastWeek++;\r\n            }\r\n            stats.totalQuizzes += (u.totalQuizzes || 0);\r\n            stats.averageScore += (u.averageScore || 0);\r\n        });\r\n        \r\n        stats.averageScore = stats.total > 0 ? Math.round(stats.averageScore / stats.total) : 0;\r\n        \r\n        setCachedValue(cacheKey, stats, 'stats');\r\n        return stats;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur statistiques utilisateurs:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n","// Module Authentication - Gestion de l'authentification Google\r\nimport { auth } from './firebase-config.js';\r\nimport { \r\n    GoogleAuthProvider, \r\n    signInWithPopup, \r\n    signOut, \r\n    onAuthStateChanged \r\n} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';\r\nimport { createOrUpdateUser } from './firestore-service.js';\r\n\r\nconst provider = new GoogleAuthProvider();\r\nprovider.setCustomParameters({\r\n    prompt: 'select_account'\r\n});\r\n\r\n// Prevent multiple simultaneous sign-in attempts\r\nlet signInInProgress = false;\r\n\r\n// Sign in with Google\r\nexport async function signInWithGoogle() {\r\n    // Prevent multiple popup windows\r\n    if (signInInProgress) {\r\n        console.warn('‚ö†Ô∏è Connexion d√©j√† en cours, veuillez patienter...');\r\n        return null;\r\n    }\r\n    \r\n    signInInProgress = true;\r\n    \r\n    try {\r\n        console.log('üîê Tentative de connexion Google...');\r\n        const result = await signInWithPopup(auth, provider);\r\n        const user = result.user;\r\n        \r\n        console.log('‚úÖ Authentification r√©ussie:', user.displayName);\r\n        console.log('üìß Email:', user.email);\r\n        \r\n        // Cr√©er ou mettre √† jour le profil utilisateur dans Firestore\r\n        await createOrUpdateUser(user);\r\n        \r\n        return user;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur de connexion:', error);\r\n        \r\n        // Messages d'erreur personnalis√©s\r\n        let errorMessage = 'Erreur lors de la connexion. Veuillez r√©essayer.';\r\n        \r\n        if (error.code === 'auth/popup-closed-by-user') {\r\n            errorMessage = 'Connexion annul√©e. Veuillez r√©essayer.';\r\n        } else if (error.code === 'auth/popup-blocked') {\r\n            errorMessage = 'Pop-up bloqu√©e. Autorisez les pop-ups pour ce site.';\r\n        } else if (error.code === 'auth/unauthorized-domain') {\r\n            errorMessage = 'Domaine non autoris√©. Configurez Firebase Authentication.';\r\n        } else if (error.code === 'auth/cancelled-popup-request') {\r\n            // Silent error - user clicked too fast\r\n            console.warn('‚ö†Ô∏è Requ√™te de popup annul√©e (clic multiple)');\r\n            return null;\r\n        }\r\n        \r\n        if (error.code !== 'auth/cancelled-popup-request') {\r\n            alert(errorMessage);\r\n        }\r\n        throw error;\r\n    } finally {\r\n        // Reset flag after 2 seconds to allow retry\r\n        setTimeout(() => {\r\n            signInInProgress = false;\r\n        }, 2000);\r\n    }\r\n}\r\n\r\n// Sign out\r\nexport async function signOutUser() {\r\n    try {\r\n        const userName = auth.currentUser?.displayName || 'Utilisateur';\r\n        await signOut(auth);\r\n        console.log('‚úÖ D√©connexion r√©ussie:', userName);\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur de d√©connexion:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n// Listen for auth state changes\r\nexport function onAuthChange(callback) {\r\n    return onAuthStateChanged(auth, (user) => {\r\n        if (user) {\r\n            console.log('üë§ Utilisateur connect√©:', user.email);\r\n        } else {\r\n            console.log('üë§ Aucun utilisateur connect√©');\r\n        }\r\n        callback(user);\r\n    });\r\n}\r\n\r\n// Get current user\r\nexport function getCurrentUser() {\r\n    return auth.currentUser;\r\n}\r\n\r\n// Check if user is authenticated\r\nexport function isAuthenticated() {\r\n    return auth.currentUser !== null;\r\n}\r\n\r\n// Show admin UI elements if user is admin\r\nexport async function showAdminUIIfAdmin(userProfile) {\r\n    if (!userProfile) return;\r\n    \r\n    const isAdmin = userProfile.role === 'admin';\r\n    \r\n    if (isAdmin) {\r\n        // Afficher l'onglet Admin dans la navigation\r\n        const navAdminItem = document.getElementById('nav-admin-item');\r\n        if (navAdminItem) {\r\n            navAdminItem.classList.remove('hidden');\r\n        }\r\n        \r\n        // Afficher le badge Admin\r\n        const adminBadgeNav = document.getElementById('admin-badge-nav');\r\n        if (adminBadgeNav) {\r\n            adminBadgeNav.classList.remove('hidden');\r\n        }\r\n        \r\n        console.log('Admin UI elements shown');\r\n    }\r\n}\r\n\r\n// ============================================\r\n// MODE D√âMO\r\n// ============================================\r\n\r\n/**\r\n * Activer le mode d√©mo sans authentification Firebase\r\n * Cr√©e un utilisateur fictif en localStorage\r\n */\r\nexport async function activateDemoMode() {\r\n    try {\r\n        console.log('üé≠ Activation du mode d√©mo...');\r\n        \r\n        // Cr√©er un utilisateur d√©mo\r\n        const demoUser = {\r\n            uid: 'demo-user-' + Date.now(),\r\n            email: 'demo@avantage-quizz.local',\r\n            displayName: 'Utilisateur D√©mo',\r\n            photoURL: null,\r\n            isDemo: true,\r\n            role: 'admin', // Admin par d√©faut pour tester toutes les fonctionnalit√©s\r\n            createdAt: new Date().toISOString()\r\n        };\r\n        \r\n        // Stocker en localStorage\r\n        localStorage.setItem('demoUser', JSON.stringify(demoUser));\r\n        localStorage.setItem('authMode', 'demo');\r\n        \r\n        console.log('‚úÖ Mode d√©mo activ√©:', demoUser.displayName);\r\n        console.log('üìß Email:', demoUser.email);\r\n        console.log('üëë R√¥le:', demoUser.role);\r\n        \r\n        return demoUser;\r\n        \r\n    } catch (error) {\r\n        console.error('‚ùå Erreur activation mode d√©mo:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * D√©sactiver le mode d√©mo\r\n */\r\nexport function deactivateDemoMode() {\r\n    localStorage.removeItem('demoUser');\r\n    localStorage.removeItem('authMode');\r\n    console.log('‚úÖ Mode d√©mo d√©sactiv√©');\r\n}\r\n\r\n/**\r\n * V√©rifier si le mode d√©mo est actif\r\n */\r\nexport function isDemoMode() {\r\n    return localStorage.getItem('authMode') === 'demo';\r\n}\r\n\r\n/**\r\n * R√©cup√©rer l'utilisateur d√©mo depuis localStorage\r\n */\r\nexport function getDemoUser() {\r\n    try {\r\n        const demoUserJson = localStorage.getItem('demoUser');\r\n        if (!demoUserJson) return null;\r\n        \r\n        const demoUser = JSON.parse(demoUserJson);\r\n        return demoUser;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur lecture utilisateur d√©mo:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Obtenir l'utilisateur actuel (Firebase ou D√©mo)\r\n */\r\nexport function getCurrentUserUnified() {\r\n    // Mode d√©mo\r\n    if (isDemoMode()) {\r\n        return getDemoUser();\r\n    }\r\n    \r\n    // Mode Firebase normal\r\n    return getCurrentUser();\r\n}\r\n"],"file":"auth-DPcck7WP.js"}