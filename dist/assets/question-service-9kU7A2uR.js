import{m as p,s as y,l as A,o as g,p as l,q,r as d,t as E,k as f,n as u,j as b}from"./auth-NyiblVhF.js";import{collection as I,where as a,orderBy as C,query as Q,getDocs as x,Timestamp as w,addDoc as L,doc as S,getDoc as O,deleteDoc as M}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";const h={questions:"questions"};async function N(e={}){const t=A(["questions",JSON.stringify(e||{})]),n=p(t);if(n)return n;try{const o=await g();let r=I(l,h.questions);const s=[a("clientId","==",o)];e.module&&s.push(a("module","==",e.module)),e.month&&s.push(a("month","==",e.month)),e.year&&s.push(a("year","==",e.year)),s.push(C("createdAt","desc")),r=Q(r,...s);const i=await q(()=>x(r)),c=[];return i.forEach(m=>{c.push({id:m.id,...m.data()})}),console.log(`üìö ${c.length} questions charg√©es`),y(t,c,"questions"),c}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration questions:",o),o}}async function U(e){try{const t=d.currentUser;if(!t)throw new Error("Utilisateur non connect√©");if(!e.question||e.question.length<10)throw new Error("La question doit contenir au moins 10 caract√®res");if(!e.options||e.options.length!==4)throw new Error("La question doit avoir exactement 4 options");if(e.correctAnswer===void 0||e.correctAnswer<0||e.correctAnswer>3)throw new Error("La r√©ponse correcte doit √™tre entre 0 et 3");if(!e.explanation||e.explanation.length<20)throw new Error("L'explication doit contenir au moins 20 caract√®res");if(!["auto","loisir","vr","tracteur"].includes(e.module))throw new Error("Module invalide");if(!e.month||e.month<1||e.month>12)throw new Error("Mois invalide");const n=await g(),o={question:e.question.trim(),options:e.options.map(s=>s.trim()),correctAnswer:parseInt(e.correctAnswer),explanation:e.explanation.trim(),module:e.module,month:parseInt(e.month),year:e.year||new Date().getFullYear(),clientId:n,createdAt:w.now(),createdBy:t.uid,updatedAt:w.now()},r=await E(()=>L(I(l,h.questions),o));return console.log("‚úÖ Question cr√©√©e:",r.id),await f({action:"CREATE_QUESTION",questionId:r.id,adminId:t.uid,adminEmail:t.email}),u("questions"),u("questions-stats"),r.id}catch(t){throw console.error("‚ùå Erreur cr√©ation question:",t),t}}async function F(e){try{const t=d.currentUser;if(!t)throw new Error("Utilisateur non connect√©");const n=S(l,h.questions,e),r=(await q(()=>O(n))).data();return await E(()=>M(n)),console.log("üóëÔ∏è Question supprim√©e:",e),await f({action:"DELETE_QUESTION",questionId:e,adminId:t.uid,adminEmail:t.email,deletedData:r}),u("questions"),u("questions-stats"),!0}catch(t){throw console.error("‚ùå Erreur suppression question:",t),t}}async function J(e){try{const t=d.currentUser;if(!t)throw new Error("Utilisateur non connect√©");if(!e.module||!e.month||!e.year||!e.questions)throw new Error("Format JSON invalide - champs obligatoires manquants");if(!Array.isArray(e.questions)||e.questions.length===0)throw new Error("Le fichier JSON doit contenir au moins une question");const n=[],o=[];for(let r=0;r<e.questions.length;r++){const s=e.questions[r];try{const i={question:s.question,options:s.options,correctAnswer:s.correctAnswer,explanation:s.explanation,module:e.module,month:e.month,year:e.year},c=await U(i);n.push(c)}catch(i){o.push({index:r,error:i.message}),console.error(`‚ùå Erreur question ${r+1}:`,i.message)}}return await b({importedBy:t.uid,module:e.module,month:e.month,year:e.year,totalQuestions:e.questions.length,successCount:n.length,errorCount:o.length,status:o.length===0?"success":"partial"}),console.log(`‚úÖ Import termin√©: ${n.length}/${e.questions.length} questions import√©es`),u("questions"),u("questions-stats"),{success:n.length,total:e.questions.length,errors:o,ids:n}}catch(t){throw console.error("‚ùå Erreur import JSON:",t),t}}async function R(){const e="questions-stats",t=p(e);if(t)return t;try{const n=await N(),o={total:n.length,byModule:{},byMonth:{},byYear:{}};return n.forEach(r=>{o.byModule[r.module]=(o.byModule[r.module]||0)+1,o.byMonth[r.month]=(o.byMonth[r.month]||0)+1,o.byYear[r.year]=(o.byYear[r.year]||0)+1}),y(e,o,"stats"),o}catch(n){throw console.error("‚ùå Erreur statistiques questions:",n),n}}export{R as a,U as c,F as d,N as g,J as i};
//# sourceMappingURL=question-service-9kU7A2uR.js.map
