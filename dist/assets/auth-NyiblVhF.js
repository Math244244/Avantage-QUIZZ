import{initializeApp as ne}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as ie,GoogleAuthProvider as ae,signInWithPopup as ce,signOut as le,onAuthStateChanged as ue}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getFirestore as de,doc as b,getDoc as U,Timestamp as f,addDoc as O,collection as L,runTransaction as fe,setDoc as me,query as S,where as x,orderBy as k,limit as F,getDocs as N,startAfter as he,updateDoc as Q}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{getDatabase as ge}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();function pe(e){if(!e||typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function P(e){return pe(e)}function I(e,t="info",r=3e3){const o=W(),s=we(e,t);return o.appendChild(s),setTimeout(()=>s.classList.add("show"),10),r>0&&setTimeout(()=>{z(s)},r),s}function W(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.className="fixed top-4 right-4 z-50 flex flex-col gap-3",document.body.appendChild(e)),e}function we(e,t){const r=document.createElement("div");r.className=`toast toast-${t} transform translate-x-full transition-all duration-300`,t==="error"?(r.setAttribute("role","alert"),r.setAttribute("aria-live","assertive")):(r.setAttribute("role","status"),r.setAttribute("aria-live","polite")),r.setAttribute("aria-atomic","true");const o=H(t);return r.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${o.borderColor} p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                ${o.icon}
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${P(e)}</p>
            </div>
            <button class="toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors" aria-label="Fermer la notification">
                <svg aria-hidden="true" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `,r.querySelector(".toast-close").addEventListener("click",()=>z(r)),r}function H(e){const t={success:{borderColor:"border-green-500",icon:`<div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>`},error:{borderColor:"border-red-500",icon:`<div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>`},warning:{borderColor:"border-yellow-500",icon:`<div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>`},info:{borderColor:"border-blue-500",icon:`<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>`}};return t[e]||t.info}function z(e){e.classList.remove("show"),e.classList.add("translate-x-full"),setTimeout(()=>{e.remove();const t=document.getElementById("toast-container");t&&t.children.length===0&&t.remove()},300)}const $e={success:(e,t)=>I(e,"success",t),error:(e,t)=>I(e,"error",t),warning:(e,t)=>I(e,"warning",t),info:(e,t)=>I(e,"info",t)};function Be(e){const t=W(),r=document.createElement("div");return r.className="toast toast-loading transform translate-x-full transition-all duration-300",r.setAttribute("data-loading","true"),r.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 border-indigo-500 p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${P(e)}</p>
            </div>
        </div>
    `,t.appendChild(r),setTimeout(()=>r.classList.add("show"),10),r}function Oe(e,t,r="success"){if(!e||!e.getAttribute("data-loading"))return;const o=H(r),s=e.classList.contains("show");e.className=`toast toast-${r} transform transition-all duration-300${s?" show":""}`,e.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${o.borderColor} p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                ${o.icon}
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${P(t)}</p>
            </div>
            <button class="toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `,e.removeAttribute("data-loading"),e.querySelector(".toast-close").addEventListener("click",()=>z(e)),setTimeout(()=>z(e),3e3)}if(typeof document<"u"){const e=document.createElement("style");e.textContent=`
        .toast.show {
            transform: translateX(0) !important;
        }
        
        @media (max-width: 640px) {
            #toast-container {
                left: 1rem;
                right: 1rem;
                top: 1rem;
            }
            
            .toast > div {
                min-width: auto !important;
                width: 100%;
            }
        }
    `,document.head.appendChild(e)}const w=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="192.168.1.1"||window.location.port==="3200",_={log:(...e)=>{w&&console.log(...e)},error:(...e)=>{console.error(...e)},warn:(...e)=>{w&&console.warn(...e)},info:(...e)=>{w&&console.info(...e)},group:(...e)=>{w&&console.group(...e)},groupEnd:()=>{w&&console.groupEnd()},table:(...e)=>{w&&console.table(...e)}};console.log(w?"üîß Mode d√©veloppement - Logs activ√©s":"üöÄ Mode production - Logs d√©sactiv√©s (sauf erreurs)");const G={apiKey:"AIzaSyD8w7Em_xdMGplscfGLrnM72vmm4z5ZTr0",authDomain:"avantage-quizz.firebaseapp.com",databaseURL:"https://avantage-quizz-default-rtdb.firebaseio.com",projectId:"avantage-quizz",storageBucket:"avantage-quizz.firebasestorage.app",messagingSenderId:"919472910099",appId:"1:919472910099:web:e17d4c1cdc7a04c6cab4e6"},D=ne(G),m=ie(D),u=de(D);ge(D);_.log("‚úÖ Firebase initialis√© avec succ√®s");_.log("üìä Projet:",G.projectId);_.log("üîê Services: Authentication, Firestore, Realtime Database");const Fe=Object.freeze(Object.defineProperty({__proto__:null,app:D,auth:m,db:u},Symbol.toStringTag,{value:"Module"})),ve="modulepreload",ye=function(e){return"/"+e},$={},be=function(t,r,o){let s=Promise.resolve();if(r&&r.length>0){let l=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),a=n?.nonce||n?.getAttribute("nonce");s=l(r.map(c=>{if(c=ye(c),c in $)return;$[c]=!0;const d=c.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":ve,d||(h.as="script"),h.crossOrigin="",h.href=c,a&&h.setAttribute("nonce",a),document.head.appendChild(h),d)return new Promise((oe,se)=>{h.addEventListener("load",oe),h.addEventListener("error",()=>se(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return s.then(n=>{for(const a of n||[])a.status==="rejected"&&i(a.reason);return t().catch(i)})};class K{constructor(t,r){this.maxRequests=t,this.windowMs=r,this.requests=[]}async check(){const t=Date.now();if(this.requests=this.requests.filter(r=>t-r<this.windowMs),this.requests.length>=this.maxRequests){const r=this.requests[0],o=this.windowMs-(t-r);throw new Error(`Trop de requ√™tes. Veuillez patienter ${Math.ceil(o/1e3)} secondes.`)}this.requests.push(t)}reset(){this.requests=[]}getRemainingRequests(){const t=Date.now();return this.requests=this.requests.filter(r=>t-r<this.windowMs),Math.max(0,this.maxRequests-this.requests.length)}}const xe=new K(100,6e4),Ee=new K(50,6e4);async function V(e,t={}){const r=t.isWrite?Ee:xe;try{return await r.check(),await e()}catch(o){throw o.message.includes("Trop de requ√™tes")&&console.warn("‚ö†Ô∏è Rate limit atteint:",o.message),o}}async function v(e){return V(e,{isWrite:!1})}async function C(e){return V(e,{isWrite:!0})}const R="default";let q=null,B=0;const Le=300*1e3;async function A(e=null){const t=e||m.currentUser;if(!t)return console.warn("‚ö†Ô∏è Aucun utilisateur connect√©, utilisation du clientId par d√©faut"),R;const r=Date.now();if(q&&r<B)return q;try{const o=b(u,"users",t.uid),s=await v(()=>U(o));if(s.exists()){let n=s.data().clientId;return n||(n=T(t.email)),q=n,B=r+Le,n}else{const i=T(t.email);return console.log("üîÑ Profil utilisateur non trouv√©, clientId d√©termin√© √† partir de l'email:",i),i}}catch(o){return console.error("‚ùå Erreur r√©cup√©ration clientId:",o),T(t.email)}}function T(e){if(!e)return R;const t=e.split("@")[1];return{}[t]||R}const E=new Map,j={users:600*1e3,quizResults:300*1e3,questions:1800*1e3,stats:120*1e3,monthlyProgress:600*1e3,annualProgress:900*1e3,default:300*1e3};function Ce(e){return j[e]||j.default}function J(e=[]){return e.filter(Boolean).join("::")}function X(e){const t=E.get(e);return t?Date.now()>t.expireAt?(E.delete(e),null):t.value:null}function Z(e,t,r=j.default){const o=typeof r=="string"?Ce(r):r;E.set(e,{value:t,expireAt:Date.now()+o,dataType:typeof r=="string"?r:null})}function y(e){E.forEach((t,r)=>{r.startsWith(e)&&E.delete(r)})}async function Qe(e){try{const t={...e,importedAt:f.now()};await C(()=>O(L(u,"importLogs"),t)),console.log("Log import cree")}catch(t){console.error("Erreur creation log import:",t)}}async function Ae(e){try{const t={...e,timestamp:f.now()};await C(()=>O(L(u,"auditLogs"),t)),console.log("Log audit cree")}catch(t){console.error("Erreur creation log audit:",t)}}const g={users:"users"};async function Y(e){try{const t=b(u,g.users,e.uid),r=await A(e),o={uid:e.uid,email:e.email,displayName:e.displayName,photoURL:e.photoURL,lastLogin:f.now(),updatedAt:f.now(),clientId:r},s=await v(()=>U(t));return s.exists()?s.data().clientId||(o.clientId=r,console.log("üîÑ Migration: Ajout du clientId au profil utilisateur existant")):(o.createdAt=f.now(),o.totalQuizzes=0,o.averageScore=0,o.currentStreak=0,o.longestStreak=0,o.role="user",console.log("üë§ Cr√©ation du profil utilisateur:",e.email)),await C(()=>me(t,o,{merge:!0})),console.log("‚úÖ Profil utilisateur sauvegard√©"),o}catch(t){throw console.error("‚ùå Erreur cr√©ation utilisateur:",t),t}}async function ee(e){try{const t=b(u,g.users,e),r=await v(()=>U(t));return r.exists()?r.data():null}catch(t){throw console.error("‚ùå Erreur r√©cup√©ration profil:",t),t}}async function Ie(e,t){if(isNaN(t)||t<0||t>100)throw console.error("‚ùå Score invalide pour mise √† jour des stats:",t),new Error(`Score invalide: ${t}. Doit √™tre entre 0 et 100.`);try{await fe(u,async r=>{const o=b(u,g.users,e),s=await r.get(o);if(!s.exists())throw new Error("Utilisateur non trouv√©");const i=s.data(),n=(i.totalQuizzes||0)+1,l=((i.averageScore||0)*(n-1)+t)/n,c=Math.round(l);if(isNaN(c)||c<0||c>100)throw console.error("‚ùå Moyenne calcul√©e invalide:",c),new Error(`Erreur de calcul de la moyenne: ${c}`);r.update(o,{totalQuizzes:n,averageScore:c,lastQuizDate:f.now(),updatedAt:f.now()})}),console.log("üìä Statistiques mises √† jour"),y("users"),y("users-stats")}catch(r){throw console.error("‚ùå Erreur mise √† jour statistiques:",r),r}}async function Se(e){const{getUserQuizResults:t}=await be(async()=>{const{getUserQuizResults:r}=await import("./quiz-service-B8667vFA.js").then(o=>o.q);return{getUserQuizResults:r}},[]);try{const r=await t(e,12);let o=0;const s=new Set;for(const l of r)l.score>=60&&s.add(l.month);const i=Array.from(s).sort().reverse();for(let l=0;l<i.length&&(o++,l<i.length-1);l++);const n=b(u,g.users,e),a=await v(()=>U(n));if(a.exists()){const l=a.data(),c=Math.max(o,l.longestStreak||0);await C(()=>Q(n,{currentStreak:o,longestStreak:c,updatedAt:f.now()})),console.log(`üî• S√©rie mise √† jour: ${o} mois`),y("users"),y("users-stats")}return o}catch(r){throw console.error("‚ùå Erreur mise √† jour s√©rie:",r),r}}async function ke(e=10){try{const t=await A(),r=S(L(u,g.users),x("clientId","==",t),k("averageScore","desc"),k("totalQuizzes","desc"),F(e)),o=await v(()=>N(r)),s=[];return o.forEach(i=>{const n=i.data();s.push({uid:i.id,displayName:n.displayName,photoURL:n.photoURL,averageScore:n.averageScore,totalQuizzes:n.totalQuizzes,currentStreak:n.currentStreak})}),console.log("üèÜ Classement charg√©"),s}catch(t){throw console.error("‚ùå Erreur r√©cup√©ration classement:",t),t}}async function ze(){try{const e=m.currentUser;return e?(await ee(e.uid))?.role==="admin":!1}catch(e){return console.error("‚ùå Erreur v√©rification admin:",e),!1}}async function te(e={}){const t=J(["users",JSON.stringify(e||{})]),r=X(t);if(r)return r;try{const o=await A(),s=[x("clientId","==",o)];e.role&&s.push(x("role","==",e.role)),s.push(k("createdAt","desc"));const i=S(L(u,g.users),...s),n=await v(()=>N(i)),a=[];return n.forEach(l=>{a.push({id:l.id,...l.data()})}),console.log(`üë• ${a.length} utilisateurs charg√©s`),Z(t,a,"users"),a}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration utilisateurs:",o),o}}async function Ue(e={},t=20,r=null){try{const o=await A(),s=[x("clientId","==",o)];e.role&&s.push(x("role","==",e.role)),s.push(k("createdAt","desc")),s.push(F(t+1));let i=S(L(u,g.users),...s);r&&(i=S(i,he(r)));const n=await v(()=>N(i)),a=[];let l=null,c=!1;return n.forEach((d,p)=>{p<t?a.push({id:d.id,...d.data()}):c=!0}),n.docs.length>0&&a.length===t&&(l=n.docs[t-1]),console.log(`üë• ${a.length} utilisateurs charg√©s (pagination)`),{users:a,lastDoc:l,hasMore:c}}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration utilisateurs pagin√©s:",o),o}}async function De(e,t){try{const r=m.currentUser;if(!r)throw new Error("Utilisateur non connect√©");if(!["user","admin"].includes(t))throw new Error('R√¥le invalide - doit √™tre "user" ou "admin"');const o=b(u,g.users,e);return await C(()=>Q(o,{role:t,updatedAt:f.now()})),console.log(`‚úÖ R√¥le mis √† jour pour ${e}: ${t}`),await Ae({action:"UPDATE_USER_ROLE",targetUserId:e,newRole:t,adminId:r.uid,adminEmail:r.email}),y("users"),y("users-stats"),!0}catch(r){throw console.error("‚ùå Erreur mise √† jour r√¥le:",r),r}}async function qe(){const e=await A(),t=J(["users-stats",e]),r=X(t);if(r)return r;try{const o=await te(),s={total:o.length,admins:o.filter(n=>n.role==="admin").length,regularUsers:o.filter(n=>n.role!=="admin").length,activeLastWeek:0,averageScore:0,totalQuizzes:0},i=new Date;return i.setDate(i.getDate()-7),o.forEach(n=>{n.lastLogin&&n.lastLogin.toDate()>i&&s.activeLastWeek++,s.totalQuizzes+=n.totalQuizzes||0,s.averageScore+=n.averageScore||0}),s.averageScore=s.total>0?Math.round(s.averageScore/s.total):0,Z(t,s,"stats"),s}catch(o){throw console.error("‚ùå Erreur statistiques utilisateurs:",o),o}}const We=Object.freeze(Object.defineProperty({__proto__:null,createOrUpdateUser:Y,getAllUsers:te,getAllUsersPaginated:Ue,getLeaderboard:ke,getUserProfile:ee,getUsersStats:qe,isCurrentUserAdmin:ze,updateStreak:Se,updateUserRole:De,updateUserStats:Ie},Symbol.toStringTag,{value:"Module"})),re=new ae;re.setCustomParameters({prompt:"select_account"});let M=!1;async function He(){if(M)return console.warn("‚ö†Ô∏è Connexion d√©j√† en cours, veuillez patienter..."),null;M=!0;try{console.log("üîê Tentative de connexion Google...");const t=(await ce(m,re)).user;return console.log("‚úÖ Authentification r√©ussie:",t.displayName),console.log("üìß Email:",t.email),await Y(t),t}catch(e){console.error("‚ùå Erreur de connexion:",e);let t="Erreur lors de la connexion. Veuillez r√©essayer.";if(e.code==="auth/popup-closed-by-user")t="Connexion annul√©e. Veuillez r√©essayer.";else if(e.code==="auth/popup-blocked")t="Pop-up bloqu√©e. Autorisez les pop-ups pour ce site.";else if(e.code==="auth/unauthorized-domain")t="Domaine non autoris√©. Configurez Firebase Authentication.";else if(e.code==="auth/cancelled-popup-request")return console.warn("‚ö†Ô∏è Requ√™te de popup annul√©e (clic multiple)"),null;throw e.code!=="auth/cancelled-popup-request"&&alert(t),e}finally{setTimeout(()=>{M=!1},2e3)}}async function Ge(){try{const e=m.currentUser?.displayName||"Utilisateur";await le(m),console.log("‚úÖ D√©connexion r√©ussie:",e)}catch(e){throw console.error("‚ùå Erreur de d√©connexion:",e),e}}function Ke(e){return ue(m,t=>{t?console.log("üë§ Utilisateur connect√©:",t.email):console.log("üë§ Aucun utilisateur connect√©"),e(t)})}function Te(){return m.currentUser}async function Ve(e){if(!e)return;if(e.role==="admin"){const r=document.getElementById("nav-admin-item");r&&r.classList.remove("hidden");const o=document.getElementById("admin-badge-nav");o&&o.classList.remove("hidden"),console.log("Admin UI elements shown")}}function Me(){return localStorage.getItem("authMode")==="demo"}function Re(){try{const e=localStorage.getItem("demoUser");return e?JSON.parse(e):null}catch(e){return console.error("‚ùå Erreur lecture utilisateur d√©mo:",e),null}}function Je(){return Me()?Re():Te()}export{_ as A,Me as B,Re as C,D,Be as E,He as F,Oe as G,Je as H,Ve as I,Fe as J,We as K,be as _,Se as a,ke as b,Y as c,te as d,Ue as e,De as f,ee as g,qe as h,ze as i,Qe as j,Ae as k,J as l,X as m,y as n,A as o,u as p,v as q,m as r,Z as s,C as t,Ie as u,Ke as v,$e as w,P as x,Te as y,Ge as z};
//# sourceMappingURL=auth-NyiblVhF.js.map
