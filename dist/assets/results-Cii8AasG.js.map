{"version":3,"file":"results-Cii8AasG.js","sources":["../../js/results.js"],"sourcesContent":["// Page Mes R√©sultats - Gestion compl√®te des r√©sultats et statistiques\r\nimport { db } from './firebase-config.js';\r\nimport { collection, query, where, orderBy, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { onAuthChange, signOutUser } from './auth.js';\r\nimport { getUserProfile } from './firestore-service.js';\r\nimport { toast } from './toast.js';\r\nimport { logger } from './logger.js';\r\n// ‚úÖ CORRECTION SECTION 4 : Protection XSS - Utiliser escapeHtml centralis√©\r\nimport { escapeHtml } from './security.js';\r\nimport {\r\n    createResultSkeleton,\r\n    createStatsSkeleton,\r\n    createChartSkeleton,\r\n    showSkeleton,\r\n    hideSkeleton\r\n} from './skeleton.js';\r\n\r\n// √âtat\r\nlet allResults = [];\r\nlet filteredResults = [];\r\nlet currentPage = 1;\r\nconst resultsPerPage = 10;\r\nlet progressChart = null;\r\nlet moduleChart = null;\r\n\r\n// Configuration des modules\r\nconst moduleNames = {\r\n    'auto': 'AT-AVE-AVEX',\r\n    'loisir': 'VTT, Motoneige, etc.',\r\n    'vr': 'V√©hicules R√©cr√©atifs',\r\n    'tracteur': '√âquipement Agricole'\r\n};\r\n\r\nconst moduleColors = {\r\n    'auto': '#6366f1',\r\n    'loisir': '#06b6d4',\r\n    'vr': '#f97316',\r\n    'tracteur': '#22c55e'\r\n};\r\n\r\nconst MONTH_LABELS = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];\r\n\r\n// Initialisation\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n    // V√©rifier l'authentification Firebase\r\n    onAuthChange(async (user) => {\r\n        if (!user) {\r\n            window.location.href = '/index.html';\r\n            return;\r\n        }\r\n        \r\n        updateUserInfo(user);\r\n        \r\n        // V√©rifier si l'utilisateur est admin\r\n        const userProfile = await getUserProfile(user.uid);\r\n        if (userProfile && userProfile.role === 'admin') {\r\n            document.getElementById('nav-admin-item')?.classList.remove('hidden');\r\n            document.getElementById('admin-badge-nav')?.classList.remove('hidden');\r\n        }\r\n        \r\n        await loadResults(user.uid);\r\n    });\r\n    \r\n    // √âv√©nements\r\n    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);\r\n    document.getElementById('signout-link')?.addEventListener('click', handleLogout);\r\n    document.getElementById('filter-module')?.addEventListener('change', applyFilters);\r\n    document.getElementById('filter-period')?.addEventListener('change', applyFilters);\r\n    document.getElementById('filter-sort')?.addEventListener('change', applyFilters);\r\n    document.getElementById('reset-filters-btn')?.addEventListener('click', resetFilters);\r\n    document.getElementById('prev-page-btn')?.addEventListener('click', () => changePage(-1));\r\n    document.getElementById('next-page-btn')?.addEventListener('click', () => changePage(1));\r\n    document.getElementById('export-results-btn')?.addEventListener('click', exportToCSV);\r\n\r\n    const resultsList = document.getElementById('results-list');\r\n    if (resultsList && !resultsList.dataset.eventsBound) {\r\n        resultsList.addEventListener('click', handleResultsListClick);\r\n        resultsList.dataset.eventsBound = 'true';\r\n    }\r\n});\r\n\r\n// Mettre √† jour les infos utilisateur\r\nfunction updateUserInfo(user) {\r\n    // Anciens IDs (top nav - supprimer si pr√©sents)\r\n    if (document.getElementById('user-name')) {\r\n        document.getElementById('user-name').textContent = user.displayName || user.email;\r\n    }\r\n    if (document.getElementById('user-photo')) {\r\n        document.getElementById('user-photo').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}`;\r\n    }\r\n    \r\n    // Nouveaux IDs (sidebar)\r\n    if (document.getElementById('user-display-name')) {\r\n        document.getElementById('user-display-name').textContent = user.displayName || user.email;\r\n    }\r\n    if (document.getElementById('user-avatar')) {\r\n        document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}`;\r\n    }\r\n}\r\n\r\n// Charger les r√©sultats depuis Firestore\r\nasync function loadResults(userId) {\r\n    logger.info('üì• Chargement des r√©sultats pour:', userId);\r\n    \r\n    try {\r\n        // Afficher les skeletons pendant le chargement\r\n        const statsContainer = document.getElementById('global-stats');\r\n        const resultsListContainer = document.getElementById('results-list');\r\n        const progressChartContainer = document.getElementById('progress-chart-container');\r\n        \r\n        if (statsContainer) {\r\n            showSkeleton('global-stats', createStatsSkeleton(4));\r\n        }\r\n        if (resultsListContainer) {\r\n            showSkeleton('results-list', createResultSkeleton(5));\r\n        }\r\n        if (progressChartContainer) {\r\n            progressChartContainer.innerHTML = createChartSkeleton();\r\n        }\r\n        \r\n        // 1) Requ√™te principale sur le champ normalis√© 'completedAt'\r\n        let q = query(\r\n            collection(db, 'quizResults'),\r\n            where('userId', '==', userId),\r\n            orderBy('completedAt', 'desc')\r\n        );\r\n        \r\n        let querySnapshot = await getDocs(q);\r\n        \r\n        // 2) Fallback r√©tro-compatibilit√©: certains anciens documents n'ont que 'date'\r\n        if (querySnapshot.empty) {\r\n            q = query(\r\n                collection(db, 'quizResults'),\r\n                where('userId', '==', userId),\r\n                orderBy('date', 'desc')\r\n            );\r\n            querySnapshot = await getDocs(q);\r\n        }\r\n        \r\n        allResults = [];\r\n        querySnapshot.forEach((doc) => {\r\n            const data = doc.data();\r\n            let completedAt = null;\r\n            // Nouveau format (Timestamp Firestore)\r\n            if (data.completedAt && typeof data.completedAt.toDate === 'function') {\r\n                completedAt = data.completedAt.toDate();\r\n            } else if (data.date && typeof data.date.toDate === 'function') {\r\n                // Ancien champ 'date'\r\n                completedAt = data.date.toDate();\r\n            } else if (data.date && typeof data.date === 'string') {\r\n                // Si 'date' est une string (s√©curit√©)\r\n                const parsed = new Date(data.date);\r\n                if (!isNaN(parsed.getTime())) completedAt = parsed;\r\n            }\r\n\r\n            allResults.push({\r\n                id: doc.id,\r\n                ...data,\r\n                completedAt\r\n            });\r\n        });\r\n        \r\n        logger.info(`‚úÖ ${allResults.length} r√©sultats charg√©s`);\r\n        \r\n        if (allResults.length === 0) {\r\n            showNoResults();\r\n        } else {\r\n            filteredResults = [...allResults];\r\n            updateUI();\r\n        }\r\n        \r\n    } catch (error) {\r\n        logger.error('‚ùå Erreur lors du chargement des r√©sultats:', error);\r\n\r\n        if (error.code === 'permission-denied') {\r\n            toast.error('Permissions insuffisantes pour consulter vos r√©sultats. Contactez un administrateur.');\r\n        } else {\r\n            toast.error('Erreur lors du chargement des r√©sultats');\r\n        }\r\n        showNoResults();\r\n    }\r\n}\r\n\r\n// Mettre √† jour l'interface compl√®te\r\nfunction updateUI() {\r\n    if (filteredResults.length === 0) {\r\n        document.getElementById('results-container')?.classList.add('hidden');\r\n        showNoResults();\r\n        return;\r\n    }\r\n\r\n    document.getElementById('no-results')?.classList.add('hidden');\r\n    updateGlobalStats();\r\n    updateCharts();\r\n    renderResults();\r\n    document.getElementById('results-loading')?.classList.add('hidden');\r\n    document.getElementById('results-container')?.classList.remove('hidden');\r\n}\r\n\r\n// Calculer et afficher les statistiques globales\r\nfunction updateGlobalStats() {\r\n    const statsContainer = document.getElementById('global-stats');\r\n    \r\n    const totalQuizzes = filteredResults.length;\r\n    const avgScore = totalQuizzes > 0 \r\n        ? Math.round(filteredResults.reduce((sum, r) => sum + r.score, 0) / totalQuizzes) \r\n        : 0;\r\n    const totalQuestions = filteredResults.reduce((sum, r) => sum + r.totalQuestions, 0);\r\n    const totalCorrect = filteredResults.reduce((sum, r) => sum + r.correctAnswers, 0);\r\n    const totalTime = filteredResults.reduce((sum, r) => sum + (r.timeSpent || 0), 0);\r\n    const avgTime = totalQuizzes > 0 \r\n        ? Math.round(totalTime / totalQuizzes) \r\n        : 0;\r\n    \r\n    // ‚úÖ CORRECTION SECTION 4 : Protection XSS - Les valeurs num√©riques sont safe, mais formatTime() peut retourner du texte\r\n    const safeAvgTime = escapeHtml(formatTime(avgTime));\r\n    \r\n    statsContainer.innerHTML = `\r\n        <div class=\"bg-white rounded-xl shadow-md p-6 fade-in\">\r\n            <div class=\"flex items-center gap-4\">\r\n                <div class=\"w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center\">\r\n                    <svg class=\"w-6 h-6 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                </div>\r\n                <div>\r\n                    <p class=\"text-sm text-slate-500\">Quiz compl√©t√©s</p>\r\n                    <p class=\"text-3xl font-bold text-slate-900\">${totalQuizzes}</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <div class=\"bg-white rounded-xl shadow-md p-6 fade-in\">\r\n            <div class=\"flex items-center gap-4\">\r\n                <div class=\"w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center\">\r\n                    <svg class=\"w-6 h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6\"></path>\r\n                    </svg>\r\n                </div>\r\n                <div>\r\n                    <p class=\"text-sm text-slate-500\">Score moyen</p>\r\n                    <p class=\"text-3xl font-bold text-slate-900\">${avgScore}%</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <div class=\"bg-white rounded-xl shadow-md p-6 fade-in\">\r\n            <div class=\"flex items-center gap-4\">\r\n                <div class=\"w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center\">\r\n                    <svg class=\"w-6 h-6 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\"></path>\r\n                    </svg>\r\n                </div>\r\n                <div>\r\n                    <p class=\"text-sm text-slate-500\">Questions r√©pondues</p>\r\n                    <p class=\"text-3xl font-bold text-slate-900\">${totalQuestions}</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <div class=\"bg-white rounded-xl shadow-md p-6 fade-in\">\r\n            <div class=\"flex items-center gap-4\">\r\n                <div class=\"w-12 h-12 rounded-lg bg-orange-100 flex items-center justify-center\">\r\n                    <svg class=\"w-6 h-6 text-orange-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                </div>\r\n                <div>\r\n                    <p class=\"text-sm text-slate-500\">Temps moyen</p>\r\n                    <p class=\"text-3xl font-bold text-slate-900\">${safeAvgTime}</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n// Mettre √† jour les graphiques\r\nfunction updateCharts() {\r\n    updateProgressChart();\r\n    updateModuleChart();\r\n}\r\n\r\n// Graphique d'√©volution des scores\r\nfunction updateProgressChart() {\r\n    const ctx = document.getElementById('progress-chart');\r\n    if (!ctx) return;\r\n    \r\n    // Prendre les 10 derniers r√©sultats\r\n    const recentResults = [...filteredResults].reverse().slice(-10);\r\n    \r\n    const labels = recentResults.map((r, i) => {\r\n        const date = r.completedAt;\r\n        return date ? `${date.getDate()}/${date.getMonth() + 1}` : `Quiz ${i + 1}`;\r\n    });\r\n    \r\n    const scores = recentResults.map(r => r.score);\r\n    \r\n    if (progressChart) {\r\n        progressChart.destroy();\r\n    }\r\n    \r\n    progressChart = new Chart(ctx, {\r\n        type: 'line',\r\n        data: {\r\n            labels: labels,\r\n            datasets: [{\r\n                label: 'Score (%)',\r\n                data: scores,\r\n                borderColor: '#6366f1',\r\n                backgroundColor: 'rgba(99, 102, 241, 0.1)',\r\n                tension: 0.4,\r\n                fill: true,\r\n                pointRadius: 5,\r\n                pointHoverRadius: 7\r\n            }]\r\n        },\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: false,\r\n            plugins: {\r\n                legend: {\r\n                    display: false\r\n                }\r\n            },\r\n            scales: {\r\n                y: {\r\n                    beginAtZero: true,\r\n                    max: 100,\r\n                    ticks: {\r\n                        callback: (value) => value + '%'\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Graphique de r√©partition par module\r\nfunction updateModuleChart() {\r\n    const ctx = document.getElementById('module-chart');\r\n    if (!ctx) return;\r\n    \r\n    // Compter les quiz par module\r\n    const moduleCounts = {};\r\n    filteredResults.forEach(r => {\r\n        moduleCounts[r.module] = (moduleCounts[r.module] || 0) + 1;\r\n    });\r\n    \r\n    const labels = Object.keys(moduleCounts).map(m => moduleNames[m] || m);\r\n    const data = Object.values(moduleCounts);\r\n    const colors = Object.keys(moduleCounts).map(m => moduleColors[m] || '#6366f1');\r\n    \r\n    if (moduleChart) {\r\n        moduleChart.destroy();\r\n    }\r\n    \r\n    moduleChart = new Chart(ctx, {\r\n        type: 'doughnut',\r\n        data: {\r\n            labels: labels,\r\n            datasets: [{\r\n                data: data,\r\n                backgroundColor: colors,\r\n                borderWidth: 2,\r\n                borderColor: '#ffffff'\r\n            }]\r\n        },\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: false,\r\n            plugins: {\r\n                legend: {\r\n                    position: 'bottom'\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Afficher les r√©sultats avec pagination\r\nfunction renderResults() {\r\n    const container = document.getElementById('results-list');\r\n    if (!container) return;\r\n\r\n    const start = (currentPage - 1) * resultsPerPage;\r\n    const end = start + resultsPerPage;\r\n    const pageResults = filteredResults.slice(start, end);\r\n    \r\n    if (pageResults.length === 0) {\r\n        container.replaceChildren();\r\n        return;\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    pageResults.forEach(result => {\r\n        fragment.appendChild(createResultCardElement(result));\r\n    });\r\n    \r\n    container.replaceChildren(fragment);\r\n    \r\n    updatePagination();\r\n}\r\n\r\nfunction createResultCardElement(result) {\r\n    const card = document.createElement('article');\r\n    card.className = 'p-6 hover:bg-slate-50 transition-colors';\r\n    card.dataset.resultId = result.id;\r\n\r\n    const date = result.completedAt instanceof Date ? result.completedAt : null;\r\n    const dateStr = date\r\n        ? `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} √† ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`\r\n        : 'Date inconnue';\r\n\r\n    const scoreColor = result.score >= 80 ? 'text-green-600' : result.score >= 60 ? 'text-yellow-600' : 'text-red-600';\r\n    // ‚úÖ CORRECTION SECTION 4 : Protection XSS - √âchapper toutes les donn√©es utilisateur\r\n    const moduleLabel = escapeHtml(moduleNames[result.module] || result.module || 'Module');\r\n    const monthLabelRaw = result.month ? String(result.month).trim() : '';\r\n    const yearLabelRaw = result.year ? String(result.year).trim() : '';\r\n    const periodLabel = escapeHtml([monthLabelRaw, yearLabelRaw].filter(Boolean).join(' ').trim());\r\n    const scoreValue = Number.isFinite(result.score) ? result.score : 0;\r\n    const correctAnswersValue = Number.isFinite(result.correctAnswers) ? result.correctAnswers : 0;\r\n    const totalQuestionsValue = Number.isFinite(result.totalQuestions) ? result.totalQuestions : 0;\r\n    const scoreDisplay = escapeHtml(`${scoreValue}%`);\r\n    const answersDisplay = escapeHtml(`${correctAnswersValue}/${totalQuestionsValue}`);\r\n    const timeDisplay = escapeHtml(formatTime(result.timeSpent || 0));\r\n    const dateDisplay = escapeHtml(dateStr);\r\n\r\n    card.innerHTML = `\r\n        <div class=\"flex items-center justify-between\">\r\n            <div class=\"flex-1\">\r\n                <div class=\"flex items-center gap-3 mb-2\">\r\n                    <h3 class=\"text-lg font-bold text-slate-900\">${moduleLabel}</h3>\r\n                    <span class=\"px-3 py-1 text-xs font-medium bg-slate-100 text-slate-600 rounded-full\">\r\n                        ${periodLabel}\r\n                    </span>\r\n                </div>\r\n                <p class=\"text-sm text-slate-500\">${dateDisplay}</p>\r\n            </div>\r\n            <div class=\"flex items-center gap-6\">\r\n                <div class=\"text-center\">\r\n                    <p class=\"text-sm text-slate-500 mb-1\">Score</p>\r\n                    <p class=\"${scoreColor} text-3xl font-bold\">${scoreDisplay}</p>\r\n                </div>\r\n                <div class=\"text-center\">\r\n                    <p class=\"text-sm text-slate-500 mb-1\">R√©ponses</p>\r\n                    <p class=\"text-slate-700 font-semibold\">${answersDisplay}</p>\r\n                </div>\r\n                <div class=\"text-center\">\r\n                    <p class=\"text-sm text-slate-500 mb-1\">Temps</p>\r\n                    <p class=\"text-slate-700 font-semibold\">${timeDisplay}</p>\r\n                </div>\r\n                <button class=\"result-details-btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium\" data-result-id=\"${result.id}\">\r\n                    D√©tails\r\n                </button>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    return card;\r\n}\r\n\r\nfunction handleResultsListClick(event) {\r\n    const button = event.target.closest('.result-details-btn');\r\n    if (!button) {\r\n        return;\r\n    }\r\n\r\n    const { resultId } = button.dataset;\r\n    if (!resultId) {\r\n        return;\r\n    }\r\n\r\n    openResultDetails(resultId);\r\n}\r\n\r\n// Mettre √† jour la pagination\r\nfunction updatePagination() {\r\n    const totalPages = Math.ceil(filteredResults.length / resultsPerPage);\r\n    const pageInfo = document.getElementById('page-info');\r\n    if (pageInfo) {\r\n        pageInfo.textContent = `Page ${currentPage} sur ${totalPages || 1}`;\r\n    }\r\n\r\n    const prevBtn = document.getElementById('prev-page-btn');\r\n    const nextBtn = document.getElementById('next-page-btn');\r\n    if (prevBtn) {\r\n        prevBtn.disabled = currentPage === 1;\r\n    }\r\n    if (nextBtn) {\r\n        nextBtn.disabled = currentPage === totalPages || totalPages === 0;\r\n    }\r\n}\r\n\r\n// Changer de page\r\nfunction changePage(direction) {\r\n    currentPage += direction;\r\n    renderResults();\r\n    window.scrollTo({ top: 0, behavior: 'smooth' });\r\n}\r\n\r\n// Appliquer les filtres\r\nfunction applyFilters() {\r\n    const moduleFilter = document.getElementById('filter-module').value;\r\n    const periodFilter = document.getElementById('filter-period').value;\r\n    const sortFilter = document.getElementById('filter-sort').value;\r\n    \r\n    // Filtrer par module\r\n    filteredResults = moduleFilter \r\n        ? allResults.filter(r => r.module === moduleFilter)\r\n        : [...allResults];\r\n    \r\n    // Filtrer par p√©riode\r\n    if (periodFilter !== 'all') {\r\n        const now = new Date();\r\n        const filterDate = new Date();\r\n        \r\n        if (periodFilter === 'week') {\r\n            filterDate.setDate(now.getDate() - 7);\r\n        } else if (periodFilter === 'month') {\r\n            filterDate.setDate(now.getDate() - 30);\r\n        } else if (periodFilter === 'year') {\r\n            filterDate.setFullYear(now.getFullYear());\r\n            filterDate.setMonth(0);\r\n            filterDate.setDate(1);\r\n        }\r\n        \r\n        filteredResults = filteredResults.filter(r => r.completedAt >= filterDate);\r\n    }\r\n    \r\n    // Trier\r\n    filteredResults.sort((a, b) => {\r\n        if (sortFilter === 'date-desc') {\r\n            return b.completedAt - a.completedAt;\r\n        } else if (sortFilter === 'date-asc') {\r\n            return a.completedAt - b.completedAt;\r\n        } else if (sortFilter === 'score-desc') {\r\n            return b.score - a.score;\r\n        } else if (sortFilter === 'score-asc') {\r\n            return a.score - b.score;\r\n        }\r\n        return 0;\r\n    });\r\n    \r\n    currentPage = 1;\r\n    updateUI();\r\n}\r\n\r\n// R√©initialiser les filtres\r\nfunction resetFilters() {\r\n    document.getElementById('filter-module').value = '';\r\n    document.getElementById('filter-period').value = 'all';\r\n    document.getElementById('filter-sort').value = 'date-desc';\r\n    applyFilters();\r\n}\r\n\r\n// Exporter en CSV\r\nfunction exportToCSV() {\r\n    if (filteredResults.length === 0) {\r\n        toast.warning('Aucun r√©sultat √† exporter');\r\n        return;\r\n    }\r\n    \r\n    const loadingToast = toast.showLoadingToast('G√©n√©ration du fichier CSV...');\r\n    \r\n    try {\r\n        const headers = ['Date', 'Module', 'Mois', 'Ann√©e', 'Score (%)', 'Bonnes r√©ponses', 'Total questions', 'Temps (s)'];\r\n        const rows = filteredResults.map(r => {\r\n            const date = r.completedAt ? r.completedAt.toLocaleString('fr-FR') : 'N/A';\r\n            return [\r\n                date,\r\n                moduleNames[r.module] || r.module,\r\n                r.month,\r\n                r.year,\r\n                r.score,\r\n                r.correctAnswers,\r\n                r.totalQuestions,\r\n                r.timeSpent || 0\r\n            ];\r\n        });\r\n        \r\n        const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');\r\n        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\r\n        const link = document.createElement('a');\r\n        link.href = URL.createObjectURL(blob);\r\n        link.download = `mes-resultats-${new Date().toISOString().split('T')[0]}.csv`;\r\n        link.click();\r\n        \r\n        toast.updateLoadingToast(loadingToast, 'Export CSV r√©ussi !', 'success');\r\n        logger.info('‚úÖ Export CSV r√©ussi');\r\n    } catch (error) {\r\n        toast.updateLoadingToast(loadingToast, 'Erreur d\\'export', 'error');\r\n        toast.error('Erreur lors de l\\'export CSV', 4000);\r\n        logger.error('‚ùå Erreur export CSV:', error);\r\n    }\r\n}\r\n\r\n// Afficher les d√©tails d'un r√©sultat (modal)\r\nfunction openResultDetails(resultId) {\r\n    const result = allResults.find(r => r.id === resultId);\r\n    if (!result) {\r\n        return;\r\n    }\r\n\r\n    // ‚úÖ CORRECTION SECTION 4 : Protection XSS - √âchapper toutes les donn√©es utilisateur\r\n    const moduleLabel = escapeHtml(moduleNames[result.module] || result.module || 'Module');\r\n    const periodLabel = escapeHtml([result.month, result.year].filter(Boolean).join(' '));\r\n    const scoreValue = Number.isFinite(result.score) ? result.score : 0;\r\n    const correctAnswersValue = Number.isFinite(result.correctAnswers) ? result.correctAnswers : 0;\r\n    const totalQuestionsValue = Number.isFinite(result.totalQuestions) ? result.totalQuestions : 0;\r\n    const timeDisplay = escapeHtml(formatTime(result.timeSpent || 0));\r\n    const answers = Array.isArray(result.answers) ? result.answers : [];\r\n\r\n    const modal = document.createElement('div');\r\n    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';\r\n\r\n    const dialog = document.createElement('div');\r\n    dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto flex flex-col';\r\n    modal.appendChild(dialog);\r\n\r\n    const header = document.createElement('div');\r\n    header.className = 'px-8 py-6 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white';\r\n    const title = document.createElement('h2');\r\n    title.className = 'text-2xl font-bold';\r\n    title.textContent = 'D√©tails du quiz';\r\n    const subtitle = document.createElement('p');\r\n    subtitle.className = 'text-indigo-100 mt-1';\r\n    // ‚úÖ CORRECTION SECTION 4 : Protection XSS - textContent √©chappe automatiquement\r\n    subtitle.textContent = periodLabel ? `${moduleLabel} - ${periodLabel}` : moduleLabel;\r\n    header.append(title, subtitle);\r\n    dialog.appendChild(header);\r\n\r\n    const body = document.createElement('div');\r\n    body.className = 'p-8';\r\n    dialog.appendChild(body);\r\n\r\n    const metricsGrid = document.createElement('div');\r\n    metricsGrid.className = 'grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8';\r\n    body.appendChild(metricsGrid);\r\n\r\n    const createMetricCard = (label, value, valueClass = '') => {\r\n        const card = document.createElement('div');\r\n        card.className = 'text-center p-4 bg-slate-50 rounded-lg';\r\n        const labelEl = document.createElement('p');\r\n        labelEl.className = 'text-sm text-slate-500 mb-1';\r\n        labelEl.textContent = label;\r\n        const valueEl = document.createElement('p');\r\n        valueEl.className = `text-3xl font-bold ${valueClass}`.trim();\r\n        valueEl.textContent = value;\r\n        card.append(labelEl, valueEl);\r\n        return card;\r\n    };\r\n\r\n    metricsGrid.append(\r\n        createMetricCard('Score', `${scoreValue}%`, 'text-indigo-600'),\r\n        createMetricCard('Bonnes r√©ponses', `${correctAnswersValue}/${totalQuestionsValue}`, 'text-slate-900'),\r\n        createMetricCard('Temps total', timeDisplay, 'text-slate-900')\r\n    );\r\n\r\n    if (answers.length > 0) {\r\n        const detailTitle = document.createElement('h3');\r\n        detailTitle.className = 'text-xl font-bold text-slate-900 mb-4';\r\n        detailTitle.textContent = 'R√©ponses d√©taill√©es';\r\n        body.appendChild(detailTitle);\r\n\r\n        const answersContainer = document.createElement('div');\r\n        answersContainer.className = 'space-y-3 max-h-96 overflow-y-auto';\r\n        body.appendChild(answersContainer);\r\n\r\n        answers.forEach((answer, index) => {\r\n            const wrapper = document.createElement('div');\r\n            wrapper.className = `p-4 rounded-lg border ${answer.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;\r\n\r\n            const row = document.createElement('div');\r\n            row.className = 'flex items-start gap-3';\r\n            wrapper.appendChild(row);\r\n\r\n            const icon = document.createElement('span');\r\n            icon.className = 'text-2xl';\r\n            icon.textContent = answer.isCorrect ? '‚úÖ' : '‚ùå';\r\n            row.appendChild(icon);\r\n\r\n            const content = document.createElement('div');\r\n            content.className = 'flex-1';\r\n            row.appendChild(content);\r\n\r\n            const questionTitle = document.createElement('p');\r\n            questionTitle.className = 'font-semibold text-slate-900 mb-1';\r\n            questionTitle.textContent = `Question ${index + 1}`;\r\n            content.appendChild(questionTitle);\r\n\r\n            const questionText = document.createElement('p');\r\n            questionText.className = 'text-sm text-slate-700 mb-2';\r\n            // ‚úÖ CORRECTION SECTION 4 : Protection XSS - textContent √©chappe automatiquement\r\n            questionText.textContent = answer.question || 'Question indisponible';\r\n            content.appendChild(questionText);\r\n\r\n            if (!answer.isCorrect) {\r\n                const diff = document.createElement('div');\r\n                diff.className = 'text-xs text-slate-600 space-y-1';\r\n\r\n                const userAnswer = document.createElement('p');\r\n                const userLabel = document.createElement('strong');\r\n                userLabel.textContent = 'Votre r√©ponse :';\r\n                // ‚úÖ CORRECTION SECTION 4 : Protection XSS - textContent √©chappe automatiquement\r\n                userAnswer.append(userLabel, document.createTextNode(` ${answer.selectedAnswer || 'N/A'}`));\r\n\r\n                const correctAnswer = document.createElement('p');\r\n                const correctLabel = document.createElement('strong');\r\n                correctLabel.textContent = 'Bonne r√©ponse :';\r\n                // ‚úÖ CORRECTION SECTION 4 : Protection XSS - textContent √©chappe automatiquement\r\n                correctAnswer.append(correctLabel, document.createTextNode(` ${answer.correctAnswer || 'N/A'}`));\r\n\r\n                diff.append(userAnswer, correctAnswer);\r\n                content.appendChild(diff);\r\n            }\r\n\r\n            const duration = document.createElement('span');\r\n            duration.className = 'text-sm text-slate-500';\r\n            duration.textContent = `${Number.isFinite(answer.timeSpent) ? answer.timeSpent : 0}s`;\r\n            row.appendChild(duration);\r\n\r\n            answersContainer.appendChild(wrapper);\r\n        });\r\n    } else {\r\n        const emptyState = document.createElement('p');\r\n        emptyState.className = 'text-slate-500 text-center py-8';\r\n        emptyState.textContent = 'D√©tails des r√©ponses non disponibles';\r\n        body.appendChild(emptyState);\r\n    }\r\n\r\n    const footer = document.createElement('div');\r\n    footer.className = 'px-8 py-6 bg-slate-50 border-t border-gray-200 flex justify-end';\r\n    const closeBtn = document.createElement('button');\r\n    closeBtn.id = 'close-modal-btn';\r\n    closeBtn.className = 'px-6 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors font-medium';\r\n    closeBtn.textContent = 'Fermer';\r\n    footer.appendChild(closeBtn);\r\n    dialog.appendChild(footer);\r\n\r\n    document.body.appendChild(modal);\r\n\r\n    const removeModal = () => {\r\n        if (modal.parentNode) {\r\n            modal.parentNode.removeChild(modal);\r\n        }\r\n    };\r\n\r\n    closeBtn.addEventListener('click', removeModal);\r\n    modal.addEventListener('click', (event) => {\r\n        if (event.target === modal) {\r\n            removeModal();\r\n        }\r\n    });\r\n}\r\n\r\n// Afficher message si aucun r√©sultat\r\nfunction showNoResults() {\r\n    document.getElementById('results-loading')?.classList.add('hidden');\r\n    document.getElementById('no-results')?.classList.remove('hidden');\r\n    document.getElementById('results-container')?.classList.add('hidden');\r\n}\r\n\r\n// Afficher erreur\r\nfunction showError(message) {\r\n    alert(message);\r\n    document.getElementById('results-loading')?.classList.add('hidden');\r\n}\r\n\r\n// Formater le temps\r\nfunction formatTime(seconds) {\r\n    const mins = Math.floor(seconds / 60);\r\n    const secs = seconds % 60;\r\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n}\r\n\r\n// ‚úÖ CORRECTION SECTION 4 : Fonction escapeHtml() supprim√©e - Utiliser celle de security.js\r\n\r\n// D√©connexion\r\nasync function handleLogout() {\r\n    try {\r\n        await signOutUser();\r\n        window.location.href = '/';\r\n    } catch (error) {\r\n        logger.error('Erreur lors de la d√©connexion:', error);\r\n    }\r\n}\r\n"],"names":["allResults","filteredResults","currentPage","resultsPerPage","progressChart","moduleChart","moduleNames","moduleColors","onAuthChange","user","updateUserInfo","userProfile","getUserProfile","loadResults","handleLogout","applyFilters","resetFilters","changePage","exportToCSV","resultsList","handleResultsListClick","userId","logger","statsContainer","resultsListContainer","progressChartContainer","showSkeleton","createStatsSkeleton","createResultSkeleton","createChartSkeleton","q","query","collection","db","where","orderBy","querySnapshot","getDocs","doc","data","completedAt","parsed","showNoResults","updateUI","error","toast","updateGlobalStats","updateCharts","renderResults","totalQuizzes","avgScore","sum","r","totalQuestions","totalTime","avgTime","safeAvgTime","escapeHtml","formatTime","updateProgressChart","updateModuleChart","ctx","recentResults","labels","i","date","scores","value","moduleCounts","m","colors","container","start","end","pageResults","fragment","result","createResultCardElement","updatePagination","card","dateStr","scoreColor","moduleLabel","monthLabelRaw","yearLabelRaw","periodLabel","scoreValue","correctAnswersValue","totalQuestionsValue","scoreDisplay","answersDisplay","timeDisplay","dateDisplay","event","button","resultId","openResultDetails","totalPages","pageInfo","prevBtn","nextBtn","direction","moduleFilter","periodFilter","sortFilter","now","filterDate","a","b","loadingToast","headers","rows","csv","row","blob","link","answers","modal","dialog","header","title","subtitle","body","metricsGrid","createMetricCard","label","valueClass","labelEl","valueEl","detailTitle","answersContainer","answer","index","wrapper","icon","content","questionTitle","questionText","diff","userAnswer","userLabel","correctAnswer","correctLabel","duration","emptyState","footer","closeBtn","removeModal","seconds","mins","secs","signOutUser"],"mappings":"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"}