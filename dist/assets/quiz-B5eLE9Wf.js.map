{"version":3,"mappings":"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","names":["hasWindow","hasDocument","hasNavigator","isVitest","nodeTestEnv","__vite_import_meta_env__","isTestRuntime","supportsServiceWorker","analytics","getPageMetadata","initAnalytics","getAnalytics","app","error","trackEvent","eventName","params","path","logEvent","trackError","context","trackingError","setAnalyticsUser","userId","setUserId","setAnalyticsUserProperties","properties","setUserProperties","trackPageView","pageName","pagePath","href","trackQuizStart","moduleId","month","trackQuizComplete","score","timeElapsed","totalQuestions","shouldAutoInit","initWhenReady","auth","user","RateLimitError","waitTimeMs","RateLimiter","maxRequests","windowMs","now","time","oldestRequest","waitTime","isHappyDom","hasVitestWorker","define_process_env_default","getRateLimitWindowMs","firestoreRateLimiter","firestoreWriteRateLimiter","getReadLimiter","getWriteLimiter","wait","ms","resolve","safeFirestoreCall","fn","options","limiter","maxRetry","attempts","testRuntime","safeFirestoreRead","safeFirestoreWrite","ErrorTypes","ErrorHandler","event","errorData","isDemoMode","err","logger","message","code","logMessage","duration","toast","analytics$1","db","__vitePreload","n","collection","addDoc","Timestamp","isCurrentUserAdmin","limit","errorHandler","DEFAULT_OPTIONS","isRetryableError","retryableErrors","retryableCode","calculateDelay","attempt","initialDelay","maxDelay","backoffMultiplier","delay","withRetry","opts","lastError","withFirestoreRetry","firestoreOperation","launchConfetti","canvas","ctx","particles","colors","i","animate","activeParticles","p","index","moduleConfig","getCurrentQuiz","stateManager","setCurrentQuiz","value","getCurrentQuestionIndex","setCurrentQuestionIndex","getUserAnswers","setUserAnswers","getStartTime","setStartTime","getTimerInterval","setTimerInterval","getQuestionStartTime","setQuestionStartTime","getCurrentStreak","setCurrentStreak","getIsPaused","setIsPaused","getPausedDuration","setPausedDuration","getPauseStartedAt","setPauseStartedAt","getCurrentModule","setCurrentModule","getCurrentMonth","setCurrentMonth","getCurrentYear","setCurrentYear","getHasCurrentQuestionBeenAnswered","setHasCurrentQuestionBeenAnswered","getQuizEventDelegationInitialized","setQuizEventDelegationInitialized","moduleColors","loadQuizFromFirestore","monthNumber","year","toQuestionObjects","doc","data","opt","saved","demoQuestions","parsed","q","matchModule","matchMonth","q1","query","where","snap","getDocs","res","d","monthText","normalizedMonth","q2","loadDemoQuestions","resp","idx","e","startQuiz","config","loadingToast","showLoadingToast","showLoadingScreen","getCurrentMonthNumber","normalizeMonthFormat","questions","updateLoadingToast","currentMonth","showQuizView","renderQuestion","startTimer","updateScoreDisplay","updateProgressBar","stopTimer","moduleName","quizView","getOrCreateQuizView","escapeHtml","banner","initializeQuizEventDelegation","optionButton","optionId","handleAnswer","nextQuestion","returnToDashboard","toggleFocusMode","togglePause","currentQuiz","currentQuestionIndex","question","colorScheme","tag","option","progressPercent","progressBar","progressPercentElement","questionStartTime","selectedOption","timeSpent","userAnswers","currentStreak","btn","showAnswerFeedback","selectedId","isCorrect","correctOption","optId","explanationArea","showResults","calculateQuizScore","pausedDuration","isPaused","pauseStartedAt","pausedOffset","startTime","totalTime","minutes","seconds","saveQuizToFirestore","a","answer","quizTotalTime","currentModule","getCurrentUserUnified","currentYear","moduleDetails","quizData","saveQuizResult","resultData","syncQueue","queueError","queueKey","localError","interval","elapsedMs","elapsed","timerElement","timerInterval","calculateScore","quizScoring","scoreElement","pauseBtn","link","invalidateByDataType","initializeDashboard","correctCount","getMonthlyQuizStatus","monthIndex","currentMonthIndex","monthScore"],"ignoreList":[],"sources":["../../js/analytics.js","../../js/rate-limiter.js","../../js/error-handler.js","../../js/retry-handler.js","../../js/confetti.js","../../js/quiz.js","../../js/utils/quiz-scoring.js"],"sourcesContent":["/**\r\n * Module Analytics et Monitoring\r\n * \r\n * ‚úÖ CORRECTION SECTION 9 : Monitoring et Analytics\r\n * \r\n * G√®re Firebase Analytics et le tracking d'erreurs\r\n */\r\n\r\nimport { getAnalytics, logEvent, setUserProperties, setUserId } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';\r\nimport { app } from './firebase-config.js';\r\nimport { auth } from './firebase-config.js';\r\n\r\nconst hasWindow = typeof window !== 'undefined';\r\nconst hasDocument = typeof document !== 'undefined';\r\nconst hasNavigator = typeof navigator !== 'undefined';\r\nconst isVitest = typeof import.meta !== 'undefined' && Boolean(import.meta.vitest);\r\nconst nodeTestEnv =\r\n    (typeof process !== 'undefined' && process.env?.NODE_ENV === 'test') ||\r\n    (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.MODE === 'test');\r\nconst isTestRuntime = isVitest || nodeTestEnv;\r\nconst supportsServiceWorker = hasNavigator && 'serviceWorker' in navigator;\r\n\r\nlet analytics = null;\r\n\r\nfunction getPageMetadata() {\r\n    if (hasWindow && window.location) {\r\n        return {\r\n            path: window.location.pathname,\r\n            href: window.location.href\r\n        };\r\n    }\r\n    return {\r\n        path: '/test',\r\n        href: 'https://localhost/test'\r\n    };\r\n}\r\n\r\n/**\r\n * Initialiser Firebase Analytics\r\n */\r\nexport function initAnalytics() {\r\n    try {\r\n        if (analytics) return analytics;\r\n        // Autoriser l'initialisation sur navigateur ou en environnement de test (Vitest)\r\n        if ((hasWindow && supportsServiceWorker) || isTestRuntime) {\r\n            analytics = getAnalytics(app);\r\n            console.log('‚úÖ Firebase Analytics initialis√©');\r\n        } else {\r\n            console.warn('‚ö†Ô∏è Firebase Analytics non disponible dans cet environnement');\r\n        }\r\n        return analytics;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur initialisation Analytics:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Tracker un √©v√©nement\r\n * @param {string} eventName - Nom de l'√©v√©nement\r\n * @param {Object} params - Param√®tres de l'√©v√©nement\r\n */\r\nexport function trackEvent(eventName, params = {}) {\r\n    if (!analytics) {\r\n        // Mode silencieux si analytics non disponible\r\n        console.log(`[Analytics] ${eventName}`, params);\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        const { path } = getPageMetadata();\r\n        logEvent(analytics, eventName, {\r\n            ...params,\r\n            timestamp: Date.now(),\r\n            page: path\r\n        });\r\n        console.log(`üìä Event tracked: ${eventName}`, params);\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur tracking √©v√©nement:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Tracker une erreur\r\n * @param {Error} error - Erreur √† tracker\r\n * @param {Object} context - Contexte suppl√©mentaire\r\n */\r\nexport function trackError(error, context = {}) {\r\n    if (!analytics) {\r\n        console.error('[Analytics Error]', error, context);\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        logEvent(analytics, 'exception', {\r\n            description: error.message || 'Unknown error',\r\n            fatal: false,\r\n            error_type: error.name || 'Error',\r\n            error_stack: error.stack?.substring(0, 500) || '', // Limiter la taille\r\n            ...context\r\n        });\r\n        console.error('üìä Error tracked:', error.message);\r\n    } catch (trackingError) {\r\n        console.error('‚ùå Erreur tracking erreur:', trackingError);\r\n    }\r\n}\r\n\r\n/**\r\n * Tracker une m√©trique de performance\r\n * @param {string} metricName - Nom de la m√©trique\r\n * @param {number} value - Valeur de la m√©trique\r\n * @param {string} unit - Unit√© (ms, bytes, etc.)\r\n */\r\nexport function trackPerformance(metricName, value, unit = 'ms') {\r\n    if (!analytics) {\r\n        console.log(`[Analytics Performance] ${metricName}: ${value}${unit}`);\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        const { path } = getPageMetadata();\r\n        logEvent(analytics, 'performance', {\r\n            metric_name: metricName,\r\n            metric_value: value,\r\n            metric_unit: unit,\r\n            page: path\r\n        });\r\n        console.log(`üìä Performance tracked: ${metricName} = ${value}${unit}`);\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur tracking performance:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * D√©finir l'utilisateur pour Analytics\r\n * @param {string} userId - ID de l'utilisateur\r\n */\r\nexport function setAnalyticsUser(userId) {\r\n    if (!analytics) return;\r\n    \r\n    try {\r\n        setUserId(analytics, userId);\r\n        console.log('‚úÖ Analytics user set:', userId);\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur d√©finition utilisateur Analytics:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * D√©finir les propri√©t√©s utilisateur\r\n * @param {Object} properties - Propri√©t√©s utilisateur\r\n */\r\nexport function setAnalyticsUserProperties(properties) {\r\n    if (!analytics) return;\r\n    \r\n    try {\r\n        setUserProperties(analytics, properties);\r\n        console.log('‚úÖ Analytics user properties set:', properties);\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur d√©finition propri√©t√©s utilisateur:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Tracker une page vue\r\n * @param {string} pageName - Nom de la page\r\n * @param {string} pagePath - Chemin de la page\r\n */\r\nexport function trackPageView(pageName, pagePath) {\r\n    if (!analytics) {\r\n        console.log(`[Analytics PageView] ${pageName} - ${pagePath || getPageMetadata().path}`);\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        const { path, href } = getPageMetadata();\r\n        logEvent(analytics, 'page_view', {\r\n            page_title: pageName,\r\n            page_location: href,\r\n            page_path: pagePath || path\r\n        });\r\n        console.log(`üìä Page view tracked: ${pageName}`);\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur tracking page view:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Tracker le d√©but d'un quiz\r\n * @param {string} moduleId - ID du module\r\n * @param {string} month - Mois du quiz\r\n */\r\nexport function trackQuizStart(moduleId, month) {\r\n    trackEvent('quiz_start', {\r\n        module_id: moduleId,\r\n        month: month\r\n    });\r\n}\r\n\r\n/**\r\n * Tracker la fin d'un quiz\r\n * @param {string} moduleId - ID du module\r\n * @param {number} score - Score obtenu\r\n * @param {number} timeElapsed - Temps √©coul√© en secondes\r\n * @param {number} totalQuestions - Nombre total de questions\r\n */\r\nexport function trackQuizComplete(moduleId, score, timeElapsed, totalQuestions) {\r\n    trackEvent('quiz_complete', {\r\n        module_id: moduleId,\r\n        score: score,\r\n        time_elapsed: timeElapsed,\r\n        total_questions: totalQuestions,\r\n        passed: score >= 60\r\n    });\r\n}\r\n\r\n/**\r\n * Tracker une action utilisateur\r\n * @param {string} action - Action effectu√©e\r\n * @param {string} category - Cat√©gorie de l'action\r\n * @param {Object} params - Param√®tres suppl√©mentaires\r\n */\r\nexport function trackUserAction(action, category = 'user_interaction', params = {}) {\r\n    trackEvent('user_action', {\r\n        action: action,\r\n        category: category,\r\n        ...params\r\n    });\r\n}\r\n\r\n/**\r\n * Tracker un √©v√©nement de conversion\r\n * @param {string} conversionType - Type de conversion\r\n * @param {Object} params - Param√®tres de conversion\r\n */\r\nexport function trackConversion(conversionType, params = {}) {\r\n    trackEvent('conversion', {\r\n        conversion_type: conversionType,\r\n        ...params\r\n    });\r\n}\r\n\r\n// Initialiser automatiquement si possible\r\nconst shouldAutoInit = hasWindow || isTestRuntime;\r\n\r\nif (shouldAutoInit) {\r\n    // Attendre le chargement complet pour √©viter les erreurs de circular dependency\r\n    const initWhenReady = () => {\r\n        try {\r\n            initAnalytics();\r\n            \r\n            if (auth && typeof auth.onAuthStateChanged === 'function') {\r\n                auth.onAuthStateChanged((user) => {\r\n                    if (user) {\r\n                        setAnalyticsUser(user.uid);\r\n                        setAnalyticsUserProperties({\r\n                            email: user.email || '',\r\n                            display_name: user.displayName || ''\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.warn('‚ö†Ô∏è Analytics auto-init skipped:', error.message);\r\n        }\r\n    };\r\n    \r\n    if (hasDocument && document.readyState === 'loading' && hasWindow) {\r\n        document.addEventListener('DOMContentLoaded', initWhenReady);\r\n    } else if (hasWindow) {\r\n        // Utiliser setTimeout pour √©viter les circular dependencies\r\n        setTimeout(initWhenReady, 0);\r\n    }\r\n}\r\n\r\n","/**\r\n * Gestionnaire de rate limiting pour les appels Firestore (Section 4 - S√©curit√©)\r\n * \r\n * Ce module limite le nombre de requ√™tes Firestore par utilisateur pour pr√©venir\r\n * l'abus de quota et les attaques DoS.\r\n */\r\n\r\n/**\r\n * Erreur d√©di√©e au rate limiting (permet d'inspecter le temps d'attente)\r\n */\r\nexport class RateLimitError extends Error {\r\n    constructor(waitTimeMs) {\r\n        super(`Trop de requ√™tes. Veuillez patienter ${Math.ceil(waitTimeMs / 1000)} secondes.`);\r\n        this.name = 'RateLimitError';\r\n        this.waitTimeMs = waitTimeMs;\r\n    }\r\n}\r\n\r\n/**\r\n * Classe pour limiter le taux de requ√™tes\r\n */\r\nexport class RateLimiter {\r\n    constructor(maxRequests, windowMs) {\r\n        this.maxRequests = maxRequests;\r\n        this.windowMs = windowMs;\r\n        this.requests = [];\r\n    }\r\n\r\n    /**\r\n     * Nettoyage interne des requ√™tes expir√©es\r\n     * @param {number} [now=Date.now()]\r\n     */\r\n    _cleanup(now = Date.now()) {\r\n        this.requests = this.requests.filter(time => now - time < this.windowMs);\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si une nouvelle requ√™te peut √™tre ex√©cut√©e imm√©diatement\r\n     * @returns {boolean} true si la requ√™te peut √™tre ex√©cut√©e, false sinon\r\n     */\r\n    canExecute() {\r\n        const now = Date.now();\r\n        this._cleanup(now);\r\n\r\n        if (this.requests.length < this.maxRequests) {\r\n            this.requests.push(now);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Retourne le temps restant avant la prochaine ex√©cution possible\r\n     * @returns {number} Temps en ms\r\n     */\r\n    getRemainingTime() {\r\n        const now = Date.now();\r\n        this._cleanup(now);\r\n\r\n        if (this.requests.length === 0) {\r\n            return 0;\r\n        }\r\n\r\n        const oldestRequest = this.requests[0];\r\n        return Math.max(0, this.windowMs - (now - oldestRequest));\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si une nouvelle requ√™te est autoris√©e\r\n     * @throws {RateLimitError} Si la limite est d√©pass√©e\r\n     */\r\n    async check() {\r\n        if (this.canExecute()) {\r\n            return;\r\n        }\r\n\r\n        const waitTime = this.getRemainingTime() || this.windowMs;\r\n        throw new RateLimitError(waitTime);\r\n    }\r\n\r\n    /**\r\n     * R√©initialise le compteur\r\n     */\r\n    reset() {\r\n        this.requests = [];\r\n    }\r\n\r\n    /**\r\n     * Retourne le nombre de requ√™tes restantes dans la fen√™tre\r\n     */\r\n    getRemainingRequests() {\r\n        this._cleanup();\r\n        return Math.max(0, this.maxRequests - this.requests.length);\r\n    }\r\n}\r\n\r\nconst isHappyDom = () => typeof window !== 'undefined' && typeof window.happyDOM !== 'undefined';\r\nconst hasVitestWorker = () =>\r\n    typeof globalThis !== 'undefined' && Boolean(globalThis.__vitest_worker__);\r\n\r\nfunction isTestRuntime() {\r\n    if (isHappyDom()) return true;\r\n    if (hasVitestWorker()) return true;\r\n    if (\r\n        typeof navigator !== 'undefined' &&\r\n        /happy\\s?dom|jsdom/i.test(navigator.userAgent || '')\r\n    ) {\r\n        return true;\r\n    }\r\n    if (typeof globalThis !== 'undefined' && Boolean(globalThis.__vitest_browser__)) return true;\r\n    if (typeof import.meta !== 'undefined' && Boolean(import.meta.vitest)) return true;\r\n    if (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.MODE === 'test') {\r\n        return true;\r\n    }\r\n    if (typeof process !== 'undefined' && process.env?.npm_lifecycle_event === 'test') return true;\r\n    if (typeof process !== 'undefined' && process.env?.NODE_ENV === 'test') return true;\r\n    return false;\r\n}\r\n\r\nfunction getRateLimitWindowMs() {\r\n    return isTestRuntime() ? 1000 : 60000; // 1s en test, 60s en prod\r\n}\r\n\r\nlet firestoreRateLimiter = null;\r\nlet firestoreWriteRateLimiter = null;\r\n\r\nfunction getReadLimiter() {\r\n    if (!firestoreRateLimiter) {\r\n        firestoreRateLimiter = new RateLimiter(100, getRateLimitWindowMs());\r\n    }\r\n    return firestoreRateLimiter;\r\n}\r\n\r\nfunction getWriteLimiter() {\r\n    if (!firestoreWriteRateLimiter) {\r\n        firestoreWriteRateLimiter = new RateLimiter(50, getRateLimitWindowMs());\r\n    }\r\n    return firestoreWriteRateLimiter;\r\n}\r\n\r\nfunction wait(ms) {\r\n    if (ms <= 0) return Promise.resolve();\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * Wrapper pour prot√©ger les appels Firestore avec rate limiting\r\n * @param {Function} fn - Fonction async √† ex√©cuter\r\n * @param {Object} options - Options (isWrite: boolean, maxRetry: number)\r\n * @returns {Promise} R√©sultat de la fonction\r\n */\r\nexport async function safeFirestoreCall(fn, options = {}) {\r\n    const limiter = options.isWrite ? getWriteLimiter() : getReadLimiter();\r\n    const maxRetry = options.maxRetry ?? 5;\r\n    let attempts = 0;\r\n    const testRuntime = isTestRuntime();\r\n\r\n    while (attempts <= maxRetry) {\r\n        try {\r\n            await limiter.check();\r\n            return await fn();\r\n        } catch (error) {\r\n            if (error instanceof RateLimitError) {\r\n                console.warn('‚ö†Ô∏è Rate limit atteint:', error.message);\r\n                attempts += 1;\r\n                const waitTime = testRuntime ? Math.min(error.waitTimeMs, 1000) : error.waitTimeMs;\r\n                await wait(waitTime);\r\n                continue;\r\n            }\r\n\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    throw new RateLimitError(limiter.getRemainingTime() || limiter.windowMs);\r\n}\r\n\r\n/**\r\n * Wrapper sp√©cialis√© pour les lectures Firestore\r\n */\r\nexport async function safeFirestoreRead(fn) {\r\n    return safeFirestoreCall(fn, { isWrite: false });\r\n}\r\n\r\n/**\r\n * Wrapper sp√©cialis√© pour les √©critures Firestore\r\n */\r\nexport async function safeFirestoreWrite(fn) {\r\n    return safeFirestoreCall(fn, { isWrite: true });\r\n}\r\n\r\n/**\r\n * R√©initialise les rate limiters (utile pour les tests)\r\n */\r\nexport function resetRateLimiters() {\r\n    firestoreRateLimiter = new RateLimiter(100, getRateLimitWindowMs());\r\n    firestoreWriteRateLimiter = new RateLimiter(50, getRateLimitWindowMs());\r\n}\r\n\r\nexport default {\r\n    RateLimiter,\r\n    RateLimitError,\r\n    safeFirestoreCall,\r\n    safeFirestoreRead,\r\n    safeFirestoreWrite,\r\n    resetRateLimiters\r\n};\r\n\r\n\r\n","/**\r\n * Gestionnaire d'erreurs centralis√© pour l'application Avantage QUIZZ\r\n * \r\n * Ce module fournit une gestion d'erreurs centralis√©e pour :\r\n * - Capturer les erreurs non g√©r√©es\r\n * - Logger les erreurs de mani√®re coh√©rente\r\n * - Afficher des messages utilisateur appropri√©s\r\n * - Envoyer les erreurs critiques √† Firestore (si admin)\r\n */\r\n\r\nimport { logger } from './logger.js';\r\nimport { toast } from './toast.js';\r\nimport { isDemoMode } from './auth.js';\r\n\r\n/**\r\n * Types d'erreurs possibles\r\n */\r\nexport const ErrorTypes = {\r\n    NETWORK: 'NETWORK',\r\n    FIRESTORE: 'FIRESTORE',\r\n    AUTH: 'AUTH',\r\n    VALIDATION: 'VALIDATION',\r\n    UNKNOWN: 'UNKNOWN'\r\n};\r\n\r\n/**\r\n * Classe pour g√©rer les erreurs de mani√®re centralis√©e\r\n */\r\nclass ErrorHandler {\r\n    constructor() {\r\n        this.errorLog = [];\r\n        this.maxLogSize = 100; // Limiter la taille du log en m√©moire\r\n        this.setupGlobalHandlers();\r\n    }\r\n\r\n    /**\r\n     * Configure les gestionnaires d'erreurs globaux\r\n     */\r\n    setupGlobalHandlers() {\r\n        // Gestionnaire pour les erreurs JavaScript non captur√©es\r\n        window.addEventListener('error', (event) => {\r\n            this.handleError({\r\n                message: event.message,\r\n                filename: event.filename,\r\n                lineno: event.lineno,\r\n                colno: event.colno,\r\n                error: event.error,\r\n                type: ErrorTypes.UNKNOWN\r\n            }, 'Global error handler');\r\n        });\r\n\r\n        // Gestionnaire pour les promesses rejet√©es non g√©r√©es\r\n        window.addEventListener('unhandledrejection', (event) => {\r\n            this.handleError({\r\n                message: event.reason?.message || 'Unhandled promise rejection',\r\n                error: event.reason,\r\n                type: ErrorTypes.UNKNOWN\r\n            }, 'Unhandled promise rejection');\r\n        });\r\n    }\r\n\r\n    /**\r\n     * G√®re une erreur de mani√®re centralis√©e\r\n     * @param {Error|Object} error - L'erreur √† g√©rer\r\n     * @param {string} context - Contexte o√π l'erreur s'est produite\r\n     * @param {Object} options - Options suppl√©mentaires\r\n     */\r\n    handleError(error, context = 'Unknown', options = {}) {\r\n        const errorData = this.normalizeError(error, context, options);\r\n        \r\n        // Logger l'erreur\r\n        this.logError(errorData);\r\n        \r\n        // Afficher un message utilisateur si n√©cessaire\r\n        if (options.showToUser !== false) {\r\n            this.showUserMessage(errorData, options);\r\n        }\r\n        \r\n        // Envoyer √† Firestore si critique et en production\r\n        if (options.critical && !isDemoMode()) {\r\n            this.sendToFirestore(errorData).catch(err => {\r\n                logger.error('Impossible d\\'envoyer l\\'erreur √† Firestore:', err);\r\n            });\r\n        }\r\n        \r\n        return errorData;\r\n    }\r\n\r\n    /**\r\n     * Normalise une erreur en objet standardis√©\r\n     * @param {Error|Object} error - L'erreur √† normaliser\r\n     * @param {string} context - Contexte\r\n     * @param {Object} options - Options\r\n     * @returns {Object} Erreur normalis√©e\r\n     */\r\n    normalizeError(error, context, options) {\r\n        const errorData = {\r\n            message: error?.message || String(error) || 'Erreur inconnue',\r\n            stack: error?.stack,\r\n            context: context,\r\n            type: this.detectErrorType(error),\r\n            timestamp: new Date().toISOString(),\r\n            url: window.location.href,\r\n            userAgent: navigator.userAgent,\r\n            ...options.metadata\r\n        };\r\n\r\n        // Ajouter des informations sp√©cifiques selon le type d'erreur\r\n        if (error?.code) {\r\n            errorData.code = error.code;\r\n        }\r\n        if (error?.name) {\r\n            errorData.name = error.name;\r\n        }\r\n\r\n        return errorData;\r\n    }\r\n\r\n    /**\r\n     * D√©tecte le type d'erreur bas√© sur le message ou le code\r\n     * @param {Error|Object} error - L'erreur\r\n     * @returns {string} Type d'erreur\r\n     */\r\n    detectErrorType(error) {\r\n        if (!error) return ErrorTypes.UNKNOWN;\r\n\r\n        const message = (error.message || '').toLowerCase();\r\n        const code = error.code || '';\r\n\r\n        if (code === 'unavailable' || code === 'deadline-exceeded' || message.includes('network') || message.includes('fetch')) {\r\n            return ErrorTypes.NETWORK;\r\n        }\r\n        if (code === 'permission-denied' || code === 'unauthenticated' || message.includes('auth')) {\r\n            return ErrorTypes.AUTH;\r\n        }\r\n        if (code === 'invalid-argument' || code === 'failed-precondition' || message.includes('validation')) {\r\n            return ErrorTypes.VALIDATION;\r\n        }\r\n        if (message.includes('firestore') || code.startsWith('firestore')) {\r\n            return ErrorTypes.FIRESTORE;\r\n        }\r\n\r\n        return ErrorTypes.UNKNOWN;\r\n    }\r\n\r\n    /**\r\n     * Log l'erreur de mani√®re coh√©rente\r\n     * @param {Object} errorData - Donn√©es d'erreur normalis√©es\r\n     */\r\n    logError(errorData) {\r\n        // Ajouter au log en m√©moire\r\n        this.errorLog.push(errorData);\r\n        if (this.errorLog.length > this.maxLogSize) {\r\n            this.errorLog.shift(); // Garder seulement les N derni√®res erreurs\r\n        }\r\n\r\n        // Logger selon le type\r\n        const logMessage = `[${errorData.type}] ${errorData.context}: ${errorData.message}`;\r\n        \r\n        if (errorData.type === ErrorTypes.NETWORK) {\r\n            logger.warn(logMessage, errorData);\r\n        } else {\r\n            logger.error(logMessage, errorData);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Affiche un message utilisateur appropri√©\r\n     * @param {Object} errorData - Donn√©es d'erreur\r\n     * @param {Object} options - Options\r\n     */\r\n    showUserMessage(errorData, options) {\r\n        let message = options.userMessage;\r\n        \r\n        if (!message) {\r\n            // Messages par d√©faut selon le type\r\n            switch (errorData.type) {\r\n                case ErrorTypes.NETWORK:\r\n                    message = 'Probl√®me de connexion. V√©rifiez votre connexion internet.';\r\n                    break;\r\n                case ErrorTypes.AUTH:\r\n                    message = 'Erreur d\\'authentification. Veuillez vous reconnecter.';\r\n                    break;\r\n                case ErrorTypes.VALIDATION:\r\n                    message = 'Donn√©es invalides. Veuillez v√©rifier vos informations.';\r\n                    break;\r\n                case ErrorTypes.FIRESTORE:\r\n                    message = 'Erreur lors de l\\'acc√®s aux donn√©es. Veuillez r√©essayer.';\r\n                    break;\r\n                default:\r\n                    message = 'Une erreur est survenue. Veuillez r√©essayer.';\r\n            }\r\n        }\r\n\r\n        // Afficher le toast\r\n        const duration = options.duration || (errorData.type === ErrorTypes.NETWORK ? 8000 : 5000);\r\n        toast.error(message, duration);\r\n    }\r\n\r\n    /**\r\n     * Envoie l'erreur √† Firestore pour analyse (si admin)\r\n     * ‚úÖ CORRECTION SECTION 9 : Ajouter tracking Analytics\r\n     * @param {Object} errorData - Donn√©es d'erreur\r\n     */\r\n    async sendToFirestore(errorData) {\r\n        // ‚úÖ CORRECTION SECTION 9 : Tracker l'erreur avec Analytics\r\n        try {\r\n            const { trackError } = await import('./analytics.js');\r\n            trackError(new Error(errorData.message), {\r\n                error_type: errorData.type,\r\n                error_source: errorData.source,\r\n                user_id: errorData.userId || 'anonymous'\r\n            });\r\n        } catch (analyticsError) {\r\n            // Mode silencieux si analytics non disponible\r\n            console.warn('Analytics non disponible pour tracking erreur');\r\n        }\r\n        \r\n        try {\r\n            // Import dynamique pour √©viter les d√©pendances circulaires\r\n            const { db } = await import('./firebase-config.js');\r\n            const { collection, addDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');\r\n            const { isCurrentUserAdmin } = await import('./firestore-service.js');\r\n            \r\n            // Seulement si admin (pour √©viter les co√ªts)\r\n            const isAdmin = await isCurrentUserAdmin();\r\n            if (!isAdmin) {\r\n                return;\r\n            }\r\n\r\n            await addDoc(collection(db, 'errorLogs'), {\r\n                ...errorData,\r\n                timestamp: Timestamp.now()\r\n            });\r\n        } catch (err) {\r\n            // Ne pas logger pour √©viter les boucles infinies\r\n            console.error('Impossible d\\'envoyer l\\'erreur √† Firestore:', err);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re les erreurs r√©centes\r\n     * @param {number} limit - Nombre d'erreurs √† retourner\r\n     * @returns {Array} Liste des erreurs\r\n     */\r\n    getRecentErrors(limit = 10) {\r\n        return this.errorLog.slice(-limit);\r\n    }\r\n\r\n    /**\r\n     * Efface le log d'erreurs\r\n     */\r\n    clearErrorLog() {\r\n        this.errorLog = [];\r\n    }\r\n}\r\n\r\n// Instance singleton\r\nexport const errorHandler = new ErrorHandler();\r\n\r\n/**\r\n * Fonction utilitaire pour wrapper les fonctions async avec gestion d'erreur\r\n * @param {Function} fn - Fonction async √† wrapper\r\n * @param {string} context - Contexte de l'erreur\r\n * @param {Object} options - Options\r\n * @returns {Function} Fonction wrapp√©e\r\n */\r\nexport function withErrorHandling(fn, context, options = {}) {\r\n    return async (...args) => {\r\n        try {\r\n            return await fn(...args);\r\n        } catch (error) {\r\n            errorHandler.handleError(error, context, options);\r\n            throw error; // Re-throw pour permettre la gestion en amont si n√©cessaire\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Fonction utilitaire pour cr√©er un gestionnaire d'erreur pour une fonction sp√©cifique\r\n * @param {Function} fn - Fonction √† prot√©ger\r\n * @param {string} context - Contexte\r\n * @param {Object} options - Options\r\n * @returns {Function} Fonction prot√©g√©e\r\n */\r\nexport function protectFunction(fn, context, options = {}) {\r\n    return withErrorHandling(fn, context, {\r\n        ...options,\r\n        showToUser: options.showToUser !== false\r\n    });\r\n}\r\n\r\nexport default errorHandler;\r\n\r\n\r\n","/**\r\n * Gestionnaire de retry automatique pour les op√©rations r√©seau/Firestore\r\n * \r\n * Ce module fournit un syst√®me de retry avec backoff exponentiel pour :\r\n * - Les requ√™tes Firestore qui √©chouent\r\n * - Les op√©rations r√©seau\r\n * - Les appels API\r\n */\r\n\r\nimport { logger } from './logger.js';\r\nimport { errorHandler, ErrorTypes } from './error-handler.js';\r\n\r\n/**\r\n * Options par d√©faut pour le retry\r\n */\r\nconst DEFAULT_OPTIONS = {\r\n    maxRetries: 3,\r\n    initialDelay: 1000, // 1 seconde\r\n    maxDelay: 30000, // 30 secondes max\r\n    backoffMultiplier: 2,\r\n    retryableErrors: ['unavailable', 'deadline-exceeded', 'internal', 'aborted'],\r\n    onRetry: null // Callback appel√© √† chaque retry\r\n};\r\n\r\n/**\r\n * V√©rifie si une erreur est retryable\r\n * @param {Error} error - L'erreur √† v√©rifier\r\n * @param {Array} retryableErrors - Liste des codes d'erreur retryables\r\n * @returns {boolean} True si l'erreur est retryable\r\n */\r\nfunction isRetryableError(error, retryableErrors) {\r\n    if (!error) return false;\r\n    \r\n    const code = error.code || '';\r\n    const message = (error.message || '').toLowerCase();\r\n    \r\n    // Erreurs r√©seau toujours retryables\r\n    if (code === 'unavailable' || code === 'deadline-exceeded' || \r\n        message.includes('network') || message.includes('fetch failed')) {\r\n        return true;\r\n    }\r\n    \r\n    // V√©rifier dans la liste des erreurs retryables\r\n    return retryableErrors.some(retryableCode => \r\n        code === retryableCode || message.includes(retryableCode.toLowerCase())\r\n    );\r\n}\r\n\r\n/**\r\n * Calcule le d√©lai avant le prochain retry (backoff exponentiel)\r\n * @param {number} attempt - Num√©ro de la tentative (0 = premi√®re retry)\r\n * @param {number} initialDelay - D√©lai initial\r\n * @param {number} maxDelay - D√©lai maximum\r\n * @param {number} backoffMultiplier - Multiplicateur\r\n * @returns {number} D√©lai en millisecondes\r\n */\r\nfunction calculateDelay(attempt, initialDelay, maxDelay, backoffMultiplier) {\r\n    const delay = initialDelay * Math.pow(backoffMultiplier, attempt);\r\n    return Math.min(delay, maxDelay);\r\n}\r\n\r\n/**\r\n * Attend un certain d√©lai\r\n * @param {number} ms - Millisecondes √† attendre\r\n * @returns {Promise} Promise qui se r√©sout apr√®s le d√©lai\r\n */\r\nfunction wait(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * Ex√©cute une fonction avec retry automatique\r\n * @param {Function} fn - Fonction async √† ex√©cuter\r\n * @param {Object} options - Options de retry\r\n * @returns {Promise} R√©sultat de la fonction\r\n */\r\nexport async function withRetry(fn, options = {}) {\r\n    const opts = { ...DEFAULT_OPTIONS, ...options };\r\n    let lastError;\r\n    \r\n    // Premi√®re tentative\r\n    try {\r\n        return await fn();\r\n    } catch (error) {\r\n        lastError = error;\r\n        \r\n        // Si l'erreur n'est pas retryable, on arr√™te imm√©diatement\r\n        if (!isRetryableError(error, opts.retryableErrors)) {\r\n            throw error;\r\n        }\r\n    }\r\n    \r\n    // Retries\r\n    for (let attempt = 0; attempt < opts.maxRetries; attempt++) {\r\n        const delay = calculateDelay(\r\n            attempt,\r\n            opts.initialDelay,\r\n            opts.maxDelay,\r\n            opts.backoffMultiplier\r\n        );\r\n        \r\n        // Callback onRetry si fourni\r\n        if (opts.onRetry) {\r\n            opts.onRetry(attempt + 1, delay, lastError);\r\n        } else {\r\n            // Message par d√©faut\r\n            logger.warn(`Nouvelle tentative ${attempt + 1}/${opts.maxRetries} dans ${delay}ms...`);\r\n        }\r\n        \r\n        // Attendre avant de retry\r\n        await wait(delay);\r\n        \r\n        try {\r\n            return await fn();\r\n        } catch (error) {\r\n            lastError = error;\r\n            \r\n            // Si l'erreur n'est plus retryable, arr√™ter\r\n            if (!isRetryableError(error, opts.retryableErrors)) {\r\n                throw error;\r\n            }\r\n            \r\n            // Si c'est la derni√®re tentative, logger et throw\r\n            if (attempt === opts.maxRetries - 1) {\r\n                errorHandler.handleError(error, 'Retry handler - Max retries reached', {\r\n                    showToUser: true,\r\n                    userMessage: `√âchec apr√®s ${opts.maxRetries} tentatives. Veuillez r√©essayer plus tard.`\r\n                });\r\n                throw error;\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Ne devrait jamais arriver ici, mais au cas o√π\r\n    throw lastError;\r\n}\r\n\r\n/**\r\n * Wrapper sp√©cialis√© pour les op√©rations Firestore\r\n * @param {Function} firestoreOperation - Op√©ration Firestore async\r\n * @param {Object} options - Options de retry\r\n * @returns {Promise} R√©sultat de l'op√©ration\r\n */\r\nexport async function withFirestoreRetry(firestoreOperation, options = {}) {\r\n    return withRetry(firestoreOperation, {\r\n        ...options,\r\n        retryableErrors: [\r\n            'unavailable',\r\n            'deadline-exceeded',\r\n            'internal',\r\n            'aborted',\r\n            'resource-exhausted'\r\n        ],\r\n        onRetry: options.onRetry || ((attempt, delay) => {\r\n            logger.warn(`Retry Firestore ${attempt}/${options.maxRetries || 3} dans ${delay}ms...`);\r\n        })\r\n    });\r\n}\r\n\r\n/**\r\n * Wrapper sp√©cialis√© pour les op√©rations r√©seau (fetch)\r\n * @param {Function} networkOperation - Op√©ration r√©seau async\r\n * @param {Object} options - Options de retry\r\n * @returns {Promise} R√©sultat de l'op√©ration\r\n */\r\nexport async function withNetworkRetry(networkOperation, options = {}) {\r\n    return withRetry(networkOperation, {\r\n        ...options,\r\n        retryableErrors: ['network', 'timeout', 'fetch'],\r\n        onRetry: options.onRetry || ((attempt, delay) => {\r\n            logger.warn(`Retry r√©seau ${attempt}/${options.maxRetries || 3} dans ${delay}ms...`);\r\n        })\r\n    });\r\n}\r\n\r\nexport default {\r\n    withRetry,\r\n    withFirestoreRetry,\r\n    withNetworkRetry\r\n};\r\n\r\n\r\n","// Simple confetti animation using canvas\r\nexport function launchConfetti() {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.style.position = 'fixed';\r\n    canvas.style.top = '0';\r\n    canvas.style.left = '0';\r\n    canvas.style.width = '100%';\r\n    canvas.style.height = '100%';\r\n    canvas.style.pointerEvents = 'none';\r\n    canvas.style.zIndex = '9999';\r\n    document.body.appendChild(canvas);\r\n\r\n    const ctx = canvas.getContext('2d');\r\n    canvas.width = window.innerWidth;\r\n    canvas.height = window.innerHeight;\r\n\r\n    const particles = [];\r\n    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];\r\n    \r\n    // Create particles\r\n    for (let i = 0; i < 150; i++) {\r\n        particles.push({\r\n            x: Math.random() * canvas.width,\r\n            y: canvas.height + Math.random() * 100,\r\n            size: Math.random() * 8 + 4,\r\n            speedY: -(Math.random() * 3 + 3),\r\n            speedX: Math.random() * 6 - 3,\r\n            color: colors[Math.floor(Math.random() * colors.length)],\r\n            rotation: Math.random() * 360,\r\n            rotationSpeed: Math.random() * 10 - 5,\r\n            gravity: 0.15,\r\n            opacity: 1\r\n        });\r\n    }\r\n\r\n    function animate() {\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n        \r\n        let activeParticles = 0;\r\n        \r\n        particles.forEach((p, index) => {\r\n            p.speedY += p.gravity;\r\n            p.y += p.speedY;\r\n            p.x += p.speedX;\r\n            p.rotation += p.rotationSpeed;\r\n            \r\n            // Fade out near the bottom\r\n            if (p.y > canvas.height - 100) {\r\n                p.opacity -= 0.02;\r\n            }\r\n            \r\n            if (p.opacity > 0 && p.y < canvas.height + 50) {\r\n                activeParticles++;\r\n                \r\n                ctx.save();\r\n                ctx.translate(p.x, p.y);\r\n                ctx.rotate((p.rotation * Math.PI) / 180);\r\n                ctx.globalAlpha = p.opacity;\r\n                ctx.fillStyle = p.color;\r\n                \r\n                // Draw rectangle confetti\r\n                ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);\r\n                \r\n                ctx.restore();\r\n            }\r\n        });\r\n        \r\n        if (activeParticles > 0) {\r\n            requestAnimationFrame(animate);\r\n        } else {\r\n            canvas.remove();\r\n        }\r\n    }\r\n    \r\n    animate();\r\n}\r\n","// Module Quiz - Interface de questions style professionnel (VERSION 2.0 - Firestore)\r\nimport { db } from './firebase-config.js';\r\nimport { collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { getCurrentUserUnified, isDemoMode } from './auth.js';\r\nimport { launchConfetti } from './confetti.js';\r\nimport { saveQuizResult } from './firestore-service.js';\r\nimport { toast, showLoadingToast, updateLoadingToast } from './toast.js';\r\n// ‚úÖ CORRECTION SECTION 9 : Analytics\r\nimport { trackQuizStart, trackQuizComplete } from './analytics.js';\r\n// Import du gestionnaire de retry (Section 1 - Architecture)\r\nimport { withFirestoreRetry } from './retry-handler.js';\r\n// Import des fonctions de s√©curit√© (Section 4 - S√©curit√©)\r\nimport { escapeHtml } from './security.js';\r\n// Import du rate limiter (Section 4 - S√©curit√©)\r\nimport { safeFirestoreRead } from './rate-limiter.js';\r\n// ‚úÖ CORRECTION SECTION 5 : Import du gestionnaire d'√©tat centralis√©\r\nimport { stateManager } from './state-manager.js';\r\n\r\n// Configuration des modules (m√©tadonn√©es uniquement - pas de questions hardcod√©es)\r\nconst moduleConfig = {\r\n    'auto': {\r\n        name: 'AT-AVE-AVEX',\r\n        color: 'indigo',\r\n        label: 'Auto'\r\n    },\r\n    'loisir': {\r\n        name: 'VTT, Motoneige, etc.',\r\n        color: 'cyan',\r\n        label: 'Loisir'\r\n    },\r\n    'vr': {\r\n        name: 'V√©hicules R√©cr√©atifs',\r\n        color: 'orange',\r\n        label: 'VR'\r\n    },\r\n    'tracteur': {\r\n        name: '√âquipement Agricole',\r\n        color: 'green',\r\n        label: 'Tracteur'\r\n    },\r\n    'avex': {\r\n        name: 'Protection Exceptionnelle',\r\n        color: 'purple',\r\n        label: 'AVEX'\r\n    },\r\n    'hasard-route': {\r\n        name: 'Protection Routi√®re',\r\n        color: 'amber',\r\n        label: 'Hasard de Route'\r\n    }\r\n};\r\n\r\n// ‚úÖ CORRECTION SECTION 5 : √âtat du quiz g√©r√© par StateManager\r\n// Helper functions pour faciliter la migration (utilisent StateManager en arri√®re-plan)\r\nconst getCurrentQuiz = () => stateManager.get('currentQuiz');\r\nconst setCurrentQuiz = (value) => stateManager.set('currentQuiz', value);\r\nconst getCurrentQuestionIndex = () => stateManager.get('currentQuestionIndex');\r\nconst setCurrentQuestionIndex = (value) => stateManager.set('currentQuestionIndex', value);\r\nconst getUserAnswers = () => stateManager.get('userAnswers');\r\nconst setUserAnswers = (value) => stateManager.set('userAnswers', value);\r\nconst getStartTime = () => stateManager.get('startTime');\r\nconst setStartTime = (value) => stateManager.set('startTime', value);\r\nconst getTimerInterval = () => stateManager.get('timerInterval');\r\nconst setTimerInterval = (value) => stateManager.set('timerInterval', value);\r\nconst getQuestionStartTime = () => stateManager.get('questionStartTime');\r\nconst setQuestionStartTime = (value) => stateManager.set('questionStartTime', value);\r\nconst getCurrentStreak = () => stateManager.get('currentStreak');\r\nconst setCurrentStreak = (value) => stateManager.set('currentStreak', value);\r\nconst getIsPaused = () => stateManager.get('isPaused');\r\nconst setIsPaused = (value) => stateManager.set('isPaused', value);\r\nconst getPausedDuration = () => stateManager.get('pausedDuration');\r\nconst setPausedDuration = (value) => stateManager.set('pausedDuration', value);\r\nconst getPauseStartedAt = () => stateManager.get('pauseStartedAt');\r\nconst setPauseStartedAt = (value) => stateManager.set('pauseStartedAt', value);\r\nconst getCurrentModule = () => stateManager.get('currentModule');\r\nconst setCurrentModule = (value) => stateManager.set('currentModule', value);\r\nconst getCurrentMonth = () => stateManager.get('currentMonth');\r\nconst setCurrentMonth = (value) => stateManager.set('currentMonth', value);\r\nconst getCurrentYear = () => stateManager.get('currentYear');\r\nconst setCurrentYear = (value) => stateManager.set('currentYear', value);\r\nconst getHasCurrentQuestionBeenAnswered = () => stateManager.get('hasCurrentQuestionBeenAnswered');\r\nconst setHasCurrentQuestionBeenAnswered = (value) => stateManager.set('hasCurrentQuestionBeenAnswered', value);\r\nconst getQuizEventDelegationInitialized = () => stateManager.get('quizEventDelegationInitialized');\r\nconst setQuizEventDelegationInitialized = (value) => stateManager.set('quizEventDelegationInitialized', value);\r\n\r\n// Couleurs par module - AVANTAGE PLUS\r\nconst moduleColors = {\r\n    'indigo': { bg: 'bg-ap-red-primary', text: 'text-ap-red-primary', border: 'border-ap-red-primary' }, // Auto -> Rouge AP\r\n    'cyan': { bg: 'bg-ap-gold', text: 'text-ap-gold', border: 'border-ap-gold' }, // Loisir -> Dor√© AP\r\n    'orange': { bg: 'bg-orange-600', text: 'text-orange-600', border: 'border-orange-600' }, // VR -> Orange (OK)\r\n    'green': { bg: 'bg-green-600', text: 'text-green-600', border: 'border-green-600' }, // Tracteur -> Vert (OK)\r\n    'purple': { bg: 'bg-purple-600', text: 'text-purple-600', border: 'border-purple-600' }, // AVEX -> Violet\r\n    'amber': { bg: 'bg-amber-600', text: 'text-amber-600', border: 'border-amber-600' } // Hasard de Route -> Ambre\r\n};\r\n\r\n// Charger les questions depuis Firestore, compatible mois num√©rique ou texte (r√©tro-compatibilit√©)\r\nasync function loadQuizFromFirestore(moduleId, monthNumber, year) {\r\n    console.log(`üì• Chargement des questions: module=${moduleId}, mois=${monthNumber}, ann√©e=${year}`);\r\n\r\n    const toQuestionObjects = (doc) => {\r\n        const data = doc.data();\r\n        return {\r\n            id: doc.id,\r\n            question: data.question,\r\n            options: data.options.map((opt, index) => ({\r\n                id: String.fromCharCode(65 + index), // A, B, C, D\r\n                text: opt,\r\n                correct: index === data.correctAnswer\r\n            })),\r\n            explanation: data.explanation || 'Pas d\\'explication disponible',\r\n            reference: data.reference || '',\r\n            tags: data.tags || []\r\n        };\r\n    };\r\n\r\n    // ‚úÖ MODE D√âMO : Utiliser les questions mock√©es de localStorage OU d√©fauts\r\n    if (isDemoMode()) {\r\n        console.log('üìù Mode d√©mo : Chargement des questions simul√©es pour le quiz...');\r\n        \r\n        // üíæ Charger depuis localStorage (synchronis√© avec admin)\r\n        const DEMO_STORAGE_KEY = 'avantage-quizz-demo-questions';\r\n        const saved = localStorage.getItem(DEMO_STORAGE_KEY);\r\n        \r\n        let demoQuestions = [];\r\n        \r\n        if (saved) {\r\n            try {\r\n                const parsed = JSON.parse(saved);\r\n                console.log(`üíæ ${parsed.length} questions charg√©es depuis localStorage`);\r\n                \r\n                // Convertir au format attendu par le quiz\r\n                demoQuestions = parsed.map(q => ({\r\n                    id: q.id,\r\n                    question: q.question,\r\n                    options: q.options.map((opt, index) => ({\r\n                        id: String.fromCharCode(65 + index), // A, B, C, D\r\n                        text: opt,\r\n                        correct: index === q.correctAnswer\r\n                    })),\r\n                    explanation: q.explanation || 'Pas d\\'explication disponible',\r\n                    reference: q.reference || '',\r\n                    tags: q.tags || []\r\n                }));\r\n                \r\n                // Filtrer par module et mois si n√©cessaire\r\n                demoQuestions = demoQuestions.filter(q => {\r\n                    const matchModule = !moduleId || parsed.find(p => p.id === q.id)?.module === moduleId;\r\n                    const matchMonth = !monthNumber || parsed.find(p => p.id === q.id)?.month === monthNumber;\r\n                    return matchModule && matchMonth;\r\n                });\r\n                \r\n            } catch (e) {\r\n                console.warn('‚ö†Ô∏è Erreur lecture localStorage, utilisation questions par d√©faut');\r\n            }\r\n        }\r\n        \r\n        // Si pas de questions en localStorage, utiliser les 5 par d√©faut\r\n        if (demoQuestions.length === 0) {\r\n            console.log('üì¶ Utilisation questions par d√©faut (aucune en localStorage)');\r\n            demoQuestions = [\r\n                {\r\n                    id: 'demo-1',\r\n                    question: 'Quelle est la vitesse maximale autoris√©e sur une autoroute au Qu√©bec ?',\r\n                    options: [\r\n                        { id: 'A', text: '100 km/h', correct: false },\r\n                        { id: 'B', text: '110 km/h', correct: false },\r\n                        { id: 'C', text: '120 km/h', correct: false },\r\n                        { id: 'D', text: '100 km/h (conditions normales)', correct: true }\r\n                    ],\r\n                    explanation: 'La vitesse maximale sur autoroute au Qu√©bec est de 100 km/h, sauf indication contraire.',\r\n                    reference: 'Code de la s√©curit√© routi√®re du Qu√©bec',\r\n                    tags: ['vitesse', 'autoroute']\r\n                },\r\n                {\r\n                    id: 'demo-2',\r\n                    question: '√Ä quelle distance minimale devez-vous vous arr√™ter derri√®re un autobus scolaire dont les feux clignotent ?',\r\n                    options: [\r\n                        { id: 'A', text: '3 m√®tres', correct: false },\r\n                        { id: 'B', text: '5 m√®tres', correct: true },\r\n                        { id: 'C', text: '10 m√®tres', correct: false },\r\n                        { id: 'D', text: '15 m√®tres', correct: false }\r\n                    ],\r\n                    explanation: 'Vous devez vous arr√™ter √† au moins 5 m√®tres d\\'un autobus scolaire.',\r\n                    reference: 'Article 460 CSR',\r\n                    tags: ['autobus', 's√©curit√©']\r\n                },\r\n                {\r\n                    id: 'demo-3',\r\n                    question: 'Quel est le taux d\\'alcool√©mie maximal pour conduire au Qu√©bec ?',\r\n                    options: [\r\n                        { id: 'A', text: '0.05', correct: false },\r\n                        { id: 'B', text: '0.08', correct: true },\r\n                        { id: 'C', text: '0.10', correct: false },\r\n                        { id: 'D', text: '0.00', correct: false }\r\n                    ],\r\n                    explanation: 'Le taux maximal est de 0.08 pour conducteurs exp√©riment√©s.',\r\n                    reference: 'Code criminel du Canada',\r\n                    tags: ['alcool', 's√©curit√©']\r\n                },\r\n                {\r\n                    id: 'demo-4',\r\n                    question: 'Combien de points d\\'inaptitude entra√Æne un exc√®s de vitesse de 30 km/h ?',\r\n                    options: [\r\n                        { id: 'A', text: '2 points', correct: false },\r\n                        { id: 'B', text: '3 points', correct: true },\r\n                        { id: 'C', text: '4 points', correct: false },\r\n                        { id: 'D', text: '5 points', correct: false }\r\n                    ],\r\n                    explanation: 'Un exc√®s de 21 √† 30 km/h entra√Æne 3 points.',\r\n                    reference: 'SAAQ',\r\n                    tags: ['vitesse', 'points']\r\n                },\r\n                {\r\n                    id: 'demo-5',\r\n                    question: 'Quelle est la distance de s√©curit√© recommand√©e entre v√©hicules ?',\r\n                    options: [\r\n                        { id: 'A', text: '1 seconde', correct: false },\r\n                        { id: 'B', text: '2 secondes', correct: true },\r\n                        { id: 'C', text: '3 secondes', correct: false },\r\n                        { id: 'D', text: '5 secondes', correct: false }\r\n                    ],\r\n                    explanation: 'La r√®gle des 2 secondes est recommand√©e.',\r\n                    reference: 'Guide SAAQ',\r\n                    tags: ['distance', 's√©curit√©']\r\n                }\r\n            ];\r\n        }\r\n        \r\n        console.log(`‚úÖ ${demoQuestions.length} questions d√©mo charg√©es pour le quiz`);\r\n        return demoQuestions;\r\n    }\r\n\r\n    try {\r\n        // 1) Essayer avec mois num√©rique (sch√©ma actuel de l'admin)\r\n        let q1 = query(\r\n            collection(db, 'questions'),\r\n            where('module', '==', moduleId),\r\n            where('month', '==', monthNumber),\r\n            where('year', '==', year)\r\n        );\r\n        let snap = await getDocs(q1);\r\n        if (!snap.empty) {\r\n            const res = [];\r\n            snap.forEach((d) => res.push(toQuestionObjects(d)));\r\n            console.log(`‚úÖ ${res.length} questions (mois num√©rique)`);\r\n            return res;\r\n        }\r\n\r\n        // 2) R√©tro-compatibilit√©: essayer avec mois texte (ex: \"Novembre\")\r\n        const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];\r\n        const monthText = monthNames[monthNumber - 1];\r\n        const normalizedMonth = monthText.charAt(0).toUpperCase() + monthText.slice(1).toLowerCase();\r\n\r\n        let q2 = query(\r\n            collection(db, 'questions'),\r\n            where('module', '==', moduleId),\r\n            where('month', '==', normalizedMonth),\r\n            where('year', '==', year)\r\n        );\r\n        snap = await getDocs(q2);\r\n        if (!snap.empty) {\r\n            const res = [];\r\n            snap.forEach((d) => res.push(toQuestionObjects(d)));\r\n            console.log(`‚úÖ ${res.length} questions (mois texte)`);\r\n            return res;\r\n        }\r\n\r\n        console.warn('‚ö†Ô∏è Aucune question trouv√©e pour ces crit√®res (num√©rique/texte)');\r\n        return [];\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur lors du chargement des questions:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n// Fallback Demo: charger depuis un JSON local lorsque le Mode D√©mo est actif\r\nasync function loadDemoQuestions(moduleId, monthNumber, year) {\r\n    try {\r\n        const resp = await fetch('/test-questions-valides.json');\r\n        if (!resp.ok) return [];\r\n        const data = await resp.json();\r\n        const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];\r\n        const monthText = monthNames[monthNumber - 1];\r\n\r\n        const filtered = data.filter(q => q.module === moduleId && q.year === year && (q.month === monthText || q.month === monthNumber));\r\n        return filtered.map((q, idx) => ({\r\n            id: `demo-${moduleId}-${idx}`,\r\n            question: q.question,\r\n            options: q.options.map((opt, index) => ({\r\n                id: String.fromCharCode(65 + index),\r\n                text: opt,\r\n                correct: index === q.correctAnswer\r\n            })),\r\n            explanation: q.explanation || 'Pas d\\'explication disponible',\r\n            reference: q.reference || '',\r\n            tags: q.tags || []\r\n        }));\r\n    } catch (e) {\r\n        console.warn('Demo questions fallback error:', e);\r\n        return [];\r\n    }\r\n}\r\n\r\n// **FONCTION MODIFI√âE** : Initialiser le quiz avec chargement Firestore\r\nexport async function startQuiz(moduleId) {\r\n    const config = moduleConfig[moduleId];\r\n    if (!config) {\r\n        console.error('Module de quiz non trouv√©:', moduleId);\r\n        toast.error('Module non trouv√©. Veuillez r√©essayer.');\r\n        return;\r\n    }\r\n    \r\n    // Afficher un √©cran de chargement avec toast\r\n    const loadingToast = showLoadingToast(`Chargement du quiz ${config.label}...`);\r\n    showLoadingScreen(config.label);\r\n    \r\n    try {\r\n        // D√©terminer le mois (num√©rique) et l'ann√©e actuels\r\n        // ‚úÖ CORRECTION SECTION 2 : Utiliser les utilitaires de mois pour normalisation\r\n        const { getCurrentMonthNumber, getCurrentYear, normalizeMonthFormat } = await import('./month-utils.js');\r\n        const monthNumber = getCurrentMonthNumber();\r\n        const year = getCurrentYear();\r\n        // Normaliser le format du mois pour garantir la coh√©rence avec le dashboard\r\n        // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n        const normalizedMonth = normalizeMonthFormat(monthNumber, year);\r\n        setCurrentMonth(normalizedMonth);\r\n        setCurrentYear(year);\r\n        setCurrentModule(moduleId);\r\n        \r\n    // Indiquer qu'un quiz est en cours (utilis√© pour confirmations de navigation)\r\n    try { window.__QUIZ_ACTIVE = true; } catch (e) {}\r\n\r\n    // Charger les questions depuis Firestore (num√©rique/texte)\r\n        let questions = await loadQuizFromFirestore(moduleId, monthNumber, year);\r\n\r\n        // En mode D√©mo, si aucune question en base, charger depuis JSON local\r\n        if (questions.length === 0 && isDemoMode()) {\r\n            console.log('‚ÑπÔ∏è Mode D√©mo: chargement des questions locales de test');\r\n            questions = await loadDemoQuestions(moduleId, monthNumber, year);\r\n        }\r\n        \r\n        if (questions.length === 0) {\r\n            hideLoadingScreen();\r\n            updateLoadingToast(loadingToast, 'Aucune question disponible', 'error');\r\n            // ‚úÖ CORRECTION SECTION 2 : currentMonth est d√©j√† normalis√© (format \"Novembre 2025\")\r\n            const currentMonth = getCurrentMonth();\r\n            toast.error(`Aucune question trouv√©e pour ${config.label} en ${currentMonth}.\\n\\nContactez l'administrateur.`, 5000);\r\n            return;\r\n        }\r\n        \r\n        // Cr√©er l'objet quiz\r\n        // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n        const currentMonth = getCurrentMonth();\r\n        setCurrentQuiz({\r\n            // ‚úÖ CORRECTION SECTION 2 : currentMonth est d√©j√† normalis√© (format \"Novembre 2025\")\r\n            name: `Quiz ${config.label} - ${currentMonth}`,\r\n            module: config.name,\r\n            color: config.color,\r\n            questions: questions\r\n        });\r\n        \r\n        // R√©initialiser l'√©tat\r\n        setCurrentQuestionIndex(0);\r\n        setUserAnswers([]);\r\n        setStartTime(Date.now());\r\n        setQuestionStartTime(Date.now());\r\n        \r\n        // ‚úÖ CORRECTION SECTION 9 : Tracker le d√©but du quiz\r\n        trackQuizStart(moduleId, getCurrentMonth());\r\n        setCurrentStreak(0);\r\n        setIsPaused(false);\r\n        setPausedDuration(0);\r\n        setPauseStartedAt(null);\r\n        setHasCurrentQuestionBeenAnswered(false);\r\n        \r\n        // Cacher l'√©cran de chargement et d√©marrer\r\n    hideLoadingScreen();\r\n    showQuizView();\r\n        renderQuestion();\r\n        startTimer();\r\n        updateScoreDisplay();\r\n        updateProgressBar(); // ‚úÖ CORRECTION: Mettre √† jour la barre de progression au d√©marrage\r\n        \r\n        // Toast de succ√®s\r\n        updateLoadingToast(loadingToast, `${questions.length} questions charg√©es !`, 'success');\r\n        \r\n    } catch (error) {\r\n        stopTimer(); // ‚úÖ CORRECTION SECTION 3 : Nettoyer le timer en cas d'erreur\r\n        hideLoadingScreen();\r\n        console.error('‚ùå Erreur lors du d√©marrage du quiz:', error);\r\n        updateLoadingToast(loadingToast, 'Erreur de chargement', 'error');\r\n        toast.error('Erreur lors du chargement du quiz. Veuillez r√©essayer.', 4000);\r\n    }\r\n}\r\n\r\n// √âcran de chargement\r\nfunction showLoadingScreen(moduleName) {\r\n    const quizView = getOrCreateQuizView();\r\n    // ‚úÖ FIX: Pr√©server le bandeau en l'ajoutant avant le contenu\r\n    quizView.innerHTML = `\r\n        <!-- Banni√®re de Marque Avantage Plus -->\r\n        <div class=\"brand-banner\">\r\n            <img src=\"assets/images/logos/Bandeau AVEX.png\" alt=\"Protection M√©canique Exceptionnelle - Avantage Plus\" class=\"banner-image\">\r\n        </div>\r\n        <div class=\"min-h-screen flex items-center justify-center\">\r\n            <div class=\"text-center\">\r\n                <div class=\"animate-spin rounded-full h-16 w-16 border-b-4 border-ap-red-primary mx-auto mb-6\"></div>\r\n                        <h2 class=\"text-2xl font-bold text-slate-900 mb-2\">Chargement du quiz ${escapeHtml(moduleName)}</h2>\r\n                <p class=\"text-slate-600\">R√©cup√©ration des questions...</p>\r\n            </div>\r\n        </div>\r\n    `;\r\n    quizView.classList.remove('view-hidden');\r\n}\r\n\r\nfunction hideLoadingScreen() {\r\n    // L'√©cran sera remplac√© par le contenu du quiz\r\n}\r\n\r\n// Afficher la vue du quiz\r\nfunction showQuizView() {\r\n    document.getElementById('dashboard-view')?.classList.add('view-hidden');\r\n    document.getElementById('module-selection-view')?.classList.add('view-hidden');\r\n    document.getElementById('login-view')?.classList.add('view-hidden');\r\n    \r\n    const quizView = getOrCreateQuizView();\r\n    quizView.classList.remove('view-hidden');\r\n}\r\n\r\nfunction getOrCreateQuizView() {\r\n    let quizView = document.getElementById('quiz-view');\r\n    if (!quizView) {\r\n        quizView = document.createElement('div');\r\n        quizView.id = 'quiz-view';\r\n        quizView.style.cssText = 'margin: 0; padding: 0; width: 100%; height: 100%;';\r\n        \r\n        // ‚úÖ Ajouter la banni√®re de marque Avantage Plus au d√©but de la vue quiz\r\n        const banner = document.createElement('div');\r\n        banner.className = 'brand-banner';\r\n        banner.innerHTML = `<img src=\"assets/images/logos/Bandeau AVEX.png\" alt=\"Protection M√©canique Exceptionnelle - Avantage Plus\" class=\"banner-image\">`;\r\n        quizView.appendChild(banner);\r\n        \r\n        document.querySelector('main').appendChild(quizView);\r\n    }\r\n    initializeQuizEventDelegation(quizView);\r\n    return quizView;\r\n}\r\n\r\nfunction initializeQuizEventDelegation(quizView) {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    if (getQuizEventDelegationInitialized() || !quizView) {\r\n        return;\r\n    }\r\n\r\n    quizView.addEventListener('click', (event) => {\r\n        const optionButton = event.target.closest('.option-button');\r\n        if (optionButton && !optionButton.disabled) {\r\n            const optionId = optionButton.dataset.optionId;\r\n            if (optionId) {\r\n                handleAnswer(optionId);\r\n            }\r\n            return;\r\n        }\r\n\r\n        const nextButton = event.target.closest('#next-question-btn');\r\n        if (nextButton) {\r\n            event.preventDefault();\r\n            nextQuestion();\r\n            return;\r\n        }\r\n\r\n        const quitButton = event.target.closest('#quit-quiz-btn');\r\n        if (quitButton) {\r\n            event.preventDefault();\r\n            if (confirm('Voulez-vous vraiment quitter le quiz ? Votre progression sera perdue.')) {\r\n                returnToDashboard();\r\n            }\r\n            return;\r\n        }\r\n\r\n        const focusButton = event.target.closest('#focus-mode-btn');\r\n        if (focusButton) {\r\n            event.preventDefault();\r\n            toggleFocusMode();\r\n            return;\r\n        }\r\n\r\n        const pauseButton = event.target.closest('#pause-btn');\r\n        if (pauseButton) {\r\n            event.preventDefault();\r\n            togglePause();\r\n            return;\r\n        }\r\n    });\r\n\r\n    setQuizEventDelegationInitialized(true);\r\n}\r\n\r\n// Rendre la question actuelle\r\nfunction renderQuestion() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    const currentQuiz = getCurrentQuiz();\r\n    const currentQuestionIndex = getCurrentQuestionIndex();\r\n    const question = currentQuiz.questions[currentQuestionIndex];\r\n    const quizView = document.getElementById('quiz-view');\r\n    const colorScheme = moduleColors[currentQuiz.color];\r\n    setHasCurrentQuestionBeenAnswered(false);\r\n    \r\n    quizView.innerHTML = `\r\n        <!-- Banni√®re de Marque Avantage Plus -->\r\n        <div class=\"brand-banner\">\r\n            <img src=\"assets/images/logos/Bandeau AVEX.png\" alt=\"Protection M√©canique Exceptionnelle - Avantage Plus\" class=\"banner-image\">\r\n        </div>\r\n        <!-- En-t√™te du quiz -->\r\n        <div class=\"bg-white border-b border-gray-200 shadow-sm\">\r\n            <div class=\"max-w-5xl mx-auto px-6 py-4\">\r\n                <div class=\"flex items-center justify-between\">\r\n                    <div>\r\n                        <h1 class=\"text-xl font-bold text-slate-900\">${escapeHtml(currentQuiz.name)}</h1>\r\n                        <p class=\"text-sm text-slate-500\">Question ${currentQuestionIndex + 1} sur ${currentQuiz.questions.length}</p>\r\n                    </div>\r\n                    <div class=\"flex items-center gap-6\">\r\n                        <button id=\"focus-mode-btn\" class=\"text-sm font-medium text-slate-600 hover:text-slate-900 flex items-center gap-1\" aria-pressed=\"false\" aria-label=\"Activer le mode focus\">\r\n                            <svg aria-hidden=\"true\" class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"></path>\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\"></path>\r\n                            </svg>\r\n                            Focus\r\n                        </button>\r\n                        <button id=\"pause-btn\" class=\"text-sm font-medium text-slate-600 hover:text-slate-900 flex items-center gap-1\" aria-pressed=\"false\" aria-label=\"Mettre le quiz en pause\">\r\n                            <svg aria-hidden=\"true\" class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                            </svg>\r\n                            Pause\r\n                        </button>\r\n                        <div class=\"flex items-center gap-2\">\r\n                            <svg class=\"w-5 h-5 text-ap-red-primary\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                            </svg>\r\n                            <span id=\"quiz-score\" class=\"text-sm font-bold text-ap-red-primary\">Score: 0%</span>\r\n                        </div>\r\n                        <div class=\"flex items-center gap-2\">\r\n                            <svg class=\"w-5 h-5 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                            </svg>\r\n                            <span id=\"quiz-timer\" class=\"text-sm font-medium text-slate-600\">0:00</span>\r\n                        </div>\r\n                        <button id=\"quit-quiz-btn\" class=\"text-sm font-medium text-slate-600 hover:text-slate-900\">\r\n                            Quitter\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Barre de progression - ROUGE AVANTAGE PLUS PROFESSIONNEL AVEC ANIMATIONS -->\r\n                <div class=\"mt-4 w-full bg-gray-300 rounded-full h-5 overflow-hidden border-2 border-gray-700 shadow-lg relative\" style=\"background-color: #D1D5DB !important; border-color: #374151 !important; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);\">\r\n                    <div id=\"quiz-progress-bar\" class=\"h-full rounded-full transition-all duration-600 ease-out relative overflow-hidden\" style=\"background: linear-gradient(135deg, #C41E3A 0%, #A01A2E 50%, #8B1429 100%) !important; width: ${Math.max(0, Math.min(100, ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100))}%; box-shadow: 0 2px 8px rgba(196, 30, 58, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);\">\r\n                        <div class=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer\" style=\"animation: shimmer 2s infinite; transform: translateX(-100%);\"></div>\r\n                    </div>\r\n                    <div id=\"quiz-progress-percent\" class=\"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold text-gray-700 pointer-events-none\" style=\"z-index: 10;\">${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%</div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Contenu de la question -->\r\n        <div class=\"max-w-5xl mx-auto px-6 py-8\">\r\n            <div class=\"bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden\">\r\n                \r\n                <!-- En-t√™te de question -->\r\n                <div class=\"px-8 py-6 bg-gradient-to-r from-slate-50 to-white border-b border-gray-100\">\r\n                    <div class=\"mb-4\">\r\n                        <span class=\"text-sm font-medium ${colorScheme.text}\">Question ${currentQuestionIndex + 1} sur ${currentQuiz.questions.length}</span>\r\n                    </div>\r\n                    \r\n                    <h2 class=\"text-2xl font-bold text-slate-900 leading-relaxed\">\r\n                        ${escapeHtml(question.question)}\r\n                    </h2>\r\n                    \r\n                    <!-- Tags -->\r\n                    ${question.tags && question.tags.length > 0 ? `\r\n                        <div class=\"flex flex-wrap gap-2 mt-4\">\r\n                            ${question.tags.map(tag => `\r\n                                <span class=\"px-3 py-1 bg-slate-100 text-slate-600 text-xs font-medium rounded-full\">\r\n                                    ${escapeHtml(tag)}\r\n                                </span>\r\n                            `).join('')}\r\n                        </div>\r\n                    ` : ''}\r\n                </div>\r\n\r\n                <!-- Options de r√©ponse -->\r\n                <div class=\"p-8\">\r\n                    <div class=\"space-y-3\">\r\n                        ${question.options.map(option => `\r\n                            <button data-option-id=\"${escapeHtml(option.id)}\" \r\n                                    class=\"option-button w-full text-left px-6 py-5 rounded-xl border-2 border-gray-200 hover:border-ap-red-primary hover:bg-ap-red-50 transition-all duration-200 group\">\r\n                                <div class=\"flex items-center gap-4\">\r\n                                    <div class=\"flex-shrink-0 w-10 h-10 rounded-lg bg-ap-red-100 flex items-center justify-center group-hover:bg-ap-red-primary group-hover:text-white transition-all\">\r\n                                        <span class=\"text-lg font-bold text-ap-red-primary group-hover:text-white\">${escapeHtml(option.id)}</span>\r\n                                    </div>\r\n                                    <span class=\"text-lg text-slate-700 group-hover:text-slate-900 font-medium\">\r\n                                        ${escapeHtml(option.text)}\r\n                                    </span>\r\n                                </div>\r\n                            </button>\r\n                        `).join('')}\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Zone d'explication (cach√©e initialement) -->\r\n                <div id=\"explanation-area\" class=\"hidden px-8 py-6 bg-slate-50 border-t border-gray-200\">\r\n                    <!-- Sera rempli apr√®s la r√©ponse -->\r\n                </div>\r\n\r\n                <!-- Bouton suivant (cach√© initialement) -->\r\n                <div id=\"next-button-area\" class=\"hidden px-8 py-6 border-t border-gray-200\">\r\n                    <div class=\"flex justify-between items-center\">\r\n                        <p class=\"text-sm text-slate-500\">Question suivante dans quelques secondes...</p>\r\n                        <button id=\"next-question-btn\" class=\"bg-ap-red-primary hover:bg-ap-red-dark text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-ap-md hover:shadow-ap-lg transform hover:-translate-y-1\">\r\n                            Question suivante\r\n                            <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 7l5 5m0 0l-5 5m5-5H6\"></path>\r\n                            </svg>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n    updateScoreDisplay();\r\n    updateProgressBar();\r\n}\r\n\r\n// Mettre √† jour la barre de progression\r\nfunction updateProgressBar() {\r\n    const currentQuiz = getCurrentQuiz();\r\n    if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) {\r\n        return;\r\n    }\r\n    \r\n    const currentQuestionIndex = getCurrentQuestionIndex();\r\n    const totalQuestions = currentQuiz.questions.length;\r\n    \r\n    // Calculer le pourcentage (s√©curis√©)\r\n    const progressPercent = Math.max(0, Math.min(100, ((currentQuestionIndex + 1) / totalQuestions) * 100));\r\n    \r\n    const progressBar = document.getElementById('quiz-progress-bar');\r\n    const progressPercentElement = document.getElementById('quiz-progress-percent');\r\n    \r\n    if (progressBar) {\r\n        progressBar.style.width = `${progressPercent}%`;\r\n        // ‚úÖ CORRECTION: Forcer le style rouge pour garantir la visibilit√©\r\n        progressBar.style.background = 'linear-gradient(135deg, #C41E3A 0%, #A01A2E 50%, #8B1429 100%)';\r\n        progressBar.style.setProperty('background', 'linear-gradient(135deg, #C41E3A 0%, #A01A2E 50%, #8B1429 100%)', 'important');\r\n        \r\n        // Mettre √† jour le pourcentage affich√©\r\n        if (progressPercentElement) {\r\n            progressPercentElement.textContent = `${Math.round(progressPercent)}%`;\r\n        }\r\n        \r\n        console.log(`üìä Barre de progression mise √† jour: ${progressPercent.toFixed(1)}% (Question ${currentQuestionIndex + 1}/${totalQuestions})`);\r\n    }\r\n}\r\n\r\n// G√©rer la r√©ponse de l'utilisateur\r\nfunction handleAnswer(optionId) {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    if (getHasCurrentQuestionBeenAnswered()) {\r\n        return;\r\n    }\r\n    const currentQuiz = getCurrentQuiz();\r\n    const currentQuestionIndex = getCurrentQuestionIndex();\r\n    const questionStartTime = getQuestionStartTime();\r\n    const question = currentQuiz.questions[currentQuestionIndex];\r\n    const selectedOption = question.options.find(opt => opt.id === optionId);\r\n    const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);\r\n    setHasCurrentQuestionBeenAnswered(true);\r\n    \r\n    // Enregistrer la r√©ponse\r\n    const userAnswers = getUserAnswers();\r\n    userAnswers.push({\r\n        questionId: question.id,\r\n        question: question.question,\r\n        selectedAnswer: optionId,\r\n        correctAnswer: question.options.find(opt => opt.correct).id,\r\n        isCorrect: selectedOption.correct,\r\n        timeSpent: timeSpent\r\n    });\r\n    setUserAnswers(userAnswers);\r\n    \r\n    // Mettre √† jour le streak\r\n    let currentStreak = getCurrentStreak();\r\n    if (selectedOption.correct) {\r\n        currentStreak++;\r\n    } else {\r\n        currentStreak = 0;\r\n    }\r\n    setCurrentStreak(currentStreak);\r\n    \r\n    // D√©sactiver tous les boutons\r\n    document.querySelectorAll('.option-button').forEach(btn => {\r\n        btn.disabled = true;\r\n        btn.classList.remove('hover:border-ap-red-primary', 'hover:bg-ap-red-50');\r\n    });\r\n    \r\n    // Afficher le r√©sultat\r\n    showAnswerFeedback(optionId, selectedOption.correct, question);\r\n    \r\n    // Mettre √† jour le score\r\n    updateScoreDisplay();\r\n    \r\n    // Passer √† la question suivante apr√®s un d√©lai\r\n    setTimeout(() => {\r\n        document.getElementById('next-button-area')?.classList.remove('hidden');\r\n    }, 1000);\r\n}\r\n\r\n// Afficher le feedback de la r√©ponse\r\nfunction showAnswerFeedback(selectedId, isCorrect, question) {\r\n    // ‚úÖ CORRECTION : Utiliser StateManager pour currentQuiz\r\n    const currentQuiz = getCurrentQuiz();\r\n    const colorScheme = moduleColors[currentQuiz.color];\r\n    const correctOption = question.options.find(opt => opt.correct);\r\n    \r\n    // Colorier les options\r\n    document.querySelectorAll('.option-button').forEach(btn => {\r\n        const optId = btn.dataset.optionId;\r\n        \r\n        if (optId === correctOption.id) {\r\n            // Bonne r√©ponse en vert\r\n            btn.classList.add('border-green-500', 'bg-green-50');\r\n            btn.classList.remove('border-gray-200');\r\n        } else if (optId === selectedId && !isCorrect) {\r\n            // Mauvaise r√©ponse en rouge\r\n            btn.classList.add('border-red-500', 'bg-red-50');\r\n            btn.classList.remove('border-gray-200');\r\n        }\r\n    });\r\n    \r\n    // Afficher l'explication\r\n    const explanationArea = document.getElementById('explanation-area');\r\n    if (explanationArea) {\r\n        explanationArea.innerHTML = `\r\n            <div class=\"flex items-start gap-4\">\r\n                ${isCorrect ? \r\n                    '<div class=\"flex-shrink-0 w-12 h-12 rounded-full bg-green-100 flex items-center justify-center\"><svg class=\"w-6 h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"></path></svg></div>' :\r\n                    '<div class=\"flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center\"><svg class=\"w-6 h-6 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path></svg></div>'\r\n                }\r\n                <div class=\"flex-1\">\r\n                    <h3 class=\"text-lg font-bold ${isCorrect ? 'text-green-700' : 'text-red-700'} mb-2\">\r\n                        ${isCorrect ? '‚úÖ Bonne r√©ponse !' : '‚ùå R√©ponse incorrecte'}\r\n                    </h3>\r\n                    <p class=\"text-slate-700 mb-2\"><strong>Explication :</strong> ${escapeHtml(question.explanation)}</p>\r\n                    ${question.reference ? `<p class=\"text-sm text-slate-500\"><strong>R√©f√©rence :</strong> ${escapeHtml(question.reference)}</p>` : ''}\r\n                </div>\r\n            </div>\r\n        `;\r\n        explanationArea.classList.remove('hidden');\r\n    }\r\n}\r\n\r\n// Passer √† la question suivante\r\nfunction nextQuestion() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    setQuestionStartTime(Date.now());\r\n    const currentQuestionIndex = getCurrentQuestionIndex();\r\n    setCurrentQuestionIndex(currentQuestionIndex + 1);\r\n    \r\n    const currentQuiz = getCurrentQuiz();\r\n    const newIndex = getCurrentQuestionIndex();\r\n    if (newIndex < currentQuiz.questions.length) {\r\n        renderQuestion();\r\n        // ‚úÖ CORRECTION: Mettre √† jour la barre de progression explicitement\r\n        updateProgressBar();\r\n    } else {\r\n        showResults();\r\n    }\r\n}\r\n\r\n// Afficher les r√©sultats finaux\r\nasync function showResults() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    stopTimer();\r\n    try { window.__QUIZ_ACTIVE = false; } catch (e) {}\r\n    \r\n    const userAnswers = getUserAnswers();\r\n    // ‚úÖ CORRECTION SECTION 2 : Validation avant calcul du score pour √©viter division par z√©ro\r\n    if (userAnswers.length === 0) {\r\n        console.error('‚ùå Aucune r√©ponse enregistr√©e - quiz invalide');\r\n        toast.error('Aucune r√©ponse enregistr√©e. Le quiz ne peut pas √™tre compl√©t√©.');\r\n        return;\r\n    }\r\n    \r\n    // ‚úÖ P0 CRITIQUE: Utiliser la fonction de calcul de score testable\r\n    const { calculateScore: calculateQuizScore } = await import('./utils/quiz-scoring.js');\r\n    const score = calculateQuizScore(userAnswers);\r\n    \r\n    // ‚úÖ CORRECTION SECTION 2 : Validation du score calcul√©\r\n    if (isNaN(score) || score < 0 || score > 100) {\r\n        console.error('‚ùå Score invalide calcul√©:', score);\r\n        toast.error('Erreur de calcul du score. Contactez le support.');\r\n        return;\r\n    }\r\n    const pausedDuration = getPausedDuration();\r\n    const isPaused = getIsPaused();\r\n    const pauseStartedAt = getPauseStartedAt();\r\n    let pausedOffset = pausedDuration;\r\n    if (isPaused && pauseStartedAt) {\r\n        pausedOffset += Date.now() - pauseStartedAt;\r\n    }\r\n    const startTime = getStartTime();\r\n    const totalTime = Math.max(0, Math.floor((Date.now() - startTime - pausedOffset) / 1000));\r\n    setIsPaused(false);\r\n    setPauseStartedAt(null);\r\n    setPausedDuration(0);\r\n    const minutes = Math.floor(totalTime / 60);\r\n    const seconds = totalTime % 60;\r\n    \r\n    // Sauvegarder dans Firestore\r\n    saveQuizToFirestore(score, totalTime);\r\n    \r\n    // ‚úÖ CORRECTION : Utiliser StateManager pour currentQuiz\r\n    const currentQuiz = getCurrentQuiz();\r\n    if (!currentQuiz) {\r\n        console.error('‚ùå currentQuiz non d√©fini dans showResults');\r\n        toast.error('Erreur: Impossible d\\'afficher les r√©sultats. Veuillez r√©essayer.');\r\n        return;\r\n    }\r\n    \r\n    const colorScheme = moduleColors[currentQuiz.color];\r\n    const quizView = document.getElementById('quiz-view');\r\n    \r\n    quizView.innerHTML = `\r\n        <!-- Banni√®re de Marque Avantage Plus -->\r\n        <div class=\"brand-banner\">\r\n            <img src=\"assets/images/logos/Bandeau AVEX.png\" alt=\"Protection M√©canique Exceptionnelle - Avantage Plus\" class=\"banner-image\">\r\n        </div>\r\n        <div class=\"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 py-12 px-4\">\r\n            <div class=\"max-w-4xl mx-auto\">\r\n                <!-- Carte de r√©sultat principale -->\r\n                <div class=\"bg-white rounded-3xl shadow-2xl overflow-hidden mb-8 border-t-4 border-ap-gold\">\r\n                    <!-- Header avec score - GRADIENT AVANTAGE PLUS -->\r\n                    <div class=\"px-8 py-12 text-center text-white\" style=\"background: ${score >= 80 ? 'linear-gradient(135deg, #28A745 0%, #D4AF37 100%)' : 'var(--ap-gradient-primary)'};\">\r\n                        <h1 class=\"text-4xl font-bold mb-4\">Quiz Termin√© ! üéâ</h1>\r\n                        <div class=\"text-8xl font-bold mb-4\" style=\"text-shadow: 0 4px 20px rgba(0,0,0,0.2);\">${score}%</div>\r\n                        <p class=\"text-xl opacity-90\">${userAnswers.filter(a => a.isCorrect).length} / ${userAnswers.length} bonnes r√©ponses</p>\r\n                        <p class=\"text-lg opacity-75 mt-2\">Temps total : ${minutes}:${seconds.toString().padStart(2, '0')}</p>\r\n                    </div>\r\n                    \r\n                    <!-- Message de feedback -->\r\n                    <div class=\"px-8 py-8 text-center border-b border-gray-200\">\r\n                        ${score >= 90 ? \r\n                            '<h2 class=\"text-3xl font-bold text-green-600 mb-2\">üèÜ Excellent !</h2><p class=\"text-slate-600 text-lg\">Performance exceptionnelle ! Vous ma√Ætrisez parfaitement ce module.</p>' :\r\n                        score >= 75 ?\r\n                            '<h2 class=\"text-3xl font-bold text-blue-600 mb-2\">üëè Tr√®s bien !</h2><p class=\"text-slate-600 text-lg\">Bon travail ! Quelques r√©visions et vous serez au top.</p>' :\r\n                        score >= 60 ?\r\n                            '<h2 class=\"text-3xl font-bold text-yellow-600 mb-2\">üìö Pas mal !</h2><p class=\"text-slate-600 text-lg\">C\\'est un bon d√©but. Continuez √† r√©viser pour am√©liorer votre score.</p>' :\r\n                            '<h2 class=\"text-3xl font-bold text-red-600 mb-2\">üí™ Continuez !</h2><p class=\"text-slate-600 text-lg\">Ne vous d√©couragez pas. R√©visez les points faibles et r√©essayez !</p>'\r\n                        }\r\n                    </div>\r\n                    \r\n                    <!-- D√©tails des r√©ponses -->\r\n                    <div class=\"px-8 py-6\">\r\n                        <h3 class=\"text-xl font-bold text-slate-900 mb-4\">D√©tails de vos r√©ponses :</h3>\r\n                        <div class=\"space-y-3 max-h-96 overflow-y-auto\">\r\n                            ${userAnswers.map((answer, index) => `\r\n                                <div class=\"flex items-center justify-between p-4 rounded-lg ${answer.isCorrect ? 'bg-green-50' : 'bg-red-50'}\">\r\n                                    <div class=\"flex items-center gap-3 flex-1\">\r\n                                        <span class=\"${answer.isCorrect ? 'text-green-600' : 'text-red-600'} text-2xl\">\r\n                                            ${answer.isCorrect ? '‚úÖ' : '‚ùå'}\r\n                                        </span>\r\n                                        <div class=\"flex-1\">\r\n                                            <p class=\"font-medium text-slate-900\">Question ${index + 1}</p>\r\n                                            <p class=\"text-sm text-slate-600\">${answer.question}</p>\r\n                                            ${!answer.isCorrect ? `<p class=\"text-xs text-slate-500 mt-1\">Votre r√©ponse : ${answer.selectedAnswer} | Correcte : ${answer.correctAnswer}</p>` : ''}\r\n                                        </div>\r\n                                    </div>\r\n                                    <span class=\"text-sm text-slate-500\">${answer.timeSpent}s</span>\r\n                                </div>\r\n                            `).join('')}\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Boutons d'action -->\r\n                    <div class=\"px-8 py-6 flex gap-4\">\r\n                        <button id=\"retry-quiz-btn\" class=\"flex-1 bg-ap-red-primary hover:bg-ap-red-dark text-white px-6 py-3 rounded-xl font-semibold transition-all transform hover:-translate-y-1 shadow-ap-md hover:shadow-ap-lg\">\r\n                            Refaire le quiz\r\n                        </button>\r\n                        <button id=\"return-dashboard-btn\" class=\"flex-1 border-2 border-ap-red-primary text-ap-red-primary px-6 py-3 rounded-xl font-semibold hover:bg-ap-red-50 transition-all\">\r\n                            Retour au tableau de bord\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n    \r\n    // Confettis si bon score\r\n    if (score >= 80) {\r\n        setTimeout(() => launchConfetti(), 500);\r\n    }\r\n    \r\n    // ‚úÖ CORRECTION SECTION 9 : Tracker la fin du quiz\r\n    // currentQuiz est d√©j√† d√©fini plus haut dans la fonction\r\n    const quizTotalTime = Math.floor((Date.now() - getStartTime()) / 1000);\r\n    trackQuizComplete(\r\n        getCurrentModule(),\r\n        score,\r\n        quizTotalTime,\r\n        currentQuiz?.questions?.length || 0\r\n    );\r\n    \r\n    // √âv√©nements\r\n    document.getElementById('retry-quiz-btn')?.addEventListener('click', () => {\r\n        const currentModule = getCurrentModule();\r\n        if (currentModule) {\r\n            startQuiz(currentModule);\r\n        } else {\r\n            toast.error('Erreur: Impossible de red√©marrer le quiz.');\r\n        }\r\n    });\r\n    \r\n    document.getElementById('return-dashboard-btn')?.addEventListener('click', returnToDashboard);\r\n}\r\n\r\n// Sauvegarder le r√©sultat dans Firestore\r\nasync function saveQuizToFirestore(score, totalTime) {\r\n    // ‚úÖ CORRECTION SECTION 3 : Nettoyer le timer en cas d'erreur\r\n    try {\r\n        const user = getCurrentUserUnified();\r\n        if (!user) {\r\n            console.log('Aucun utilisateur - r√©sultat non sauvegard√©');\r\n            stopTimer(); // Nettoyer le timer\r\n            return;\r\n        }\r\n        \r\n        // En mode d√©mo, ne pas sauvegarder dans Firestore\r\n        if (isDemoMode()) {\r\n            console.log('Mode d√©mo - r√©sultat non sauvegard√© dans Firestore');\r\n            toast.info('Mode D√©mo : les r√©sultats ne sont pas sauvegard√©s');\r\n            stopTimer(); // Nettoyer le timer\r\n            return;\r\n        }\r\n        \r\n        // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n        const currentModule = getCurrentModule();\r\n        const currentMonth = getCurrentMonth();\r\n        const currentYear = getCurrentYear();\r\n        const currentQuiz = getCurrentQuiz();\r\n        const userAnswers = getUserAnswers();\r\n        const moduleDetails = moduleConfig[currentModule] || {};\r\n        const quizData = {\r\n            moduleId: currentModule,\r\n            moduleName: moduleDetails.name || currentQuiz.module || currentModule,\r\n            score,\r\n            correctAnswers: userAnswers.filter(a => a.isCorrect).length,\r\n            totalQuestions: currentQuiz.questions.length,\r\n            timeElapsed: totalTime,\r\n            answers: userAnswers,\r\n            month: currentMonth,\r\n            year: currentYear\r\n        };\r\n        \r\n        // ‚úÖ CORRECTION SECTION 3 : Utiliser retry automatique avec notification utilisateur\r\n        await withFirestoreRetry(\r\n            () => saveQuizResult(quizData),\r\n            {\r\n                maxRetries: 3,\r\n                onRetry: (attempt, delay) => {\r\n                    toast.info(`Nouvelle tentative de sauvegarde ${attempt}/3...`, 3000);\r\n                }\r\n            }\r\n        );\r\n        \r\n        toast.success('R√©sultat sauvegard√© avec succ√®s !', 3000);\r\n        console.log('‚úÖ R√©sultat sauvegard√© dans Firestore');\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur lors de la sauvegarde:', error);\r\n        stopTimer(); // ‚úÖ CORRECTION SECTION 3 : Nettoyer le timer en cas d'erreur\r\n        \r\n        // ‚úÖ CORRECTION SECTION 3 : Informer l'utilisateur de l'erreur\r\n        toast.error('Erreur lors de la sauvegarde. Le r√©sultat sera sauvegard√© localement et synchronis√© plus tard.', 8000);\r\n        \r\n        // ‚úÖ CORRECTION SECTION 8 : Utiliser la file d'attente globale\r\n        try {\r\n            // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n            const currentModule = getCurrentModule();\r\n            const currentMonth = getCurrentMonth();\r\n            const currentYear = getCurrentYear();\r\n            const userAnswers = getUserAnswers();\r\n            \r\n            const resultData = {\r\n                moduleId: currentModule,\r\n                moduleName: moduleConfig[currentModule]?.name || currentModule,\r\n                score: score,\r\n                correctAnswers: userAnswers.filter(a => a.isCorrect).length,\r\n                totalQuestions: userAnswers.length,\r\n                timeElapsed: totalTime,\r\n                answers: userAnswers,\r\n                month: currentMonth,\r\n                year: currentYear\r\n            };\r\n            \r\n            // ‚úÖ CORRECTION SECTION 8 : Ajouter √† la file d'attente globale\r\n            const { syncQueue } = await import('./sync-queue.js');\r\n            await syncQueue.add('quizResult', async (data) => {\r\n                await saveQuizResult(data);\r\n            }, resultData);\r\n            \r\n            console.log('‚úÖ R√©sultat ajout√© √† la file d\\'attente de synchronisation');\r\n        } catch (queueError) {\r\n            console.error('‚ùå Erreur ajout √† la file d\\'attente:', queueError);\r\n            // Fallback sur localStorage si IndexedDB n'est pas disponible\r\n            try {\r\n                const queueKey = `quiz_result_${Date.now()}`;\r\n                localStorage.setItem(queueKey, JSON.stringify({\r\n                    score,\r\n                    totalTime,\r\n                    moduleId: getCurrentModule(),\r\n                    month: getCurrentMonth(),\r\n                    year: getCurrentYear(),\r\n                    userAnswers: getUserAnswers(),\r\n                    timestamp: Date.now()\r\n                }));\r\n            } catch (localError) {\r\n                console.error('‚ùå Erreur sauvegarde locale de secours:', localError);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// Timer du quiz\r\nfunction startTimer() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    stopTimer();\r\n    const interval = setInterval(() => {\r\n        const startTime = getStartTime();\r\n        if (startTime === null) {\r\n            return;\r\n        }\r\n\r\n        const pausedDuration = getPausedDuration();\r\n        const isPaused = getIsPaused();\r\n        const pauseStartedAt = getPauseStartedAt();\r\n        let pausedOffset = pausedDuration;\r\n        if (isPaused && pauseStartedAt) {\r\n            pausedOffset += Date.now() - pauseStartedAt;\r\n        }\r\n\r\n        const elapsedMs = Date.now() - startTime - pausedOffset;\r\n        const elapsed = Math.max(0, Math.floor(elapsedMs / 1000));\r\n        const minutes = Math.floor(elapsed / 60);\r\n        const seconds = elapsed % 60;\r\n        const timerElement = document.getElementById('quiz-timer');\r\n        if (timerElement) {\r\n            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;\r\n        }\r\n    }, 1000);\r\n    setTimerInterval(interval);\r\n}\r\n\r\nfunction stopTimer() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    const timerInterval = getTimerInterval();\r\n    if (timerInterval) {\r\n        clearInterval(timerInterval);\r\n        setTimerInterval(null);\r\n    }\r\n    setPauseStartedAt(null);\r\n}\r\n\r\n// ‚úÖ CORRECTION SECTION 3 : Nettoyer le timer sur toutes les sorties (beforeunload, erreurs)\r\n// Nettoyer le timer quand l'utilisateur quitte la page\r\nwindow.addEventListener('beforeunload', () => {\r\n    stopTimer();\r\n});\r\n\r\n// Nettoyer le timer quand la page est cach√©e (onglet inactif)\r\ndocument.addEventListener('visibilitychange', () => {\r\n    if (document.hidden) {\r\n        // Optionnel : on peut aussi nettoyer ici si n√©cessaire\r\n    }\r\n});\r\n\r\n// Mettre √† jour l'affichage du score\r\nasync function updateScoreDisplay() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    const userAnswers = getUserAnswers();\r\n    if (userAnswers.length === 0) return;\r\n    \r\n    // ‚úÖ P0 CRITIQUE: Utiliser la fonction de calcul de score testable\r\n    const { calculateScore } = await import('./utils/quiz-scoring.js');\r\n    const score = calculateScore(userAnswers);\r\n    \r\n    const scoreElement = document.getElementById('quiz-score');\r\n    if (scoreElement) {\r\n        scoreElement.textContent = `Score: ${score}%`;\r\n    }\r\n}\r\n\r\n// Mode focus\r\nfunction toggleFocusMode() {\r\n    document.body.classList.toggle('focus-mode');\r\n}\r\n\r\n// Pause\r\nfunction togglePause() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    const pauseBtn = document.getElementById('pause-btn');\r\n    if (!pauseBtn) {\r\n        return;\r\n    }\r\n\r\n    const isPaused = getIsPaused();\r\n    if (!isPaused) {\r\n        setIsPaused(true);\r\n        setPauseStartedAt(Date.now());\r\n        // ‚úÖ CORRECTION ACCESSIBILIT√â : Mettre √† jour aria-pressed\r\n        pauseBtn.setAttribute('aria-pressed', 'true');\r\n        pauseBtn.setAttribute('aria-label', 'Reprendre le quiz');\r\n        pauseBtn.innerHTML = '<svg aria-hidden=\"true\" class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z\"></path><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg> Reprendre';\r\n        toast.warning('Quiz en pause. Cliquez sur \"Reprendre\" pour continuer.', 3000);\r\n    } else {\r\n        // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n        setIsPaused(false);\r\n        const pauseStartedAt = getPauseStartedAt();\r\n        if (pauseStartedAt) {\r\n            const pausedDuration = getPausedDuration();\r\n            setPausedDuration(pausedDuration + (Date.now() - pauseStartedAt));\r\n        }\r\n        setPauseStartedAt(null);\r\n        // ‚úÖ CORRECTION ACCESSIBILIT√â : Mettre √† jour aria-pressed\r\n        pauseBtn.setAttribute('aria-pressed', 'false');\r\n        pauseBtn.setAttribute('aria-label', 'Mettre le quiz en pause');\r\n        pauseBtn.innerHTML = '<svg aria-hidden=\"true\" class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg> Pause';\r\n        toast.success('Quiz repris !', 2000);\r\n    }\r\n}\r\n\r\n// Retour au dashboard\r\nfunction returnToDashboard() {\r\n    // ‚úÖ CORRECTION SECTION 5 : Utiliser StateManager\r\n    stopTimer();\r\n    try { window.__QUIZ_ACTIVE = false; } catch (e) {}\r\n    setIsPaused(false);\r\n    setPausedDuration(0);\r\n    setPauseStartedAt(null);\r\n    setHasCurrentQuestionBeenAnswered(false);\r\n    document.getElementById('quiz-view')?.classList.add('view-hidden');\r\n    document.getElementById('dashboard-view')?.classList.remove('view-hidden');\r\n    \r\n    // Mettre √† jour la navigation\r\n    document.querySelectorAll('.nav-link').forEach(link => {\r\n        link.classList.remove('bg-ap-red-dark', 'text-white');\r\n        link.classList.add('text-white');\r\n    });\r\n    document.getElementById('nav-dashboard')?.classList.add('bg-ap-red-dark', 'text-white');\r\n    \r\n    // Toast de confirmation\r\n    toast.info('Retour au tableau de bord', 2000);\r\n    \r\n    // ‚úÖ FIX: Recharger les donn√©es du dashboard (sans reload) pour afficher la progression √† jour\r\n    setTimeout(async () => {\r\n        try {\r\n            console.log('üîÑ D√©but rechargement dashboard apr√®s quiz...');\r\n            \r\n            // ‚úÖ CRITIQUE: Invalider TOUT le cache avant de recharger pour forcer la lecture depuis Firestore\r\n            const { invalidateByDataType } = await import('./services/cache-service.js');\r\n            invalidateByDataType('annualProgress');\r\n            invalidateByDataType('monthlyProgress');\r\n            invalidateByDataType('quizResults');\r\n            console.log('üóëÔ∏è Cache invalid√©');\r\n            \r\n            // ‚úÖ Recharger le dashboard avec les nouvelles donn√©es\r\n            const { initializeDashboard } = await import('./dashboard.js');\r\n            if (typeof initializeDashboard === 'function') {\r\n                await initializeDashboard();\r\n                console.log('‚úÖ Dashboard recharg√© apr√®s quiz');\r\n            }\r\n        } catch (error) {\r\n            console.error('‚ùå Erreur rechargement dashboard:', error);\r\n            // Fallback: recharger la page si l'import √©choue\r\n            window.location.reload();\r\n        }\r\n    }, 1500); // ‚úÖ Augment√© de 500ms √† 1500ms pour laisser le temps √† Firestore d'√©crire\r\n}\r\n","/**\r\n * Utilitaires pour le calcul de score et la logique de d√©blocage mensuel\r\n * \r\n * ‚úÖ P0 CRITIQUE: Extraction des fonctions critiques pour tests unitaires\r\n */\r\n\r\n/**\r\n * Calcule le score d'un quiz bas√© sur les r√©ponses de l'utilisateur\r\n * @param {Array} userAnswers - Tableau des r√©ponses de l'utilisateur avec propri√©t√© `isCorrect`\r\n * @returns {number} Score entre 0 et 100, ou 0 si aucune r√©ponse\r\n */\r\nexport function calculateScore(userAnswers) {\r\n    if (!userAnswers || userAnswers.length === 0) {\r\n        return 0;\r\n    }\r\n    \r\n    const correctCount = userAnswers.filter(a => a.isCorrect).length;\r\n    const score = Math.round((correctCount / userAnswers.length) * 100);\r\n    \r\n    // Validation du score calcul√©\r\n    if (isNaN(score) || score < 0 || score > 100) {\r\n        console.error('‚ùå Score invalide calcul√©:', score);\r\n        return 0;\r\n    }\r\n    \r\n    return score;\r\n}\r\n\r\n/**\r\n * D√©termine si un quiz mensuel est d√©bloqu√©\r\n * @param {number} monthIndex - Index du mois (0-11, o√π 0 = janvier, 11 = d√©cembre)\r\n * @param {number} currentMonthIndex - Index du mois actuel (0-11)\r\n * @returns {boolean} true si le quiz est d√©bloqu√©, false sinon\r\n */\r\nexport function isMonthlyQuizUnlocked(monthIndex, currentMonthIndex) {\r\n    // Validation des param√®tres\r\n    if (typeof monthIndex !== 'number' || monthIndex < 0 || monthIndex > 11) {\r\n        console.error('‚ùå monthIndex invalide:', monthIndex);\r\n        return false;\r\n    }\r\n    \r\n    if (typeof currentMonthIndex !== 'number' || currentMonthIndex < 0 || currentMonthIndex > 11) {\r\n        console.error('‚ùå currentMonthIndex invalide:', currentMonthIndex);\r\n        return false;\r\n    }\r\n    \r\n    // Un quiz est d√©bloqu√© si son index est <= au mois actuel\r\n    // Exemple: Si on est en novembre (index 10), les quiz de janvier (0) √† novembre (10) sont d√©bloqu√©s\r\n    return monthIndex <= currentMonthIndex;\r\n}\r\n\r\n/**\r\n * D√©termine l'√©tat d'un quiz mensuel\r\n * @param {number} monthIndex - Index du mois (0-11)\r\n * @param {number} currentMonthIndex - Index du mois actuel (0-11)\r\n * @param {number|null} monthScore - Score obtenu pour ce mois (null si non compl√©t√©)\r\n * @returns {string} 'completed' | 'active' | 'incomplete' | 'locked'\r\n */\r\nexport function getMonthlyQuizStatus(monthIndex, currentMonthIndex, monthScore = null) {\r\n    if (monthIndex < currentMonthIndex) {\r\n        // Mois pass√©\r\n        return monthScore !== null ? 'completed' : 'incomplete';\r\n    } else if (monthIndex === currentMonthIndex) {\r\n        // ‚úÖ FIX: Mois actuel - v√©rifier si compl√©t√©\r\n        return monthScore !== null ? 'completed' : 'active';\r\n    } else {\r\n        // Mois futur\r\n        return 'locked';\r\n    }\r\n}\r\n\r\n"],"file":"quiz-B5eLE9Wf.js"}