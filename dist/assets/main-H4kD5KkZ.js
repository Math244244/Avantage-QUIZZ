const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/auth-D1jWYWbN.js","assets/auth-Jh67oLjD.css","assets/firestore-service-xM8Hh84j.js","assets/quiz-service-v7Xiv4E0.js","assets/question-service-D48iYvF_.js"])))=>i.map(i=>d[i]);
import{p as te,C as Me,A as R,v as q,w as g,_ as C,D as ce,E as de,F as T,x as v,n as ne,G as ue,y as De,t as Le,g as qe,H as Te,a as Se}from"./auth-D1jWYWbN.js";import{getAnalytics as Be,setUserId as $e,setUserProperties as _e,logEvent as W}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";import{query as re,collection as oe,where as z,getDocs as se}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{s as ae,b as Re,M as Oe,a as Qe,c as Pe,n as Ne}from"./quiz-service-v7Xiv4E0.js";import{s as d}from"./state-manager-w7-wWzCS.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";let y=null;function U(){try{return typeof window<"u"&&"serviceWorker"in navigator?(y=Be(Me),console.log("‚úÖ Firebase Analytics initialis√©"),y):(console.warn("‚ö†Ô∏è Firebase Analytics non disponible dans cet environnement"),null)}catch(e){return console.error("‚ùå Erreur initialisation Analytics:",e),null}}function K(e,t={}){if(!y){console.log(`[Analytics] ${e}`,t);return}try{W(y,e,{...t,timestamp:Date.now(),page:window.location.pathname}),console.log(`üìä Event tracked: ${e}`,t)}catch(n){console.error("‚ùå Erreur tracking √©v√©nement:",n)}}function je(e,t={}){if(!y){console.error("[Analytics Error]",e,t);return}try{W(y,"exception",{description:e.message||"Unknown error",fatal:!1,error_type:e.name||"Error",error_stack:e.stack?.substring(0,500)||"",...t}),console.error("üìä Error tracked:",e.message)}catch(n){console.error("‚ùå Erreur tracking erreur:",n)}}function me(e){if(y)try{$e(y,e),console.log("‚úÖ Analytics user set:",e)}catch(t){console.error("‚ùå Erreur d√©finition utilisateur Analytics:",t)}}function ge(e){if(y)try{_e(y,e),console.log("‚úÖ Analytics user properties set:",e)}catch(t){console.error("‚ùå Erreur d√©finition propri√©t√©s utilisateur:",t)}}function pe(e,t=window.location.pathname){if(!y){console.log(`[Analytics PageView] ${e} - ${t}`);return}try{W(y,"page_view",{page_title:e,page_location:window.location.href,page_path:t}),console.log(`üìä Page view tracked: ${e}`)}catch(n){console.error("‚ùå Erreur tracking page view:",n)}}function he(e,t){K("quiz_start",{module_id:e,month:t,timestamp:Date.now()})}function fe(e,t,n,r){K("quiz_complete",{module_id:e,score:t,time_elapsed:n,total_questions:r,passed:t>=60})}typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{U()}):U(),te&&te.onAuthStateChanged(e=>{e&&(me(e.uid),ge({email:e.email||"",display_name:e.displayName||""}))}));const Ve=Object.freeze(Object.defineProperty({__proto__:null,initAnalytics:U,setAnalyticsUser:me,setAnalyticsUserProperties:ge,trackError:je,trackEvent:K,trackPageView:pe,trackQuizComplete:fe,trackQuizStart:he},Symbol.toStringTag,{value:"Module"})),f={NETWORK:"NETWORK",FIRESTORE:"FIRESTORE",AUTH:"AUTH",VALIDATION:"VALIDATION",UNKNOWN:"UNKNOWN"};class Ue{constructor(){this.errorLog=[],this.maxLogSize=100,this.setupGlobalHandlers()}setupGlobalHandlers(){window.addEventListener("error",t=>{this.handleError({message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,error:t.error,type:f.UNKNOWN},"Global error handler")}),window.addEventListener("unhandledrejection",t=>{this.handleError({message:t.reason?.message||"Unhandled promise rejection",error:t.reason,type:f.UNKNOWN},"Unhandled promise rejection")})}handleError(t,n="Unknown",r={}){const s=this.normalizeError(t,n,r);return this.logError(s),r.showToUser!==!1&&this.showUserMessage(s,r),r.critical&&!R()&&this.sendToFirestore(s).catch(a=>{q.error("Impossible d'envoyer l'erreur √† Firestore:",a)}),s}normalizeError(t,n,r){const s={message:t?.message||String(t)||"Erreur inconnue",stack:t?.stack,context:n,type:this.detectErrorType(t),timestamp:new Date().toISOString(),url:window.location.href,userAgent:navigator.userAgent,...r.metadata};return t?.code&&(s.code=t.code),t?.name&&(s.name=t.name),s}detectErrorType(t){if(!t)return f.UNKNOWN;const n=(t.message||"").toLowerCase(),r=t.code||"";return r==="unavailable"||r==="deadline-exceeded"||n.includes("network")||n.includes("fetch")?f.NETWORK:r==="permission-denied"||r==="unauthenticated"||n.includes("auth")?f.AUTH:r==="invalid-argument"||r==="failed-precondition"||n.includes("validation")?f.VALIDATION:n.includes("firestore")||r.startsWith("firestore")?f.FIRESTORE:f.UNKNOWN}logError(t){this.errorLog.push(t),this.errorLog.length>this.maxLogSize&&this.errorLog.shift();const n=`[${t.type}] ${t.context}: ${t.message}`;t.type===f.NETWORK?q.warn(n,t):q.error(n,t)}showUserMessage(t,n){let r=n.userMessage;if(!r)switch(t.type){case f.NETWORK:r="Probl√®me de connexion. V√©rifiez votre connexion internet.";break;case f.AUTH:r="Erreur d'authentification. Veuillez vous reconnecter.";break;case f.VALIDATION:r="Donn√©es invalides. Veuillez v√©rifier vos informations.";break;case f.FIRESTORE:r="Erreur lors de l'acc√®s aux donn√©es. Veuillez r√©essayer.";break;default:r="Une erreur est survenue. Veuillez r√©essayer."}const s=n.duration||(t.type===f.NETWORK?8e3:5e3);g.error(r,s)}async sendToFirestore(t){try{const{trackError:n}=await C(async()=>{const{trackError:r}=await Promise.resolve().then(()=>Ve);return{trackError:r}},void 0);n(new Error(t.message),{error_type:t.type,error_source:t.source,user_id:t.userId||"anonymous"})}catch{console.warn("Analytics non disponible pour tracking erreur")}try{const{db:n}=await C(async()=>{const{db:i}=await import("./auth-D1jWYWbN.js").then(c=>c.I);return{db:i}},__vite__mapDeps([0,1])),{collection:r,addDoc:s,Timestamp:a}=await C(async()=>{const{collection:i,addDoc:c,Timestamp:u}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{collection:i,addDoc:c,Timestamp:u}},[]),{isCurrentUserAdmin:o}=await C(async()=>{const{isCurrentUserAdmin:i}=await import("./firestore-service-xM8Hh84j.js");return{isCurrentUserAdmin:i}},__vite__mapDeps([2,0,1,3,4]));if(!await o())return;await s(r(n,"errorLogs"),{...t,timestamp:a.now()})}catch(n){console.error("Impossible d'envoyer l'erreur √† Firestore:",n)}}getRecentErrors(t=10){return this.errorLog.slice(-t)}clearErrorLog(){this.errorLog=[]}}const He=new Ue,Fe={maxRetries:3,initialDelay:1e3,maxDelay:3e4,backoffMultiplier:2,retryableErrors:["unavailable","deadline-exceeded","internal","aborted"],onRetry:null};function ie(e,t){if(!e)return!1;const n=e.code||"",r=(e.message||"").toLowerCase();return n==="unavailable"||n==="deadline-exceeded"||r.includes("network")||r.includes("fetch failed")?!0:t.some(s=>n===s||r.includes(s.toLowerCase()))}function Ge(e,t,n,r){const s=t*Math.pow(r,e);return Math.min(s,n)}function We(e){return new Promise(t=>setTimeout(t,e))}async function Ke(e,t={}){const n={...Fe,...t};let r;try{return await e()}catch(s){if(r=s,!ie(s,n.retryableErrors))throw s}for(let s=0;s<n.maxRetries;s++){const a=Ge(s,n.initialDelay,n.maxDelay,n.backoffMultiplier);n.onRetry?n.onRetry(s+1,a,r):q.warn(`Nouvelle tentative ${s+1}/${n.maxRetries} dans ${a}ms...`),await We(a);try{return await e()}catch(o){if(r=o,!ie(o,n.retryableErrors))throw o;if(s===n.maxRetries-1)throw He.handleError(o,"Retry handler - Max retries reached",{showToUser:!0,userMessage:`√âchec apr√®s ${n.maxRetries} tentatives. Veuillez r√©essayer plus tard.`}),o}}throw r}async function Ye(e,t={}){return Ke(e,{...t,retryableErrors:["unavailable","deadline-exceeded","internal","aborted","resource-exhausted"],onRetry:t.onRetry||((n,r)=>{q.warn(`Retry Firestore ${n}/${t.maxRetries||3} dans ${r}ms...`)})})}const Ze="avantage-quizz-sync",Xe=1,h="sync-queue";let b=null;async function w(){return b||new Promise((e,t)=>{const n=indexedDB.open(Ze,Xe);n.onerror=()=>t(n.error),n.onsuccess=()=>{b=n.result,e(b)},n.onupgradeneeded=r=>{const s=r.target.result;if(!s.objectStoreNames.contains(h)){const a=s.createObjectStore(h,{keyPath:"id",autoIncrement:!0});a.createIndex("timestamp","timestamp",{unique:!1}),a.createIndex("type","type",{unique:!1}),a.createIndex("status","status",{unique:!1})}}})}class Je{constructor(){this.isProcessing=!1,this.listeners=new Set}async add(t,n,r={}){await w();const s={type:t,operation:this.serializeOperation(n),data:r,timestamp:Date.now(),status:"pending",retries:0,maxRetries:3};return new Promise((a,o)=>{const c=b.transaction([h],"readwrite").objectStore(h).add(s);c.onsuccess=()=>{const u=c.result;console.log(`üì• Op√©ration ajout√©e √† la file d'attente: ${t} (ID: ${u})`),this.notifyListeners("added",{id:u,type:t}),a(u)},c.onerror=()=>o(c.error)})}serializeOperation(t){return{name:t.name||"anonymous"}}async getAll(){return await w(),new Promise((t,n)=>{const o=b.transaction([h],"readonly").objectStore(h).index("status").getAll("pending");o.onsuccess=()=>t(o.result),o.onerror=()=>n(o.error)})}async markCompleted(t){return await w(),new Promise((n,r)=>{const a=b.transaction([h],"readwrite").objectStore(h),o=a.get(t);o.onsuccess=()=>{const l=o.result;if(l){l.status="completed";const i=a.put(l);i.onsuccess=()=>{console.log(`‚úÖ Op√©ration compl√©t√©e: ${l.type} (ID: ${t})`),this.notifyListeners("completed",{id:t,type:l.type}),n()},i.onerror=()=>r(i.error)}else n()},o.onerror=()=>r(o.error)})}async markFailed(t,n){return await w(),new Promise((r,s)=>{const o=b.transaction([h],"readwrite").objectStore(h),l=o.get(t);l.onsuccess=()=>{const i=l.result;if(i){i.retries++,i.retries>=i.maxRetries?(i.status="failed",i.error=n?.message||"Unknown error"):i.status="pending";const c=o.put(i);c.onsuccess=()=>{i.status==="failed"?(console.error(`‚ùå Op√©ration √©chou√©e d√©finitivement: ${i.type} (ID: ${t})`),this.notifyListeners("failed",{id:t,type:i.type,error:n})):console.warn(`‚ö†Ô∏è Op√©ration √©chou√©e, r√©essai ${i.retries}/${i.maxRetries}: ${i.type} (ID: ${t})`),r()},c.onerror=()=>s(c.error)}else r()},l.onerror=()=>s(l.error)})}async remove(t){return await w(),new Promise((n,r)=>{const o=b.transaction([h],"readwrite").objectStore(h).delete(t);o.onsuccess=()=>{console.log(`üóëÔ∏è Op√©ration supprim√©e: ID ${t}`),n()},o.onerror=()=>r(o.error)})}async processQueue(t={}){if(this.isProcessing){console.log("‚è≥ Traitement d√©j√† en cours...");return}if(!navigator.onLine){console.log("üì¥ Hors ligne, synchronisation report√©e");return}this.isProcessing=!0,console.log("üîÑ D√©but du traitement de la file d'attente...");try{const n=await this.getAll();if(n.length===0)return console.log("‚úÖ Aucune op√©ration en attente"),this.isProcessing=!1,{success:0,failed:0};console.log(`üìã ${n.length} op√©ration(s) en attente`);let r=0,s=0;for(const a of n)try{const o=t[a.type];if(!o){console.warn(`‚ö†Ô∏è Aucun handler pour le type: ${a.type}`),await this.markFailed(a.id,new Error(`No handler for type: ${a.type}`)),s++;continue}await o(a.data),await this.markCompleted(a.id),await this.remove(a.id),r++}catch(o){console.error(`‚ùå Erreur traitement op√©ration ${a.id}:`,o),await this.markFailed(a.id,o),s++}return console.log(`‚úÖ Traitement termin√©: ${r} r√©ussies, ${s} √©chou√©es`),this.notifyListeners("processed",{success:r,failed:s}),{success:r,failed:s}}catch(n){throw console.error("‚ùå Erreur traitement file d'attente:",n),n}finally{this.isProcessing=!1}}async getStats(){return await w(),new Promise((t,n)=>{const a=b.transaction([h],"readonly").objectStore(h).getAll();a.onsuccess=()=>{const o=a.result,l={total:o.length,pending:o.filter(i=>i.status==="pending").length,completed:o.filter(i=>i.status==="completed").length,failed:o.filter(i=>i.status==="failed").length};t(l)},a.onerror=()=>n(a.error)})}async cleanCompleted(){await w();const t=Date.now()-10080*60*1e3;return new Promise((n,r)=>{const l=b.transaction([h],"readwrite").objectStore(h).index("timestamp").openCursor();let i=0;l.onsuccess=c=>{const u=c.target.result;if(u){const m=u.value;m.status==="completed"&&m.timestamp<t&&(u.delete(),i++),u.continue()}else console.log(`üßπ ${i} op√©ration(s) compl√©t√©e(s) nettoy√©e(s)`),n(i)},l.onerror=()=>r(l.error)})}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notifyListeners(t,n){this.listeners.forEach(r=>{try{r(t,n)}catch(s){console.error("Erreur listener:",s)}})}}const H=new Je;w().catch(e=>{console.error("‚ùå Erreur initialisation IndexedDB:",e)});const et=Object.freeze(Object.defineProperty({__proto__:null,syncQueue:H},Symbol.toStringTag,{value:"Module"}));class tt{constructor(){this.isOnline=navigator.onLine,this.listeners=new Set,this.indicatorElement=null,this.setupEventListeners(),this.createIndicator()}setupEventListeners(){window.addEventListener("online",()=>this.handleOnline()),window.addEventListener("offline",()=>this.handleOffline()),setInterval(()=>this.checkConnection(),3e4)}async checkConnection(){try{const t=await fetch("https://firestore.googleapis.com",{method:"HEAD",mode:"no-cors",cache:"no-cache"});this.isOnline||this.handleOnline()}catch{this.isOnline&&this.handleOffline()}}async handleOnline(){if(!this.isOnline){this.isOnline=!0,console.log("üåê Connexion r√©tablie"),this.updateIndicator(),this.notifyListeners("online"),g.success("Connexion r√©tablie. Synchronisation en cours...",3e3);try{const{saveQuizResult:t}=await C(async()=>{const{saveQuizResult:r}=await import("./firestore-service-xM8Hh84j.js");return{saveQuizResult:r}},__vite__mapDeps([2,0,1,3,4])),n=await H.getStats();if(n.pending>0){console.log(`üì§ Synchronisation de ${n.pending} op√©ration(s) en attente...`);const r={quizResult:async a=>{await t(a)}},s=await H.processQueue(r);s.success>0&&g.success(`${s.success} op√©ration(s) synchronis√©e(s) avec succ√®s`,3e3),s.failed>0&&g.warning(`${s.failed} op√©ration(s) n'ont pas pu √™tre synchronis√©es`,3e3)}}catch(t){console.error("‚ùå Erreur synchronisation:",t),g.error("Erreur lors de la synchronisation",3e3)}}}handleOffline(){this.isOnline&&(this.isOnline=!1,console.log("üì¥ Connexion perdue"),this.updateIndicator(),this.notifyListeners("offline"),g.warning("Connexion perdue. Les donn√©es seront sauvegard√©es localement.",5e3))}createIndicator(){this.indicatorElement=document.createElement("div"),this.indicatorElement.id="offline-indicator",this.indicatorElement.className="fixed bottom-4 right-4 z-50 flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg transition-all duration-300",this.indicatorElement.style.display="none",document.body.appendChild(this.indicatorElement),this.updateIndicator()}updateIndicator(){this.indicatorElement&&(this.isOnline?this.indicatorElement.style.display="none":(this.indicatorElement.style.display="flex",this.indicatorElement.className="fixed bottom-4 right-4 z-50 flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg bg-yellow-500 text-white transition-all duration-300",this.indicatorElement.innerHTML=`
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"></path>
                </svg>
                <span class="text-sm font-medium">Mode hors ligne</span>
            `))}getStatus(){return{isOnline:this.isOnline,timestamp:Date.now()}}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notifyListeners(t){this.listeners.forEach(n=>{try{n(t,this.getStatus())}catch(r){console.error("Erreur listener offline:",r)}})}}new tt;console.log("Initialisation de la page d accueil...");document.addEventListener("DOMContentLoaded",nt);function nt(){console.log("üìÑ DOM charg√© - configuration du bouton de connexion...");const e=document.getElementById("google-signin-btn");e?(e.addEventListener("click",rt),console.log("‚úÖ Bouton Google configur√©")):console.warn("‚ö†Ô∏è Bouton Google non trouv√©")}async function rt(){console.log("üîê Clic sur connexion Google...");const e=ce("Connexion en cours...");try{const t=await de();T(e,`Bienvenue ${t.displayName} !`,"success"),setTimeout(()=>{window.location.reload()},800)}catch(t){console.error("‚ùå Erreur connexion Google:",t);let n="Erreur lors de la connexion";t.code==="auth/popup-closed-by-user"?n="Connexion annul√©e":t.code==="auth/popup-blocked"?n="Pop-up bloqu√©e. Autorisez les pop-ups.":t.code==="auth/unauthorized-domain"?n="Domaine non autoris√© dans Firebase":t.code==="auth/network-request-failed"&&(n="Erreur r√©seau. V√©rifiez votre connexion."),T(e,n,"error")}}function ot(){const e=document.createElement("canvas");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="9999",document.body.appendChild(e);const t=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const n=[],r=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#F7DC6F","#BB8FCE","#85C1E2"];for(let a=0;a<150;a++)n.push({x:Math.random()*e.width,y:e.height+Math.random()*100,size:Math.random()*8+4,speedY:-(Math.random()*3+3),speedX:Math.random()*6-3,color:r[Math.floor(Math.random()*r.length)],rotation:Math.random()*360,rotationSpeed:Math.random()*10-5,gravity:.15,opacity:1});function s(){t.clearRect(0,0,e.width,e.height);let a=0;n.forEach((o,l)=>{o.speedY+=o.gravity,o.y+=o.speedY,o.x+=o.speedX,o.rotation+=o.rotationSpeed,o.y>e.height-100&&(o.opacity-=.02),o.opacity>0&&o.y<e.height+50&&(a++,t.save(),t.translate(o.x,o.y),t.rotate(o.rotation*Math.PI/180),t.globalAlpha=o.opacity,t.fillStyle=o.color,t.fillRect(-o.size/2,-o.size/2,o.size,o.size),t.restore())}),a>0?requestAnimationFrame(s):e.remove()}s()}const F={auto:{name:"AT-AVE-AVEX",color:"indigo",label:"Auto"},loisir:{name:"VTT, Motoneige, etc.",color:"cyan",label:"Loisir"},vr:{name:"V√©hicules R√©cr√©atifs",color:"orange",label:"VR"},tracteur:{name:"√âquipement Agricole",color:"green",label:"Tracteur"}},L=()=>d.get("currentQuiz"),st=e=>d.set("currentQuiz",e),_=()=>d.get("currentQuestionIndex"),ve=e=>d.set("currentQuestionIndex",e),I=()=>d.get("userAnswers"),xe=e=>d.set("userAnswers",e),G=()=>d.get("startTime"),at=e=>d.set("startTime",e),it=()=>d.get("timerInterval"),ye=e=>d.set("timerInterval",e),lt=()=>d.get("questionStartTime"),be=e=>d.set("questionStartTime",e),ct=()=>d.get("currentStreak"),we=e=>d.set("currentStreak",e),Y=()=>d.get("isPaused"),B=e=>d.set("isPaused",e),Z=()=>d.get("pausedDuration"),O=e=>d.set("pausedDuration",e),X=()=>d.get("pauseStartedAt"),D=e=>d.set("pauseStartedAt",e),S=()=>d.get("currentModule"),dt=e=>d.set("currentModule",e),M=()=>d.get("currentMonth"),ut=e=>d.set("currentMonth",e),j=()=>d.get("currentYear"),mt=e=>d.set("currentYear",e),gt=()=>d.get("hasCurrentQuestionBeenAnswered"),Q=e=>d.set("hasCurrentQuestionBeenAnswered",e),pt=()=>d.get("quizEventDelegationInitialized"),ht=e=>d.set("quizEventDelegationInitialized",e),J={indigo:{bg:"bg-ap-red-primary",text:"text-ap-red-primary",border:"border-ap-red-primary"},cyan:{bg:"bg-ap-gold",text:"text-ap-gold",border:"border-ap-gold"},orange:{bg:"bg-orange-600",text:"text-orange-600",border:"border-orange-600"},green:{bg:"bg-green-600",text:"text-green-600",border:"border-green-600"}};async function ft(e,t,n){console.log(`üì• Chargement des questions: module=${e}, mois=${t}, ann√©e=${n}`);const r=s=>{const a=s.data();return{id:s.id,question:a.question,options:a.options.map((o,l)=>({id:String.fromCharCode(65+l),text:o,correct:l===a.correctAnswer})),explanation:a.explanation||"Pas d'explication disponible",reference:a.reference||"",tags:a.tags||[]}};if(R()){console.log("üìù Mode d√©mo : Chargement des questions simul√©es pour le quiz...");const a=localStorage.getItem("avantage-quizz-demo-questions");let o=[];if(a)try{const l=JSON.parse(a);console.log(`üíæ ${l.length} questions charg√©es depuis localStorage`),o=l.map(i=>({id:i.id,question:i.question,options:i.options.map((c,u)=>({id:String.fromCharCode(65+u),text:c,correct:u===i.correctAnswer})),explanation:i.explanation||"Pas d'explication disponible",reference:i.reference||"",tags:i.tags||[]})),o=o.filter(i=>{const c=!e||l.find(m=>m.id===i.id)?.module===e,u=!t||l.find(m=>m.id===i.id)?.month===t;return c&&u})}catch{console.warn("‚ö†Ô∏è Erreur lecture localStorage, utilisation questions par d√©faut")}return o.length===0&&(console.log("üì¶ Utilisation questions par d√©faut (aucune en localStorage)"),o=[{id:"demo-1",question:"Quelle est la vitesse maximale autoris√©e sur une autoroute au Qu√©bec ?",options:[{id:"A",text:"100 km/h",correct:!1},{id:"B",text:"110 km/h",correct:!1},{id:"C",text:"120 km/h",correct:!1},{id:"D",text:"100 km/h (conditions normales)",correct:!0}],explanation:"La vitesse maximale sur autoroute au Qu√©bec est de 100 km/h, sauf indication contraire.",reference:"Code de la s√©curit√© routi√®re du Qu√©bec",tags:["vitesse","autoroute"]},{id:"demo-2",question:"√Ä quelle distance minimale devez-vous vous arr√™ter derri√®re un autobus scolaire dont les feux clignotent ?",options:[{id:"A",text:"3 m√®tres",correct:!1},{id:"B",text:"5 m√®tres",correct:!0},{id:"C",text:"10 m√®tres",correct:!1},{id:"D",text:"15 m√®tres",correct:!1}],explanation:"Vous devez vous arr√™ter √† au moins 5 m√®tres d'un autobus scolaire.",reference:"Article 460 CSR",tags:["autobus","s√©curit√©"]},{id:"demo-3",question:"Quel est le taux d'alcool√©mie maximal pour conduire au Qu√©bec ?",options:[{id:"A",text:"0.05",correct:!1},{id:"B",text:"0.08",correct:!0},{id:"C",text:"0.10",correct:!1},{id:"D",text:"0.00",correct:!1}],explanation:"Le taux maximal est de 0.08 pour conducteurs exp√©riment√©s.",reference:"Code criminel du Canada",tags:["alcool","s√©curit√©"]},{id:"demo-4",question:"Combien de points d'inaptitude entra√Æne un exc√®s de vitesse de 30 km/h ?",options:[{id:"A",text:"2 points",correct:!1},{id:"B",text:"3 points",correct:!0},{id:"C",text:"4 points",correct:!1},{id:"D",text:"5 points",correct:!1}],explanation:"Un exc√®s de 21 √† 30 km/h entra√Æne 3 points.",reference:"SAAQ",tags:["vitesse","points"]},{id:"demo-5",question:"Quelle est la distance de s√©curit√© recommand√©e entre v√©hicules ?",options:[{id:"A",text:"1 seconde",correct:!1},{id:"B",text:"2 secondes",correct:!0},{id:"C",text:"3 secondes",correct:!1},{id:"D",text:"5 secondes",correct:!1}],explanation:"La r√®gle des 2 secondes est recommand√©e.",reference:"Guide SAAQ",tags:["distance","s√©curit√©"]}]),console.log(`‚úÖ ${o.length} questions d√©mo charg√©es pour le quiz`),o}try{let s=re(oe(ne,"questions"),z("module","==",e),z("month","==",t),z("year","==",n)),a=await se(s);if(!a.empty){const u=[];return a.forEach(m=>u.push(r(m))),console.log(`‚úÖ ${u.length} questions (mois num√©rique)`),u}const l=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"][t-1],i=l.charAt(0).toUpperCase()+l.slice(1).toLowerCase();let c=re(oe(ne,"questions"),z("module","==",e),z("month","==",i),z("year","==",n));if(a=await se(c),!a.empty){const u=[];return a.forEach(m=>u.push(r(m))),console.log(`‚úÖ ${u.length} questions (mois texte)`),u}return console.warn("‚ö†Ô∏è Aucune question trouv√©e pour ces crit√®res (num√©rique/texte)"),[]}catch(s){throw console.error("‚ùå Erreur lors du chargement des questions:",s),s}}async function vt(e,t,n){try{const r=await fetch("/test-questions-valides.json");if(!r.ok)return[];const s=await r.json(),o=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"][t-1];return s.filter(i=>i.module===e&&i.year===n&&(i.month===o||i.month===t)).map((i,c)=>({id:`demo-${e}-${c}`,question:i.question,options:i.options.map((u,m)=>({id:String.fromCharCode(65+m),text:u,correct:m===i.correctAnswer})),explanation:i.explanation||"Pas d'explication disponible",reference:i.reference||"",tags:i.tags||[]}))}catch(r){return console.warn("Demo questions fallback error:",r),[]}}async function Ee(e){const t=F[e];if(!t){console.error("Module de quiz non trouv√©:",e),g.error("Module non trouv√©. Veuillez r√©essayer.");return}const n=ce(`Chargement du quiz ${t.label}...`);xt(t.label);try{const{getCurrentMonthNumber:r,getCurrentYear:s,normalizeMonthFormat:a}=await C(async()=>{const{getCurrentMonthNumber:m,getCurrentYear:P,normalizeMonthFormat:N}=await import("./quiz-service-v7Xiv4E0.js").then(p=>p.m);return{getCurrentMonthNumber:m,getCurrentYear:P,normalizeMonthFormat:N}},__vite__mapDeps([3,0,1])),o=r(),l=s(),i=a(o,l);ut(i),mt(l),dt(e);try{window.__QUIZ_ACTIVE=!0}catch{}let c=await ft(e,o,l);if(c.length===0&&R()&&(console.log("‚ÑπÔ∏è Mode D√©mo: chargement des questions locales de test"),c=await vt(e,o,l)),c.length===0){T(n,"Aucune question disponible","error");const m=M();g.error(`Aucune question trouv√©e pour ${t.label} en ${m}.

Contactez l'administrateur.`,5e3);return}const u=M();st({name:`Quiz ${t.label} - ${u}`,module:t.name,color:t.color,questions:c}),ve(0),xe([]),at(Date.now()),be(Date.now()),he(e,M()),we(0),B(!1),O(0),D(null),Q(!1),yt(),Ce(),zt(),ee(),T(n,`${c.length} questions charg√©es !`,"success")}catch(r){E(),console.error("‚ùå Erreur lors du d√©marrage du quiz:",r),T(n,"Erreur de chargement","error"),g.error("Erreur lors du chargement du quiz. Veuillez r√©essayer.",4e3)}}function xt(e){const t=ke();t.innerHTML=`
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-ap-red-primary mx-auto mb-6"></div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Chargement du quiz ${v(e)}</h2>
                <p class="text-slate-600">R√©cup√©ration des questions...</p>
            </div>
        </div>
    `,t.classList.remove("view-hidden")}function yt(){document.getElementById("dashboard-view")?.classList.add("view-hidden"),document.getElementById("module-selection-view")?.classList.add("view-hidden"),document.getElementById("login-view")?.classList.add("view-hidden"),ke().classList.remove("view-hidden")}function ke(){let e=document.getElementById("quiz-view");return e||(e=document.createElement("div"),e.id="quiz-view",document.querySelector("main").appendChild(e)),bt(e),e}function bt(e){pt()||!e||(e.addEventListener("click",t=>{const n=t.target.closest(".option-button");if(n&&!n.disabled){const l=n.dataset.optionId;l&&wt(l);return}if(t.target.closest("#next-question-btn")){t.preventDefault(),kt();return}if(t.target.closest("#quit-quiz-btn")){t.preventDefault(),confirm("Voulez-vous vraiment quitter le quiz ? Votre progression sera perdue.")&&Ae();return}if(t.target.closest("#focus-mode-btn")){t.preventDefault(),It();return}if(t.target.closest("#pause-btn")){t.preventDefault(),Mt();return}}),ht(!0))}function Ce(){const e=L(),t=_(),n=e.questions[t],r=document.getElementById("quiz-view"),s=J[e.color];Q(!1),r.innerHTML=`
        <!-- En-t√™te du quiz -->
        <div class="bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-5xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-bold text-slate-900">${v(e.name)}</h1>
                        <p class="text-sm text-slate-500">Question ${t+1} sur ${e.questions.length}</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <button id="focus-mode-btn" class="text-sm font-medium text-slate-600 hover:text-slate-900 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            Focus
                        </button>
                        <button id="pause-btn" class="text-sm font-medium text-slate-600 hover:text-slate-900 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Pause
                        </button>
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-ap-red-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="quiz-score" class="text-sm font-bold text-ap-red-primary">Score: 0%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="quiz-timer" class="text-sm font-medium text-slate-600">0:00</span>
                        </div>
                        <button id="quit-quiz-btn" class="text-sm font-medium text-slate-600 hover:text-slate-900">
                            Quitter
                        </button>
                    </div>
                </div>
                
                <!-- Barre de progression - DOR√âE AVANTAGE PLUS -->
                <div class="mt-4 w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div class="h-2 rounded-full transition-all duration-300 progress-bar-shine" style="background: var(--ap-gradient-gold); width: ${(t+1)/e.questions.length*100}%; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);"></div>
                </div>
            </div>
        </div>

        <!-- Contenu de la question -->
        <div class="max-w-5xl mx-auto px-6 py-8">
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                
                <!-- En-t√™te de question -->
                <div class="px-8 py-6 bg-gradient-to-r from-slate-50 to-white border-b border-gray-100">
                    <div class="mb-4">
                        <span class="text-sm font-medium ${s.text}">Question ${t+1} sur ${e.questions.length}</span>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-slate-900 leading-relaxed">
                        ${v(n.question)}
                    </h2>
                    
                    <!-- Tags -->
                    ${n.tags&&n.tags.length>0?`
                        <div class="flex flex-wrap gap-2 mt-4">
                            ${n.tags.map(a=>`
                                <span class="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-medium rounded-full">
                                    ${v(a)}
                                </span>
                            `).join("")}
                        </div>
                    `:""}
                </div>

                <!-- Options de r√©ponse -->
                <div class="p-8">
                    <div class="space-y-3">
                        ${n.options.map(a=>`
                            <button data-option-id="${v(a.id)}" 
                                    class="option-button w-full text-left px-6 py-5 rounded-xl border-2 border-gray-200 hover:border-ap-red-primary hover:bg-ap-red-50 transition-all duration-200 group">
                                <div class="flex items-center gap-4">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-ap-red-100 flex items-center justify-center group-hover:bg-ap-red-primary group-hover:text-white transition-all">
                                        <span class="text-lg font-bold text-ap-red-primary group-hover:text-white">${v(a.id)}</span>
                                    </div>
                                    <span class="text-lg text-slate-700 group-hover:text-slate-900 font-medium">
                                        ${v(a.text)}
                                    </span>
                                </div>
                            </button>
                        `).join("")}
                    </div>
                </div>

                <!-- Zone d'explication (cach√©e initialement) -->
                <div id="explanation-area" class="hidden px-8 py-6 bg-slate-50 border-t border-gray-200">
                    <!-- Sera rempli apr√®s la r√©ponse -->
                </div>

                <!-- Bouton suivant (cach√© initialement) -->
                <div id="next-button-area" class="hidden px-8 py-6 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-slate-500">Question suivante dans quelques secondes...</p>
                        <button id="next-question-btn" class="bg-ap-red-primary hover:bg-ap-red-dark text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-ap-md hover:shadow-ap-lg transform hover:-translate-y-1">
                            Question suivante
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,ee()}function wt(e){if(gt())return;const t=L(),n=_(),r=lt(),s=t.questions[n],a=s.options.find(c=>c.id===e),o=Math.floor((Date.now()-r)/1e3);Q(!0);const l=I();l.push({questionId:s.id,question:s.question,selectedAnswer:e,correctAnswer:s.options.find(c=>c.correct).id,isCorrect:a.correct,timeSpent:o}),xe(l);let i=ct();a.correct?i++:i=0,we(i),document.querySelectorAll(".option-button").forEach(c=>{c.disabled=!0,c.classList.remove("hover:border-ap-red-primary","hover:bg-ap-red-50")}),Et(e,a.correct,s),ee(),setTimeout(()=>{document.getElementById("next-button-area")?.classList.remove("hidden")},1e3)}function Et(e,t,n){const r=L();J[r.color];const s=n.options.find(o=>o.correct);document.querySelectorAll(".option-button").forEach(o=>{const l=o.dataset.optionId;l===s.id?(o.classList.add("border-green-500","bg-green-50"),o.classList.remove("border-gray-200")):l===e&&!t&&(o.classList.add("border-red-500","bg-red-50"),o.classList.remove("border-gray-200"))});const a=document.getElementById("explanation-area");a&&(a.innerHTML=`
            <div class="flex items-start gap-4">
                ${t?'<div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-100 flex items-center justify-center"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>':'<div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center"><svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>'}
                <div class="flex-1">
                    <h3 class="text-lg font-bold ${t?"text-green-700":"text-red-700"} mb-2">
                        ${t?"‚úÖ Bonne r√©ponse !":"‚ùå R√©ponse incorrecte"}
                    </h3>
                    <p class="text-slate-700 mb-2"><strong>Explication :</strong> ${v(n.explanation)}</p>
                    ${n.reference?`<p class="text-sm text-slate-500"><strong>R√©f√©rence :</strong> ${v(n.reference)}</p>`:""}
                </div>
            </div>
        `,a.classList.remove("hidden"))}function kt(){be(Date.now());const e=_();ve(e+1);const t=L();_()<t.questions.length?Ce():Ct()}function Ct(){E();try{window.__QUIZ_ACTIVE=!1}catch{}const e=I();if(e.length===0){console.error("‚ùå Aucune r√©ponse enregistr√©e - quiz invalide"),g.error("Aucune r√©ponse enregistr√©e. Le quiz ne peut pas √™tre compl√©t√©.");return}const t=e.filter(p=>p.isCorrect).length,n=Math.round(t/e.length*100);if(isNaN(n)||n<0||n>100){console.error("‚ùå Score invalide calcul√©:",n),g.error("Erreur de calcul du score. Contactez le support.");return}const r=Z(),s=Y(),a=X();let o=r;s&&a&&(o+=Date.now()-a);const l=G(),i=Math.max(0,Math.floor((Date.now()-l-o)/1e3));B(!1),D(null),O(0);const c=Math.floor(i/60),u=i%60;At(n,i);const m=L();if(!m){console.error("‚ùå currentQuiz non d√©fini dans showResults"),g.error("Erreur: Impossible d'afficher les r√©sultats. Veuillez r√©essayer.");return}J[m.color];const P=document.getElementById("quiz-view");P.innerHTML=`
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 py-12 px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Carte de r√©sultat principale -->
                <div class="bg-white rounded-3xl shadow-2xl overflow-hidden mb-8 border-t-4 border-ap-gold">
                    <!-- Header avec score - GRADIENT AVANTAGE PLUS -->
                    <div class="px-8 py-12 text-center text-white" style="background: ${n>=80?"linear-gradient(135deg, #28A745 0%, #D4AF37 100%)":"var(--ap-gradient-primary)"};">
                        <h1 class="text-4xl font-bold mb-4">Quiz Termin√© ! üéâ</h1>
                        <div class="text-8xl font-bold mb-4" style="text-shadow: 0 4px 20px rgba(0,0,0,0.2);">${n}%</div>
                        <p class="text-xl opacity-90">${e.filter(p=>p.isCorrect).length} / ${e.length} bonnes r√©ponses</p>
                        <p class="text-lg opacity-75 mt-2">Temps total : ${c}:${u.toString().padStart(2,"0")}</p>
                    </div>
                    
                    <!-- Message de feedback -->
                    <div class="px-8 py-8 text-center border-b border-gray-200">
                        ${n>=90?'<h2 class="text-3xl font-bold text-green-600 mb-2">üèÜ Excellent !</h2><p class="text-slate-600 text-lg">Performance exceptionnelle ! Vous ma√Ætrisez parfaitement ce module.</p>':n>=75?'<h2 class="text-3xl font-bold text-blue-600 mb-2">üëè Tr√®s bien !</h2><p class="text-slate-600 text-lg">Bon travail ! Quelques r√©visions et vous serez au top.</p>':n>=60?`<h2 class="text-3xl font-bold text-yellow-600 mb-2">üìö Pas mal !</h2><p class="text-slate-600 text-lg">C'est un bon d√©but. Continuez √† r√©viser pour am√©liorer votre score.</p>`:'<h2 class="text-3xl font-bold text-red-600 mb-2">üí™ Continuez !</h2><p class="text-slate-600 text-lg">Ne vous d√©couragez pas. R√©visez les points faibles et r√©essayez !</p>'}
                    </div>
                    
                    <!-- D√©tails des r√©ponses -->
                    <div class="px-8 py-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">D√©tails de vos r√©ponses :</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${e.map((p,Ie)=>`
                                <div class="flex items-center justify-between p-4 rounded-lg ${p.isCorrect?"bg-green-50":"bg-red-50"}">
                                    <div class="flex items-center gap-3 flex-1">
                                        <span class="${p.isCorrect?"text-green-600":"text-red-600"} text-2xl">
                                            ${p.isCorrect?"‚úÖ":"‚ùå"}
                                        </span>
                                        <div class="flex-1">
                                            <p class="font-medium text-slate-900">Question ${Ie+1}</p>
                                            <p class="text-sm text-slate-600">${p.question}</p>
                                            ${p.isCorrect?"":`<p class="text-xs text-slate-500 mt-1">Votre r√©ponse : ${p.selectedAnswer} | Correcte : ${p.correctAnswer}</p>`}
                                        </div>
                                    </div>
                                    <span class="text-sm text-slate-500">${p.timeSpent}s</span>
                                </div>
                            `).join("")}
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="px-8 py-6 flex gap-4">
                        <button id="retry-quiz-btn" class="flex-1 bg-ap-red-primary hover:bg-ap-red-dark text-white px-6 py-3 rounded-xl font-semibold transition-all transform hover:-translate-y-1 shadow-ap-md hover:shadow-ap-lg">
                            Refaire le quiz
                        </button>
                        <button id="return-dashboard-btn" class="flex-1 border-2 border-ap-red-primary text-ap-red-primary px-6 py-3 rounded-xl font-semibold hover:bg-ap-red-50 transition-all">
                            Retour au tableau de bord
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,n>=80&&setTimeout(()=>ot(),500);const N=Math.floor((Date.now()-G())/1e3);fe(S(),n,N,m?.questions?.length||0),document.getElementById("retry-quiz-btn")?.addEventListener("click",()=>{const p=S();p?Ee(p):g.error("Erreur: Impossible de red√©marrer le quiz.")}),document.getElementById("return-dashboard-btn")?.addEventListener("click",Ae)}async function At(e,t){try{if(!ue()){console.log("Aucun utilisateur - r√©sultat non sauvegard√©"),E();return}if(R()){console.log("Mode d√©mo - r√©sultat non sauvegard√© dans Firestore"),g.info("Mode D√©mo : les r√©sultats ne sont pas sauvegard√©s"),E();return}const r=S(),s=M(),a=j(),o=L(),l=I(),i=F[r]||{},c={moduleId:r,moduleName:i.name||o.module||r,score:e,correctAnswers:l.filter(u=>u.isCorrect).length,totalQuestions:o.questions.length,timeElapsed:t,answers:l,month:s,year:a};await Ye(()=>ae(c),{maxRetries:3,onRetry:(u,m)=>{g.info(`Nouvelle tentative de sauvegarde ${u}/3...`,3e3)}}),g.success("R√©sultat sauvegard√© avec succ√®s !",3e3),console.log("‚úÖ R√©sultat sauvegard√© dans Firestore")}catch(n){console.error("‚ùå Erreur lors de la sauvegarde:",n),E(),g.error("Erreur lors de la sauvegarde. Le r√©sultat sera sauvegard√© localement et synchronis√© plus tard.",8e3);try{const r=S(),s=M(),a=j(),o=I(),l={moduleId:r,moduleName:F[r]?.name||r,score:e,correctAnswers:o.filter(c=>c.isCorrect).length,totalQuestions:o.length,timeElapsed:t,answers:o,month:s,year:a},{syncQueue:i}=await C(async()=>{const{syncQueue:c}=await Promise.resolve().then(()=>et);return{syncQueue:c}},void 0);await i.add("quizResult",async c=>{await ae(c)},l),console.log("‚úÖ R√©sultat ajout√© √† la file d'attente de synchronisation")}catch(r){console.error("‚ùå Erreur ajout √† la file d'attente:",r);try{const s=`quiz_result_${Date.now()}`;localStorage.setItem(s,JSON.stringify({score:e,totalTime:t,moduleId:S(),month:M(),year:j(),userAnswers:I(),timestamp:Date.now()}))}catch(s){console.error("‚ùå Erreur sauvegarde locale de secours:",s)}}}}function zt(){E();const e=setInterval(()=>{const t=G();if(t===null)return;const n=Z(),r=Y(),s=X();let a=n;r&&s&&(a+=Date.now()-s);const o=Date.now()-t-a,l=Math.max(0,Math.floor(o/1e3)),i=Math.floor(l/60),c=l%60,u=document.getElementById("quiz-timer");u&&(u.textContent=`${i}:${c.toString().padStart(2,"0")}`)},1e3);ye(e)}function E(){const e=it();e&&(clearInterval(e),ye(null)),D(null)}window.addEventListener("beforeunload",()=>{E()});document.addEventListener("visibilitychange",()=>{});function ee(){const e=I();if(e.length===0)return;const t=Math.round(e.filter(r=>r.isCorrect).length/e.length*100),n=document.getElementById("quiz-score");n&&(n.textContent=`Score: ${t}%`)}function It(){document.body.classList.toggle("focus-mode")}function Mt(){const e=document.getElementById("pause-btn");if(!e)return;if(!Y())B(!0),D(Date.now()),e.innerHTML='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Reprendre',g.warning('Quiz en pause. Cliquez sur "Reprendre" pour continuer.',3e3);else{B(!1);const n=X();if(n){const r=Z();O(r+(Date.now()-n))}D(null),e.innerHTML='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Pause',g.success("Quiz repris !",2e3)}}function Ae(){E();try{window.__QUIZ_ACTIVE=!1}catch{}B(!1),O(0),D(null),Q(!1),document.getElementById("quiz-view")?.classList.add("view-hidden"),document.getElementById("dashboard-view")?.classList.remove("view-hidden"),document.querySelectorAll(".nav-link").forEach(e=>{e.classList.remove("bg-ap-red-dark","text-white"),e.classList.add("text-white")}),document.getElementById("nav-dashboard")?.classList.add("bg-ap-red-dark","text-white"),g.info("Retour au tableau de bord",2e3),setTimeout(()=>window.location.reload(),500)}const k=Re(),Dt=Oe;d.set("monthsData",Dt.map(e=>({name:e,score:null})));d.set("currentMonthIndex",k);const V={login:document.getElementById("login-view"),dashboard:document.getElementById("dashboard-view"),moduleSelection:document.getElementById("module-selection-view")},x={modulesGrid:document.getElementById("modules-grid"),annualProgressBar:document.getElementById("annual-progress-bar"),annualProgressText:document.getElementById("annual-progress-text"),moduleSelectionTitle:document.getElementById("module-selection-title"),welcomeMessage:document.getElementById("welcome-message"),userAvatar:document.getElementById("user-avatar"),userName:document.getElementById("user-name"),googleSigninBtn:document.getElementById("google-signin-btn"),signoutLink:document.getElementById("signout-link")};d.set("dashboardEventDelegationAttached",!1);function A(e){Object.values(V).forEach(t=>{t&&t.classList.add("view-hidden")}),V[e]?V[e].classList.remove("view-hidden"):console.error("‚ùå Vue non trouv√©e:",e)}function $(e){document.querySelectorAll(".nav-link").forEach(n=>{n.classList.remove("bg-indigo-800","text-indigo-100"),n.classList.add("text-indigo-300")});const t=document.getElementById(e);t&&(t.classList.add("bg-indigo-800","text-indigo-100"),t.classList.remove("text-indigo-300"))}function Lt(e,t){const r=(o=>o>=90?{badgeText:"üèÜ Excellent"}:o>=75?{badgeText:"‚≠ê Tr√®s bien"}:o>=60?{badgeText:"‚úì Bien"}:{badgeText:"‚úì Passable"})(t),s=v(e),a=v(t);return`
        <div class="module-card module-card--completed">
            <div class="module-card-header">
                <div class="module-card-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="module-card-badge">${r.badgeText}</div>
            </div>
            <h3 class="module-card-title">${s}</h3>
            <p class="module-card-subtitle">Quiz compl√©t√©</p>
            <p class="module-card-progress-label">Score obtenu</p>
            <div class="module-card-progress-bar">
                <div class="module-card-progress-fill" style="width: ${a}%"></div>
            </div>
            <span class="text-sm font-semibold text-ap-red-dark">Score: ${a}%</span>
        </div>
    `}function qt(e){return`
        <div class="module-card module-card--locked">
            <div class="module-card-header">
                <div class="module-card-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <div class="module-card-badge">üîí Verrouill√©</div>
            </div>
            <h3 class="module-card-title">${v(e)}</h3>
            <p class="module-card-subtitle">Disponible le 1er du mois</p>
            <p class="module-card-progress-label">Progression</p>
            <div class="module-card-progress-bar">
                <div class="module-card-progress-fill" style="width: 0%"></div>
            </div>
            <span class="text-sm text-ap-gray-600">Pas encore accessible</span>
        </div>
    `}function Tt(e){return`
        <div class="module-card module-card--incomplete">
            <div class="module-card-header">
                <div class="module-card-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="module-card-badge">‚ö†Ô∏è √Ä compl√©ter</div>
            </div>
            <h3 class="module-card-title">${v(e)}</h3>
            <p class="module-card-subtitle">Mois manqu√© - Rattrapez-le !</p>
            <p class="module-card-progress-label">Progression</p>
            <div class="module-card-progress-bar">
                <div class="module-card-progress-fill" style="width: 0%"></div>
            </div>
            <span class="text-sm font-semibold text-ap-warning">0% compl√©t√©</span>
        </div>
    `}function St(e){return`
        <div class="module-card module-card--active">
            <div class="module-card-header">
                <div class="module-card-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </div>
                <div class="module-card-badge">‚ö° Actif</div>
            </div>
            <h3 class="module-card-title">${v(e)}</h3>
            <p class="module-card-subtitle">Pr√™t √† √™tre compl√©t√© !</p>
            <p class="module-card-progress-label">Progression</p>
            <div class="module-card-progress-bar">
                <div class="module-card-progress-fill" style="width: 0%"></div>
            </div>
            <button class="start-quiz-button btn-primary w-full mt-2 flex items-center justify-center gap-2">
                <span>D√©marrer</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
            </button>
        </div>
    `}function Bt(){const e=d.get("monthsData");let t=0;for(let n=k-1;n>=0&&(e[n].score!==null&&e[n].score>=60);n--)t++;return t}async function $t(){try{const e=ue();if(!e){console.log("‚ÑπÔ∏è Aucun utilisateur - pas de donn√©es √† charger");return}console.log("üìä Chargement des donn√©es du dashboard...");const t=await qe(e.uid);t&&await Te(t);const n=await Qe(e.uid),r=Pe();let s=d.get("monthsData");s=s.map((l,i)=>{const c=Ne(l.name,r);return n[c]?{name:l.name,score:n[c].score}:l});const a=await Se(e.uid),o=document.getElementById("streak-count");o&&(o.textContent=a),console.log("‚úÖ Donn√©es du dashboard charg√©es")}catch(e){console.error("‚ùå Erreur chargement donn√©es:",e)}}async function _t(){if(!x.modulesGrid){console.error("‚ùå L'√©l√©ment 'modules-grid' est introuvable.");return}await $t(),x.modulesGrid.innerHTML="";let e=0;d.get("monthsData").forEach((o,l)=>{let i="";l<k?o.score!==null?(i=Lt(o.name,o.score),e++):i=Tt(o.name):l===k?i=St(o.name):i=qt(o.name),x.modulesGrid.innerHTML+=i});const n=e/12*100;x.annualProgressBar.style.width=`${n}%`,x.annualProgressText.textContent=`${e}/12`;const r=Bt(),s=document.getElementById("streak-count");s&&(s.textContent=r);const a=document.getElementById("streak-badge");a&&r===0&&(a.style.display="none"),Nt(),setTimeout(()=>{Rt(),Ot(),Qt()},500)}function Rt(){const e=document.getElementById("skills-radar-chart");e&&new Chart(e,{type:"radar",data:{labels:["Proc√©dures","Garanties","Documentation","Inspection","Entretien","R√©glementation"],datasets:[{label:"Vos Comp√©tences",data:[92,88,85,90,87,94],backgroundColor:"rgba(99, 102, 241, 0.2)",borderColor:"rgb(99, 102, 241)",borderWidth:2,pointBackgroundColor:"rgb(99, 102, 241)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgb(99, 102, 241)"}]},options:{responsive:!0,maintainAspectRatio:!0,scales:{r:{beginAtZero:!0,max:100,ticks:{stepSize:20}}},plugins:{legend:{display:!1}}}})}function Ot(){const e=document.getElementById("scores-trend-chart");if(!e)return;const n=d.get("monthsData").filter((r,s)=>s<k);new Chart(e,{type:"line",data:{labels:n.map(r=>r.name),datasets:[{label:"Score (%)",data:n.map(r=>r.score),backgroundColor:"rgba(99, 102, 241, 0.1)",borderColor:"rgb(99, 102, 241)",borderWidth:3,fill:!0,tension:.4,pointRadius:5,pointHoverRadius:7,pointBackgroundColor:"rgb(99, 102, 241)",pointBorderColor:"#fff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!0,scales:{y:{beginAtZero:!0,max:100,ticks:{callback:function(r){return r+"%"}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(r){return"Score: "+r.parsed.y+"%"}}}}}})}function Qt(){const e=document.getElementById("activity-heatmap");if(!e)return;const t=52,n=7;let r='<div class="flex gap-1">';for(let s=0;s<t;s++){r+='<div class="flex flex-col gap-1">';for(let a=0;a<n;a++){const o=s*n+a;let l=0;o%30<28&&(l=Math.floor(Math.random()*4)+1),r+=`<div class="w-3 h-3 rounded-sm ${["bg-slate-100","bg-green-200","bg-green-400","bg-green-600","bg-green-800"][l]}" title="Activit√©"></div>`}r+="</div>"}r+="</div>",e.innerHTML=r}let le=!1;function Pt(){le||(le=!0,console.log("üîß Attachement des listeners de navigation (une seule fois)..."),document.getElementById("nav-dashboard")?.addEventListener("click",e=>{e.preventDefault(),A("dashboard"),$("nav-dashboard")}),document.getElementById("nav-quiz")?.addEventListener("click",e=>{e.preventDefault();const n=d.get("monthsData")[k]?.name||"ce mois";x.moduleSelectionTitle.textContent=`Quiz de ${n}`,A("moduleSelection"),$("nav-quiz")}),document.getElementById("nav-results")?.addEventListener("click",e=>{e.preventDefault();const t=e.currentTarget;window.__QUIZ_ACTIVE?confirm("Un quiz est en cours. Voulez-vous vraiment quitter ?")&&t&&t.href&&(window.location.href=t.href):t&&t.href&&(window.location.href=t.href)}),document.getElementById("nav-resources")?.addEventListener("click",e=>{e.preventDefault();const t=e.currentTarget;window.__QUIZ_ACTIVE?confirm("Un quiz est en cours. Voulez-vous vraiment quitter ?")&&t&&t.href&&(window.location.href=t.href):t&&t.href&&(window.location.href=t.href)}),console.log("‚úÖ Listeners de navigation attach√©s"))}function Nt(){d.get("dashboardEventDelegationAttached")||(document.addEventListener("click",e=>{if(e.target.closest(".start-quiz-button")){e.preventDefault();const a=d.get("monthsData")[k]?.name||"ce mois";x.moduleSelectionTitle.textContent=`Quiz de ${a}`,A("moduleSelection"),$("nav-quiz");return}if(e.target.closest(".back-to-dashboard")){e.preventDefault(),A("dashboard"),$("nav-dashboard");return}const r=e.target.closest(".module-card");if(r){e.preventDefault();const s=r.getAttribute("data-module");s&&Ee(s)}}),d.set("dashboardEventDelegationAttached",!0))}function jt(e){if(e){x.userName.textContent=e.displayName||"Utilisateur",x.userAvatar.src=e.photoURL||"https://placehold.co/100x100/667eea/e0e7ff?text="+(e.displayName?.[0]||"U");const t=d.get("monthsData"),n=e.displayName?.split(" ")[0]||"Utilisateur",r=t[k]?.name||"ce mois";x.welcomeMessage.textContent=`Bonjour ${n}, pr√™t √† relever votre d√©fi de ${r} ?`}}function Vt(){const e=localStorage.getItem("theme")||"light";document.documentElement.classList.toggle("dark",e==="dark"),ze(e)}function ze(e){const t=document.getElementById("theme-icon-sun"),n=document.getElementById("theme-icon-moon"),r=document.getElementById("theme-text");e==="dark"?(t?.classList.remove("hidden"),n?.classList.add("hidden"),r&&(r.textContent="Mode Clair")):(t?.classList.add("hidden"),n?.classList.remove("hidden"),r&&(r.textContent="Mode Sombre"))}function Ut(){const t=(document.documentElement.classList.contains("dark")?"dark":"light")==="dark"?"light":"dark";document.documentElement.classList.toggle("dark"),localStorage.setItem("theme",t),ze(t)}document.addEventListener("DOMContentLoaded",()=>{pe("Dashboard","/index.html"),console.log("üöÄ Initialisation de QuizPro..."),Vt(),Pt(),document.getElementById("theme-toggle")?.addEventListener("click",Ut),x.googleSigninBtn?.addEventListener("click",de),x.signoutLink?.addEventListener("click",e=>{e.preventDefault(),confirm("Voulez-vous vraiment vous d√©connecter ?")&&De()}),A("login"),Le(e=>{e?(console.log("‚úÖ Utilisateur connect√©:",e.displayName),jt(e),A("dashboard"),$("nav-dashboard"),_t()):(console.log("üë§ Aucun utilisateur connect√©"),A("login"))}),console.log("‚úÖ QuizPro initialis√© avec succ√®s")});
//# sourceMappingURL=main-H4kD5KkZ.js.map
