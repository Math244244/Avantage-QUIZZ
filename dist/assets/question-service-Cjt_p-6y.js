import{k as f,l as w,n as h,o as p,s as y,p as l,q as g,j as q,m as c,h as A}from"./auth-r9CQeqie.js";import{collection as E,where as a,orderBy as b,query as I,getDocs as Q,Timestamp as m,addDoc as x,doc as L,getDoc as S,deleteDoc as C}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";const d={questions:"questions"};async function O(e={}){const r=f(["questions",JSON.stringify(e||{})]),n=w(r);if(n)return n;try{let o=E(h,d.questions);const t=[];e.module&&t.push(a("module","==",e.module)),e.month&&t.push(a("month","==",e.month)),e.year&&t.push(a("year","==",e.year)),t.push(b("createdAt","desc")),t.length>0&&(o=I(o,...t));const i=await p(()=>Q(o)),s=[];return i.forEach(u=>{s.push({id:u.id,...u.data()})}),console.log(`üìö ${s.length} questions charg√©es`),y(r,s,"questions"),s}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration questions:",o),o}}async function M(e){try{const r=l.currentUser;if(!r)throw new Error("Utilisateur non connect√©");if(!e.question||e.question.length<10)throw new Error("La question doit contenir au moins 10 caract√®res");if(!e.options||e.options.length!==4)throw new Error("La question doit avoir exactement 4 options");if(e.correctAnswer===void 0||e.correctAnswer<0||e.correctAnswer>3)throw new Error("La r√©ponse correcte doit √™tre entre 0 et 3");if(!e.explanation||e.explanation.length<20)throw new Error("L'explication doit contenir au moins 20 caract√®res");if(!["auto","loisir","vr","tracteur"].includes(e.module))throw new Error("Module invalide");if(!e.month||e.month<1||e.month>12)throw new Error("Mois invalide");const n={question:e.question.trim(),options:e.options.map(t=>t.trim()),correctAnswer:parseInt(e.correctAnswer),explanation:e.explanation.trim(),module:e.module,month:parseInt(e.month),year:e.year||new Date().getFullYear(),createdAt:m.now(),createdBy:r.uid,updatedAt:m.now()},o=await g(()=>x(E(h,d.questions),n));return console.log("‚úÖ Question cr√©√©e:",o.id),await q({action:"CREATE_QUESTION",questionId:o.id,adminId:r.uid,adminEmail:r.email}),c("questions"),c("questions-stats"),o.id}catch(r){throw console.error("‚ùå Erreur cr√©ation question:",r),r}}async function v(e){try{const r=l.currentUser;if(!r)throw new Error("Utilisateur non connect√©");const n=L(h,d.questions,e),t=(await p(()=>S(n))).data();return await g(()=>C(n)),console.log("üóëÔ∏è Question supprim√©e:",e),await q({action:"DELETE_QUESTION",questionId:e,adminId:r.uid,adminEmail:r.email,deletedData:t}),c("questions"),c("questions-stats"),!0}catch(r){throw console.error("‚ùå Erreur suppression question:",r),r}}async function T(e){try{const r=l.currentUser;if(!r)throw new Error("Utilisateur non connect√©");if(!e.module||!e.month||!e.year||!e.questions)throw new Error("Format JSON invalide - champs obligatoires manquants");if(!Array.isArray(e.questions)||e.questions.length===0)throw new Error("Le fichier JSON doit contenir au moins une question");const n=[],o=[];for(let t=0;t<e.questions.length;t++){const i=e.questions[t];try{const s={question:i.question,options:i.options,correctAnswer:i.correctAnswer,explanation:i.explanation,module:e.module,month:e.month,year:e.year},u=await M(s);n.push(u)}catch(s){o.push({index:t,error:s.message}),console.error(`‚ùå Erreur question ${t+1}:`,s.message)}}return await A({importedBy:r.uid,module:e.module,month:e.month,year:e.year,totalQuestions:e.questions.length,successCount:n.length,errorCount:o.length,status:o.length===0?"success":"partial"}),console.log(`‚úÖ Import termin√©: ${n.length}/${e.questions.length} questions import√©es`),c("questions"),c("questions-stats"),{success:n.length,total:e.questions.length,errors:o,ids:n}}catch(r){throw console.error("‚ùå Erreur import JSON:",r),r}}async function F(){const e="questions-stats",r=w(e);if(r)return r;try{const n=await O(),o={total:n.length,byModule:{},byMonth:{},byYear:{}};return n.forEach(t=>{o.byModule[t.module]=(o.byModule[t.module]||0)+1,o.byMonth[t.month]=(o.byMonth[t.month]||0)+1,o.byYear[t.year]=(o.byYear[t.year]||0)+1}),y(e,o,"stats"),o}catch(n){throw console.error("‚ùå Erreur statistiques questions:",n),n}}export{F as a,M as c,v as d,O as g,T as i};
//# sourceMappingURL=question-service-Cjt_p-6y.js.map
