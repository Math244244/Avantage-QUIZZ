{"version":3,"mappings":";wxBAOA,MAAMA,GAAkB,CACpB,IAAK,QACL,IAAK,OACL,IAAK,OACL,IAAK,SACL,IAAK,SACL,IAAK,QACT,EAEMC,GAAoB,YAEnB,SAASC,GAAaC,EAAK,CAC9B,OAAIA,GAAQ,KAAkC,GAEhC,OAAOA,CAAG,EACX,QAAQF,GAAmBG,GAAQJ,GAAgBI,CAAI,GAAKA,CAAI,CACjF,CAOO,SAASC,EAAWC,EAAM,CAC7B,OAAOJ,GAAaI,CAAI,CAC5B,WC5BA,MAAMC,GACD,OAAO,OAAW,KAAe,OAAO,OAAO,SAAa,KAC5D,OAAO,UAAc,KAAe,qBAAqB,KAAK,UAAU,WAAa,EAAE,GACvF,OAAO,WAAe,KAAe,EAAQ,WAAW,mBACxD,OAAO,WAAe,KAAe,EAAQ,WAAW,oBACxD,OAAO,YAAgB,KAAe,EAAQ,YAAY,QAC1D,OAAO,QAAY,KAAeC,IAAa,sBAAwB,QACvE,OAAO,QAAY,KAAe,GACjCC,GAAqBF,GAAe,EAAI,IAQvC,SAASG,EAAUC,EAASC,EAAO,OAAQC,EAAW,IAAM,CAC/D,MAAMC,EAAYC,GAAA,EAEZC,EAAQC,GAAmBN,EAASC,CAAI,EAC9C,OAAAE,EAAU,YAAYE,CAAK,EAG3B,WAAW,IAAMA,EAAM,UAAU,IAAI,MAAM,EAAG,EAAE,EAG5CH,EAAW,GACX,WAAW,IAAM,CACbK,EAAWF,CAAK,CACpB,EAAGH,CAAQ,EAGRG,CACX,CAKA,SAASD,IAA4B,CACjC,IAAID,EAAY,SAAS,eAAe,iBAAiB,EAEzD,OAAKA,IACDA,EAAY,SAAS,cAAc,KAAK,EACxCA,EAAU,GAAK,kBACfA,EAAU,UAAY,+CACtB,SAAS,KAAK,YAAYA,CAAS,GAGhCA,CACX,CAKA,SAASG,GAAmBN,EAASC,EAAM,CACvC,MAAMI,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,UAAY,eAAeJ,CAAI,0DAIjCA,IAAS,SACTI,EAAM,aAAa,OAAQ,OAAO,EAClCA,EAAM,aAAa,YAAa,WAAW,IAE3CA,EAAM,aAAa,OAAQ,QAAQ,EACnCA,EAAM,aAAa,YAAa,QAAQ,GAE5CA,EAAM,aAAa,cAAe,MAAM,EAExC,MAAMG,EAASC,GAAeR,CAAI,EAElCI,SAAM,UAAY;AAAA,uFACiEG,EAAO,WAAW;AAAA;AAAA,kBAEvFA,EAAO,IAAI;AAAA;AAAA;AAAA,gEAGmCd,EAAWM,CAAO,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAW9DK,EAAM,cAAc,cAAc,EAC1C,iBAAiB,QAAS,IAAME,EAAWF,CAAK,CAAC,EAEnDA,CACX,CAKA,SAASI,GAAeR,EAAM,CAC1B,MAAMS,EAAU,CACZ,QAAS,CACL,YAAa,mBACb,KAAM;AAAA;AAAA;AAAA;AAAA,qBAMV,MAAO,CACH,YAAa,iBACb,KAAM;AAAA;AAAA;AAAA;AAAA,qBAMV,QAAS,CACL,YAAa,oBACb,KAAM;AAAA;AAAA;AAAA;AAAA,qBAMV,KAAM,CACF,YAAa,kBACb,KAAM;AAAA;AAAA;AAAA;AAAA,oBAKV,EAGJ,OAAOA,EAAQT,CAAI,GAAKS,EAAQ,IACpC,CAKA,SAASH,EAAWF,EAAO,CACvB,GAAI,CAACA,GAASA,EAAM,QAAQ,UAAY,OAAQ,OAEhDA,EAAM,QAAQ,QAAU,OACxBA,EAAM,UAAU,OAAO,MAAM,EAC7BA,EAAM,UAAU,IAAI,MAAM,EAC1BA,EAAM,UAAU,IAAI,kBAAkB,EAEtC,MAAMF,EAAY,SAAS,eAAe,iBAAiB,EACrDQ,EACFR,GACA,MAAM,KAAKA,EAAU,QAAQ,EAAE,QAClBS,IAAUP,GAASO,EAAM,UAAU,SAAS,OAAO,GAGhED,IACAN,EAAM,UAAU,OAAO,OAAO,EAC9BA,EAAM,UAAU,IAAI,eAAe,GAGvC,MAAMQ,EAAc,IAAM,CACtBR,EAAM,SAEN,MAAMS,EAAmB,SAAS,eAAe,iBAAiB,EAC9DA,GAAoBA,EAAiB,SAAS,SAAW,GACzDA,EAAiB,QAEzB,EAEMC,EAAeJ,EAAwB,EAAKf,GAAe,IAAME,GAEnEiB,IAAiB,EACjBF,EAAA,EAEA,WAAWA,EAAaE,CAAY,CAE5C,CAKO,MAAMV,EAAQ,CACjB,QAAS,CAACL,EAASE,IAAaH,EAAUC,EAAS,UAAWE,CAAQ,EACtE,MAAO,CAACF,EAASE,IAAaH,EAAUC,EAAS,QAASE,CAAQ,EAClE,QAAS,CAACF,EAASE,IAAaH,EAAUC,EAAS,UAAWE,CAAQ,EACtE,KAAM,CAACF,EAASE,IAAaH,EAAUC,EAAS,OAAQE,CAAQ,CACpE,EAkDO,SAASc,GAAiBhB,EAAS,CACtC,MAAMG,EAAYC,GAAA,EAEZC,EAAQ,SAAS,cAAc,KAAK,EAC1CA,SAAM,UAAY,6EAClBA,EAAM,aAAa,eAAgB,MAAM,EAEzCA,EAAM,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gEAM0CX,EAAWM,CAAO,CAAC;AAAA;AAAA;AAAA,MAK/EG,EAAU,YAAYE,CAAK,EAG3B,WAAW,IAAMA,EAAM,UAAU,IAAI,MAAM,EAAG,EAAE,EAEzCA,CACX,CAKO,SAASY,GAAmBZ,EAAOL,EAASC,EAAO,UAAW,CACjE,GAAI,CAACI,GAAS,CAACA,EAAM,aAAa,cAAc,EAAG,OAEnD,MAAMG,EAASC,GAAeR,CAAI,EAE5BiB,EAAUb,EAAM,UAAU,SAAS,MAAM,EAC/CA,EAAM,UAAY,eAAeJ,CAAI,yCAAyCiB,EAAU,QAAU,EAAE,GAEpGb,EAAM,UAAY;AAAA,uFACiEG,EAAO,WAAW;AAAA;AAAA,kBAEvFA,EAAO,IAAI;AAAA;AAAA;AAAA,gEAGmCd,EAAWM,CAAO,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAU/EK,EAAM,gBAAgB,cAAc,EACpCA,EAAM,cAAc,cAAc,EAAE,iBAAiB,QAAS,IAAME,EAAWF,CAAK,CAAC,EAGrF,WAAW,IAAME,EAAWF,CAAK,EAAG,GAAI,CAC5C,CAmDA,GAAI,OAAO,SAAa,IAAa,CACjC,MAAMc,EAAe,SAAS,cAAc,OAAO,EACnDA,EAAa,YAAc;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAyB3B,SAAS,KAAK,YAAYA,CAAY,CAC1C,CCrXA,MAAMC,EAAgB,OAAO,SAAS,WAAa,aAC9B,OAAO,SAAS,WAAa,aAC7B,OAAO,SAAS,WAAa,eAC7B,OAAO,SAAS,OAAS,OAMjCC,EAAS,CAIlB,IAAK,IAAIC,IAAS,CACVF,GACA,QAAQ,IAAI,GAAGE,CAAI,CAE3B,EAKA,MAAO,IAAIA,IAAS,CAChB,QAAQ,MAAM,GAAGA,CAAI,CACzB,EAKA,KAAM,IAAIA,IAAS,CACXF,GACA,QAAQ,KAAK,GAAGE,CAAI,CAE5B,EAKA,KAAM,IAAIA,IAAS,CACXF,GACA,QAAQ,KAAK,GAAGE,CAAI,CAE5B,EAKA,MAAO,IAAIA,IAAS,CACZF,GACA,QAAQ,MAAM,GAAGE,CAAI,CAE7B,EAKA,SAAU,IAAM,CACRF,GACA,QAAQ,SAAQ,CAExB,EAKA,MAAO,IAAIE,IAAS,CACZF,GACA,QAAQ,MAAM,GAAGE,CAAI,CAE7B,CACJ,EAII,QAAQ,IADRF,EACY,uCAEA,qDAFsC,EC9CtD,MAAMG,GAAiB,CACrB,OAAQ,0CACR,WAAY,iCACZ,YAAa,qDACb,UAAW,iBACX,cAAe,qCACf,kBAAmB,eACnB,MAAO,2CACT,EAGMC,EAAMC,GAAcF,EAAc,EAG3BG,EAAOC,GAAQH,CAAG,EAClBI,EAAKC,GAAaL,CAAG,EACRM,GAAYN,CAAG,EAClC,MAAMO,GAAYC,GAAaR,CAAG,EAKzCH,EAAO,IAAI,mCAAmC,EAC9CA,EAAO,IAAI,aAAcE,GAAe,SAAS,EACjDF,EAAO,IAAI,2DAA2D,6sCC7ChEY,GAAW,IAAIC,GACrBD,GAAS,oBAAoB,CACzB,OAAQ,gBACZ,CAAC,EAGD,IAAIE,EAAmB,GAGhB,eAAeC,IAAmB,CAErC,GAAID,EACA,eAAQ,KAAK,mDAAmD,EACzD,KAGXA,EAAmB,GAEnB,GAAI,CACA,QAAQ,IAAI,qCAAqC,EAEjD,MAAME,GADS,MAAMC,GAAgBZ,EAAMO,EAAQ,GAC/B,KAEpB,eAAQ,IAAI,8BAA+BI,EAAK,WAAW,EAC3D,QAAQ,IAAI,YAAaA,EAAK,KAAK,EAGnC,MAAME,GAAmBF,CAAI,EAEtBA,CACX,OAASG,EAAO,CACZ,QAAQ,MAAM,yBAA0BA,CAAK,EAG7C,IAAIC,EAAe,mDAEnB,GAAID,EAAM,OAAS,4BACfC,EAAe,iDACRD,EAAM,OAAS,qBACtBC,EAAe,8DACRD,EAAM,OAAS,2BACtBC,EAAe,oEACRD,EAAM,OAAS,+BAEtB,eAAQ,KAAK,6CAA6C,EACnD,KAGX,MAAIA,EAAM,OAAS,gCACf,MAAMC,CAAY,EAEhBD,CACV,QAAC,CAEG,WAAW,IAAM,CACbL,EAAmB,EACvB,EAAG,GAAI,CACX,CACJ,CAGO,eAAeO,IAAc,CAChC,GAAI,CACA,MAAMC,EAAWjB,EAAK,aAAa,aAAe,cAClD,MAAMkB,GAAQlB,CAAI,EAClB,QAAQ,IAAI,yBAA0BiB,CAAQ,CAClD,OAASH,EAAO,CACZ,cAAQ,MAAM,2BAA4BA,CAAK,EACzCA,CACV,CACJ,CAGO,SAASK,GAAaC,EAAU,CACnC,OAAOC,GAAmBrB,EAAOW,GAAS,CAClCA,EACA,QAAQ,IAAI,2BAA4BA,EAAK,KAAK,EAElD,QAAQ,IAAI,+BAA+B,EAE/CS,EAAST,CAAI,CACjB,CAAC,CACL,CAGO,SAASW,IAAiB,CAC7B,OAAOtB,EAAK,WAChB,CAQO,eAAeuB,GAAmBC,EAAa,CAClD,GAAI,CAACA,EAAa,OAIlB,GAFgBA,EAAY,OAAS,QAExB,CAET,MAAMC,EAAe,SAAS,eAAe,gBAAgB,EACzDA,GACAA,EAAa,UAAU,OAAO,QAAQ,EAI1C,MAAMC,EAAgB,SAAS,eAAe,iBAAiB,EAC3DA,GACAA,EAAc,UAAU,OAAO,QAAQ,EAG3C,QAAQ,IAAI,yBAAyB,CACzC,CACJ,CAqDO,SAASC,GAAa,CACzB,OAAO,aAAa,QAAQ,UAAU,IAAM,MAChD,CAKO,SAASC,IAAc,CAC1B,GAAI,CACA,MAAMC,EAAe,aAAa,QAAQ,UAAU,EACpD,OAAKA,EAEY,KAAK,MAAMA,CAAY,EAFd,IAI9B,OAASf,EAAO,CACZ,eAAQ,MAAM,qCAAsCA,CAAK,EAClD,IACX,CACJ,CAKO,SAASgB,IAAwB,CAEpC,OAAIH,EAAU,EACHC,GAAW,EAIfN,GAAc,CACzB,CCvMO,eAAeS,IAAe,CACjC,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CAEpC,GAAIN,EAAU,EAAI,CACd,MAAMO,EAAWN,KACjB,GAAIM,GAAYA,EAAS,OAAS,QAAS,CACvC,QAAQ,IAAI,gCAAiCA,EAAS,KAAK,EAC3DF,EAAQE,CAAQ,EAChB,MACJ,KAAO,CACH,QAAQ,KAAK,4CAA4C,EACzD,MAAM,4DAA4D,EAClE,OAAO,SAAS,KAAO,cACvBD,EAAO,IAAI,MAAM,cAAc,CAAC,EAChC,MACJ,CACJ,CAGA,MAAME,EAAcnC,EAAK,mBAAmB,MAAOW,GAAS,CAGxD,GAFAwB,IAEI,CAACxB,EAAM,CACP,QAAQ,KAAK,0CAA0C,EACvD,OAAO,SAAS,KAAO,cACvBsB,EAAO,IAAI,MAAM,iBAAiB,CAAC,EACnC,MACJ,CAEA,GAAI,CAEA,MAAMT,EAAc,MAAMY,GAAezB,EAAK,GAAG,EAEjD,GAAI,CAACa,GAAeA,EAAY,OAAS,QAAS,CAC9C,QAAQ,KAAK,gDAAgD,EAC7D,MAAM,4DAA4D,EAClE,OAAO,SAAS,KAAO,cACvBS,EAAO,IAAI,MAAM,cAAc,CAAC,EAChC,MACJ,CAEA,QAAQ,IAAI,oBAAqBtB,EAAK,KAAK,EAC3CqB,EAAQrB,CAAI,CAChB,OAASG,EAAO,CACZ,QAAQ,MAAM,+BAAgCA,CAAK,EACnD,OAAO,SAAS,KAAO,cACvBmB,EAAOnB,CAAK,CAChB,CACJ,CAAC,CACL,CAAC,CACL,CC3BO,SAASuB,GAAmBC,EAAQ,EAAG,CAC1C,MAAMC,EAAY,GAElB,QAASC,EAAI,EAAGA,EAAIF,EAAOE,IACvBD,EAAU,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAWd,EAGL,OAAOA,EAAU,KAAK,EAAE,CAC5B,CAiDO,SAASE,GAAsB,CAClC,MAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAaX,CAgEO,SAASC,GAAuBJ,EAAQ,EAAG,CAC9C,MAAMK,EAAY,GAElB,QAASH,EAAI,EAAGA,EAAIF,EAAOE,IACvBG,EAAU,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAuBd,EAGL,OAAOA,EAAU,KAAK,EAAE,CAC5B,CAOO,SAASC,GAAmBN,EAAQ,GAAI,CAC3C,MAAMO,EAAQ,GAEd,QAASL,EAAI,EAAGA,EAAIF,EAAOE,IACvBK,EAAM,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAgBV,EAGL,OAAOA,EAAM,KAAK,EAAE,CACxB,CAOO,SAASC,GAAqBR,EAAQ,EAAG,CAC5C,MAAMS,EAAU,GAEhB,QAASP,EAAI,EAAGA,EAAIF,EAAOE,IACvBO,EAAQ,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAsBZ,EAGL,OAAOA,EAAQ,KAAK,EAAE,CAC1B,CAOO,SAASC,GAAuBV,EAAQ,EAAG,CAC9C,MAAMW,EAAY,GAElB,QAAST,EAAI,EAAGA,EAAIF,EAAOE,IACvBS,EAAU,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAkBd,EAGL,OAAOA,EAAU,KAAK,EAAE,CAC5B,CAOO,SAASC,GAAoBZ,EAAQ,EAAG,CAC3C,MAAMa,EAAQ,GAEd,QAASX,EAAI,EAAGA,EAAIF,EAAOE,IACvBW,EAAM,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SASV,EAGL,OAAOA,EAAM,KAAK,EAAE,CACxB,CAOO,SAASC,EAAaC,EAAaC,EAAc,CACpD,MAAM7E,EAAY,SAAS,eAAe4E,CAAW,EACjD5E,IACAA,EAAU,UAAY6E,EAE9B,CClUA,MAAMC,GAAmB,gCAGzB,SAASC,IAAoB,CACzB,GAAI,CAAC7B,IAAc,MAAO,GAE1B,MAAM8B,EAAQ,aAAa,QAAQF,EAAgB,EACnD,GAAIE,EACA,GAAI,CAGA,OAFe,KAAK,MAAMA,CAAK,EAEjB,IAAIC,IAAM,CACpB,GAAGA,EACH,UAAW,IAAI,KAAKA,EAAE,SAAS,CAC/C,EAAc,CACN,OAASC,EAAG,CACR,QAAQ,KAAK,oCAAqCA,CAAC,CACvD,CAIJ,MAAO,CACH,CAAE,GAAI,IAAK,OAAQ,OAAQ,MAAO,GAAI,KAAM,KAAM,SAAU,6EAA+E,QAAS,CAAC,SAAU,SAAU,SAAU,QAAQ,EAAG,cAAe,EAAG,YAAa,gFAAiF,UAAW,IAAI,IAAM,EACnU,CAAE,GAAI,IAAK,OAAQ,OAAQ,MAAO,GAAI,KAAM,KAAM,SAAU,sDAAwD,QAAS,CAAC,mBAAoB,oBAAqB,oBAAqB,mBAAmB,EAAG,cAAe,EAAG,YAAa,oGAAsG,UAAW,IAAI,IAAM,EAC5W,CAAE,GAAI,IAAK,OAAQ,SAAU,MAAO,GAAI,KAAM,KAAM,SAAU,iEAAkE,QAAS,CAAC,UAAW,UAAW,UAAW,SAAS,EAAG,cAAe,EAAG,YAAa,wEAAyE,UAAW,IAAI,IAAM,EACpT,CAAE,GAAI,IAAK,OAAQ,KAAM,MAAO,GAAI,KAAM,KAAM,SAAU,wEAAyE,QAAS,CAAC,QAAS,SAAU,SAAU,QAAQ,EAAG,cAAe,EAAG,YAAa,+DAAgE,UAAW,IAAI,IAAM,EACzS,CAAE,GAAI,IAAK,OAAQ,WAAY,MAAO,GAAI,KAAM,KAAM,SAAU,uEAAwE,QAAS,CAAC,WAAY,WAAY,WAAY,UAAU,EAAG,cAAe,EAAG,YAAa,0DAA2D,UAAW,IAAI,IAAM,CAC1T,CACA,CAGA,SAASC,GAAkBjB,EAAW,CAC7BhB,EAAU,IACf,aAAa,QAAQ4B,GAAkB,KAAK,UAAUZ,CAAS,CAAC,EAChE,QAAQ,IAAI,kCAAmCA,EAAU,MAAM,EACnE,CAGA,IAAIkB,EAAiBL,GAAiB,EAEtC,MAAMM,GAAa,CACf,MAAO,IACP,SAAU,CAAE,KAAM,GAAI,OAAQ,GAAI,GAAI,GAAI,SAAU,EAAE,EACtD,OAAQ,EACZ,EAGA,IAAIC,EAAmB,GACnBC,EAAiB,CACjB,OAAQ,GACR,MAAO,GACP,KAAM,IAAI,KAAI,EAAG,YAAW,CAChC,EACIC,EAAc,EAClB,MAAMC,EAAmB,GAKlB,eAAeC,IAAuB,CACzC,QAAQ,IAAI,6CAA6C,EAGzD,MAAMC,EAAa,EAGnB,MAAMC,EAAS,EAGfC,IACJ,CAKA,SAASA,IAAqB,CAE1B,MAAMC,EAAa,SAAS,eAAe,sBAAsB,EAC7DA,GACAA,EAAW,iBAAiB,SAAUC,EAAoB,EAI9D,MAAMC,EAAY,SAAS,eAAe,iBAAiB,EACvDA,GACAA,EAAU,iBAAiB,SAAUC,EAAgB,EAIzD,MAAMC,EAAY,SAAS,eAAe,iBAAiB,EACvDA,GACAA,EAAU,iBAAiB,QAAS,IAAMF,GAAW,MAAK,CAAE,EAIhE,MAAMG,EAAe,SAAS,eAAe,eAAe,EACtDC,EAAc,SAAS,eAAe,cAAc,EACpDC,EAAa,SAAS,eAAe,aAAa,EAClDC,EAAc,SAAS,eAAe,kBAAkB,EACxDC,EAAgB,SAAS,eAAe,gBAAgB,EAE1DJ,GAAcA,EAAa,iBAAiB,SAAUK,CAAkB,EACxEJ,GAAaA,EAAY,iBAAiB,SAAUI,CAAkB,EACtEH,GAAYA,EAAW,iBAAiB,SAAUG,CAAkB,EACpEF,GAAaA,EAAY,iBAAiB,QAASG,EAAY,EAE/DF,GAAiB,CAACA,EAAc,QAAQ,cACxCA,EAAc,iBAAiB,QAASG,EAAwB,EAChEH,EAAc,QAAQ,YAAc,QAIxC,MAAMI,EAAU,SAAS,eAAe,eAAe,EACjDC,EAAU,SAAS,eAAe,eAAe,EAEnDD,GAASA,EAAQ,iBAAiB,QAAS,IAAME,GAAW,EAAE,CAAC,EAC/DD,GAASA,EAAQ,iBAAiB,QAAS,IAAMC,GAAW,CAAC,CAAC,CACtE,CAEA,SAASH,GAAyBI,EAAO,CACrC,MAAMC,EAAeD,EAAM,OAAO,QAAQ,0CAA0C,EACpF,GAAI,CAACC,EACD,OAGJ,MAAMC,EAAaD,EAAa,QAAQ,WACxC,GAAKC,EAIL,IAAID,EAAa,UAAU,SAAS,mBAAmB,EAAG,CACtDE,GAAcD,CAAU,EACxB,MACJ,CAEID,EAAa,UAAU,SAAS,qBAAqB,GACrDG,GAAqBF,CAAU,EAEvC,CAKA,eAAerB,GAAgB,CAC3B,GAAI,CAQA,GANkB,SAAS,eAAe,gBAAgB,GAEtDhB,EAAa,iBAAkBV,GAAuB,CAAC,CAAC,EAIxDf,EAAU,EAAI,CACd,QAAQ,IAAI,qDAAqD,EAGjE,MAAM,IAAI,QAAQK,GAAW,WAAWA,EAAS,GAAG,CAAC,EAGrD+B,EAAmBF,EAAe,OAAOH,GACjCM,IAAe,QAAUN,EAAE,SAAWM,EAAe,QACrDA,EAAe,OAASN,EAAE,QAAU,SAASM,EAAe,KAAK,GACjEA,EAAe,MAAQN,EAAE,OAAS,SAASM,EAAe,IAAI,EAErE,EAED,QAAQ,IAAI,KAAKD,EAAiB,MAAM,8BAA8B,EACtE6B,IACA,MACJ,CAGA,MAAMC,EAAU,GACZ7B,EAAe,SAAQ6B,EAAQ,OAAS7B,EAAe,QACvDA,EAAe,QAAO6B,EAAQ,MAAQ,SAAS7B,EAAe,KAAK,GACnEA,EAAe,OAAM6B,EAAQ,KAAO,SAAS7B,EAAe,IAAI,GAEpED,EAAmB,MAAM+B,GAAaD,CAAO,EAC7C,QAAQ,IAAI,uBAAuB9B,EAAiB,MAAM,EAAE,EAE5D6B,GACJ,OAAS9E,EAAO,CACZ,QAAQ,MAAM,+BAAgCA,CAAK,EACnD,MAAMrC,EAAY,SAAS,eAAe,gBAAgB,EACtDA,IACAA,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yCAMOqC,EAAM,OAAO;AAAA;AAAA,cAIlD,CACJ,CAKA,SAAS8E,GAAsB,CAC3B,MAAMnH,EAAY,SAAS,eAAe,gBAAgB,EAC1D,GAAI,CAACA,EAAW,OAEhB,GAAIsF,EAAiB,SAAW,EAAG,CAC/B,MAAMgC,EAAa,SAAS,cAAc,KAAK,EAC/CA,EAAW,UAAY,mCACvBA,EAAW,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAOvBtH,EAAU,gBAAgBsH,CAAU,EACpC,MACJ,CAGA,MAAMC,GAAc/B,EAAc,GAAKC,EACjC+B,EAAWD,EAAa9B,EACxBgC,EAAqBnC,EAAiB,MAAMiC,EAAYC,CAAQ,EAEhEE,EAAW,SAAS,yBAC1BD,EAAmB,QAAQE,GAAY,CACnCD,EAAS,YAAYE,GAA0BD,CAAQ,CAAC,CAC5D,CAAC,EAED3H,EAAU,gBAAgB0H,CAAQ,EAGlCG,IACJ,CAKA,SAASD,GAA0BD,EAAU,CACzC,MAAMG,EAAe,CACjB,KAAM,MACN,OAAQ,OACR,GAAI,SACJ,SAAU,OAClB,EAEUC,EAAc,CAChB,KAAM,KACN,OAAQ,MACR,GAAI,KACJ,SAAU,IAClB,EAEUC,EAAQF,EAAaH,EAAS,MAAM,GAAK,OACzCM,EAAOF,EAAYJ,EAAS,MAAM,GAAK,KAGvCO,EADa,CAAC,MAAO,MAAO,MAAO,MAAO,MAAO,OAAQ,OAAQ,OAAQ,MAAO,MAAO,MAAO,KAAK,EAC5EP,EAAS,MAAQ,CAAC,GAAKA,EAAS,MACvDQ,EAAYR,EAAS,WAAW,QAChC,IAAI,KAAKA,EAAS,UAAU,QAAU,GAAI,EAC1CA,EAAS,qBAAqB,KAC1BA,EAAS,UACT,KACJS,EAAmBD,EAAYA,EAAU,mBAAmB,OAAO,EAAI,MAEvEE,EAAW,SAAS,cAAc,UAAU,EAClD,OAAAA,EAAS,UAAY;AAAA,oIAC2GV,EAAS,EAAE;AAAA;AAAA;AAAA,6CAGlGM,CAAI;AAAA;AAAA,uDAEMD,CAAK,aAAaA,CAAK;AAAA,8BAChDzI,EAAWoI,EAAS,OAAO,YAAW,CAAE,CAAC;AAAA;AAAA,oEAEHpI,EAAW,GAAG2I,CAAS,IAAIP,EAAS,IAAI,EAAE,CAAC;AAAA;AAAA;AAAA;AAAA,+JAIgDA,EAAS,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA,mJAKvBA,EAAS,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oEAO1FpI,EAAWoI,EAAS,QAAQ,CAAC;AAAA;AAAA,kBAE/EA,EAAS,QAAQ,IAAI,CAACW,EAAKC,IAAQ;AAAA,iEACYA,IAAQZ,EAAS,cAAgB,uDAAyD,gBAAgB;AAAA,kDACzH,OAAO,aAAa,GAAKY,CAAG,CAAC;AAAA,gCAC/ChJ,EAAW+I,CAAG,CAAC;AAAA,0BACrBC,IAAQZ,EAAS,cAAgB,0SAA4S,EAAE;AAAA;AAAA,iBAExV,EAAE,KAAK,EAAE,CAAC;AAAA;AAAA;AAAA;AAAA,mDAIwBpI,EAAWoI,EAAS,WAAW,CAAC;AAAA;AAAA;AAAA,4BAGvDpI,EAAW6I,CAAgB,CAAC,GAAGT,EAAS,UAAYpI,EAAW,WAAWoI,EAAS,SAAS,EAAE,EAAI,EAAE;AAAA;AAAA;AAAA,MAKrHU,EAAS,QAAQ,iBAC5B,CAKA,eAAetC,GAAqB,EAAG,CACnC,EAAE,eAAc,EAEhB,MAAMyC,EAAO,EAAE,OACTC,EAAYD,EAAK,cAAc,iBAAiB,EAChDE,EAAkBD,EAAU,UAElC,GAAI,CACAA,EAAU,SAAW,GACrBA,EAAU,UAAY,wWAEtB,MAAME,EAAe,CACjB,SAAUH,EAAK,cAAc,mBAAmB,EAAE,MAClD,QAAS,CACLA,EAAK,cAAc,kBAAkB,EAAE,MACvCA,EAAK,cAAc,kBAAkB,EAAE,MACvCA,EAAK,cAAc,kBAAkB,EAAE,MACvCA,EAAK,cAAc,kBAAkB,EAAE,KACvD,EACY,cAAe,SAASA,EAAK,cAAc,gCAAgC,EAAE,KAAK,EAClF,YAAaA,EAAK,cAAc,sBAAsB,EAAE,MACxD,OAAQA,EAAK,cAAc,iBAAiB,EAAE,MAC9C,MAAO,SAASA,EAAK,cAAc,gBAAgB,EAAE,KAAK,EAC1D,KAAM,SAASA,EAAK,cAAc,eAAe,EAAE,KAAK,CACpE,EAGQ,GAAItF,EAAU,EAAI,CACd,QAAQ,IAAI,gDAAgD,EAC5D,MAAM,IAAI,QAAQK,GAAW,WAAWA,EAAS,GAAG,CAAC,EAGrD,MAAMqF,EAAkB,CACpB,GAAI,QAAQ,KAAK,IAAG,CAAE,GACtB,GAAGD,EACH,YAAaA,EAAa,aAAe,0BACzC,UAAW,IAAI,IAC/B,EACYvD,EAAe,QAAQwD,CAAe,EAGtCzD,GAAkBC,CAAc,EAEhCyD,EAAY,4CAA4C,EACxDL,EAAK,MAAK,EAEV,MAAM7C,EAAa,EACnB,MAAMC,EAAS,EACf,MACJ,CAEA,MAAMkD,GAAeH,CAAY,EAEjCE,EAAY,6BAA6B,EACzCL,EAAK,MAAK,EACV,MAAM7C,EAAa,EACnB,MAAMC,EAAS,CACnB,OAASvD,EAAO,CACZ,QAAQ,MAAM,4BAA6BA,CAAK,EAChD0G,EAAU,wBAAyB1G,EAAM,SAAW,4BAA4B,CACpF,QAAC,CACGoG,EAAU,SAAW,GACrBA,EAAU,UAAYC,CAC1B,CACJ,CAKA,eAAezC,GAAiB,EAAG,CAC/B,MAAM+C,EAAO,EAAE,OAAO,MAAM,CAAC,EAC7B,GAAKA,EAEL,GAAI,CACAC,GAAY,cAAc,EAE1B,MAAMzJ,EAAO,MAAMwJ,EAAK,OAClBE,EAAW,KAAK,MAAM1J,CAAI,EAGhC2J,GAAmBD,CAAQ,EAG3BE,GAAgBF,EAAUF,EAAK,IAAI,CACvC,OAAS3G,EAAO,CACZ,QAAQ,MAAM,uBAAwBA,CAAK,EAC3C0G,EAAU,eAAgB1G,EAAM,SAAW,uBAAuB,CACtE,CACJ,CAKA,SAAS8G,GAAmBE,EAAM,CAC9B,GAAI,CAACA,EAAK,QAAU,CAACA,EAAK,OAAS,CAACA,EAAK,KACrC,MAAM,IAAI,MAAM,oDAAoD,EAGxE,GAAI,CAAC,MAAM,QAAQA,EAAK,SAAS,GAAKA,EAAK,UAAU,SAAW,EAC5D,MAAM,IAAI,MAAM,gDAAgD,EAIpE,OAAAA,EAAK,UAAU,QAAQ,CAACpE,EAAGsD,IAAQ,CAC/B,GAAI,CAACtD,EAAE,UAAYA,EAAE,SAAS,OAAS,GACnC,MAAM,IAAI,MAAM,YAAYsD,EAAM,CAAC,wCAAwC,EAE/E,GAAI,CAAC,MAAM,QAAQtD,EAAE,OAAO,GAAKA,EAAE,QAAQ,SAAW,EAClD,MAAM,IAAI,MAAM,YAAYsD,EAAM,CAAC,mCAAmC,EAE1E,GAAItD,EAAE,gBAAkB,QAAaA,EAAE,cAAgB,GAAKA,EAAE,cAAgB,EAC1E,MAAM,IAAI,MAAM,YAAYsD,EAAM,CAAC,0CAA0C,EAEjF,GAAI,CAACtD,EAAE,aAAeA,EAAE,YAAY,OAAS,GACzC,MAAM,IAAI,MAAM,YAAYsD,EAAM,CAAC,+CAA+C,CAE1F,CAAC,EAEM,EACX,CAKA,SAASa,GAAgBC,EAAMC,EAAU,CACrC,MAAMtJ,EAAY,SAAS,eAAe,cAAc,EACxD,GAAI,CAACA,EAAW,OAEhB,MAAMuJ,EAAc,CAChB,KAAM,OACN,OAAQ,SACR,GAAI,KACJ,SAAU,UAClB,EAEUC,EAAa,CAAC,UAAW,UAAW,OAAQ,QAAS,MAAO,OAAQ,UAAW,OAAQ,YAAa,UAAW,WAAY,UAAU,EAE3IxJ,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA,2EAIiDsJ,CAAQ;AAAA;AAAA;AAAA,sDAG7BD,EAAK,UAAU,MAAM;AAAA,8DACbE,EAAYF,EAAK,MAAM,GAAKA,EAAK,MAAM;AAAA,+DACtCG,EAAWH,EAAK,MAAQ,CAAC,CAAC,IAAIA,EAAK,IAAI;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAahFA,EAAK,UAAU,MAAM,EAAG,CAAC,EAAE,IAAI,CAACpE,EAAGsD,IAAQ;AAAA,sCAC3BA,EAAM,CAAC,cAAchJ,EAAW0F,EAAE,SAAS,UAAU,EAAG,EAAE,CAAC,CAAC,GAAGA,EAAE,SAAS,OAAS,GAAK,MAAQ,EAAE;AAAA,qBACnH,EAAE,KAAK,EAAE,CAAC;AAAA,sBACToE,EAAK,UAAU,OAAS,EAAI,4CAA4CA,EAAK,UAAU,OAAS,CAAC,iBAAmB,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAMzGA,EAAK,UAAU,MAAM;AAAA;AAAA;AAAA;AAAA,MAOpD,SAAS,eAAe,oBAAoB,GAAG,iBAAiB,QAAS,IAAMI,GAAoBJ,CAAI,CAAC,EACxG,SAAS,eAAe,mBAAmB,GAAG,iBAAiB,QAAS,IAAM,CAC1ErJ,EAAU,UAAY,GACtB,SAAS,eAAe,iBAAiB,EAAE,MAAQ,EACvD,CAAC,CACL,CAKA,eAAeyJ,GAAoBJ,EAAM,CACrC,MAAMrJ,EAAY,SAAS,eAAe,cAAc,EAClD0J,EAAa,SAAS,eAAe,oBAAoB,EAE/D,GAAI,CAKA,GAJAA,EAAW,SAAW,GACtBA,EAAW,UAAY,uMAGnBxG,EAAU,EAAI,CACd,QAAQ,IAAI,0CAA0C,EACtD,MAAM,IAAI,QAAQK,GAAW,WAAWA,EAAS,GAAI,CAAC,EAEtD,MAAMoG,EAAoBN,EAAK,WAAa,GAC5CM,EAAkB,QAAQ,CAAC1E,EAAGsD,IAAQ,CAClCnD,EAAe,QAAQ,CACnB,GAAI,iBAAiB,KAAK,IAAG,CAAE,IAAImD,CAAG,GACtC,SAAUtD,EAAE,SACZ,QAASA,EAAE,QACX,cAAeA,EAAE,cACjB,YAAaA,EAAE,aAAe,4BAC9B,OAAQoE,EAAK,OACb,MAAOA,EAAK,MACZ,KAAMA,EAAK,KACX,UAAW,IAAI,IACnC,CAAiB,CACL,CAAC,EAGDlE,GAAkBC,CAAc,EAEhCyD,EAAY,iCAAiCc,EAAkB,MAAM,sBAAsB,EAE3F3J,EAAU,UAAY,GACtB,SAAS,eAAe,iBAAiB,EAAE,MAAQ,GAEnD,MAAM2F,EAAa,EACnB,MAAMC,EAAS,EACf,MACJ,CAEA,MAAMgE,EAAS,MAAMC,GAAwBR,CAAI,EAEjDR,EAAY,mBAAmBe,EAAO,OAAO,IAAIA,EAAO,KAAK,sBAAsB,EAE/EA,EAAO,OAAO,OAAS,GACvB,QAAQ,KAAK,kBAAmBA,EAAO,MAAM,EAGjD5J,EAAU,UAAY,GACtB,SAAS,eAAe,iBAAiB,EAAE,MAAQ,GAEnD,MAAM2F,EAAa,EACnB,MAAMC,EAAS,CACnB,OAASvD,EAAO,CACZ,QAAQ,MAAM,iBAAkBA,CAAK,EACrC0G,EAAU,eAAgB1G,EAAM,SAAW,yBAAyB,CACxE,CACJ,CAKA,SAAS4E,GAAcD,EAAY,CACd1B,EAAiB,KAAKL,GAAKA,EAAE,KAAO+B,CAAU,GAK/D,MAAM,0BAA0BA,CAAU;AAAA,+BAAkC,CAChF,CAKA,eAAeE,GAAqBF,EAAY,CAC5C,MAAMW,EAAWrC,EAAiB,KAAKL,GAAKA,EAAE,KAAO+B,CAAU,EAO/D,GANI,GAACW,GAMD,CAJkB,QAClB;;AAAA,GAAsDA,EAAS,SAAS,UAAU,EAAG,GAAG,CAAC;;AAAA,+BACjG,GAII,GAAI,CAEA,GAAIzE,EAAU,EAAI,CACd,QAAQ,IAAI,mDAAmD,EAC/D,MAAM,IAAI,QAAQK,GAAW,WAAWA,EAAS,GAAG,CAAC,EAErD,MAAMuG,EAAQ1E,EAAe,UAAUH,GAAKA,EAAE,KAAO+B,CAAU,EAC3D8C,EAAQ,KACR1E,EAAe,OAAO0E,EAAO,CAAC,EAG9B3E,GAAkBC,CAAc,GAGpCyD,EAAY,8CAA8C,EAC1D,MAAMlD,EAAa,EACnB,MAAMC,EAAS,EACf,MACJ,CAEA,MAAMmE,GAAe/C,CAAU,EAC/B6B,EAAY,gCAAgC,EAC5C,MAAMlD,EAAa,EACnB,MAAMC,EAAS,CACnB,OAASvD,EAAO,CACZ,QAAQ,MAAM,sBAAuBA,CAAK,EAC1C0G,EAAU,iBAAkB1G,EAAM,SAAW,+BAA+B,CAChF,CACJ,CAKA,eAAemE,EAAmB,EAAG,CACjC,MAAMwD,EAAa,EAAE,OAAO,GAAG,QAAQ,UAAW,EAAE,EACpDzE,EAAeyE,CAAU,EAAI,EAAE,OAAO,MACtCxE,EAAc,EACd,MAAMG,EAAa,CACvB,CAKA,SAASc,GAAa,EAAG,CACrB,MAAMwD,EAAa,EAAE,OAAO,MAAM,YAAW,EAE7C,GAAI,CAACA,EAAY,CACb9C,IACA,MACJ,CAEA,MAAM+C,EAAW5E,EAAiB,OAAOL,GACrCA,EAAE,SAAS,cAAc,SAASgF,CAAU,GAC5ChF,EAAE,QAAQ,KAAKqD,GAAOA,EAAI,YAAW,EAAG,SAAS2B,CAAU,CAAC,GAC5DhF,EAAE,YAAY,cAAc,SAASgF,CAAU,CACvD,EAGUjK,EAAY,SAAS,eAAe,gBAAgB,EAC1D,GAAI,CAACA,EAAW,OAEhB,GAAIkK,EAAS,SAAW,EAAG,CACvB,MAAM5C,EAAa,SAAS,cAAc,KAAK,EAC/CA,EAAW,UAAY,mCACvBA,EAAW,UAAY;AAAA,sDACuB/H,EAAW0K,CAAU,CAAC;AAAA,UAEpEjK,EAAU,gBAAgBsH,CAAU,EACpC,MACJ,CAEA,MAAMI,EAAW,SAAS,yBAC1BwC,EAAS,QAAQvC,GAAY,CACzBD,EAAS,YAAYE,GAA0BD,CAAQ,CAAC,CAC5D,CAAC,EACD3H,EAAU,gBAAgB0H,CAAQ,CACtC,CAKA,SAASb,GAAWsD,EAAW,CAC3B,MAAMC,EAAa,KAAK,KAAK9E,EAAiB,OAASG,CAAgB,EACvED,GAAe2E,EAEX3E,EAAc,IAAGA,EAAc,GAC/BA,EAAc4E,IAAY5E,EAAc4E,GAE5CjD,IACA,OAAO,SAAS,CAAE,IAAK,EAAG,SAAU,QAAQ,CAAE,CAClD,CAKA,SAASU,IAA2B,CAChC,MAAMuC,EAAa,KAAK,KAAK9E,EAAiB,OAASG,CAAgB,EACjE4E,EAAW,SAAS,eAAe,WAAW,EAC9C1D,EAAU,SAAS,eAAe,eAAe,EACjDC,EAAU,SAAS,eAAe,eAAe,EAEnDyD,IACAA,EAAS,YAAc,QAAQ7E,CAAW,IAAI4E,GAAc,CAAC,IAG7DzD,IACAA,EAAQ,SAAWnB,IAAgB,GAGnCoB,IACAA,EAAQ,SAAWpB,IAAgB4E,GAAcA,IAAe,EAExE,CAKA,eAAexE,GAAY,CACvB,GAAI,CAEA,GAAI1C,EAAU,EAAI,CACd,QAAQ,IAAI,iDAAiD,EAC7DoH,GAAYjF,EAAU,EACtB,MACJ,CAGA,MAAMX,EAAQ,MAAM6F,KACpBD,GAAY5F,CAAK,CACrB,OAASrC,EAAO,CACZ,QAAQ,MAAM,2BAA4BA,CAAK,CACnD,CACJ,CAKA,SAASiI,GAAY5F,EAAO,CACxB,MAAM1E,EAAY,SAAS,eAAe,iBAAiB,EAC3D,GAAI,CAACA,EAAW,OAEhB,MAAMuJ,EAAc,CAChB,KAAM,OACN,OAAQ,SACR,GAAI,KACJ,SAAU,UAClB,EAEIvJ,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,yEAK+C0E,EAAM,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAMlE,OAAO,QAAQA,EAAM,QAAQ,EAAE,IAAI,CAAC,CAAC8F,EAAQ3G,CAAK,IAAM,CACtD,MAAM4G,GAAe5G,EAAQa,EAAM,MAAS,KAAK,QAAQ,CAAC,EAC1D,MAAO;AAAA;AAAA;AAAA,+DAGoC6E,EAAYiB,CAAM,GAAKA,CAAM;AAAA,8DAC9B3G,CAAK,KAAK4G,CAAU;AAAA;AAAA;AAAA,+GAG6BA,CAAU;AAAA;AAAA;AAAA,qBAIzG,CAAC,EAAE,KAAK,EAAE,CAAC;AAAA;AAAA;AAAA,KAI3B,CAKA,SAASxB,GAAYrE,EAAa,CAC9B,MAAM5E,EAAY,SAAS,eAAe4E,CAAW,EAChD5E,IAELA,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAS1B,CAKA,SAAS+I,EAAUnE,EAAa/E,EAAS,CACrC,MAAMG,EAAY,SAAS,eAAe4E,CAAW,EACrD,GAAI,CAAC5E,EAAW,CACZ,MAAM,WAAWH,CAAO,EAAE,EAC1B,MACJ,CAEAG,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,oDAK0BH,CAAO;AAAA;AAAA,KAG3D,CAKA,SAASgJ,EAAYhJ,EAAS,CAE1B,MAAMK,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,UAAY,kGAClBA,EAAM,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,0CAKoBL,CAAO;AAAA;AAAA,MAI7C,SAAS,KAAK,YAAYK,CAAK,EAE/B,WAAW,IAAM,CACbA,EAAM,OAAM,CAChB,EAAG,GAAI,CACX,CAKA,SAASX,EAAWC,EAAM,CACtB,MAAMkL,EAAM,SAAS,cAAc,KAAK,EACxC,OAAAA,EAAI,YAAclL,EACXkL,EAAI,SACf,CCv0BA,MAAMC,GAAa,CACf,CAAE,GAAI,IAAK,MAAO,2BAA4B,YAAa,2BAA4B,KAAM,QAAS,aAAc,EAAG,aAAc,EAAG,UAAW,IAAI,KAAK,YAAY,EAAG,UAAW,IAAI,IAAM,EAChM,CAAE,GAAI,IAAK,MAAO,2BAA4B,YAAa,eAAgB,KAAM,OAAQ,aAAc,GAAI,aAAc,GAAI,UAAW,IAAI,KAAK,YAAY,EAAG,UAAW,IAAI,IAAM,EACrL,CAAE,GAAI,IAAK,MAAO,yBAA0B,YAAa,aAAc,KAAM,OAAQ,aAAc,GAAI,aAAc,GAAI,UAAW,IAAI,KAAK,YAAY,EAAG,UAAW,IAAI,KAAK,KAAK,IAAG,EAAK,KAAQ,CAAC,EACtM,CAAE,GAAI,IAAK,MAAO,6BAA8B,YAAa,iBAAkB,KAAM,OAAQ,aAAc,GAAI,aAAc,GAAI,UAAW,IAAI,KAAK,YAAY,EAAG,UAAW,IAAI,KAAK,KAAK,IAAG,EAAK,MAAS,CAAC,EAC/M,CAAE,GAAI,IAAK,MAAO,2BAA4B,YAAa,eAAgB,KAAM,OAAQ,aAAc,GAAI,aAAc,GAAI,UAAW,IAAI,KAAK,YAAY,EAAG,UAAW,IAAI,KAAK,KAAK,IAAG,EAAK,MAAS,CAAC,CAC/M,EAEMtF,GAAa,CACf,MAAO,GACP,OAAQ,EACR,aAAc,GACd,YAAa,EACb,WAAY,EAChB,EAGA,IAAIuF,EAAe,GACfrF,EAAiB,CACjB,KAAM,GACN,OAAQ,KACZ,EAGIsF,EAAkB,CAClB,QAAS,KACT,QAAS,GACT,UAAW,GACX,SAAU,EACd,EAKO,eAAeC,IAAmB,CACrC,QAAQ,IAAI,6CAA6C,EAGzD,MAAMC,GAAS,EAGf,MAAMnF,GAAS,EAGfC,IACJ,CAKA,SAASA,IAAqB,CAE1B,MAAMmF,EAAiB,SAAS,eAAe,kBAAkB,EAC7DA,GACAA,EAAe,iBAAiB,SAAUC,EAAgB,EAI9D,MAAMC,EAAsB,SAAS,eAAe,uBAAuB,EACvEA,GACAA,EAAoB,iBAAiB,QAASC,EAAsB,EAIxE,MAAMC,EAAa,SAAS,eAAe,kBAAkB,EACvDC,EAAe,SAAS,eAAe,oBAAoB,EAC3D/E,EAAc,SAAS,eAAe,cAAc,EAEtD8E,GAAYA,EAAW,iBAAiB,SAAU5E,EAAkB,EACpE6E,GAAcA,EAAa,iBAAiB,SAAU7E,EAAkB,EACxEF,GAAaA,EAAY,iBAAiB,QAASG,EAAY,CACvE,CAKA,eAAewE,GAAiB,EAAG,CAC/B,EAAE,eAAc,EAEhB,MAAMK,EAAW,SAAS,eAAe,mBAAmB,EACtDC,EAAa,SAAS,eAAe,qBAAqB,EAC1D9C,EAAY,SAAS,eAAe,iBAAiB,EAG3D6C,EAAS,UAAU,IAAI,QAAQ,EAC/BC,EAAW,UAAU,IAAI,QAAQ,EAGjC,MAAMC,EAAW,IAAI,SAAS,EAAE,MAAM,EAChCC,EAAW,CACb,YAAaD,EAAS,IAAI,aAAa,EACvC,MAAOA,EAAS,IAAI,OAAO,EAC3B,SAAUA,EAAS,IAAI,UAAU,EACjC,KAAMA,EAAS,IAAI,MAAM,CACjC,EAGI,GAAI,CAACC,EAAS,aAAe,CAACA,EAAS,OAAS,CAACA,EAAS,UAAY,CAACA,EAAS,KAAM,CAClFC,EAAcJ,EAAU,mCAAmC,EAC3DpL,EAAM,MAAM,kCAAkC,EAC9C,MACJ,CAEA,GAAIuL,EAAS,SAAS,OAAS,EAAG,CAC9BC,EAAcJ,EAAU,qDAAqD,EAC7EpL,EAAM,MAAM,gDAAgD,EAC5D,MACJ,CAGAuI,EAAU,SAAW,GACrBA,EAAU,YAAc,yBACxB,MAAMkD,EAAezL,EAAM,iBAAiB,8BAA+B,EAE3E,GAAI,CACA,cAAQ,IAAI,oCAAsCuL,EAAS,KAAK,EAIhEvL,EAAM,mBAAmByL,EAAc,yBAA0B,OAAO,EAClE,IAAI,MAAM;;AAAA;AAAA;AAAA,qCAAqW,CAwBzX,OAAStJ,EAAO,CACZ,QAAQ,MAAM,iCAAkCA,CAAK,EACrDqJ,EAAcJ,EAAUjJ,EAAM,OAAO,CACzC,QAAC,CAEGoG,EAAU,SAAW,GACrBA,EAAU,YAAc,uBAC5B,CACJ,CAKA,SAAS0C,IAAyB,CAC9B,MAAMS,EAAQ,+DAEd,IAAIC,EAAW,GAEf,QAAS9H,EAAI,EAAGA,EAAI,GAAQA,IACxB8H,GAAYD,EAAM,OAAO,KAAK,MAAM,KAAK,SAAWA,EAAM,MAAM,CAAC,EAIrE,MAAME,EAAgB,SAAS,cAAc,wBAAwB,EACjEA,IACAA,EAAc,MAAQD,EACtBC,EAAc,KAAO,OAGrB,UAAU,UAAU,UAAUD,CAAQ,EAAE,KAAK,IAAM,CAC/C3L,EAAM,QAAQ,6DAA8D,GAAI,CACpF,CAAC,EAAE,MAAM,IAAM,CACXA,EAAM,QAAQ,wBAAwB2L,CAAQ;;AAAA,yBAA+B,GAAI,CACrF,CAAC,EAET,CAKA,SAASH,EAAcJ,EAAUzL,EAAS,CACtCyL,EAAS,YAAczL,EACvByL,EAAS,UAAU,OAAO,QAAQ,EAClCA,EAAS,eAAe,CAAE,SAAU,SAAU,MAAO,SAAS,CAAE,CACpE,CAKA,eAAeP,IAAY,CACvB,GAAI,CAQA,GANkB,SAAS,eAAe,YAAY,GAElDpG,EAAa,aAAcR,GAAmB,EAAE,CAAC,EAIjDjB,EAAU,EAAI,CACd,QAAQ,IAAI,uDAAuD,EAGnE,MAAM,IAAI,QAAQK,GAAW,WAAWA,EAAS,GAAG,CAAC,EAGrDqH,EAAeD,GAAW,OAAOzI,GAAQ,CACrC,GAAIqD,EAAe,MAAQrD,EAAK,OAASqD,EAAe,KAAM,MAAO,GAErE,GAAIA,EAAe,SAAW,MAAO,CACjC,MAAMwG,EAAa,IAAI,KACvBA,EAAW,QAAQA,EAAW,QAAO,EAAK,CAAC,EAE3C,MAAMC,EADgB9J,EAAK,UACM6J,EAGjC,GADIxG,EAAe,SAAW,UAAY,CAACyG,GACvCzG,EAAe,SAAW,YAAcyG,EAAU,MAAO,EACjE,CAEA,MAAO,EACX,CAAC,EAED,QAAQ,IAAI,KAAKpB,EAAa,MAAM,+BAA+B,EACnEqB,IACA,MACJ,CAGA,MAAM7E,EAAU,GACZ7B,EAAe,OACf6B,EAAQ,KAAO7B,EAAe,MAIlCsF,EAAgB,QAAU,KAC1BA,EAAgB,QAAU,GAE1B,MAAMjB,EAAS,MAAMsC,GAAqB9E,EAASyD,EAAgB,SAAU,IAAI,EAMjF,GALAD,EAAehB,EAAO,MACtBiB,EAAgB,QAAUjB,EAAO,QACjCiB,EAAgB,QAAUjB,EAAO,QAG7BrE,EAAe,SAAW,MAAO,CACjC,MAAMwG,EAAa,IAAI,KACvBA,EAAW,QAAQA,EAAW,QAAO,EAAK,CAAC,EAE3CnB,EAAeA,EAAa,OAAO1I,GAAQ,CACvC,GAAI,CAACA,EAAK,UAAW,OAAOqD,EAAe,SAAW,WAGtD,MAAMyG,GADgB9J,EAAK,UAAU,OAASA,EAAK,UAAU,OAAM,EAAK,IAAI,KAAKA,EAAK,SAAS,GAC9D6J,EAEjC,OAAOxG,EAAe,SAAW,SAAWyG,EAAW,CAACA,CAC5D,CAAC,CACL,CAEA,QAAQ,IAAI,yBAAyBpB,EAAa,MAAM,EAAE,EAC1DqB,IACAE,IACJ,OAAS9J,EAAO,CACZ,QAAQ,MAAM,kCAAmCA,CAAK,EACtD,MAAMrC,EAAY,SAAS,eAAe,YAAY,EACtD,GAAIA,EAAW,CAEX,MAAMoM,EAAmB7M,EAAW8C,EAAM,OAAO,EACjDrC,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yCAMOoM,CAAgB;AAAA;AAAA,aAGjD,CACJ,CACJ,CAKA,SAASH,GAAkB,CACvB,MAAMjM,EAAY,SAAS,eAAe,YAAY,EACtD,GAAKA,EAEL,IAAI4K,EAAa,SAAW,EAAG,CAC3B5K,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAQtB,MACJ,CAEAA,EAAU,UAAY4K,EAAa,IAAI1I,GAAQmK,GAAenK,CAAI,CAAC,EAAE,KAAK,EAAE,EAG5EoK,KACJ,CAKA,eAAeC,IAAgB,CAC3B,GAAI,EAAA1B,EAAgB,WAAa,CAACA,EAAgB,SAIlD,GAAI,CACAA,EAAgB,UAAY,GAE5B,MAAMzD,EAAU,GACZ7B,EAAe,OACf6B,EAAQ,KAAO7B,EAAe,MAGlC,MAAMqE,EAAS,MAAMsC,GAAqB9E,EAASyD,EAAgB,SAAUA,EAAgB,OAAO,EAGpG,IAAI2B,EAAW5C,EAAO,MACtB,GAAIrE,EAAe,SAAW,MAAO,CACjC,MAAMwG,EAAa,IAAI,KACvBA,EAAW,QAAQA,EAAW,QAAO,EAAK,CAAC,EAE3CS,EAAWA,EAAS,OAAOtK,GAAQ,CAC/B,GAAI,CAACA,EAAK,UAAW,OAAOqD,EAAe,SAAW,WAGtD,MAAMyG,GADgB9J,EAAK,UAAU,OAASA,EAAK,UAAU,OAAM,EAAK,IAAI,KAAKA,EAAK,SAAS,GAC9D6J,EAEjC,OAAOxG,EAAe,SAAW,SAAWyG,EAAW,CAACA,CAC5D,CAAC,CACL,CAGApB,EAAe,CAAC,GAAGA,EAAc,GAAG4B,CAAQ,EAC5C3B,EAAgB,QAAUjB,EAAO,QACjCiB,EAAgB,QAAUjB,EAAO,QAEjCqC,IACAE,KAEA,QAAQ,IAAI,KAAKK,EAAS,MAAM,uCAAuC,CAC3E,OAASnK,EAAO,CACZ,QAAQ,MAAM,oDAAqDA,CAAK,EACxEnC,EAAM,MAAM,4DAA4D,CAC5E,QAAC,CACG2K,EAAgB,UAAY,EAChC,CACJ,CAKA,SAASsB,IAA2B,CAEhC,MAAMM,EAAmB,SAAS,eAAe,2BAA2B,EAM5E,GALIA,GACAA,EAAiB,OAAM,EAIvB,CAAC5B,EAAgB,SAAWD,EAAa,QAAUC,EAAgB,SACnE,OAGJ,MAAM7K,EAAY,SAAS,eAAe,YAAY,EACtD,GAAI,CAACA,EAAW,OAEhB,MAAM0M,EAAiB;AAAA;AAAA,cAEb7B,EAAgB,QAAU;AAAA;AAAA;AAAA;AAAA,sBAIlBA,EAAgB,UAAY,WAAa,EAAE;AAAA;AAAA,sBAE3CA,EAAgB,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAM1B;AAAA;AAAA;AAAA;AAAA;AAAA,qBAKH;AAAA;AAAA,cAEL,EAAE;AAAA;AAAA,kBAEAD,EAAa,MAAM,eAAeA,EAAa,OAAS,EAAI,IAAM,EAAE,WAAWA,EAAa,OAAS,EAAI,IAAM,EAAE;AAAA;AAAA;AAAA,MAK/H5K,EAAU,mBAAmB,YAAa0M,CAAc,EAGxD,MAAMC,EAAc,SAAS,eAAe,qBAAqB,EAC7DA,GACAA,EAAY,iBAAiB,QAASJ,EAAa,CAE3D,CAKA,SAASF,GAAenK,EAAM,CAC1B,MAAM0K,EAAU1K,EAAK,OAAS,QACxB2K,EAAYD,EAAU,SAAW,OACjCE,EAAWF,EAAU,KAAO,KAE5BG,EAAY7K,EAAK,UAClBA,EAAK,UAAU,OAASA,EAAK,UAAU,OAAM,EAAK,IAAI,KAAKA,EAAK,SAAS,EAC1E,KAEEiG,EAAYjG,EAAK,UAClBA,EAAK,UAAU,OAASA,EAAK,UAAU,OAAM,EAAK,IAAI,KAAKA,EAAK,SAAS,EAC1E,KAEE8J,EAAWe,GAAc,IAAI,KAASA,EAAc,MAAc,GAAK,IAEvEC,EAAgBD,EAAYE,GAAmBF,CAAS,EAAI,kBAG5DG,EAAkB3N,EAAW2C,EAAK,aAAe,UAAU,EAC3DiL,EAAY5N,EAAW2C,EAAK,OAAS,EAAE,EACvCkL,EAAgB7N,EAAW2C,EAAK,aAAe,MAAM,EACrDmL,EAAYnL,EAAK,UAAY,oCAAoC,mBAAmBA,EAAK,aAAeA,EAAK,KAAK,CAAC,wCAEzH,MAAO;AAAA,wHAC6GA,EAAK,GAAG;AAAA;AAAA,4BAEpGmL,CAAS,UAAUD,CAAa;AAAA;AAAA;AAAA;AAAA;AAAA,oFAKwBF,CAAe;AAAA,yEAC1BC,CAAS;AAAA;AAAA;AAAA,+JAG6EjL,EAAK,GAAG,sBAAsBA,EAAK,KAAK,qBAAqBA,EAAK,MAAQ,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yEAStK2K,CAAS,aAAaA,CAAS;AAAA,8BAC1EC,CAAQ,IAAIF,EAAU,QAAU,MAAM;AAAA;AAAA,sEAEEZ,EAAW,8BAAgC,6BAA6B;AAAA,gEAC9EA,EAAW,eAAiB,cAAc;AAAA,8BAC5EA,EAAW,QAAU,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oEAOQ7D,EAAYA,EAAU,mBAAmB,OAAO,EAAI,KAAK;AAAA;AAAA;AAAA;AAAA,oEAIzD6E,CAAa;AAAA;AAAA;AAAA;AAAA,sBAI1DJ,EAAkC,GAAxBU,GAAgBpL,CAAI,CAAM;AAAA;AAAA;AAAA;AAAA,KAK3D,CAKA,SAASoL,GAAgBpL,EAAM,CAC3B,MAAMqL,EAAerL,EAAK,cAAgB,EACpCsL,EAAetL,EAAK,cAAgB,EACpCuL,EAAgBvL,EAAK,eAAiB,EAE5C,MAAO;AAAA;AAAA;AAAA,oEAGyDsL,CAAY;AAAA;AAAA;AAAA;AAAA,+DAIjBD,CAAY;AAAA;AAAA;AAAA;AAAA,mEAIRE,CAAa;AAAA;AAAA;AAAA;AAAA,KAKhF,CAKA,SAASnB,IAAyB,CAC9B,SAAS,iBAAiB,gBAAgB,EAAE,QAAQoB,GAAO,CACvDA,EAAI,iBAAiB,QAAUxI,GAAM,CACjC,MAAMyI,EAASzI,EAAE,cAAc,QAAQ,OACjC0I,EAAY1I,EAAE,cAAc,QAAQ,UACpC2I,EAAW3I,EAAE,cAAc,QAAQ,SACzC4I,GAAkBH,EAAQC,EAAWC,CAAQ,CACjD,CAAC,CACL,CAAC,CACL,CAKA,SAASC,GAAkBH,EAAQC,EAAWG,EAAa,CAEvD,MAAMC,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,GAAK,kBACXA,EAAM,UAAY,iFAClBA,EAAM,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0DAaoCzO,EAAWqO,GAAa,EAAE,CAAC;AAAA;AAAA;AAAA;AAAA,4GAIuBG,IAAgB,QAAU,QAAU,MAAM;AAAA;AAAA;AAAA;AAAA,yIAIbA,IAAgB,QAAU,qCAAuC,kBAAkB;AAAA,uEACrJA,IAAgB,QAAU,UAAY,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yIAO0BA,IAAgB,QAAU,qCAAuC,kBAAkB;AAAA,wEACpJA,IAAgB,QAAU,UAAY,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MA0B5G,SAAS,KAAK,YAAYC,CAAK,EAG/B,SAAS,eAAe,iBAAiB,GAAG,iBAAiB,QAAS,IAAMA,EAAM,OAAM,CAAE,EAC1F,SAAS,eAAe,iBAAiB,GAAG,iBAAiB,QAAS,IAAMA,EAAM,OAAM,CAAE,EAC1F,SAAS,eAAe,eAAe,GAAG,iBAAiB,QAAS,SAAY,CAC5E,MAAMC,EAAUD,EAAM,cAAc,4BAA4B,GAAG,MAC/DC,IACA,MAAMC,GAAiBP,EAAQC,EAAWK,CAAO,EACjDD,EAAM,OAAM,EAEpB,CAAC,EAGDA,EAAM,iBAAiB,QAAU9I,GAAM,CAC/BA,EAAE,SAAW8I,GAAOA,EAAM,OAAM,CACxC,CAAC,CACL,CAKA,eAAeE,GAAiBP,EAAQC,EAAWK,EAAS,CACxD,MAAME,EAAU,SAAS,eAAe,eAAe,EACvD,GAAI,CAACA,EAAS,OAEd,MAAMC,EAAeD,EAAQ,UACvBxC,EAAezL,EAAM,iBAAiB,wBAAwB,EAEpE,GAAI,CACAiO,EAAQ,SAAW,GACnBA,EAAQ,UAAY,mMAEpB,MAAME,GAAeV,EAAQM,CAAO,EAEpC/N,EAAM,mBAAmByL,EAAc,wBAAwBiC,CAAS,GAAI,SAAS,EACrF/E,GAAY,wBAAwB+E,CAAS,KAAKK,IAAY,QAAU,QAAU,MAAM,EAAE,EAE1F,MAAMlD,GAAS,EACf,MAAMnF,GAAS,CACnB,OAASvD,EAAO,CACZ,QAAQ,MAAM,2BAA4BA,CAAK,EAC/CnC,EAAM,mBAAmByL,EAAc,wBAAyB,OAAO,EACvEzL,EAAM,MAAM,WAAWmC,EAAM,SAAW,qCAAqC,GAAI,GAAI,EACrF8L,EAAQ,SAAW,GACnBA,EAAQ,UAAYC,CACxB,CACJ,CAKA,eAAe5H,GAAmB,EAAG,CACjC,MAAMwD,EAAa,EAAE,OAAO,GAAG,QAAQ,eAAgB,EAAE,EAAE,QAAQ,IAAK,EAAE,EAC1EzE,EAAeyE,CAAU,EAAI,EAAE,OAAO,MACtC,MAAMe,GAAS,CACnB,CAKA,SAAStE,GAAa,EAAG,CACrB,MAAMwD,EAAa,EAAE,OAAO,MAAM,YAAW,EAE7C,GAAI,CAACA,EAAY,CACbgC,IACA,MACJ,CAEA,MAAM/B,EAAWU,EAAa,OAAO0D,GAChCA,EAAE,aAAeA,EAAE,YAAY,YAAW,EAAG,SAASrE,CAAU,GAChEqE,EAAE,OAASA,EAAE,MAAM,cAAc,SAASrE,CAAU,CAC7D,EAEUjK,EAAY,SAAS,eAAe,YAAY,EACtD,GAAI,CAACA,EAAW,OAEhB,GAAIkK,EAAS,SAAW,EAAG,CAEvB,MAAMqE,EAAiBhP,EAAW0K,CAAU,EAC5CjK,EAAU,UAAY;AAAA;AAAA,0DAE4BuO,CAAc;AAAA;AAAA,UAGhE,MACJ,CAGA,MAAMC,EAAO5D,EACbA,EAAeV,EACf+B,IACArB,EAAe4D,CACnB,CAKA,eAAe5I,IAAY,CACvB,GAAI,CAEA,GAAI1C,EAAU,EAAI,CACd,QAAQ,IAAI,8DAA8D,EAC1EoH,GAAYjF,EAAU,EACtB,MACJ,CAGA,MAAMX,EAAQ,MAAM+J,KACpBnE,GAAY5F,CAAK,CACrB,OAASrC,EAAO,CACZ,QAAQ,MAAM,2BAA4BA,CAAK,CACnD,CACJ,CAKA,SAASiI,GAAY5F,EAAO,CACxB,MAAM1E,EAAY,SAAS,eAAe,aAAa,EACvD,GAAI,CAACA,EAAW,OAEhB,MAAM0O,EAAmBhK,EAAM,MAAQ,EAAI,KAAK,MAAOA,EAAM,eAAiBA,EAAM,MAAS,GAAG,EAAI,EAEpG1E,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6EAMmD0E,EAAM,KAAK;AAAA;AAAA;AAAA;AAAA,yEAIfA,EAAM,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sDAS/BA,EAAM,cAAc,KAAKgK,CAAgB;AAAA;AAAA;AAAA,kGAGGA,CAAgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wEAM1ChK,EAAM,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA,mEAKvBA,EAAM,YAAY;AAAA;AAAA;AAAA;AAAA,KAKrF,CA6CA,SAASmE,GAAYhJ,EAAS,CAC1B,MAAMK,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,UAAY,kGAEd,MAAMyO,EAAcpP,EAAWM,CAAO,EACtCK,EAAM,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,0CAKgByO,CAAW;AAAA;AAAA,MAIjD,SAAS,KAAK,YAAYzO,CAAK,EAE/B,WAAW,IAAM,CACbA,EAAM,OAAM,CAChB,EAAG,GAAI,CACX,CAKA,SAAS+M,GAAmB2B,EAAM,CAE9B,MAAMC,EADM,IAAI,KACGD,EACbE,EAAU,KAAK,MAAMD,EAAO,GAAK,EACjCE,EAAQ,KAAK,MAAMF,EAAO,IAAO,EACjCG,EAAO,KAAK,MAAMH,EAAO,KAAQ,EAEvC,OAAIC,EAAU,EAAU,cACpBA,EAAU,GAAW,UAAUA,CAAO,OACtCC,EAAQ,GAAW,UAAUA,CAAK,IAClCC,IAAS,EAAU,OACnBA,EAAO,EAAU,UAAUA,CAAI,SAC/BA,EAAO,GAAW,UAAU,KAAK,MAAMA,EAAO,CAAC,CAAC,YAC7CJ,EAAK,mBAAmB,OAAO,CAC1C,CCj0BA,MAAMK,GAAY,CACd,MAAO,CACH,WAAY,GACZ,aAAc,IACd,eAAgB,IAChB,eAAgB,GAChB,SAAU,GACV,iBAAkB,EAClB,gBAAiB,GACjB,aAAc,GACd,YAAa,EACrB,EACI,SAAU,CACN,CAAE,GAAI,IAAK,MAAO,2BAA4B,YAAa,eAAgB,aAAc,GAAI,aAAc,EAAE,EAC7G,CAAE,GAAI,IAAK,MAAO,yBAA0B,YAAa,aAAc,aAAc,GAAI,aAAc,EAAE,EACzG,CAAE,GAAI,IAAK,MAAO,6BAA8B,YAAa,iBAAkB,aAAc,GAAI,aAAc,EAAE,EACjH,CAAE,GAAI,IAAK,MAAO,2BAA4B,YAAa,eAAgB,aAAc,GAAI,aAAc,EAAE,EAC7G,CAAE,GAAI,IAAK,MAAO,yBAA0B,YAAa,aAAc,aAAc,GAAI,aAAc,EAAE,EACzG,CAAE,GAAI,IAAK,MAAO,4BAA6B,YAAa,gBAAiB,aAAc,GAAI,aAAc,EAAE,EAC/G,CAAE,GAAI,IAAK,MAAO,2BAA4B,YAAa,eAAgB,aAAc,GAAI,aAAc,EAAE,EAC7G,CAAE,GAAI,IAAK,MAAO,0BAA2B,YAAa,cAAe,aAAc,GAAI,aAAc,EAAE,EAC3G,CAAE,GAAI,IAAK,MAAO,4BAA6B,YAAa,gBAAiB,aAAc,GAAI,aAAc,EAAE,EAC/G,CAAE,GAAI,KAAM,MAAO,6BAA8B,YAAa,iBAAkB,aAAc,GAAI,aAAc,EAAE,CAC1H,EACI,eAAgB,CACZ,CAAE,GAAI,IAAK,SAAU,eAAgB,OAAQ,kBAAmB,MAAO,GAAI,YAAa,IAAI,KAAK,KAAK,IAAG,EAAK,GAAM,CAAC,EACrH,CAAE,GAAI,IAAK,SAAU,aAAc,OAAQ,oBAAqB,MAAO,GAAI,YAAa,IAAI,KAAK,KAAK,IAAG,EAAK,IAAM,CAAC,EACrH,CAAE,GAAI,IAAK,SAAU,aAAc,OAAQ,gBAAiB,MAAO,GAAI,YAAa,IAAI,KAAK,KAAK,IAAG,EAAK,KAAO,CAAC,EAClH,CAAE,GAAI,IAAK,SAAU,iBAAkB,OAAQ,iBAAkB,MAAO,GAAI,YAAa,IAAI,KAAK,KAAK,IAAG,EAAK,IAAO,CAAC,EACvH,CAAE,GAAI,IAAK,SAAU,eAAgB,OAAQ,qBAAsB,MAAO,GAAI,YAAa,IAAI,KAAK,KAAK,IAAG,EAAK,IAAO,CAAC,CACjI,EACI,YAAa,CACT,CAAE,OAAQ,OAAQ,eAAgB,GAAI,SAAU,GAAI,YAAa,EAAE,EACnE,CAAE,OAAQ,SAAU,eAAgB,GAAI,SAAU,GAAI,YAAa,EAAE,EACrE,CAAE,OAAQ,KAAM,eAAgB,GAAI,SAAU,GAAI,YAAa,EAAE,EACjE,CAAE,OAAQ,WAAY,eAAgB,GAAI,SAAU,GAAI,YAAa,EAAE,CAC/E,CACA,EAIAC,EAAa,IAAI,cAAe,CAC5B,WAAY,EACZ,aAAc,EACd,eAAgB,EAChB,eAAgB,EAChB,SAAU,EACV,iBAAkB,EAClB,gBAAiB,EACjB,aAAc,EACd,YAAa,CACjB,CAAC,EAGDA,EAAa,IAAI,gBAAiB,IAAI,EACtCA,EAAa,IAAI,eAAgB,IAAI,EACrCA,EAAa,IAAI,gBAAiB,IAAI,EAK/B,eAAeC,IAAqB,CACvCjO,EAAO,KAAK,6CAA6C,EAGzDkO,KAEA,GAAI,CAEA,MAAM,QAAQ,IAAI,CACdC,GAAe,EACfC,GAAY,EACZC,GAAkB,EAClBC,GAAe,CAC3B,CAAS,EAGDC,KAGA5J,KAGA3F,EAAM,QAAQ,iCAAkC,GAAI,CAExD,OAASmC,EAAO,CAChBnB,EAAO,MAAM,iCAAkCmB,CAAK,EAEhDnC,EAAM,MAAM,yCAA0C,GAAI,CAC9D,CACJ,CAMA,eAAemP,IAAkB,CAC7B,GAAI,CAEA,IAAIK,EAAcR,EAAa,IAAI,aAAa,EAGhD,GAAIhM,EAAU,EAAI,CACdhC,EAAO,KAAK,wDAAwD,EACpEwO,EAAcT,GAAU,MACxBC,EAAa,IAAI,cAAeQ,CAAW,EAC3CC,IACAzO,EAAO,KAAK,oCAAqCwO,CAAW,EAC5D,MACJ,CAEAxO,EAAO,KAAK,4CAA4C,EAGxD,MAAM0O,EAAW,MAAMC,IAGvB,GAAI,CAEA,MAAMjG,EAAS,MADgBkG,GAAclO,GAAW,gBAAgB,EAC5B,CAAE,SAAAgO,CAAQ,CAAE,EAExD,GAAIhG,EAAO,MAAQA,EAAO,KAAK,QAAS,CACpC1I,EAAO,KAAK,4CAA4C,EACxDwO,EAAc9F,EAAO,KAAK,MAC1BsF,EAAa,IAAI,cAAeQ,CAAW,EAC3CC,IACA,MACJ,CACJ,OAASI,EAAoB,CAEzB7O,EAAO,KAAK,6DAA8D6O,EAAmB,OAAO,CACxG,CAIA,KAAM,CAAE,cAAAtB,CAAa,EAAK,MAAKuB,GAAA,8BAAAvB,GAAA,KAAC,QAAO,wBAAwB,OAAAwB,KAAA,oDACzD,CAAE,kBAAA1F,CAAiB,EAAK,MAAKyF,GAAA,kCAAAzF,GAAA,KAAC,QAAO,wBAAwB,OAAA0F,KAAA,wDAG7DC,EAAa,MAAMzB,IACzBiB,EAAY,WAAaQ,EAAW,OAAS,EAC7CR,EAAY,iBAAmBQ,EAAW,gBAAkB,EAC5DR,EAAY,gBAAkBQ,EAAW,gBAAkB,EAG3DR,EAAY,aAAeQ,EAAW,cAAgB,EACtDR,EAAY,SAAWQ,EAAW,cAAgB,EAGlD,MAAMC,EAAiB,MAAM5F,IAC7BmF,EAAY,eAAiBS,EAAe,OAAS,EAGrD,MAAMC,EAAiBC,EACnBC,EAAW7O,EAAI,WAAW,EAC1B8O,EAAM,WAAY,KAAMX,CAAQ,EAChCY,GAAM,GAAI,CACtB,EACcC,EAAoB,MAAMC,EAAQN,CAAc,EACtDV,EAAY,eAAiBe,EAAkB,KAG/C,MAAME,EAAQ,IAAI,KAClBA,EAAM,SAAS,EAAG,EAAG,EAAG,CAAC,EACzB,MAAMC,EAAgB,IAAI,KAC1BA,EAAc,QAAQA,EAAc,QAAO,EAAK,EAAE,EAElD,MAAMC,EAAqBR,EACvBC,EAAW7O,EAAI,aAAa,EAC5B8O,EAAM,WAAY,KAAMX,CAAQ,EAChCW,EAAM,cAAe,KAAMO,GAAU,SAASF,CAAa,CAAC,EAC5DG,GAAQ,cAAe,MAAM,EAC7BP,GAAM,GAAI,CACtB,EACcQ,EAAwB,MAAMN,EAAQG,CAAkB,EAGxDI,EAAU,IAAI,KACpBA,EAAQ,QAAQA,EAAQ,QAAO,EAAK,CAAC,EAErC,IAAIC,EAAe,EACfC,EAAc,EAClBH,EAAsB,QAAQI,GAAO,CACjC,MAAMC,EAAcD,EAAI,KAAI,EAAG,aAAa,OAAM,EAC9CC,IACIA,GAAeV,GACfO,IAEAG,GAAeJ,GACfE,IAGZ,CAAC,EACDzB,EAAY,aAAewB,EAC3BxB,EAAY,YAAcyB,EAG1BjC,EAAa,IAAI,cAAeQ,CAAW,EAG3CC,IAEAzO,EAAO,KAAK,+CAAgDwO,CAAW,CAE3E,OAASrN,EAAO,CACZ,MAAAnB,EAAO,MAAM,sCAAuCmB,CAAK,EACnDA,CACV,CACJ,CAKA,eAAeiN,IAAe,CAC1B,GAAI,CAEA,GAAIpM,EAAU,EAAI,CACdhC,EAAO,KAAK,+CAA+C,EAC3DoQ,GAAerC,GAAU,QAAQ,EACjC/N,EAAO,KAAK,wBAAwB,EACpC,MACJ,CAEJA,EAAO,KAAK,yCAAyC,EAGjD,KAAM,CAAE,eAAAqQ,CAAc,EAAK,MAAKvB,GAAA,+BAAAuB,GAAA,KAAC,QAAO,wBAAwB,iEAC1DC,EAAW,MAAMD,EAAe,EAAE,EAGlCE,EAAoBD,EAAS,IAAI,CAACtP,EAAM4H,KAAW,CACrD,GAAI5H,EAAK,KAAO,QAAQ4H,CAAK,GAC7B,MAAO5H,EAAK,OAAS,GACrB,YAAaA,EAAK,aAAe,cACjC,aAAcA,EAAK,cAAgB,EACnC,aAAcA,EAAK,cAAgB,CAC/C,EAAU,EAGFoP,GAAeG,CAAiB,EAEpCvQ,EAAO,KAAK,gCAAiCsQ,CAAQ,CAErD,OAASnP,EAAO,CAChB,MAAAnB,EAAO,MAAM,iCAAkCmB,CAAK,EAC1CA,CACV,CACJ,CAKA,eAAekN,IAAqB,CAChC,GAAI,CAEA,GAAIrM,EAAU,EAAI,CACdhC,EAAO,KAAK,oDAAqD,EACjEwQ,GAAqBzC,GAAU,cAAc,EAC7C/N,EAAO,KAAK,4BAA4B,EACxC,MACJ,CAEJA,EAAO,KAAK,wCAAyC,EAGjD,MAAM+D,EAAIoL,EACNC,EAAW7O,EAAI,aAAa,EAC5BsP,GAAQ,cAAe,MAAM,EAC7BP,GAAM,EAAE,CACpB,EAEcmB,EAAW,MAAMjB,EAAQzL,CAAC,EAC1B2M,EAAa,GAEnBD,EAAS,QAAQP,GAAO,CACpB,MAAM/H,EAAO+H,EAAI,OACjBQ,EAAW,KAAK,CACZ,GAAIR,EAAI,GACR,SAAU/H,EAAK,UAAY,cAC3B,OAAQA,EAAK,QAAU,SACvB,MAAOA,EAAK,OAAS,EACrB,YAAaA,EAAK,aAAa,OAAM,GAAM,IAAI,IAC/D,CAAa,CACL,CAAC,EAGDqI,GAAqBE,CAAU,EAEnC1Q,EAAO,KAAK,8BAA+B0Q,CAAU,CAErD,OAASvP,EAAO,CAChB,MAAAnB,EAAO,MAAM,gCAAiCmB,CAAK,EACzCA,CACV,CACJ,CAMA,eAAemN,IAAkB,CAC7B,GAAI,CAEA,GAAItM,EAAU,EAAI,CACdhC,EAAO,KAAK,yDAAyD,EAErE,MAAM2Q,EAAY,CACd,KAAQ,CAAE,MAAO,GAAI,WAAY,KAAM,SAAU,EAAE,EACnD,OAAU,CAAE,MAAO,GAAI,WAAY,KAAM,SAAU,EAAE,EACrD,GAAM,CAAE,MAAO,GAAI,WAAY,KAAM,SAAU,EAAE,EACjD,SAAY,CAAE,MAAO,GAAI,WAAY,KAAM,SAAU,EAAE,CACvE,EACY,OAAA3Q,EAAO,KAAK,qCAAsC2Q,CAAS,EACpDA,CACX,CAEA3Q,EAAO,KAAK,uCAAuC,EAGnD,MAAM0O,EAAW,MAAMC,IAGvB,GAAI,CAEA,MAAMjG,EAAS,MADgBkG,GAAclO,GAAW,gBAAgB,EAC5B,CAAE,SAAAgO,CAAQ,CAAE,EAExD,GAAIhG,EAAO,MAAQA,EAAO,KAAK,QAC3B,OAAA1I,EAAO,KAAK,gDAAgD,EACrD0I,EAAO,KAAK,WAE3B,OAASmG,EAAoB,CAEzB7O,EAAO,KAAK,6DAA8D6O,EAAmB,OAAO,CACxG,CAGA,MAAM+B,EAAezB,EAAMC,EAAW7O,EAAI,aAAa,EAAG8O,EAAM,WAAY,KAAMX,CAAQ,CAAC,EACrFmC,EAAkB,MAAMrB,EAAQoB,CAAY,EAC5CE,EAAc,GAEpB,OAAAD,EAAgB,QAAQX,GAAO,CAC3B,MAAM/H,EAAO+H,EAAI,OACX5G,EAASnB,EAAK,QAAU,QAEzB2I,EAAYxH,CAAM,IACnBwH,EAAYxH,CAAM,EAAI,CAClB,MAAO,EACP,WAAY,EACZ,SAAU,CAC9B,GAGYwH,EAAYxH,CAAM,EAAE,QACpBwH,EAAYxH,CAAM,EAAE,YAAcnB,EAAK,OAAS,CACpD,CAAC,EAGD,OAAO,OAAO2I,CAAW,EAAE,QAAQC,GAAQ,CACvCA,EAAK,SAAW,KAAK,MAAMA,EAAK,WAAaA,EAAK,KAAK,CAC3D,CAAC,EAED/Q,EAAO,KAAK,0CAA2C8Q,CAAW,EAC3DA,CAEX,OAAS3P,EAAO,CACZ,MAAAnB,EAAO,MAAM,qCAAsCmB,CAAK,EAClDA,CACV,CACJ,CAKA,SAASsN,GAAoB,CACzB,MAAM3P,EAAY,SAAS,eAAe,oBAAoB,EAC9D,GAAI,CAACA,EAAW,OAGhB,MAAM0P,EAAcR,EAAa,IAAI,aAAa,EAElDlP,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mDAWyBT,EAAW,OAAOmQ,EAAY,UAAU,CAAC,CAAC;AAAA;AAAA;AAAA,kFAGXA,EAAY,gBAAgB;AAAA,kFAC5BA,EAAY,eAAe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mDAc1DA,EAAY,YAAY;AAAA;AAAA;AAAA,kFAGOA,EAAY,YAAY;AAAA,kFACxBA,EAAY,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mDActDA,EAAY,QAAQ;AAAA;AAAA;AAAA;AAAA,uFAIgBA,EAAY,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mDAexDA,EAAY,cAAc;AAAA;AAAA;AAAA,kFAGKA,EAAY,cAAc;AAAA;AAAA;AAAA,KAI5G,CAKA,SAAS4B,GAAelN,EAAO,CAC3B,MAAMpE,EAAY,SAAS,eAAe,gBAAgB,EAC1D,GAAI,CAACA,EAAW,OAEhB,GAAIoE,EAAM,SAAW,EAAG,CACpB,MAAM8N,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,UAAY,kCAClBA,EAAM,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,UAMlBlS,EAAU,gBAAgBkS,CAAK,EAC/B,MACJ,CAEA,MAAMxK,EAAW,SAAS,yBAC1BtD,EAAM,QAAQ,CAAClC,EAAM4H,IAAU,CAC3B,MAAMqI,EAAQrI,IAAU,EAAI,KAAOA,IAAU,EAAI,KAAOA,IAAU,EAAI,KAAO,GAAGA,EAAQ,CAAC,IACnFsI,EAAUtI,IAAU,EAAI,kCAC1BA,IAAU,EAAI,+BACdA,IAAU,EAAI,wCACd,4BACFuI,EAAcnQ,EAAK,UAAYA,EAAK,aAAeA,EAAK,OAAS,cACjEM,EAAWjD,EAAW8S,CAAW,EAC7B9E,EAAe,OAAO,SAASrL,EAAK,YAAY,EAAIA,EAAK,aAAe,EACxEoQ,EAAW,OAAO,SAASpQ,EAAK,QAAQ,EAAIA,EAAK,SAAW,EAEhEqQ,EAAO,SAAS,cAAc,SAAS,EACzCA,EAAK,UAAY,2DAA2DH,CAAO,qCACnFG,EAAK,UAAY;AAAA;AAAA,uDAE8BhT,EAAW4S,CAAK,CAAC;AAAA;AAAA,+DAET3P,CAAQ;AAAA,wDACfjD,EAAW,GAAGgO,CAAY,iBAAiB,CAAC;AAAA;AAAA;AAAA;AAAA,kEAIlChO,EAAW,GAAG+S,CAAQ,GAAG,CAAC;AAAA;AAAA;AAAA,UAIpF5K,EAAS,YAAY6K,CAAI,CAC7B,CAAC,EAEDvS,EAAU,gBAAgB0H,CAAQ,CACtC,CAKA,SAASgK,GAAqBE,EAAY,CACtC,MAAM5R,EAAY,SAAS,eAAe,sBAAsB,EAChE,GAAI,CAACA,EAAW,OAEhB,GAAI4R,EAAW,SAAW,EAAG,CACzB,MAAMM,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,UAAY,kCAClBA,EAAM,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,UAMlBlS,EAAU,gBAAgBkS,CAAK,EAC/B,MACJ,CAEA,MAAMxK,EAAW,SAAS,yBAC1BkK,EAAW,QAAQY,GAAY,CAC/B,MAAMC,EAAaC,GAAWF,EAAS,WAAW,EAC5CG,EAAUpT,EAAWkT,CAAU,EAC3BG,EAAaJ,EAAS,OAAS,GAAK,iBACtCA,EAAS,OAAS,GAAK,kBACvB,eACFH,EAAcG,EAAS,UAAY,cACnChQ,EAAWjD,EAAW8S,CAAW,EACjCQ,EAAatT,EAAWiT,EAAS,QAAU,QAAQ,EAC/CM,EAAevT,EAAW,GAAG,OAAO,SAASiT,EAAS,KAAK,EAAIA,EAAS,MAAQ,CAAC,GAAG,EACxFO,EAAgBxT,EAAW8S,EAAY,OAAO,CAAC,EAAE,YAAW,CAAE,EAE1DW,EAAM,SAAS,cAAc,SAAS,EAC5CA,EAAI,UAAY,uFAChBA,EAAI,UAAY;AAAA;AAAA;AAAA,0EAGkDD,CAAa;AAAA;AAAA;AAAA,4DAG3BvQ,CAAQ;AAAA,wDACZqQ,CAAU;AAAA;AAAA;AAAA;AAAA,gDAIlBD,CAAU,KAAKE,CAAY;AAAA,sDACrBH,CAAO;AAAA;AAAA,UAGrDjL,EAAS,YAAYsL,CAAG,CAC5B,CAAC,EAEDhT,EAAU,gBAAgB0H,CAAQ,CACtC,CAKA,SAAS+H,IAAe,CAEpBwD,KAGAC,KAGAC,IACJ,CAKA,eAAeF,IAAsB,CACjC,MAAMG,EAAS,SAAS,eAAe,gBAAgB,EACvD,GAAKA,EAEL,GAAI,CACA,IAAIC,EAAQC,EAAQC,EAGpB,GAAIrQ,EAAU,EAAI,CACdhC,EAAO,KAAK,yDAAyD,EAGrEmS,EAAS,GACTC,EAAS,GACTC,EAAY,GAEZ,QAASxP,EAAI,GAAIA,GAAK,EAAGA,IAAK,CAC1B,MAAM6K,EAAO,IAAI,KACjBA,EAAK,QAAQA,EAAK,QAAO,EAAK7K,CAAC,EAC/BsP,EAAO,KAAKzE,EAAK,mBAAmB,QAAS,CAAE,IAAK,UAAW,MAAO,OAAO,CAAE,CAAC,EAGhF0E,EAAO,KAAK,KAAK,MAAM,KAAK,SAAW,EAAE,EAAI,CAAC,EAC9CC,EAAU,KAAK,KAAK,MAAM,KAAK,SAAW,EAAE,EAAI,EAAE,CACtD,CACJ,KAAO,CAGH,MAAM3C,EAAgB,IAAI,KAC1BA,EAAc,QAAQA,EAAc,QAAO,EAAK,EAAE,EAGlD,MAAMhB,EAAW,MAAMC,IACjBiC,EAAezB,EAAMC,EAAW7O,EAAI,aAAa,EAAG8O,EAAM,WAAY,KAAMX,CAAQ,CAAC,EACrFmC,EAAkB,MAAMrB,EAAQoB,CAAY,EAC5C0B,EAAY,GAGlB,QAASzP,EAAI,EAAGA,EAAI,GAAIA,IAAK,CACzB,MAAM6K,EAAO,IAAI,KACjBA,EAAK,QAAQA,EAAK,QAAO,EAAK7K,CAAC,EAC/B,MAAM0P,EAAU7E,EAAK,YAAW,EAAG,MAAM,GAAG,EAAE,CAAC,EAC/C4E,EAAUC,CAAO,EAAI,CAAE,MAAO,EAAG,WAAY,EACjD,CAGA1B,EAAgB,QAAQX,GAAO,CAC3B,MAAM/H,EAAO+H,EAAI,OACXC,EAAchI,EAAK,aAAa,OAAM,EAC5C,GAAIgI,GAAeA,GAAeT,EAAe,CAC7C,MAAM6C,EAAUpC,EAAY,YAAW,EAAG,MAAM,GAAG,EAAE,CAAC,EAClDmC,EAAUC,CAAO,IACjBD,EAAUC,CAAO,EAAE,QACnBD,EAAUC,CAAO,EAAE,YAAcpK,EAAK,OAAS,EAEvD,CACJ,CAAC,EAGDgK,EAAS,OAAO,KAAKG,CAAS,EAAE,QAAO,EAAG,IAAI5E,GAChC,IAAI,KAAKA,CAAI,EACd,mBAAmB,QAAS,CAAE,IAAK,UAAW,MAAO,OAAO,CAAE,CAC1E,EAED0E,EAAS,OAAO,OAAOE,CAAS,EAAE,UAAU,IAAIE,GAAKA,EAAE,KAAK,EAC5DH,EAAY,OAAO,OAAOC,CAAS,EAAE,QAAO,EAAG,IAAIE,GAC/CA,EAAE,MAAQ,EAAI,KAAK,MAAMA,EAAE,WAAaA,EAAE,KAAK,EAAI,CACnE,CACQ,CAIA,MAAMC,EAAgBzE,EAAa,IAAI,eAAe,EAClDyE,GAAeA,EAAc,UAEjC,MAAMC,EAAgB,IAAI,MAAMR,EAAQ,CACpC,KAAM,OACN,KAAM,CACF,OAAQC,EACR,SAAU,CACN,CACI,MAAO,iBACP,KAAMC,EACN,YAAa,mBACb,gBAAiB,yBACjB,QAAS,GACT,QAAS,IACT,qBAAsB,mBACtB,iBAAkB,OAClB,iBAAkB,CAC1C,EACoB,CACI,MAAO,kBACP,KAAMC,EACN,YAAa,oBACb,gBAAiB,0BACjB,QAAS,GACT,QAAS,KACT,qBAAsB,oBACtB,iBAAkB,OAClB,iBAAkB,CAC1C,CACA,CACA,EACY,QAAS,CACL,WAAY,GACZ,oBAAqB,GACrB,YAAa,CACT,KAAM,QACN,UAAW,EAC/B,EACgB,OAAQ,CACJ,EAAG,CACC,KAAM,SACN,QAAS,GACT,SAAU,OACV,MAAO,CACH,QAAS,GACT,KAAM,gBAClC,CACA,EACoB,GAAI,CACA,KAAM,SACN,QAAS,GACT,SAAU,QACV,MAAO,CACH,QAAS,GACT,KAAM,iBAClC,EACwB,KAAM,CACF,gBAAiB,EAC7C,CACA,CACA,EACgB,QAAS,CACL,OAAQ,CACJ,SAAU,KAClC,EACoB,MAAO,CACH,QAAS,GACT,KAAM,wBAC9B,CACA,CACA,CACA,CAAS,EAGDrE,EAAa,IAAI,gBAAiB0E,CAAa,CAEnD,OAASvR,EAAO,CAChBnB,EAAO,MAAM,2CAA4CmB,CAAK,CAC9D,CACJ,CAKA,eAAe6Q,IAAqB,CAChC,MAAME,EAAS,SAAS,eAAe,eAAe,EACtD,GAAKA,EAEL,GAAI,CACA,MAAMpB,EAAc,MAAMxC,KAEpB6D,EAAS,OAAO,KAAKrB,CAAW,EAChC3I,EAAO,OAAO,OAAO2I,CAAW,EAAE,IAAI6B,GAAKA,EAAE,KAAK,EAElDC,EAAS,CACX,yBACA,0BACA,yBACA,0BACA,wBACZ,EAGcC,EAAuB7E,EAAa,IAAI,cAAc,EACxD6E,GAAsBA,EAAqB,UAE/C,MAAMC,EAAe,IAAI,MAAMZ,EAAQ,CACnC,KAAM,WACN,KAAM,CACF,OAAQC,EACR,SAAU,CAAC,CACP,KAAMhK,EACN,gBAAiByK,EACjB,YAAa,EACb,YAAa,MACjC,CAAiB,CACjB,EACY,QAAS,CACL,WAAY,GACZ,oBAAqB,GACrB,QAAS,CACL,OAAQ,CACJ,SAAU,QAClC,EACoB,MAAO,CACH,QAAS,GACT,KAAM,wBAC9B,CACA,CACA,CACA,CAAS,EAGD5E,EAAa,IAAI,eAAgB8E,CAAY,CAEjD,OAAS3R,EAAO,CAChBnB,EAAO,MAAM,uCAAwCmB,CAAK,CAC1D,CACJ,CAKA,eAAe8Q,IAAsB,CACjC,MAAMC,EAAS,SAAS,eAAe,gBAAgB,EACvD,GAAKA,EAEL,GAAI,CAEA,MAAMC,EAAS,GACThK,EAAO,GAEb,QAAStF,EAAI,EAAGA,GAAK,EAAGA,IAAK,CACzB,MAAM6K,EAAO,IAAI,KACjBA,EAAK,QAAQA,EAAK,QAAO,EAAK7K,CAAC,EAC/BsP,EAAO,KAAKzE,EAAK,mBAAmB,QAAS,CAAE,QAAS,OAAO,CAAE,CAAC,EAClEvF,EAAK,KAAK,KAAK,MAAM,KAAK,SAAW,EAAE,EAAI,CAAC,CAChD,CAGA,MAAMsK,EAAgBzE,EAAa,IAAI,eAAe,EAClDyE,GAAeA,EAAc,UAEjC,MAAMM,EAAgB,IAAI,MAAMb,EAAQ,CACpC,KAAM,MACN,KAAM,CACF,OAAQC,EACR,SAAU,CAAC,CACP,MAAO,sBACP,KAAMhK,EACN,gBAAiB,yBACjB,YAAa,mBACb,YAAa,EACb,aAAc,EACd,qBAAsB,sBAC1C,CAAiB,CACjB,EACY,QAAS,CACL,WAAY,GACZ,oBAAqB,GACrB,QAAS,CACL,OAAQ,CACJ,QAAS,EACjC,EACoB,MAAO,CACH,QAAS,GACT,KAAM,+BAC9B,CACA,EACgB,OAAQ,CACJ,EAAG,CACC,YAAa,GACb,MAAO,CACH,SAAU,CACtC,CACA,CACA,CACA,CACA,CAAS,EAGD6F,EAAa,IAAI,gBAAiB+E,CAAa,CAEnD,OAAS5R,EAAO,CAChBnB,EAAO,MAAM,wCAAyCmB,CAAK,CAC3D,CACJ,CAKO,eAAe6R,IAAc,CAChC,MAAMvI,EAAezL,EAAM,iBAAiB,sBAAsB,EAElE,GAAI,CAEA,KAAM,CAAE,MAAAiU,CAAK,EAAK,OAAO,MACnB/C,EAAM,IAAI+C,EAGhB/C,EAAI,YAAY,EAAE,EAClBA,EAAI,KAAK,4BAA6B,GAAI,EAAE,EAG5CA,EAAI,YAAY,EAAE,EAClBA,EAAI,KAAK,aAAa,IAAI,KAAI,EAAG,mBAAmB,OAAO,CAAC,GAAI,GAAI,EAAE,EAGtEA,EAAI,YAAY,EAAE,EAClBA,EAAI,KAAK,wBAAyB,GAAI,EAAE,EAExCA,EAAI,YAAY,EAAE,EAClB,IAAIgD,EAAI,GACRhD,EAAI,KAAK,uBAAuB,YAAY,UAAU,GAAI,GAAIgD,CAAC,EAC/DA,GAAK,EACLhD,EAAI,KAAK,eAAe,YAAY,YAAY,GAAI,GAAIgD,CAAC,EACzDA,GAAK,EACLhD,EAAI,KAAK,gBAAgB,YAAY,QAAQ,IAAK,GAAIgD,CAAC,EACvDA,GAAK,EACLhD,EAAI,KAAK,cAAc,YAAY,cAAc,GAAI,GAAIgD,CAAC,EAC1DA,GAAK,EACLhD,EAAI,KAAK,eAAe,YAAY,cAAc,GAAI,GAAIgD,CAAC,EAG3DhD,EAAI,KAAK,mBAAmB,IAAI,KAAI,EAAG,cAAc,MAAM,GAAG,EAAE,CAAC,CAAC,MAAM,EAExElR,EAAM,mBAAmByL,EAAc,2BAA4B,SAAS,CAEhF,OAAStJ,EAAO,CACZnB,EAAO,MAAM,uBAAwBmB,CAAK,EAC1CnC,EAAM,mBAAmByL,EAAc,sBAAwB,OAAO,EACtEzL,EAAM,MAAM,4CAA6C,GAAI,CACjE,CACJ,CAKO,eAAemU,IAAsB,CACxC,MAAM1I,EAAezL,EAAM,iBAAiB,sBAAsB,EAElE,GAAI,CAEA,MAAM0P,EAAW,MAAMC,IACjBiC,EAAezB,EAAMC,EAAW7O,EAAI,aAAa,EAAG8O,EAAM,WAAY,KAAMX,CAAQ,CAAC,EACrFmC,EAAkB,MAAMrB,EAAQoB,CAAY,EAE5CwC,EAAU,CAAC,OAAQ,cAAe,SAAU,OAAQ,QAAS,YAAa,kBAAmB,kBAAmB,WAAW,EAC3HC,EAAO,GAEbxC,EAAgB,QAAQX,GAAO,CAC3B,MAAM/H,EAAO+H,EAAI,OACXxC,EAAOvF,EAAK,aAAa,OAAM,EAAG,eAAe,OAAO,GAAK,MAEnEkL,EAAK,KAAK,CACN3F,EACAvF,EAAK,UAAY,UACjBA,EAAK,QAAU,MACfA,EAAK,OAAS,MACdA,EAAK,MAAQ,MACbA,EAAK,OAAS,EACdA,EAAK,gBAAkB,EACvBA,EAAK,gBAAkB,EACvBA,EAAK,WAAa,CAClC,CAAa,CACL,CAAC,EAED,MAAMmL,EAAM,CAACF,EAAS,GAAGC,CAAI,EAAE,IAAIvB,GAAOA,EAAI,KAAK,GAAG,CAAC,EAAE,KAAK;AAAA,CAAI,EAC5DyB,EAAO,IAAI,KAAK,CAACD,CAAG,EAAG,CAAE,KAAM,yBAAyB,CAAE,EAC1DE,EAAO,SAAS,cAAc,GAAG,EACvCA,EAAK,KAAO,IAAI,gBAAgBD,CAAI,EACpCC,EAAK,SAAW,qBAAqB,IAAI,KAAI,EAAG,cAAc,MAAM,GAAG,EAAE,CAAC,CAAC,OAC3EA,EAAK,MAAK,EAEVxU,EAAM,mBAAmByL,EAAc,2BAA4B,SAAS,CAEhF,OAAStJ,EAAO,CACZnB,EAAO,MAAM,uBAAwBmB,CAAK,EAC1CnC,EAAM,mBAAmByL,EAAc,sBAAwB,OAAO,EACtEzL,EAAM,MAAM,8BAAgC,GAAI,CACpD,CACJ,CAKA,SAAS2F,IAAqB,CAE1B,SAAS,eAAe,gBAAgB,GAAG,iBAAiB,QAASqO,EAAW,EAChF,SAAS,eAAe,gBAAgB,GAAG,iBAAiB,QAASG,EAAmB,EAGxF,SAAS,eAAe,eAAe,GAAG,iBAAiB,SAAUM,EAAkB,EAGvF,SAAS,eAAe,uBAAuB,GAAG,iBAAiB,QAAS,IAAM,CAC9EzU,EAAM,KAAK,gCAAiC,GAAI,EAChDiP,IACJ,CAAC,CACL,CAKA,eAAewF,GAAmB,EAAG,CACjC,MAAMC,EAAS,EAAE,OAAO,MACxB1U,EAAM,KAAK,aAAa0U,CAAM,GAAI,GAAI,CAE1C,CAOA,SAASxF,IAAmB,CAED,SAAS,eAAe,oBAAoB,GAE/DzK,EAAa,qBAAsBF,GAAoB,CAAC,CAAC,EAInC,SAAS,eAAe,gBAAgB,GAE9DE,EAAa,iBAAkBf,GAAmB,EAAE,CAAC,EAI/B,SAAS,eAAe,sBAAsB,GAEpEe,EAAa,uBAAwBf,GAAmB,CAAC,CAAC,EAI9D,MAAMiR,EAAyB,SAAS,eAAe,gBAAgB,EACnEA,IACAA,EAAuB,UAAY7Q,KAGvC,MAAM8Q,EAAwB,SAAS,eAAe,eAAe,EACjEA,IACAA,EAAsB,UAAY9Q,KAGtC,MAAM+Q,EAAyB,SAAS,eAAe,gBAAgB,EACnEA,IACAA,EAAuB,UAAY/Q,IAE3C,CAYA,SAAS0O,GAAW9D,EAAM,CAEtB,MAAMC,EADM,IAAI,KACGD,EACboG,EAAU,KAAK,MAAMnG,EAAO,GAAI,EAChCC,EAAU,KAAK,MAAMkG,EAAU,EAAE,EACjCjG,EAAQ,KAAK,MAAMD,EAAU,EAAE,EAC/BE,EAAO,KAAK,MAAMD,EAAQ,EAAE,EAElC,OAAIC,EAAO,EAAU,UAAUA,CAAI,IAC/BD,EAAQ,EAAU,UAAUA,CAAK,IACjCD,EAAU,EAAU,UAAUA,CAAO,MAClC,aACX","names":["HTML_ESCAPE_MAP","HTML_ESCAPE_REGEX","sanitizeHTML","str","char","escapeHtml","text","toastTestEnv","define_process_env_default","CLOSE_ANIMATION_MS","showToast","message","type","duration","container","getOrCreateToastContainer","toast","createToastElement","closeToast","config","getToastConfig","configs","hasOtherVisibleToasts","child","removeToast","currentContainer","removalDelay","showLoadingToast","updateLoadingToast","hadShow","styleElement","isDevelopment","logger","args","firebaseConfig","app","initializeApp","auth","getAuth","db","getFirestore","getDatabase","functions","getFunctions","provider","GoogleAuthProvider","signInInProgress","signInWithGoogle","user","signInWithPopup","createOrUpdateUser","error","errorMessage","signOutUser","userName","signOut","onAuthChange","callback","onAuthStateChanged","getCurrentUser","showAdminUIIfAdmin","userProfile","navAdminItem","adminBadgeNav","isDemoMode","getDemoUser","demoUserJson","getCurrentUserUnified","requireAdmin","resolve","reject","demoUser","unsubscribe","getUserProfile","createListSkeleton","count","skeletons","i","createChartSkeleton","createQuestionSkeleton","questions","createUserSkeleton","users","createResultSkeleton","results","createResourceSkeleton","resources","createStatsSkeleton","stats","showSkeleton","containerId","skeletonHTML","DEMO_STORAGE_KEY","loadDemoQuestions","saved","q","e","saveDemoQuestions","MOCK_QUESTIONS","MOCK_STATS","currentQuestions","currentFilters","currentPage","questionsPerPage","initQuestionsManager","loadQuestions","loadStats","initEventListeners","createForm","handleCreateQuestion","jsonInput","handleJSONUpload","browseBtn","moduleFilter","monthFilter","yearFilter","searchInput","questionsList","handleFilterChange","handleSearch","handleQuestionsListClick","prevBtn","nextBtn","changePage","event","actionButton","questionId","openEditModal","handleDeleteQuestion","renderQuestionsList","filters","getQuestions","emptyState","startIndex","endIndex","paginatedQuestions","fragment","question","createQuestionCardElement","updatePaginationControls","moduleColors","moduleIcons","color","icon","monthName","createdAt","createdAtDisplay","template","opt","idx","form","submitBtn","originalBtnText","questionData","newMockQuestion","showSuccess","createQuestion","showError","file","showLoading","jsonData","validateJSONFormat","showJSONPreview","data","fileName","moduleNames","monthNames","handleConfirmImport","confirmBtn","questionsToImport","result","importQuestionsFromJSON","index","deleteQuestion","filterName","searchTerm","filtered","direction","totalPages","pageInfo","renderStats","getQuestionsStats","module","percentage","div","MOCK_USERS","currentUsers","paginationState","initUsersManager","loadUsers","createUserForm","handleCreateUser","generatePasswordBtn","generateRandomPassword","roleFilter","statusFilter","errorDiv","successDiv","formData","userData","showFormError","loadingToast","chars","password","passwordInput","oneWeekAgo","isActive","renderUsersList","getAllUsersPaginated","renderPaginationControls","safeErrorMessage","renderUserCard","addUserActionListeners","loadMoreUsers","newUsers","existingControls","paginationHTML","loadMoreBtn","isAdmin","roleColor","roleIcon","lastLogin","lastLoginText","formatRelativeTime","safeDisplayName","safeEmail","safeAvatarAlt","avatarUrl","renderUserStats","totalQuizzes","averageScore","currentStreak","btn","userId","userEmail","userRole","openEditRoleModal","currentRole","modal","newRole","handleUpdateRole","saveBtn","originalText","updateUserRole","u","safeSearchTerm","temp","getUsersStats","activePercentage","safeMessage","date","diff","minutes","hours","days","MOCK_DATA","stateManager","initAdminDashboard","showLoadingState","loadGlobalStats","loadTopUsers","loadRecentActivity","loadModuleStats","createCharts","globalStats","renderGlobalStats","clientId","getCurrentClientId","httpsCallable","cloudFunctionError","__vitePreload","n","usersStats","questionsStats","resourcesQuery","query","collection","where","limit","resourcesSnapshot","getDocs","today","thirtyDaysAgo","recentQuizzesQuery","Timestamp","orderBy","recentQuizzesSnapshot","weekAgo","quizzesToday","quizzesWeek","doc","completedAt","renderTopUsers","getLeaderboard","topUsers","formattedTopUsers","renderRecentActivity","snapshot","activities","mockStats","resultsQuery","resultsSnapshot","moduleStats","stat","empty","medal","bgColor","rawUserName","avgScore","card","activity","rawTimeAgo","getTimeAgo","timeAgo","scoreColor","moduleName","scoreDisplay","avatarInitial","row","createProgressChart","createModulesChart","createActivityChart","canvas","labels","counts","avgScores","dailyData","dateStr","d","existingChart","chartProgress","s","colors","existingChartModules","chartModules","chartActivity","exportToPDF","jsPDF","y","exportToAdvancedCSV","headers","rows","csv","blob","link","handlePeriodChange","period","progressChartContainer","modulesChartContainer","activityChartContainer","seconds"],"ignoreList":[],"sources":["../../js/security.js","../../js/toast.js","../../js/logger.js","../../js/firebase-config.js","../../js/auth.js","../../js/admin-auth-guard.js","../../js/skeleton.js","../../js/admin-questions.js","../../js/admin-users.js","../../js/admin-dashboard.js"],"sourcesContent":["// Helpers de scurit - Validation et sanitization des entres\r\n\r\n/**\r\n * chappe les caractres HTML pour prvenir les attaques XSS\r\n * @param {string} str - Chane  chapper\r\n * @returns {string} Chane scurise\r\n */\r\nconst HTML_ESCAPE_MAP = {\r\n    '&': '&amp;',\r\n    '<': '&lt;',\r\n    '>': '&gt;',\r\n    '\"': '&quot;',\r\n    \"'\": '&#x27;',\r\n    '`': '&#x60;'\r\n};\r\n\r\nconst HTML_ESCAPE_REGEX = /[&<>\"'`]/g;\r\n\r\nexport function sanitizeHTML(str) {\r\n    if (str === null || str === undefined) return '';\r\n    \r\n    const value = String(str);\r\n    return value.replace(HTML_ESCAPE_REGEX, char => HTML_ESCAPE_MAP[char] || char);\r\n}\r\n\r\n/**\r\n * chappe les caractres HTML (alias pour compatibilit)\r\n * @param {string} text - Texte  chapper\r\n * @returns {string} Texte scuris\r\n */\r\nexport function escapeHtml(text) {\r\n    return sanitizeHTML(text);\r\n}\r\n\r\n/**\r\n * Valide et scurise une URL\r\n * @param {string} url - URL  valider\r\n * @returns {string} URL scurise ou '#' si invalide\r\n */\r\nexport function sanitizeURL(url) {\r\n    if (!url || typeof url !== 'string') return '#';\r\n    \r\n    try {\r\n        const parsed = new URL(url);\r\n        // Autoriser seulement http: et https:\r\n        if (!['http:', 'https:'].includes(parsed.protocol)) {\r\n            console.warn(' URL avec protocole non autoris bloque:', url);\r\n            return '#';\r\n        }\r\n        return url;\r\n    } catch {\r\n        console.warn(' URL invalide bloque:', url);\r\n        return '#';\r\n    }\r\n}\r\n\r\n/**\r\n * Validateurs pour diffrents types de donnes\r\n */\r\nexport const validators = {\r\n    /**\r\n     * Valide un email\r\n     */\r\n    email: (email) => {\r\n        if (!email || typeof email !== 'string') return false;\r\n        return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\r\n    },\r\n    \r\n    /**\r\n     * Valide le texte d'une question\r\n     */\r\n    questionText: (text) => {\r\n        if (!text || typeof text !== 'string') return false;\r\n        const trimmed = text.trim();\r\n        if (trimmed.length < 10) return false;\r\n        if (trimmed.length > 500) return false;\r\n        return true;\r\n    },\r\n    \r\n    /**\r\n     * Valide une option de rponse\r\n     */\r\n    option: (opt) => {\r\n        if (!opt || typeof opt !== 'string') return false;\r\n        const trimmed = opt.trim();\r\n        if (trimmed.length < 2) return false;\r\n        if (trimmed.length > 200) return false;\r\n        return true;\r\n    },\r\n    \r\n    /**\r\n     * Valide une explication\r\n     */\r\n    explanation: (text) => {\r\n        if (!text || typeof text !== 'string') return false;\r\n        const trimmed = text.trim();\r\n        if (trimmed.length < 20) return false;\r\n        if (trimmed.length > 1000) return false;\r\n        return true;\r\n    },\r\n    \r\n    /**\r\n     * Valide un module\r\n     */\r\n    module: (mod) => {\r\n        return ['auto', 'loisir', 'vr', 'tracteur'].includes(mod);\r\n    },\r\n    \r\n    /**\r\n     * Valide un mois (1-12)\r\n     */\r\n    month: (m) => {\r\n        return Number.isInteger(m) && m >= 1 && m <= 12;\r\n    },\r\n    \r\n    /**\r\n     * Valide une anne (2020-2030)\r\n     */\r\n    year: (y) => {\r\n        return Number.isInteger(y) && y >= 2020 && y <= 2030;\r\n    },\r\n    \r\n    /**\r\n     * Valide un index de rponse correcte (0-3)\r\n     */\r\n    correctAnswer: (idx) => {\r\n        return Number.isInteger(idx) && idx >= 0 && idx <= 3;\r\n    },\r\n    \r\n    /**\r\n     * Valide un rle utilisateur\r\n     */\r\n    role: (role) => {\r\n        return ['user', 'admin'].includes(role);\r\n    },\r\n    \r\n    /**\r\n     * Valide un score (0-100)\r\n     */\r\n    score: (score) => {\r\n        return typeof score === 'number' && score >= 0 && score <= 100;\r\n    }\r\n};\r\n\r\n/**\r\n * Valide les donnes compltes d'une question\r\n * @param {Object} data - Donnes de la question\r\n * @returns {Object} { valid: boolean, errors: string[] }\r\n */\r\nexport function validateQuestionData(data) {\r\n    const errors = [];\r\n    \r\n    // Validation question\r\n    if (!validators.questionText(data.question)) {\r\n        errors.push('Question invalide (10-500 caractres requis)');\r\n    }\r\n    \r\n    // Validation options\r\n    if (!Array.isArray(data.options) || data.options.length !== 4) {\r\n        errors.push('Exactement 4 options requises');\r\n    } else {\r\n        data.options.forEach((opt, idx) => {\r\n            if (!validators.option(opt)) {\r\n                errors.push(`Option ${idx + 1} invalide (2-200 caractres requis)`);\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Validation rponse correcte\r\n    if (!validators.correctAnswer(data.correctAnswer)) {\r\n        errors.push('Index de rponse correcte invalide (0-3)');\r\n    }\r\n    \r\n    // Validation explication\r\n    if (!validators.explanation(data.explanation)) {\r\n        errors.push('Explication invalide (20-1000 caractres requis)');\r\n    }\r\n    \r\n    // Validation module\r\n    if (!validators.module(data.module)) {\r\n        errors.push('Module invalide (auto, loisir, vr, tracteur)');\r\n    }\r\n    \r\n    // Validation mois\r\n    if (!validators.month(data.month)) {\r\n        errors.push('Mois invalide (1-12)');\r\n    }\r\n    \r\n    // Validation anne\r\n    if (!validators.year(data.year)) {\r\n        errors.push('Anne invalide (2020-2030)');\r\n    }\r\n    \r\n    return {\r\n        valid: errors.length === 0,\r\n        errors\r\n    };\r\n}\r\n\r\n/**\r\n * Nettoie et valide les donnes d'une question\r\n * @param {Object} data - Donnes brutes\r\n * @returns {Object} Donnes nettoyes et valides\r\n */\r\nexport function sanitizeQuestionData(data) {\r\n    return {\r\n        question: sanitizeHTML(data.question?.trim() || ''),\r\n        options: (data.options || []).map(opt => sanitizeHTML(opt?.trim() || '')),\r\n        correctAnswer: parseInt(data.correctAnswer, 10),\r\n        explanation: sanitizeHTML(data.explanation?.trim() || ''),\r\n        module: data.module,\r\n        month: parseInt(data.month, 10),\r\n        year: parseInt(data.year, 10),\r\n        reference: sanitizeHTML(data.reference?.trim() || ''),\r\n        tags: (data.tags || []).map(tag => sanitizeHTML(tag?.trim() || ''))\r\n    };\r\n}\r\n\r\n/**\r\n * Limite la taille d'une chane\r\n * @param {string} str - Chane  limiter\r\n * @param {number} maxLength - Longueur maximale\r\n * @returns {string} Chane limite\r\n */\r\nexport function truncateString(str, maxLength = 100) {\r\n    if (!str || typeof str !== 'string') return '';\r\n    if (str.length <= maxLength) return str;\r\n    return str.substring(0, maxLength - 3) + '...';\r\n}\r\n\r\n/**\r\n * Dtecte les tentatives d'injection SQL/NoSQL dans une chane\r\n * @param {string} str - Chane  analyser\r\n * @returns {boolean} true si suspect\r\n */\r\nexport function detectInjectionAttempt(str) {\r\n    if (!str || typeof str !== 'string') return false;\r\n    \r\n    const suspiciousPatterns = [\r\n        /(<script|javascript:|onerror=|onclick=)/i,\r\n        /(union.*select|insert.*into|drop.*table)/i,\r\n        /(\\$where|\\$ne|\\$gt|\\$lt)/i, // NoSQL injection\r\n        /(eval\\(|exec\\(|system\\()/i\r\n    ];\r\n    \r\n    return suspiciousPatterns.some(pattern => pattern.test(str));\r\n}\r\n\r\n/**\r\n * Nettoie les donnes utilisateur pour affichage scuris\r\n * @param {Object} user - Objet utilisateur\r\n * @returns {Object} Utilisateur avec donnes nettoyes\r\n */\r\nexport function sanitizeUserData(user) {\r\n    if (!user) return null;\r\n    \r\n    return {\r\n        uid: user.uid,\r\n        email: sanitizeHTML(user.email || ''),\r\n        displayName: sanitizeHTML(user.displayName || 'Utilisateur'),\r\n        photoURL: user.photoURL ? sanitizeURL(user.photoURL) : null,\r\n        role: validators.role(user.role) ? user.role : 'user'\r\n    };\r\n}\r\n\r\nexport default {\r\n    sanitizeHTML,\r\n    escapeHtml,\r\n    sanitizeURL,\r\n    validators,\r\n    validateQuestionData,\r\n    sanitizeQuestionData,\r\n    truncateString,\r\n    detectInjectionAttempt,\r\n    sanitizeUserData\r\n};\r\n","// Systme de Notifications Toast - Feedback utilisateur moderne\r\n// Utilisation: showToast('Message', 'success|error|warning|info')\r\nimport { escapeHtml } from './security.js';\r\n\r\nconst toastTestEnv =\r\n    (typeof window !== 'undefined' && typeof window.happyDOM !== 'undefined') ||\r\n    (typeof navigator !== 'undefined' && /happy\\s?dom|jsdom/i.test(navigator.userAgent || '')) ||\r\n    (typeof globalThis !== 'undefined' && Boolean(globalThis.__vitest_worker__)) ||\r\n    (typeof globalThis !== 'undefined' && Boolean(globalThis.__vitest_browser__)) ||\r\n    (typeof import.meta !== 'undefined' && Boolean(import.meta.vitest)) ||\r\n    (typeof process !== 'undefined' && process.env?.npm_lifecycle_event === 'test') ||\r\n    (typeof process !== 'undefined' && process.env?.NODE_ENV === 'test');\r\nconst CLOSE_ANIMATION_MS = toastTestEnv ? 0 : 300;\r\n\r\n/**\r\n * Afficher une notification toast\r\n * @param {string} message - Le message  afficher\r\n * @param {string} type - Type: 'success', 'error', 'warning', 'info'\r\n * @param {number} duration - Dure en ms (dfaut: 3000)\r\n */\r\nexport function showToast(message, type = 'info', duration = 3000) {\r\n    const container = getOrCreateToastContainer();\r\n    \r\n    const toast = createToastElement(message, type);\r\n    container.appendChild(toast);\r\n    \r\n    // Animation d'entre\r\n    setTimeout(() => toast.classList.add('show'), 10);\r\n    \r\n    // Auto-fermeture\r\n    if (duration > 0) {\r\n        setTimeout(() => {\r\n            closeToast(toast);\r\n        }, duration);\r\n    }\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Crer ou rcuprer le conteneur de toasts\r\n */\r\nfunction getOrCreateToastContainer() {\r\n    let container = document.getElementById('toast-container');\r\n    \r\n    if (!container) {\r\n        container = document.createElement('div');\r\n        container.id = 'toast-container';\r\n        container.className = 'fixed top-4 right-4 z-50 flex flex-col gap-3';\r\n        document.body.appendChild(container);\r\n    }\r\n    \r\n    return container;\r\n}\r\n\r\n/**\r\n * Crer un lment toast\r\n */\r\nfunction createToastElement(message, type) {\r\n    const toast = document.createElement('div');\r\n    toast.className = `toast toast-${type} transform translate-x-full transition-all duration-300`;\r\n    \r\n    //  CORRECTION ACCESSIBILIT : Live regions pour toasts\r\n    // error = alert (assertive), autres = status (polite)\r\n    if (type === 'error') {\r\n        toast.setAttribute('role', 'alert');\r\n        toast.setAttribute('aria-live', 'assertive');\r\n    } else {\r\n        toast.setAttribute('role', 'status');\r\n        toast.setAttribute('aria-live', 'polite');\r\n    }\r\n    toast.setAttribute('aria-atomic', 'true');\r\n    \r\n    const config = getToastConfig(type);\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${config.borderColor} p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                ${config.icon}\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900\">${escapeHtml(message)}</p>\r\n            </div>\r\n            <button class=\"toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors\" aria-label=\"Fermer la notification\">\r\n                <svg aria-hidden=\"true\" class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </button>\r\n        </div>\r\n    `;\r\n    \r\n    // vnement de fermeture\r\n    const closeBtn = toast.querySelector('.toast-close');\r\n    closeBtn.addEventListener('click', () => closeToast(toast));\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Configuration par type de toast\r\n */\r\nfunction getToastConfig(type) {\r\n    const configs = {\r\n        success: {\r\n            borderColor: 'border-green-500',\r\n            icon: `<div class=\"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"></path>\r\n                </svg>\r\n            </div>`\r\n        },\r\n        error: {\r\n            borderColor: 'border-red-500',\r\n            icon: `<div class=\"w-8 h-8 bg-red-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </div>`\r\n        },\r\n        warning: {\r\n            borderColor: 'border-yellow-500',\r\n            icon: `<div class=\"w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-yellow-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"></path>\r\n                </svg>\r\n            </div>`\r\n        },\r\n        info: {\r\n            borderColor: 'border-blue-500',\r\n            icon: `<div class=\"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center\">\r\n                <svg class=\"w-5 h-5 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                </svg>\r\n            </div>`\r\n        }\r\n    };\r\n    \r\n    return configs[type] || configs.info;\r\n}\r\n\r\n/**\r\n * Fermer un toast\r\n */\r\nfunction closeToast(toast) {\r\n    if (!toast || toast.dataset.closing === 'true') return;\r\n\r\n    toast.dataset.closing = 'true';\r\n    toast.classList.remove('show');\r\n    toast.classList.add('hide');\r\n    toast.classList.add('translate-x-full');\r\n\r\n    const container = document.getElementById('toast-container');\r\n    const hasOtherVisibleToasts =\r\n        container &&\r\n        Array.from(container.children).some(\r\n            child => child !== toast && child.classList.contains('toast')\r\n        );\r\n\r\n    if (hasOtherVisibleToasts) {\r\n        toast.classList.remove('toast');\r\n        toast.classList.add('toast-closing');\r\n    }\r\n\r\n    const removeToast = () => {\r\n        toast.remove();\r\n\r\n        const currentContainer = document.getElementById('toast-container');\r\n        if (currentContainer && currentContainer.children.length === 0) {\r\n            currentContainer.remove();\r\n        }\r\n    };\r\n\r\n    const removalDelay = hasOtherVisibleToasts ? 0 : (toastTestEnv ? 150 : CLOSE_ANIMATION_MS);\r\n\r\n    if (removalDelay === 0) {\r\n        removeToast();\r\n    } else {\r\n        setTimeout(removeToast, removalDelay);\r\n    }\r\n}\r\n\r\n/**\r\n * Raccourcis pour les types de toasts\r\n */\r\nexport const toast = {\r\n    success: (message, duration) => showToast(message, 'success', duration),\r\n    error: (message, duration) => showToast(message, 'error', duration),\r\n    warning: (message, duration) => showToast(message, 'warning', duration),\r\n    info: (message, duration) => showToast(message, 'info', duration)\r\n};\r\n\r\n/**\r\n * Toast avec action\r\n */\r\nexport function showToastWithAction(message, type, actionText, actionCallback) {\r\n    const container = getOrCreateToastContainer();\r\n    \r\n    const toast = document.createElement('div');\r\n    toast.className = `toast toast-${type} transform translate-x-full transition-all duration-300`;\r\n    \r\n    const config = getToastConfig(type);\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${config.borderColor} p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                ${config.icon}\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900 mb-2\">${escapeHtml(message)}</p>\r\n                <button class=\"toast-action text-sm font-semibold text-ap-red-primary hover:text-ap-red-dark transition-colors\">\r\n                    ${escapeHtml(actionText)}\r\n                </button>\r\n            </div>\r\n            <button class=\"toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors\">\r\n                <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </button>\r\n        </div>\r\n    `;\r\n    \r\n    container.appendChild(toast);\r\n    \r\n    // Animation d'entre\r\n    setTimeout(() => toast.classList.add('show'), 10);\r\n    \r\n    // vnements\r\n    toast.querySelector('.toast-close').addEventListener('click', () => closeToast(toast));\r\n    toast.querySelector('.toast-action').addEventListener('click', () => {\r\n        actionCallback();\r\n        closeToast(toast);\r\n    });\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Toast de chargement\r\n */\r\nexport function showLoadingToast(message) {\r\n    const container = getOrCreateToastContainer();\r\n    \r\n    const toast = document.createElement('div');\r\n    toast.className = 'toast toast-loading transform translate-x-full transition-all duration-300';\r\n    toast.setAttribute('data-loading', 'true');\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 border-ap-red-primary p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                <div class=\"animate-spin rounded-full h-8 w-8 border-b-2 border-ap-red-primary\"></div>\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900\">${escapeHtml(message)}</p>\r\n            </div>\r\n        </div>\r\n    `;\r\n    \r\n    container.appendChild(toast);\r\n    \r\n    // Animation d'entre\r\n    setTimeout(() => toast.classList.add('show'), 10);\r\n    \r\n    return toast;\r\n}\r\n\r\n/**\r\n * Mettre  jour un toast de chargement\r\n */\r\nexport function updateLoadingToast(toast, message, type = 'success') {\r\n    if (!toast || !toast.getAttribute('data-loading')) return;\r\n    \r\n    const config = getToastConfig(type);\r\n    // Mettre  jour les classes pour reflter le statut final (et tre dtectable par les tests)\r\n    const hadShow = toast.classList.contains('show');\r\n    toast.className = `toast toast-${type} transform transition-all duration-300${hadShow ? ' show' : ''}`;\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${config.borderColor} p-4 min-w-[320px] max-w-md\">\r\n            <div class=\"flex-shrink-0\">\r\n                ${config.icon}\r\n            </div>\r\n            <div class=\"flex-1\">\r\n                <p class=\"text-sm font-medium text-slate-900\">${escapeHtml(message)}</p>\r\n            </div>\r\n            <button class=\"toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors\">\r\n                <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n            </button>\r\n        </div>\r\n    `;\r\n    \r\n    toast.removeAttribute('data-loading');\r\n    toast.querySelector('.toast-close').addEventListener('click', () => closeToast(toast));\r\n    \r\n    // Auto-fermeture aprs 3s\r\n    setTimeout(() => closeToast(toast), 3000);\r\n}\r\n\r\n/**\r\n * Fonctions helper pour faciliter l'utilisation\r\n */\r\nexport function showSuccessToast(message, duration = 3000) {\r\n    return showToast(message, 'success', duration);\r\n}\r\n\r\nexport function showErrorToast(message, duration = 3000) {\r\n    return showToast(message, 'error', duration);\r\n}\r\n\r\nexport function showWarningToast(message, duration = 3000) {\r\n    return showToast(message, 'warning', duration);\r\n}\r\n\r\nexport function showInfoToast(message, duration = 3000) {\r\n    return showToast(message, 'info', duration);\r\n}\r\n\r\n// CSS pour les animations ( ajouter dans un <style> ou fichier CSS)\r\nexport const toastStyles = `\r\n    <style>\r\n        .toast.show,\r\n        .toast-closing.show {\r\n            transform: translateX(0) !important;\r\n        }\r\n\r\n        .toast.hide,\r\n        .toast-closing.hide {\r\n            opacity: 0;\r\n        }\r\n        \r\n        @media (max-width: 640px) {\r\n            #toast-container {\r\n                left: 1rem;\r\n                right: 1rem;\r\n                top: 1rem;\r\n            }\r\n            \r\n            .toast > div,\r\n            .toast-closing > div {\r\n                min-width: auto !important;\r\n                width: 100%;\r\n            }\r\n        }\r\n    </style>\r\n`;\r\n\r\n// Injecter les styles au chargement\r\nif (typeof document !== 'undefined') {\r\n    const styleElement = document.createElement('style');\r\n    styleElement.textContent = `\r\n        .toast.show,\r\n        .toast-closing.show {\r\n            transform: translateX(0) !important;\r\n        }\r\n\r\n        .toast.hide,\r\n        .toast-closing.hide {\r\n            opacity: 0;\r\n        }\r\n        \r\n        @media (max-width: 640px) {\r\n            #toast-container {\r\n                left: 1rem;\r\n                right: 1rem;\r\n                top: 1rem;\r\n            }\r\n            \r\n            .toast > div,\r\n            .toast-closing > div {\r\n                min-width: auto !important;\r\n                width: 100%;\r\n            }\r\n        }\r\n    `;\r\n    document.head.appendChild(styleElement);\r\n}\r\n","// Logger conditionnel - Dsactive les logs en production\r\n// Garde seulement console.error actif pour dbogage critique\r\n\r\nconst isDevelopment = window.location.hostname === 'localhost' || \r\n                     window.location.hostname === '127.0.0.1' ||\r\n                     window.location.hostname === '192.168.1.1' ||\r\n                     window.location.port === '3200'; // Port Vite\r\n\r\n/**\r\n * Logger intelligent qui dsactive les logs en production\r\n * console.error reste toujours actif\r\n */\r\nexport const logger = {\r\n    /**\r\n     * Log d'information (dveloppement uniquement)\r\n     */\r\n    log: (...args) => {\r\n        if (isDevelopment) {\r\n            console.log(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Log d'erreur (toujours actif)\r\n     */\r\n    error: (...args) => {\r\n        console.error(...args);\r\n    },\r\n    \r\n    /**\r\n     * Log d'avertissement (dveloppement uniquement)\r\n     */\r\n    warn: (...args) => {\r\n        if (isDevelopment) {\r\n            console.warn(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Log d'information (dveloppement uniquement)\r\n     */\r\n    info: (...args) => {\r\n        if (isDevelopment) {\r\n            console.info(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Log de groupe (dveloppement uniquement)\r\n     */\r\n    group: (...args) => {\r\n        if (isDevelopment) {\r\n            console.group(...args);\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Fin de groupe (dveloppement uniquement)\r\n     */\r\n    groupEnd: () => {\r\n        if (isDevelopment) {\r\n            console.groupEnd();\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Table (dveloppement uniquement)\r\n     */\r\n    table: (...args) => {\r\n        if (isDevelopment) {\r\n            console.table(...args);\r\n        }\r\n    }\r\n};\r\n\r\n// Message de dmarrage\r\nif (isDevelopment) {\r\n    console.log(' Mode dveloppement - Logs activs');\r\n} else {\r\n    console.log(' Mode production - Logs dsactivs (sauf erreurs)');\r\n}\r\n\r\nexport default logger;\r\n","// Import Firebase SDK modules\r\nimport { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';\r\nimport { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';\r\nimport { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\r\nimport { getFunctions } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';\r\nimport { logger } from './logger.js';\r\n\r\n/**\r\n * Configuration Firebase - Avantage QUIZZ\r\n * \r\n *  SCURIT - Cl API Firebase Expose :\r\n * \r\n * La cl API Firebase est expose dans le code source ct client, ce qui est\r\n * NORMAL et ATTENDU pour Firebase. Firebase est conu pour fonctionner avec\r\n * des cls API publiques ct client.\r\n * \r\n * PROTECTION :\r\n * 1. Les rgles Firestore (firestore.rules) protgent les donnes ct serveur\r\n * 2. Les restrictions d'API doivent tre configures dans Firebase Console :\r\n *    - Aller dans Google Cloud Console > APIs & Services > Credentials\r\n *    - Slectionner la cl API\r\n *    - Ajouter des restrictions :\r\n *      * Application restrictions : HTTP referrers (web sites)\r\n *      * Limiter aux domaines autoriss uniquement\r\n * 3. Surveiller les quotas et cots dans Firebase Console\r\n * 4. Configurer des alertes de cots\r\n * \r\n *  IMPORTANT : Ne JAMAIS utiliser cette cl pour des oprations sensibles\r\n * ct serveur. Toute la scurit repose sur les rgles Firestore.\r\n */\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyD8w7Em_xdMGplscfGLrnM72vmm4z5ZTr0\",\r\n  authDomain: \"avantage-quizz.firebaseapp.com\",\r\n  databaseURL: \"https://avantage-quizz-default-rtdb.firebaseio.com\",\r\n  projectId: \"avantage-quizz\",\r\n  storageBucket: \"avantage-quizz.firebasestorage.app\",\r\n  messagingSenderId: \"919472910099\",\r\n  appId: \"1:919472910099:web:e17d4c1cdc7a04c6cab4e6\"\r\n};\r\n\r\n// Initialize Firebase\r\nconst app = initializeApp(firebaseConfig);\r\n\r\n// Initialize Firebase services\r\nexport const auth = getAuth(app);\r\nexport const db = getFirestore(app);\r\nexport const realtimeDB = getDatabase(app);\r\nexport const functions = getFunctions(app);\r\n\r\n//  CORRECTION SECTION 9 : Exporter app pour Analytics\r\nexport { app };\r\n\r\nlogger.log(' Firebase initialis avec succs');\r\nlogger.log(' Projet:', firebaseConfig.projectId);\r\nlogger.log(' Services: Authentication, Firestore, Realtime Database');\r\n","// Module Authentication - Gestion de l'authentification Google\r\nimport { auth } from './firebase-config.js';\r\nimport { \r\n    GoogleAuthProvider, \r\n    signInWithPopup, \r\n    signOut, \r\n    onAuthStateChanged \r\n} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';\r\nimport { createOrUpdateUser } from './firestore-service.js';\r\n\r\nconst provider = new GoogleAuthProvider();\r\nprovider.setCustomParameters({\r\n    prompt: 'select_account'\r\n});\r\n\r\n// Prevent multiple simultaneous sign-in attempts\r\nlet signInInProgress = false;\r\n\r\n// Sign in with Google\r\nexport async function signInWithGoogle() {\r\n    // Prevent multiple popup windows\r\n    if (signInInProgress) {\r\n        console.warn(' Connexion dj en cours, veuillez patienter...');\r\n        return null;\r\n    }\r\n    \r\n    signInInProgress = true;\r\n    \r\n    try {\r\n        console.log(' Tentative de connexion Google...');\r\n        const result = await signInWithPopup(auth, provider);\r\n        const user = result.user;\r\n        \r\n        console.log(' Authentification russie:', user.displayName);\r\n        console.log(' Email:', user.email);\r\n        \r\n        // Crer ou mettre  jour le profil utilisateur dans Firestore\r\n        await createOrUpdateUser(user);\r\n        \r\n        return user;\r\n    } catch (error) {\r\n        console.error(' Erreur de connexion:', error);\r\n        \r\n        // Messages d'erreur personnaliss\r\n        let errorMessage = 'Erreur lors de la connexion. Veuillez ressayer.';\r\n        \r\n        if (error.code === 'auth/popup-closed-by-user') {\r\n            errorMessage = 'Connexion annule. Veuillez ressayer.';\r\n        } else if (error.code === 'auth/popup-blocked') {\r\n            errorMessage = 'Pop-up bloque. Autorisez les pop-ups pour ce site.';\r\n        } else if (error.code === 'auth/unauthorized-domain') {\r\n            errorMessage = 'Domaine non autoris. Configurez Firebase Authentication.';\r\n        } else if (error.code === 'auth/cancelled-popup-request') {\r\n            // Silent error - user clicked too fast\r\n            console.warn(' Requte de popup annule (clic multiple)');\r\n            return null;\r\n        }\r\n        \r\n        if (error.code !== 'auth/cancelled-popup-request') {\r\n            alert(errorMessage);\r\n        }\r\n        throw error;\r\n    } finally {\r\n        // Reset flag after 2 seconds to allow retry\r\n        setTimeout(() => {\r\n            signInInProgress = false;\r\n        }, 2000);\r\n    }\r\n}\r\n\r\n// Sign out\r\nexport async function signOutUser() {\r\n    try {\r\n        const userName = auth.currentUser?.displayName || 'Utilisateur';\r\n        await signOut(auth);\r\n        console.log(' Dconnexion russie:', userName);\r\n    } catch (error) {\r\n        console.error(' Erreur de dconnexion:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n// Listen for auth state changes\r\nexport function onAuthChange(callback) {\r\n    return onAuthStateChanged(auth, (user) => {\r\n        if (user) {\r\n            console.log(' Utilisateur connect:', user.email);\r\n        } else {\r\n            console.log(' Aucun utilisateur connect');\r\n        }\r\n        callback(user);\r\n    });\r\n}\r\n\r\n// Get current user\r\nexport function getCurrentUser() {\r\n    return auth.currentUser;\r\n}\r\n\r\n// Check if user is authenticated\r\nexport function isAuthenticated() {\r\n    return auth.currentUser !== null;\r\n}\r\n\r\n// Show admin UI elements if user is admin\r\nexport async function showAdminUIIfAdmin(userProfile) {\r\n    if (!userProfile) return;\r\n    \r\n    const isAdmin = userProfile.role === 'admin';\r\n    \r\n    if (isAdmin) {\r\n        // Afficher l'onglet Admin dans la navigation\r\n        const navAdminItem = document.getElementById('nav-admin-item');\r\n        if (navAdminItem) {\r\n            navAdminItem.classList.remove('hidden');\r\n        }\r\n        \r\n        // Afficher le badge Admin\r\n        const adminBadgeNav = document.getElementById('admin-badge-nav');\r\n        if (adminBadgeNav) {\r\n            adminBadgeNav.classList.remove('hidden');\r\n        }\r\n        \r\n        console.log('Admin UI elements shown');\r\n    }\r\n}\r\n\r\n// ============================================\r\n// MODE DMO\r\n// ============================================\r\n\r\n/**\r\n * Activer le mode dmo sans authentification Firebase\r\n * Cre un utilisateur fictif en localStorage\r\n */\r\nexport async function activateDemoMode() {\r\n    try {\r\n        console.log(' Activation du mode dmo...');\r\n        \r\n        // Crer un utilisateur dmo\r\n        const demoUser = {\r\n            uid: 'demo-user-' + Date.now(),\r\n            email: 'demo@avantage-quizz.local',\r\n            displayName: 'Utilisateur Dmo',\r\n            photoURL: null,\r\n            isDemo: true,\r\n            role: 'admin', // Admin par dfaut pour tester toutes les fonctionnalits\r\n            createdAt: new Date().toISOString()\r\n        };\r\n        \r\n        // Stocker en localStorage\r\n        localStorage.setItem('demoUser', JSON.stringify(demoUser));\r\n        localStorage.setItem('authMode', 'demo');\r\n        \r\n        console.log(' Mode dmo activ:', demoUser.displayName);\r\n        console.log(' Email:', demoUser.email);\r\n        console.log(' Rle:', demoUser.role);\r\n        \r\n        return demoUser;\r\n        \r\n    } catch (error) {\r\n        console.error(' Erreur activation mode dmo:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Dsactiver le mode dmo\r\n */\r\nexport function deactivateDemoMode() {\r\n    localStorage.removeItem('demoUser');\r\n    localStorage.removeItem('authMode');\r\n    console.log(' Mode dmo dsactiv');\r\n}\r\n\r\n/**\r\n * Vrifier si le mode dmo est actif\r\n */\r\nexport function isDemoMode() {\r\n    return localStorage.getItem('authMode') === 'demo';\r\n}\r\n\r\n/**\r\n * Rcuprer l'utilisateur dmo depuis localStorage\r\n */\r\nexport function getDemoUser() {\r\n    try {\r\n        const demoUserJson = localStorage.getItem('demoUser');\r\n        if (!demoUserJson) return null;\r\n        \r\n        const demoUser = JSON.parse(demoUserJson);\r\n        return demoUser;\r\n    } catch (error) {\r\n        console.error(' Erreur lecture utilisateur dmo:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Obtenir l'utilisateur actuel (Firebase ou Dmo)\r\n */\r\nexport function getCurrentUserUnified() {\r\n    // Mode dmo\r\n    if (isDemoMode()) {\r\n        return getDemoUser();\r\n    }\r\n    \r\n    // Mode Firebase normal\r\n    return getCurrentUser();\r\n}\r\n","// Admin Auth Guard - Protection des routes administrateur\r\nimport { auth } from './firebase-config.js';\r\nimport { getUserProfile } from './firestore-service.js';\r\nimport { isDemoMode, getDemoUser } from './auth.js';\r\n\r\n/**\r\n * Vrifie si l'utilisateur actuel est admin\r\n * Redirige vers index.html si non autoris\r\n * Support du mode dmo et Firebase\r\n */\r\nexport async function requireAdmin() {\r\n    return new Promise((resolve, reject) => {\r\n        //  Vrifier d'abord le mode dmo\r\n        if (isDemoMode()) {\r\n            const demoUser = getDemoUser();\r\n            if (demoUser && demoUser.role === 'admin') {\r\n                console.log(' Admin autoris (mode dmo):', demoUser.email);\r\n                resolve(demoUser);\r\n                return;\r\n            } else {\r\n                console.warn(' Accs refus: utilisateur dmo non admin');\r\n                alert('Accs refus. Cette page est rserve aux administrateurs.');\r\n                window.location.href = '/index.html';\r\n                reject(new Error('Non autoris'));\r\n                return;\r\n            }\r\n        }\r\n        \r\n        //  Mode Firebase normal\r\n        const unsubscribe = auth.onAuthStateChanged(async (user) => {\r\n            unsubscribe(); // Se dsabonner immdiatement\r\n            \r\n            if (!user) {\r\n                console.warn(' Accs refus: Utilisateur non connect');\r\n                window.location.href = '/index.html';\r\n                reject(new Error('Non authentifi'));\r\n                return;\r\n            }\r\n            \r\n            try {\r\n                // Vrifier le rle\r\n                const userProfile = await getUserProfile(user.uid);\r\n                \r\n                if (!userProfile || userProfile.role !== 'admin') {\r\n                    console.warn(' Accs refus: Utilisateur non administrateur');\r\n                    alert('Accs refus. Cette page est rserve aux administrateurs.');\r\n                    window.location.href = '/index.html';\r\n                    reject(new Error('Non autoris'));\r\n                    return;\r\n                }\r\n                \r\n                console.log(' Admin autoris:', user.email);\r\n                resolve(user);\r\n            } catch (error) {\r\n                console.error(' Erreur vrification admin:', error);\r\n                window.location.href = '/index.html';\r\n                reject(error);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Vrifie si l'utilisateur est admin sans redirection\r\n * Retourne true/false\r\n * Support du mode dmo et Firebase\r\n */\r\nexport async function isAdmin() {\r\n    try {\r\n        //  Vrifier le mode dmo d'abord\r\n        if (isDemoMode()) {\r\n            const demoUser = getDemoUser();\r\n            return demoUser?.role === 'admin';\r\n        }\r\n        \r\n        //  Mode Firebase normal\r\n        const user = auth.currentUser;\r\n        if (!user) return false;\r\n        \r\n        const userProfile = await getUserProfile(user.uid);\r\n        return userProfile?.role === 'admin';\r\n    } catch (error) {\r\n        console.error('Erreur verification admin:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Ajoute le badge admin dans le profil utilisateur\r\n */\r\nexport function addAdminBadge() {\r\n    const userProfile = document.getElementById('user-profile');\r\n    if (!userProfile) return;\r\n    \r\n    const existingBadge = userProfile.querySelector('.admin-badge');\r\n    if (existingBadge) return; // Badge dj ajout\r\n    \r\n    const badge = document.createElement('div');\r\n    badge.className = 'admin-badge bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded mt-1';\r\n    badge.innerHTML = ' Admin';\r\n    badge.style.display = 'inline-block';\r\n    \r\n    userProfile.appendChild(badge);\r\n}\r\n","// Skeleton Loaders - Composants de chargement anims avec shimmer effect\r\n// Amliore l'UX pendant le chargement des donnes\r\n\r\n/**\r\n * Crer un skeleton loader de type carte\r\n * @param {number} count - Nombre de cartes  afficher\r\n * @returns {string} HTML des skeleton loaders\r\n */\r\nexport function createCardSkeleton(count = 3) {\r\n    const skeletons = [];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        skeletons.push(`\r\n            <div class=\"skeleton-card bg-white rounded-xl shadow-md p-6 animate-pulse\">\r\n                <div class=\"flex items-center justify-between mb-4\">\r\n                    <div class=\"skeleton-circle h-12 w-12 bg-slate-200 rounded-full\"></div>\r\n                    <div class=\"skeleton-text h-6 w-20 bg-slate-200 rounded\"></div>\r\n                </div>\r\n                <div class=\"skeleton-text h-8 w-24 bg-slate-200 rounded mb-2\"></div>\r\n                <div class=\"skeleton-text h-4 w-32 bg-slate-200 rounded mb-4\"></div>\r\n                <div class=\"skeleton-text h-3 w-full bg-slate-200 rounded\"></div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return skeletons.join('');\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader de type liste\r\n * @param {number} count - Nombre d'items  afficher\r\n * @returns {string} HTML des skeleton loaders\r\n */\r\nexport function createListSkeleton(count = 5) {\r\n    const skeletons = [];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        skeletons.push(`\r\n            <div class=\"skeleton-list-item bg-white rounded-lg border border-slate-200 p-4 mb-3 animate-pulse\">\r\n                <div class=\"flex items-center gap-4\">\r\n                    <div class=\"skeleton-circle h-10 w-10 bg-slate-200 rounded-full flex-shrink-0\"></div>\r\n                    <div class=\"flex-1\">\r\n                        <div class=\"skeleton-text h-5 w-3/4 bg-slate-200 rounded mb-2\"></div>\r\n                        <div class=\"skeleton-text h-4 w-1/2 bg-slate-200 rounded\"></div>\r\n                    </div>\r\n                    <div class=\"skeleton-text h-8 w-20 bg-slate-200 rounded\"></div>\r\n                </div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return skeletons.join('');\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader de type tableau\r\n * @param {number} rows - Nombre de lignes\r\n * @param {number} cols - Nombre de colonnes\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createTableSkeleton(rows = 5, cols = 4) {\r\n    const headerCols = [];\r\n    for (let i = 0; i < cols; i++) {\r\n        headerCols.push(`\r\n            <th class=\"px-6 py-3\">\r\n                <div class=\"skeleton-text h-4 bg-slate-200 rounded\"></div>\r\n            </th>\r\n        `);\r\n    }\r\n    \r\n    const bodyRows = [];\r\n    for (let i = 0; i < rows; i++) {\r\n        const rowCols = [];\r\n        for (let j = 0; j < cols; j++) {\r\n            rowCols.push(`\r\n                <td class=\"px-6 py-4\">\r\n                    <div class=\"skeleton-text h-4 bg-slate-200 rounded\"></div>\r\n                </td>\r\n            `);\r\n        }\r\n        bodyRows.push(`<tr class=\"animate-pulse\">${rowCols.join('')}</tr>`);\r\n    }\r\n    \r\n    return `\r\n        <div class=\"bg-white rounded-xl shadow-md overflow-hidden\">\r\n            <table class=\"min-w-full divide-y divide-slate-200\">\r\n                <thead class=\"bg-slate-50\">\r\n                    <tr>${headerCols.join('')}</tr>\r\n                </thead>\r\n                <tbody class=\"divide-y divide-slate-200\">\r\n                    ${bodyRows.join('')}\r\n                </tbody>\r\n            </table>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader de type graphique\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createChartSkeleton() {\r\n    return `\r\n        <div class=\"skeleton-chart bg-white rounded-xl shadow-md p-6 animate-pulse\">\r\n            <div class=\"skeleton-text h-6 w-48 bg-slate-200 rounded mb-6\"></div>\r\n            <div class=\"h-64 bg-slate-100 rounded-lg flex items-end justify-around p-4\">\r\n                <div class=\"skeleton-bar w-12 bg-slate-200 rounded-t\" style=\"height: 60%\"></div>\r\n                <div class=\"skeleton-bar w-12 bg-slate-200 rounded-t\" style=\"height: 80%\"></div>\r\n                <div class=\"skeleton-bar w-12 bg-slate-200 rounded-t\" style=\"height: 45%\"></div>\r\n                <div class=\"skeleton-bar w-12 bg-slate-200 rounded-t\" style=\"height: 90%\"></div>\r\n                <div class=\"skeleton-bar w-12 bg-slate-200 rounded-t\" style=\"height: 70%\"></div>\r\n                <div class=\"skeleton-bar w-12 bg-slate-200 rounded-t\" style=\"height: 55%\"></div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader de type grille de cartes\r\n * @param {number} count - Nombre de cartes\r\n * @param {number} columns - Nombre de colonnes (2, 3, ou 4)\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createGridSkeleton(count = 6, columns = 3) {\r\n    const colClass = columns === 2 ? 'md:grid-cols-2' : \r\n                    columns === 3 ? 'md:grid-cols-3' : \r\n                    'md:grid-cols-4';\r\n    \r\n    const cards = [];\r\n    for (let i = 0; i < count; i++) {\r\n        cards.push(`\r\n            <div class=\"skeleton-grid-item bg-white rounded-xl shadow-md p-6 animate-pulse\">\r\n                <div class=\"skeleton-image h-40 bg-slate-200 rounded-lg mb-4\"></div>\r\n                <div class=\"skeleton-text h-6 w-3/4 bg-slate-200 rounded mb-3\"></div>\r\n                <div class=\"skeleton-text h-4 w-full bg-slate-200 rounded mb-2\"></div>\r\n                <div class=\"skeleton-text h-4 w-5/6 bg-slate-200 rounded\"></div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return `\r\n        <div class=\"grid grid-cols-1 ${colClass} gap-6\">\r\n            ${cards.join('')}\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader de type formulaire\r\n * @param {number} fields - Nombre de champs\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createFormSkeleton(fields = 4) {\r\n    const formFields = [];\r\n    \r\n    for (let i = 0; i < fields; i++) {\r\n        formFields.push(`\r\n            <div class=\"mb-6 animate-pulse\">\r\n                <div class=\"skeleton-text h-4 w-32 bg-slate-200 rounded mb-2\"></div>\r\n                <div class=\"skeleton-input h-10 w-full bg-slate-200 rounded-lg\"></div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return `\r\n        <div class=\"bg-white rounded-xl shadow-md p-6\">\r\n            ${formFields.join('')}\r\n            <div class=\"animate-pulse mt-6\">\r\n                <div class=\"skeleton-button h-10 w-32 bg-slate-200 rounded-lg\"></div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader personnalis pour les questions admin\r\n * @param {number} count - Nombre de questions\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createQuestionSkeleton(count = 5) {\r\n    const questions = [];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        questions.push(`\r\n            <div class=\"skeleton-question bg-white rounded-lg border border-slate-200 p-6 mb-4 animate-pulse\">\r\n                <div class=\"flex items-start justify-between mb-4\">\r\n                    <div class=\"flex-1\">\r\n                        <div class=\"skeleton-text h-5 w-3/4 bg-slate-200 rounded mb-3\"></div>\r\n                        <div class=\"flex gap-2 mb-3\">\r\n                            <div class=\"skeleton-badge h-6 w-20 bg-slate-200 rounded-full\"></div>\r\n                            <div class=\"skeleton-badge h-6 w-24 bg-slate-200 rounded-full\"></div>\r\n                            <div class=\"skeleton-badge h-6 w-16 bg-slate-200 rounded-full\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"flex gap-2\">\r\n                        <div class=\"skeleton-icon h-8 w-8 bg-slate-200 rounded\"></div>\r\n                        <div class=\"skeleton-icon h-8 w-8 bg-slate-200 rounded\"></div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"space-y-2\">\r\n                    <div class=\"skeleton-text h-4 w-full bg-slate-200 rounded\"></div>\r\n                    <div class=\"skeleton-text h-4 w-full bg-slate-200 rounded\"></div>\r\n                    <div class=\"skeleton-text h-4 w-full bg-slate-200 rounded\"></div>\r\n                    <div class=\"skeleton-text h-4 w-2/3 bg-slate-200 rounded\"></div>\r\n                </div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return questions.join('');\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader pour les utilisateurs\r\n * @param {number} count - Nombre d'utilisateurs\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createUserSkeleton(count = 10) {\r\n    const users = [];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        users.push(`\r\n            <div class=\"skeleton-user bg-white rounded-lg border border-slate-200 p-4 mb-3 animate-pulse\">\r\n                <div class=\"flex items-center justify-between\">\r\n                    <div class=\"flex items-center gap-4 flex-1\">\r\n                        <div class=\"skeleton-avatar h-12 w-12 bg-slate-200 rounded-full\"></div>\r\n                        <div class=\"flex-1\">\r\n                            <div class=\"skeleton-text h-5 w-48 bg-slate-200 rounded mb-2\"></div>\r\n                            <div class=\"skeleton-text h-4 w-64 bg-slate-200 rounded\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"flex items-center gap-3\">\r\n                        <div class=\"skeleton-badge h-6 w-16 bg-slate-200 rounded-full\"></div>\r\n                        <div class=\"skeleton-button h-8 w-20 bg-slate-200 rounded\"></div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return users.join('');\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader pour les rsultats de quiz\r\n * @param {number} count - Nombre de rsultats\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createResultSkeleton(count = 5) {\r\n    const results = [];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        results.push(`\r\n            <div class=\"skeleton-result bg-white rounded-lg border border-slate-200 p-5 mb-3 animate-pulse\">\r\n                <div class=\"flex items-center justify-between\">\r\n                    <div class=\"flex-1\">\r\n                        <div class=\"flex items-center gap-3 mb-3\">\r\n                            <div class=\"skeleton-icon h-10 w-10 bg-slate-200 rounded-lg\"></div>\r\n                            <div>\r\n                                <div class=\"skeleton-text h-5 w-48 bg-slate-200 rounded mb-2\"></div>\r\n                                <div class=\"skeleton-text h-4 w-32 bg-slate-200 rounded\"></div>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"flex gap-4\">\r\n                            <div class=\"skeleton-text h-4 w-24 bg-slate-200 rounded\"></div>\r\n                            <div class=\"skeleton-text h-4 w-32 bg-slate-200 rounded\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"text-right\">\r\n                        <div class=\"skeleton-text h-8 w-16 bg-slate-200 rounded mb-2\"></div>\r\n                        <div class=\"skeleton-text h-4 w-20 bg-slate-200 rounded\"></div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return results.join('');\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader pour les ressources\r\n * @param {number} count - Nombre de ressources\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createResourceSkeleton(count = 6) {\r\n    const resources = [];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        resources.push(`\r\n            <div class=\"skeleton-resource bg-white rounded-lg border border-slate-200 p-5 hover:shadow-md transition-shadow animate-pulse\">\r\n                <div class=\"flex items-start gap-4\">\r\n                    <div class=\"skeleton-icon h-12 w-12 bg-slate-200 rounded-lg flex-shrink-0\"></div>\r\n                    <div class=\"flex-1\">\r\n                        <div class=\"skeleton-text h-5 w-3/4 bg-slate-200 rounded mb-2\"></div>\r\n                        <div class=\"skeleton-text h-4 w-full bg-slate-200 rounded mb-3\"></div>\r\n                        <div class=\"flex gap-2 mb-3\">\r\n                            <div class=\"skeleton-badge h-5 w-20 bg-slate-200 rounded-full\"></div>\r\n                            <div class=\"skeleton-badge h-5 w-16 bg-slate-200 rounded-full\"></div>\r\n                        </div>\r\n                        <div class=\"flex items-center justify-between\">\r\n                            <div class=\"skeleton-text h-4 w-24 bg-slate-200 rounded\"></div>\r\n                            <div class=\"skeleton-button h-8 w-24 bg-slate-200 rounded\"></div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return resources.join('');\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader pour les statistiques (cartes)\r\n * @param {number} count - Nombre de cartes de stats\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createStatsSkeleton(count = 4) {\r\n    const stats = [];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        stats.push(`\r\n            <div class=\"skeleton-stats bg-gradient-to-br from-slate-200 to-slate-300 rounded-xl p-6 shadow-lg animate-pulse\">\r\n                <div class=\"flex items-center justify-between mb-4\">\r\n                    <div class=\"skeleton-icon h-12 w-12 bg-white/30 rounded-lg\"></div>\r\n                    <div class=\"skeleton-badge h-6 w-16 bg-white/30 rounded-full\"></div>\r\n                </div>\r\n                <div class=\"skeleton-text h-10 w-24 bg-white/30 rounded mb-2\"></div>\r\n                <div class=\"skeleton-text h-4 w-32 bg-white/30 rounded\"></div>\r\n            </div>\r\n        `);\r\n    }\r\n    \r\n    return stats.join('');\r\n}\r\n\r\n/**\r\n * Afficher un skeleton loader dans un conteneur\r\n * @param {string} containerId - ID du conteneur\r\n * @param {string} skeletonHTML - HTML du skeleton\r\n */\r\nexport function showSkeleton(containerId, skeletonHTML) {\r\n    const container = document.getElementById(containerId);\r\n    if (container) {\r\n        container.innerHTML = skeletonHTML;\r\n    }\r\n}\r\n\r\n/**\r\n * Cacher le skeleton et afficher le contenu rel\r\n * @param {string} containerId - ID du conteneur\r\n * @param {string} contentHTML - HTML du contenu rel\r\n */\r\nexport function hideSkeleton(containerId, contentHTML) {\r\n    const container = document.getElementById(containerId);\r\n    if (container) {\r\n        // Fade out skeleton\r\n        container.style.opacity = '0';\r\n        container.style.transition = 'opacity 300ms ease-out';\r\n        \r\n        setTimeout(() => {\r\n            container.innerHTML = contentHTML;\r\n            container.style.opacity = '1';\r\n        }, 300);\r\n    }\r\n}\r\n\r\n/**\r\n * Crer un skeleton loader fullpage (pour le chargement initial)\r\n * @returns {string} HTML du skeleton loader\r\n */\r\nexport function createFullPageSkeleton() {\r\n    return `\r\n        <div class=\"min-h-screen bg-slate-100 p-8 animate-pulse\">\r\n            <!-- Header -->\r\n            <div class=\"mb-8\">\r\n                <div class=\"skeleton-text h-10 w-64 bg-slate-200 rounded mb-2\"></div>\r\n                <div class=\"skeleton-text h-5 w-96 bg-slate-200 rounded\"></div>\r\n            </div>\r\n            \r\n            <!-- Stats Cards -->\r\n            <div class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\r\n                ${createStatsSkeleton(4)}\r\n            </div>\r\n            \r\n            <!-- Content Grid -->\r\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                ${createChartSkeleton()}\r\n                ${createChartSkeleton()}\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n// Exporter toutes les fonctions\r\nexport default {\r\n    createCardSkeleton,\r\n    createListSkeleton,\r\n    createTableSkeleton,\r\n    createChartSkeleton,\r\n    createGridSkeleton,\r\n    createFormSkeleton,\r\n    createQuestionSkeleton,\r\n    createUserSkeleton,\r\n    createResultSkeleton,\r\n    createResourceSkeleton,\r\n    createStatsSkeleton,\r\n    createFullPageSkeleton,\r\n    showSkeleton,\r\n    hideSkeleton\r\n};\r\n","// Admin Questions Manager - Gestion des questions de quiz\r\nimport { \r\n    getQuestions, \r\n    getQuestionsPaginated, //  CORRECTION SECTION 7 : Pagination\r\n    createQuestion, \r\n    updateQuestion, \r\n    deleteQuestion,\r\n    importQuestionsFromJSON,\r\n    getQuestionsStats\r\n} from './firestore-service.js';\r\nimport { isDemoMode } from './auth.js';\r\nimport { \r\n    createQuestionSkeleton,\r\n    createStatsSkeleton,\r\n    showSkeleton,\r\n    hideSkeleton\r\n} from './skeleton.js';\r\nimport { logger } from './logger.js';\r\nimport { \r\n    sanitizeHTML, \r\n    validateQuestionData, \r\n    sanitizeQuestionData \r\n} from './security.js';\r\n\r\n//  Cl localStorage pour persistance mode dmo\r\nconst DEMO_STORAGE_KEY = 'avantage-quizz-demo-questions';\r\n\r\n//  Charger les questions dmo depuis localStorage OU utiliser dfauts\r\nfunction loadDemoQuestions() {\r\n    if (!isDemoMode()) return [];\r\n    \r\n    const saved = localStorage.getItem(DEMO_STORAGE_KEY);\r\n    if (saved) {\r\n        try {\r\n            const parsed = JSON.parse(saved);\r\n            // Reconvertir les dates ISO en objets Date\r\n            return parsed.map(q => ({\r\n                ...q,\r\n                createdAt: new Date(q.createdAt)\r\n            }));\r\n        } catch (e) {\r\n            console.warn(' Erreur lecture questions dmo:', e);\r\n        }\r\n    }\r\n    \r\n    // Questions par dfaut\r\n    return [\r\n        { id: '1', module: 'auto', month: 11, year: 2025, question: 'Quelle est la pression recommande pour les pneus d\\'une voiture standard ?', options: ['32 PSI', '25 PSI', '40 PSI', '50 PSI'], correctAnswer: 0, explanation: 'La pression recommande est gnralement de 32 PSI pour un vhicule standard.', createdAt: new Date() },\r\n        { id: '2', module: 'auto', month: 11, year: 2025, question: ' quelle frquence doit-on changer l\\'huile moteur ?', options: ['Tous les 5000 km', 'Tous les 10000 km', 'Tous les 15000 km', 'Tous les 20000 km'], correctAnswer: 1, explanation: 'Il est recommand de changer l\\'huile tous les 10000 km ou selon les recommandations du fabricant.', createdAt: new Date() },\r\n        { id: '3', module: 'loisir', month: 11, year: 2025, question: 'Quel est le poids maximal recommand pour un bateau remorqu ?', options: ['1500 kg', '2000 kg', '2500 kg', '3000 kg'], correctAnswer: 2, explanation: 'Pour un vhicule standard, 2500 kg est souvent la limite recommande.', createdAt: new Date() },\r\n        { id: '4', module: 'vr', month: 10, year: 2025, question: 'Quelle est la capacit minimale recommande pour une batterie de VR ?', options: ['75 Ah', '100 Ah', '125 Ah', '150 Ah'], correctAnswer: 1, explanation: 'Une batterie de 100 Ah est le minimum recommand pour un VR.', createdAt: new Date() },\r\n        { id: '5', module: 'tracteur', month: 10, year: 2025, question: ' quelle profondeur doit-on labourer pour les cultures cralires ?', options: ['10-15 cm', '20-25 cm', '30-35 cm', '40-45 cm'], correctAnswer: 1, explanation: 'La profondeur idale est de 20-25 cm pour les crales.', createdAt: new Date() }\r\n    ];\r\n}\r\n\r\n//  Sauvegarder les questions dmo dans localStorage\r\nfunction saveDemoQuestions(questions) {\r\n    if (!isDemoMode()) return;\r\n    localStorage.setItem(DEMO_STORAGE_KEY, JSON.stringify(questions));\r\n    console.log(' Questions dmo sauvegardes:', questions.length);\r\n}\r\n\r\n//  Donnes simules pour le mode dmo\r\nlet MOCK_QUESTIONS = loadDemoQuestions();\r\n\r\nconst MOCK_STATS = {\r\n    total: 240,\r\n    byModule: { auto: 85, loisir: 62, vr: 54, tracteur: 39 },\r\n    recent: 12\r\n};\r\n\r\n// tat de l'application\r\nlet currentQuestions = [];\r\nlet currentFilters = {\r\n    module: '',\r\n    month: '',\r\n    year: new Date().getFullYear()\r\n};\r\nlet currentPage = 1;\r\nconst questionsPerPage = 20;\r\n\r\n/**\r\n * Initialiser la gestion des questions\r\n */\r\nexport async function initQuestionsManager() {\r\n    console.log('Initialisation du gestionnaire de questions');\r\n    \r\n    // Charger les questions\r\n    await loadQuestions();\r\n    \r\n    // Charger les statistiques\r\n    await loadStats();\r\n    \r\n    // Initialiser les event listeners\r\n    initEventListeners();\r\n}\r\n\r\n/**\r\n * Initialiser les event listeners\r\n */\r\nfunction initEventListeners() {\r\n    // Formulaire de cration\r\n    const createForm = document.getElementById('create-question-form');\r\n    if (createForm) {\r\n        createForm.addEventListener('submit', handleCreateQuestion);\r\n    }\r\n    \r\n    // Upload JSON\r\n    const jsonInput = document.getElementById('json-file-input');\r\n    if (jsonInput) {\r\n        jsonInput.addEventListener('change', handleJSONUpload);\r\n    }\r\n    \r\n    // Bouton parcourir\r\n    const browseBtn = document.getElementById('browse-json-btn');\r\n    if (browseBtn) {\r\n        browseBtn.addEventListener('click', () => jsonInput?.click());\r\n    }\r\n    \r\n    // Filtres\r\n    const moduleFilter = document.getElementById('filter-module');\r\n    const monthFilter = document.getElementById('filter-month');\r\n    const yearFilter = document.getElementById('filter-year');\r\n    const searchInput = document.getElementById('search-questions');\r\n    const questionsList = document.getElementById('questions-list');\r\n    \r\n    if (moduleFilter) moduleFilter.addEventListener('change', handleFilterChange);\r\n    if (monthFilter) monthFilter.addEventListener('change', handleFilterChange);\r\n    if (yearFilter) yearFilter.addEventListener('change', handleFilterChange);\r\n    if (searchInput) searchInput.addEventListener('input', handleSearch);\r\n\r\n    if (questionsList && !questionsList.dataset.eventsBound) {\r\n        questionsList.addEventListener('click', handleQuestionsListClick);\r\n        questionsList.dataset.eventsBound = 'true';\r\n    }\r\n    \r\n    // Pagination\r\n    const prevBtn = document.getElementById('prev-page-btn');\r\n    const nextBtn = document.getElementById('next-page-btn');\r\n    \r\n    if (prevBtn) prevBtn.addEventListener('click', () => changePage(-1));\r\n    if (nextBtn) nextBtn.addEventListener('click', () => changePage(1));\r\n}\r\n\r\nfunction handleQuestionsListClick(event) {\r\n    const actionButton = event.target.closest('.edit-question-btn, .delete-question-btn');\r\n    if (!actionButton) {\r\n        return;\r\n    }\r\n\r\n    const questionId = actionButton.dataset.questionId;\r\n    if (!questionId) {\r\n        return;\r\n    }\r\n\r\n    if (actionButton.classList.contains('edit-question-btn')) {\r\n        openEditModal(questionId);\r\n        return;\r\n    }\r\n\r\n    if (actionButton.classList.contains('delete-question-btn')) {\r\n        handleDeleteQuestion(questionId);\r\n    }\r\n}\r\n\r\n/**\r\n * Charger les questions avec filtres\r\n */\r\nasync function loadQuestions() {\r\n    try {\r\n        // Afficher skeleton pendant le chargement\r\n        const container = document.getElementById('questions-list');\r\n        if (container) {\r\n            showSkeleton('questions-list', createQuestionSkeleton(5));\r\n        }\r\n        \r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            console.log(' Mode dmo : Chargement des questions simules...');\r\n            \r\n            // Simuler un dlai de chargement\r\n            await new Promise(resolve => setTimeout(resolve, 500));\r\n            \r\n            // Appliquer les filtres sur les donnes mockes\r\n            currentQuestions = MOCK_QUESTIONS.filter(q => {\r\n                if (currentFilters.module && q.module !== currentFilters.module) return false;\r\n                if (currentFilters.month && q.month !== parseInt(currentFilters.month)) return false;\r\n                if (currentFilters.year && q.year !== parseInt(currentFilters.year)) return false;\r\n                return true;\r\n            });\r\n            \r\n            console.log(` ${currentQuestions.length} questions simules charges`);\r\n            renderQuestionsList();\r\n            return;\r\n        }\r\n        \r\n        // Mode Firebase normal\r\n        const filters = {};\r\n        if (currentFilters.module) filters.module = currentFilters.module;\r\n        if (currentFilters.month) filters.month = parseInt(currentFilters.month);\r\n        if (currentFilters.year) filters.year = parseInt(currentFilters.year);\r\n        \r\n        currentQuestions = await getQuestions(filters);\r\n        console.log(`Questions chargees: ${currentQuestions.length}`);\r\n        \r\n        renderQuestionsList();\r\n    } catch (error) {\r\n        console.error('Erreur chargement questions:', error);\r\n        const container = document.getElementById('questions-list');\r\n        if (container) {\r\n            container.innerHTML = `\r\n                <div class=\"text-center py-12 text-red-500\">\r\n                    <svg class=\"w-16 h-16 mx-auto mb-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                    <p class=\"text-lg font-medium\">Erreur lors du chargement</p>\r\n                    <p class=\"text-sm\">${error.message}</p>\r\n                </div>\r\n            `;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Afficher la liste des questions\r\n */\r\nfunction renderQuestionsList() {\r\n    const container = document.getElementById('questions-list');\r\n    if (!container) return;\r\n    \r\n    if (currentQuestions.length === 0) {\r\n        const emptyState = document.createElement('div');\r\n        emptyState.className = 'text-center py-12 text-slate-500';\r\n        emptyState.innerHTML = `\r\n            <svg class=\"w-16 h-16 mx-auto mb-4 opacity-50\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n            </svg>\r\n            <p class=\"text-lg font-medium\">Aucune question trouvee</p>\r\n            <p class=\"text-sm\">Creez votre premiere question ou importez un fichier JSON</p>\r\n        `;\r\n        container.replaceChildren(emptyState);\r\n        return;\r\n    }\r\n    \r\n    // Pagination\r\n    const startIndex = (currentPage - 1) * questionsPerPage;\r\n    const endIndex = startIndex + questionsPerPage;\r\n    const paginatedQuestions = currentQuestions.slice(startIndex, endIndex);\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    paginatedQuestions.forEach(question => {\r\n        fragment.appendChild(createQuestionCardElement(question));\r\n    });\r\n\r\n    container.replaceChildren(fragment);\r\n\r\n    // Mettre  jour la pagination\r\n    updatePaginationControls();\r\n}\r\n\r\n/**\r\n * Crer une carte de question sous forme de noeud DOM\r\n */\r\nfunction createQuestionCardElement(question) {\r\n    const moduleColors = {\r\n        auto: 'red',\r\n        loisir: 'cyan',\r\n        vr: 'orange',\r\n        tracteur: 'green'\r\n    };\r\n    \r\n    const moduleIcons = {\r\n        auto: '',\r\n        loisir: '',\r\n        vr: '',\r\n        tracteur: ''\r\n    };\r\n    \r\n    const color = moduleColors[question.module] || 'gray';\r\n    const icon = moduleIcons[question.module] || '';\r\n    \r\n    const monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];\r\n    const monthName = monthNames[question.month - 1] || question.month;\r\n    const createdAt = question.createdAt?.seconds\r\n        ? new Date(question.createdAt.seconds * 1000)\r\n        : question.createdAt instanceof Date\r\n            ? question.createdAt\r\n            : null;\r\n    const createdAtDisplay = createdAt ? createdAt.toLocaleDateString('fr-FR') : 'N/A';\r\n    \r\n    const template = document.createElement('template');\r\n    template.innerHTML = `\r\n        <article class=\"question-card bg-white rounded-xl shadow-md p-6 mb-4 hover:shadow-lg transition-shadow\" data-question-id=\"${question.id}\">\r\n            <div class=\"flex items-start justify-between mb-4\">\r\n                <div class=\"flex items-center gap-3\">\r\n                    <span class=\"text-2xl\">${icon}</span>\r\n                    <div>\r\n                        <span class=\"inline-block bg-${color}-100 text-${color}-700 text-xs font-semibold px-3 py-1 rounded-full\">\r\n                            ${escapeHtml(question.module.toUpperCase())}\r\n                        </span>\r\n                        <span class=\"ml-2 text-sm text-slate-500\">${escapeHtml(`${monthName} ${question.year}`)}</span>\r\n                    </div>\r\n                </div>\r\n                <div class=\"flex gap-2\">\r\n                    <button class=\"edit-question-btn text-ap-red-primary hover:text-ap-red-dark p-2 rounded hover:bg-ap-red-50 transition\" data-question-id=\"${question.id}\" title=\"Modifier\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\"></path>\r\n                        </svg>\r\n                    </button>\r\n                    <button class=\"delete-question-btn text-red-600 hover:text-red-800 p-2 rounded hover:bg-red-50 transition\" data-question-id=\"${question.id}\" title=\"Supprimer\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\"></path>\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n            <h4 class=\"text-lg font-semibold text-slate-900 mb-4\">${escapeHtml(question.question)}</h4>\r\n            <div class=\"space-y-2 mb-4\">\r\n                ${question.options.map((opt, idx) => `\r\n                    <div class=\"flex items-start gap-2 text-sm ${idx === question.correctAnswer ? 'font-semibold text-green-700 bg-green-50 p-2 rounded' : 'text-slate-600'}\">\r\n                        <span class=\"font-bold\">${String.fromCharCode(65 + idx)})</span>\r\n                        <span>${escapeHtml(opt)}</span>\r\n                        ${idx === question.correctAnswer ? '<svg class=\"w-5 h-5 text-green-600 ml-auto flex-shrink-0\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clip-rule=\"evenodd\"></path></svg>' : ''}\r\n                    </div>\r\n                `).join('')}\r\n            </div>\r\n            <div class=\"bg-blue-50 border-l-4 border-blue-500 p-3 rounded\">\r\n                <p class=\"text-xs font-semibold text-blue-700 mb-1\"> Explication</p>\r\n                <p class=\"text-sm text-blue-900\">${escapeHtml(question.explanation)}</p>\r\n            </div>\r\n            <div class=\"mt-4 pt-4 border-t border-slate-200 text-xs text-slate-500\">\r\n                Creee le: ${escapeHtml(createdAtDisplay)}${question.createdBy ? escapeHtml(` | Par: ${question.createdBy}`) : ''}\r\n            </div>\r\n        </article>\r\n    `;\r\n\r\n    return template.content.firstElementChild;\r\n}\r\n\r\n/**\r\n * Grer la cration d'une question\r\n */\r\nasync function handleCreateQuestion(e) {\r\n    e.preventDefault();\r\n    \r\n    const form = e.target;\r\n    const submitBtn = form.querySelector('[type=\"submit\"]');\r\n    const originalBtnText = submitBtn.innerHTML;\r\n    \r\n    try {\r\n        submitBtn.disabled = true;\r\n        submitBtn.innerHTML = '<svg class=\"animate-spin h-5 w-5 inline\" fill=\"none\" viewBox=\"0 0 24 24\"><circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle><path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path></svg> Creation...';\r\n        \r\n        const questionData = {\r\n            question: form.querySelector('[name=\"question\"]').value,\r\n            options: [\r\n                form.querySelector('[name=\"option1\"]').value,\r\n                form.querySelector('[name=\"option2\"]').value,\r\n                form.querySelector('[name=\"option3\"]').value,\r\n                form.querySelector('[name=\"option4\"]').value\r\n            ],\r\n            correctAnswer: parseInt(form.querySelector('[name=\"correctAnswer\"]:checked').value),\r\n            explanation: form.querySelector('[name=\"explanation\"]').value,\r\n            module: form.querySelector('[name=\"module\"]').value,\r\n            month: parseInt(form.querySelector('[name=\"month\"]').value),\r\n            year: parseInt(form.querySelector('[name=\"year\"]').value)\r\n        };\r\n        \r\n        //  Mode dmo : Simuler la cration\r\n        if (isDemoMode()) {\r\n            console.log(' Mode dmo : Simulation cration question...');\r\n            await new Promise(resolve => setTimeout(resolve, 500)); // Dlai raliste\r\n            \r\n            // Ajouter la question aux donnes mockes\r\n            const newMockQuestion = {\r\n                id: `demo-${Date.now()}`,\r\n                ...questionData,\r\n                explanation: questionData.explanation || 'Explication non fournie',\r\n                createdAt: new Date()\r\n            };\r\n            MOCK_QUESTIONS.unshift(newMockQuestion);\r\n            \r\n            //  SAUVEGARDER dans localStorage\r\n            saveDemoQuestions(MOCK_QUESTIONS);\r\n            \r\n            showSuccess(' Question cre avec succs (mode dmo) !');\r\n            form.reset();\r\n            \r\n            await loadQuestions();\r\n            await loadStats();\r\n            return;\r\n        }\r\n        \r\n        await createQuestion(questionData);\r\n        \r\n        showSuccess('Question creee avec succes!');\r\n        form.reset();\r\n        await loadQuestions();\r\n        await loadStats();\r\n    } catch (error) {\r\n        console.error('Erreur creation question:', error);\r\n        showError('create-question-error', error.message || 'Erreur lors de la creation');\r\n    } finally {\r\n        submitBtn.disabled = false;\r\n        submitBtn.innerHTML = originalBtnText;\r\n    }\r\n}\r\n\r\n/**\r\n * Grer l'upload JSON\r\n */\r\nasync function handleJSONUpload(e) {\r\n    const file = e.target.files[0];\r\n    if (!file) return;\r\n    \r\n    try {\r\n        showLoading('json-preview');\r\n        \r\n        const text = await file.text();\r\n        const jsonData = JSON.parse(text);\r\n        \r\n        // Valider le format\r\n        validateJSONFormat(jsonData);\r\n        \r\n        // Afficher l'aperu\r\n        showJSONPreview(jsonData, file.name);\r\n    } catch (error) {\r\n        console.error('Erreur lecture JSON:', error);\r\n        showError('json-preview', error.message || 'Fichier JSON invalide');\r\n    }\r\n}\r\n\r\n/**\r\n * Valider le format JSON\r\n */\r\nfunction validateJSONFormat(data) {\r\n    if (!data.module || !data.month || !data.year) {\r\n        throw new Error('Champs obligatoires manquants: module, month, year');\r\n    }\r\n    \r\n    if (!Array.isArray(data.questions) || data.questions.length === 0) {\r\n        throw new Error('Le fichier doit contenir au moins une question');\r\n    }\r\n    \r\n    // Valider chaque question\r\n    data.questions.forEach((q, idx) => {\r\n        if (!q.question || q.question.length < 10) {\r\n            throw new Error(`Question ${idx + 1}: texte trop court (min 10 caracteres)`);\r\n        }\r\n        if (!Array.isArray(q.options) || q.options.length !== 4) {\r\n            throw new Error(`Question ${idx + 1}: doit avoir exactement 4 options`);\r\n        }\r\n        if (q.correctAnswer === undefined || q.correctAnswer < 0 || q.correctAnswer > 3) {\r\n            throw new Error(`Question ${idx + 1}: correctAnswer invalide (doit etre 0-3)`);\r\n        }\r\n        if (!q.explanation || q.explanation.length < 20) {\r\n            throw new Error(`Question ${idx + 1}: explication trop courte (min 20 caracteres)`);\r\n        }\r\n    });\r\n    \r\n    return true;\r\n}\r\n\r\n/**\r\n * Afficher l'aperu du JSON\r\n */\r\nfunction showJSONPreview(data, fileName) {\r\n    const container = document.getElementById('json-preview');\r\n    if (!container) return;\r\n    \r\n    const moduleNames = {\r\n        auto: 'Auto',\r\n        loisir: 'Loisir',\r\n        vr: 'VR',\r\n        tracteur: 'Tracteur'\r\n    };\r\n    \r\n    const monthNames = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];\r\n    \r\n    container.innerHTML = `\r\n        <div class=\"bg-green-50 border-2 border-green-500 rounded-xl p-6\">\r\n            <div class=\"flex items-start justify-between mb-4\">\r\n                <div>\r\n                    <h4 class=\"text-lg font-bold text-green-900 mb-2\"> ${fileName}</h4>\r\n                    <div class=\"space-y-1 text-sm\">\r\n                        <p class=\"text-green-800\"> Format valide</p>\r\n                        <p class=\"text-green-800\"> ${data.questions.length} question(s) detectee(s)</p>\r\n                        <p class=\"text-green-800\"> Module: ${moduleNames[data.module] || data.module}</p>\r\n                        <p class=\"text-green-800\"> Periode: ${monthNames[data.month - 1]} ${data.year}</p>\r\n                    </div>\r\n                </div>\r\n                <button id=\"cancel-import-btn\" class=\"text-slate-500 hover:text-slate-700\">\r\n                    <svg class=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                    </svg>\r\n                </button>\r\n            </div>\r\n            \r\n            <div class=\"bg-white rounded-lg p-4 mb-4 max-h-60 overflow-y-auto\">\r\n                <p class=\"font-semibold text-slate-900 mb-2\">Apercu des premieres questions:</p>\r\n                <ol class=\"space-y-2 text-sm text-slate-700\">\r\n                    ${data.questions.slice(0, 5).map((q, idx) => `\r\n                        <li><strong>${idx + 1}.</strong> ${escapeHtml(q.question.substring(0, 80))}${q.question.length > 80 ? '...' : ''}</li>\r\n                    `).join('')}\r\n                    ${data.questions.length > 5 ? `<li class=\"text-slate-500 italic\">... et ${data.questions.length - 5} autre(s)</li>` : ''}\r\n                </ol>\r\n            </div>\r\n            \r\n            <div class=\"flex gap-3\">\r\n                <button id=\"confirm-import-btn\" class=\"flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition\">\r\n                    Importer les ${data.questions.length} questions \r\n                </button>\r\n            </div>\r\n        </div>\r\n    `;\r\n    \r\n    // Event listeners\r\n    document.getElementById('confirm-import-btn')?.addEventListener('click', () => handleConfirmImport(data));\r\n    document.getElementById('cancel-import-btn')?.addEventListener('click', () => {\r\n        container.innerHTML = '';\r\n        document.getElementById('json-file-input').value = '';\r\n    });\r\n}\r\n\r\n/**\r\n * Confirmer l'import JSON\r\n */\r\nasync function handleConfirmImport(data) {\r\n    const container = document.getElementById('json-preview');\r\n    const confirmBtn = document.getElementById('confirm-import-btn');\r\n    \r\n    try {\r\n        confirmBtn.disabled = true;\r\n        confirmBtn.innerHTML = '<svg class=\"animate-spin h-5 w-5 inline\" fill=\"none\" viewBox=\"0 0 24 24\"><circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle></svg> Import en cours...';\r\n        \r\n        //  Mode dmo : Simuler l'import\r\n        if (isDemoMode()) {\r\n            console.log(' Mode dmo : Simulation import JSON...');\r\n            await new Promise(resolve => setTimeout(resolve, 1000));\r\n            \r\n            const questionsToImport = data.questions || [];\r\n            questionsToImport.forEach((q, idx) => {\r\n                MOCK_QUESTIONS.unshift({\r\n                    id: `demo-imported-${Date.now()}-${idx}`,\r\n                    question: q.question,\r\n                    options: q.options,\r\n                    correctAnswer: q.correctAnswer,\r\n                    explanation: q.explanation || 'Pas d\\'explication fournie',\r\n                    module: data.module,\r\n                    month: data.month,\r\n                    year: data.year,\r\n                    createdAt: new Date()\r\n                });\r\n            });\r\n            \r\n            //  SAUVEGARDER dans localStorage\r\n            saveDemoQuestions(MOCK_QUESTIONS);\r\n            \r\n            showSuccess(` Import termin (mode dmo): ${questionsToImport.length} questions importes`);\r\n            \r\n            container.innerHTML = '';\r\n            document.getElementById('json-file-input').value = '';\r\n            \r\n            await loadQuestions();\r\n            await loadStats();\r\n            return;\r\n        }\r\n        \r\n        const result = await importQuestionsFromJSON(data);\r\n        \r\n        showSuccess(`Import termine: ${result.success}/${result.total} questions importees`);\r\n        \r\n        if (result.errors.length > 0) {\r\n            console.warn('Erreurs import:', result.errors);\r\n        }\r\n        \r\n        container.innerHTML = '';\r\n        document.getElementById('json-file-input').value = '';\r\n        \r\n        await loadQuestions();\r\n        await loadStats();\r\n    } catch (error) {\r\n        console.error('Erreur import:', error);\r\n        showError('json-preview', error.message || 'Erreur lors de l import');\r\n    }\r\n}\r\n\r\n/**\r\n * Ouvrir le modal d'dition\r\n */\r\nfunction openEditModal(questionId) {\r\n    const question = currentQuestions.find(q => q.id === questionId);\r\n    if (!question) return;\r\n    \r\n    // TODO: Implementer le modal d'edition\r\n    // Pour l'instant, on affiche une alerte\r\n    alert(`Edition de la question ${questionId}\\nA implementer: modal d'edition`);\r\n}\r\n\r\n/**\r\n * Grer la suppression d'une question\r\n */\r\nasync function handleDeleteQuestion(questionId) {\r\n    const question = currentQuestions.find(q => q.id === questionId);\r\n    if (!question) return;\r\n    \r\n    const confirmDelete = confirm(\r\n        `Voulez-vous vraiment supprimer cette question?\\n\\n\"${question.question.substring(0, 100)}...\"\\n\\nCette action est irreversible.`\r\n    );\r\n    \r\n    if (!confirmDelete) return;\r\n    \r\n    try {\r\n        //  Mode dmo : Simuler la suppression\r\n        if (isDemoMode()) {\r\n            console.log(' Mode dmo : Simulation suppression question...');\r\n            await new Promise(resolve => setTimeout(resolve, 300));\r\n            \r\n            const index = MOCK_QUESTIONS.findIndex(q => q.id === questionId);\r\n            if (index > -1) {\r\n                MOCK_QUESTIONS.splice(index, 1);\r\n                \r\n                //  SAUVEGARDER dans localStorage\r\n                saveDemoQuestions(MOCK_QUESTIONS);\r\n            }\r\n            \r\n            showSuccess(' Question supprime avec succs (mode dmo)');\r\n            await loadQuestions();\r\n            await loadStats();\r\n            return;\r\n        }\r\n        \r\n        await deleteQuestion(questionId);\r\n        showSuccess('Question supprimee avec succes');\r\n        await loadQuestions();\r\n        await loadStats();\r\n    } catch (error) {\r\n        console.error('Erreur suppression:', error);\r\n        showError('questions-list', error.message || 'Erreur lors de la suppression');\r\n    }\r\n}\r\n\r\n/**\r\n * Grer le changement de filtres\r\n */\r\nasync function handleFilterChange(e) {\r\n    const filterName = e.target.id.replace('filter-', '');\r\n    currentFilters[filterName] = e.target.value;\r\n    currentPage = 1; // Reset pagination\r\n    await loadQuestions();\r\n}\r\n\r\n/**\r\n * Grer la recherche\r\n */\r\nfunction handleSearch(e) {\r\n    const searchTerm = e.target.value.toLowerCase();\r\n    \r\n    if (!searchTerm) {\r\n        renderQuestionsList();\r\n        return;\r\n    }\r\n    \r\n    const filtered = currentQuestions.filter(q => \r\n        q.question.toLowerCase().includes(searchTerm) ||\r\n        q.options.some(opt => opt.toLowerCase().includes(searchTerm)) ||\r\n        q.explanation.toLowerCase().includes(searchTerm)\r\n    );\r\n    \r\n    // Afficher les rsultats filtrs\r\n    const container = document.getElementById('questions-list');\r\n    if (!container) return;\r\n    \r\n    if (filtered.length === 0) {\r\n        const emptyState = document.createElement('div');\r\n        emptyState.className = 'text-center py-12 text-slate-500';\r\n        emptyState.innerHTML = `\r\n            <p class=\"text-lg\">Aucun resultat pour \"${escapeHtml(searchTerm)}\"</p>\r\n        `;\r\n        container.replaceChildren(emptyState);\r\n        return;\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    filtered.forEach(question => {\r\n        fragment.appendChild(createQuestionCardElement(question));\r\n    });\r\n    container.replaceChildren(fragment);\r\n}\r\n\r\n/**\r\n * Changer de page\r\n */\r\nfunction changePage(direction) {\r\n    const totalPages = Math.ceil(currentQuestions.length / questionsPerPage);\r\n    currentPage += direction;\r\n    \r\n    if (currentPage < 1) currentPage = 1;\r\n    if (currentPage > totalPages) currentPage = totalPages;\r\n    \r\n    renderQuestionsList();\r\n    window.scrollTo({ top: 0, behavior: 'smooth' });\r\n}\r\n\r\n/**\r\n * Mettre  jour les contrles de pagination\r\n */\r\nfunction updatePaginationControls() {\r\n    const totalPages = Math.ceil(currentQuestions.length / questionsPerPage);\r\n    const pageInfo = document.getElementById('page-info');\r\n    const prevBtn = document.getElementById('prev-page-btn');\r\n    const nextBtn = document.getElementById('next-page-btn');\r\n    \r\n    if (pageInfo) {\r\n        pageInfo.textContent = `Page ${currentPage}/${totalPages || 1}`;\r\n    }\r\n    \r\n    if (prevBtn) {\r\n        prevBtn.disabled = currentPage === 1;\r\n    }\r\n    \r\n    if (nextBtn) {\r\n        nextBtn.disabled = currentPage === totalPages || totalPages === 0;\r\n    }\r\n}\r\n\r\n/**\r\n * Charger les statistiques des questions\r\n */\r\nasync function loadStats() {\r\n    try {\r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            console.log(' Mode dmo : Chargement des stats simules...');\r\n            renderStats(MOCK_STATS);\r\n            return;\r\n        }\r\n        \r\n        // Mode Firebase normal\r\n        const stats = await getQuestionsStats();\r\n        renderStats(stats);\r\n    } catch (error) {\r\n        console.error('Erreur chargement stats:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Afficher les statistiques\r\n */\r\nfunction renderStats(stats) {\r\n    const container = document.getElementById('questions-stats');\r\n    if (!container) return;\r\n    \r\n    const moduleNames = {\r\n        auto: 'Auto',\r\n        loisir: 'Loisir',\r\n        vr: 'VR',\r\n        tracteur: 'Tracteur'\r\n    };\r\n    \r\n    container.innerHTML = `\r\n        <div class=\"bg-white rounded-xl shadow-md p-6\">\r\n            <h3 class=\"text-xl font-bold text-slate-900 mb-4\"> Statistiques des Questions</h3>\r\n            \r\n            <div class=\"mb-6\">\r\n                <p class=\"text-3xl font-bold text-ap-red-primary mb-1\">${stats.total}</p>\r\n                <p class=\"text-sm text-slate-600\">questions au total</p>\r\n            </div>\r\n            \r\n            <div class=\"space-y-3\">\r\n                <p class=\"text-sm font-semibold text-slate-700 mb-2\">Par module:</p>\r\n                ${Object.entries(stats.byModule).map(([module, count]) => {\r\n                    const percentage = ((count / stats.total) * 100).toFixed(0);\r\n                    return `\r\n                        <div>\r\n                            <div class=\"flex justify-between text-sm mb-1\">\r\n                                <span class=\"text-slate-700\">${moduleNames[module] || module}</span>\r\n                                <span class=\"font-semibold\">${count} (${percentage}%)</span>\r\n                            </div>\r\n                            <div class=\"bg-slate-200 rounded-full h-2\">\r\n                                <div class=\"bg-ap-red-primary rounded-full h-2 transition-all\" style=\"width: ${percentage}%\"></div>\r\n                            </div>\r\n                        </div>\r\n                    `;\r\n                }).join('')}\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Afficher un loader\r\n */\r\nfunction showLoading(containerId) {\r\n    const container = document.getElementById(containerId);\r\n    if (!container) return;\r\n    \r\n    container.innerHTML = `\r\n        <div class=\"text-center py-12\">\r\n            <svg class=\"animate-spin h-12 w-12 mx-auto text-ap-red-primary\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n                <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n            </svg>\r\n            <p class=\"text-slate-600 mt-4\">Chargement...</p>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Afficher une erreur\r\n */\r\nfunction showError(containerId, message) {\r\n    const container = document.getElementById(containerId);\r\n    if (!container) {\r\n        alert(`Erreur: ${message}`);\r\n        return;\r\n    }\r\n    \r\n    container.innerHTML = `\r\n        <div class=\"bg-red-50 border-2 border-red-500 rounded-xl p-6 text-center\">\r\n            <svg class=\"w-12 h-12 mx-auto text-red-500 mb-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n            </svg>\r\n            <p class=\"text-red-900 font-semibold\">${message}</p>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Afficher un message de succs\r\n */\r\nfunction showSuccess(message) {\r\n    // Crer une notification toast\r\n    const toast = document.createElement('div');\r\n    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 animate-fade-in';\r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3\">\r\n            <svg class=\"w-6 h-6\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clip-rule=\"evenodd\"></path>\r\n            </svg>\r\n            <span class=\"font-semibold\">${message}</span>\r\n        </div>\r\n    `;\r\n    \r\n    document.body.appendChild(toast);\r\n    \r\n    setTimeout(() => {\r\n        toast.remove();\r\n    }, 3000);\r\n}\r\n\r\n/**\r\n * chapper le HTML\r\n */\r\nfunction escapeHtml(text) {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n}\r\n","// Admin Users Manager - Gestion des utilisateurs\r\nimport { \r\n    getAllUsers, \r\n    getAllUsersPaginated, //  CORRECTION SECTION 7 : Pagination\r\n    updateUserRole,\r\n    getUsersStats\r\n} from './firestore-service.js';\r\nimport { toast } from './toast.js';\r\nimport { isDemoMode } from './auth.js';\r\n//  CORRECTION SECTION 4 : Protection XSS - Utiliser escapeHtml centralis\r\nimport { escapeHtml } from './security.js';\r\nimport {\r\n    createUserSkeleton,\r\n    createStatsSkeleton,\r\n    showSkeleton,\r\n    hideSkeleton\r\n} from './skeleton.js';\r\n\r\n//  Donnes simules pour le mode dmo\r\nconst MOCK_USERS = [\r\n    { id: '1', email: 'admin@avantage-quizz.com', displayName: 'Administrateur Principal', role: 'admin', totalQuizzes: 0, averageScore: 0, createdAt: new Date('2025-01-15'), lastLogin: new Date() },\r\n    { id: '2', email: 'alice.dupont@example.com', displayName: 'Alice Dupont', role: 'user', totalQuizzes: 24, averageScore: 92, createdAt: new Date('2025-02-20'), lastLogin: new Date() },\r\n    { id: '3', email: 'bob.martin@example.com', displayName: 'Bob Martin', role: 'user', totalQuizzes: 21, averageScore: 88, createdAt: new Date('2025-03-10'), lastLogin: new Date(Date.now() - 86400000) },\r\n    { id: '4', email: 'claire.bernard@example.com', displayName: 'Claire Bernard', role: 'user', totalQuizzes: 19, averageScore: 85, createdAt: new Date('2025-03-25'), lastLogin: new Date(Date.now() - 172800000) },\r\n    { id: '5', email: 'david.dubois@example.com', displayName: 'David Dubois', role: 'user', totalQuizzes: 18, averageScore: 83, createdAt: new Date('2025-04-05'), lastLogin: new Date(Date.now() - 259200000) }\r\n];\r\n\r\nconst MOCK_STATS = {\r\n    total: 42,\r\n    admins: 2,\r\n    regularUsers: 40,\r\n    activeToday: 8,\r\n    activeWeek: 23\r\n};\r\n\r\n// tat\r\nlet currentUsers = [];\r\nlet currentFilters = {\r\n    role: '',\r\n    status: 'all'\r\n};\r\n\r\n//  CORRECTION SECTION 7 : Pagination - tat de pagination\r\nlet paginationState = {\r\n    lastDoc: null,\r\n    hasMore: false,\r\n    isLoading: false,\r\n    pageSize: 20\r\n};\r\n\r\n/**\r\n * Initialiser la gestion des utilisateurs\r\n */\r\nexport async function initUsersManager() {\r\n    console.log('Initialisation du gestionnaire utilisateurs');\r\n    \r\n    // Charger les utilisateurs\r\n    await loadUsers();\r\n    \r\n    // Charger les statistiques\r\n    await loadStats();\r\n    \r\n    // Initialiser les event listeners\r\n    initEventListeners();\r\n}\r\n\r\n/**\r\n * Initialiser les event listeners\r\n */\r\nfunction initEventListeners() {\r\n    // Formulaire de cration d'utilisateur\r\n    const createUserForm = document.getElementById('create-user-form');\r\n    if (createUserForm) {\r\n        createUserForm.addEventListener('submit', handleCreateUser);\r\n    }\r\n    \r\n    // Bouton gnration de mot de passe\r\n    const generatePasswordBtn = document.getElementById('generate-password-btn');\r\n    if (generatePasswordBtn) {\r\n        generatePasswordBtn.addEventListener('click', generateRandomPassword);\r\n    }\r\n    \r\n    // Filtres\r\n    const roleFilter = document.getElementById('filter-user-role');\r\n    const statusFilter = document.getElementById('filter-user-status');\r\n    const searchInput = document.getElementById('search-users');\r\n    \r\n    if (roleFilter) roleFilter.addEventListener('change', handleFilterChange);\r\n    if (statusFilter) statusFilter.addEventListener('change', handleFilterChange);\r\n    if (searchInput) searchInput.addEventListener('input', handleSearch);\r\n}\r\n\r\n/**\r\n * Crer un nouvel utilisateur\r\n */\r\nasync function handleCreateUser(e) {\r\n    e.preventDefault();\r\n    \r\n    const errorDiv = document.getElementById('create-user-error');\r\n    const successDiv = document.getElementById('create-user-success');\r\n    const submitBtn = document.getElementById('create-user-btn');\r\n    \r\n    // Masquer les messages\r\n    errorDiv.classList.add('hidden');\r\n    successDiv.classList.add('hidden');\r\n    \r\n    // Rcuprer les donnes\r\n    const formData = new FormData(e.target);\r\n    const userData = {\r\n        displayName: formData.get('displayName'),\r\n        email: formData.get('email'),\r\n        password: formData.get('password'),\r\n        role: formData.get('role')\r\n    };\r\n    \r\n    // Validation\r\n    if (!userData.displayName || !userData.email || !userData.password || !userData.role) {\r\n        showFormError(errorDiv, 'Tous les champs sont obligatoires');\r\n        toast.error('Veuillez remplir tous les champs');\r\n        return;\r\n    }\r\n    \r\n    if (userData.password.length < 6) {\r\n        showFormError(errorDiv, 'Le mot de passe doit contenir au moins 6 caractres');\r\n        toast.error('Mot de passe trop court (minimum 6 caractres)');\r\n        return;\r\n    }\r\n    \r\n    // Dsactiver le bouton et afficher loading toast\r\n    submitBtn.disabled = true;\r\n    submitBtn.textContent = ' Cration en cours...';\r\n    const loadingToast = toast.showLoadingToast('Cration de l\\'utilisateur...');\r\n    \r\n    try {\r\n        console.log('Cration d\\'un nouvel utilisateur:', userData.email);\r\n        \r\n        // Appeler la Cloud Function ( crer)\r\n        // Pour l'instant, on simule avec un message d'erreur explicite\r\n        toast.updateLoadingToast(loadingToast, 'Cloud Function requise', 'error');\r\n        throw new Error(' CLOUD FUNCTION REQUISE: Cette fonctionnalit ncessite une Cloud Function Firebase pour crer des utilisateurs avec mot de passe. Actuellement, seule l\\'authentification Google est supporte. Pour activer cette fonctionnalit:\\n\\n1. Activer Email/Password dans Firebase Auth\\n2. Crer une Cloud Function createUser\\n3. Dployer la fonction sur Firebase');\r\n        \r\n        // Code  utiliser une fois la Cloud Function cre:\r\n        /*\r\n        const createUserFunction = httpsCallable(functions, 'createUser');\r\n        const result = await createUserFunction(userData);\r\n        \r\n        console.log(' Utilisateur cr avec succs:', result.data);\r\n        \r\n        // Afficher le message de succs\r\n        successDiv.textContent = ` Utilisateur cr avec succs ! Email: ${userData.email}`;\r\n        successDiv.classList.remove('hidden');\r\n        \r\n        // Toast de succs\r\n        toast.updateLoadingToast(loadingToast, 'Utilisateur cr avec succs !', 'success');\r\n        toast.success(`Utilisateur ${userData.email} cr !`, 4000);\r\n        \r\n        // Rinitialiser le formulaire\r\n        e.target.reset();\r\n        \r\n        // Recharger la liste des utilisateurs\r\n        await loadUsers();\r\n        */\r\n        \r\n    } catch (error) {\r\n        console.error(' Erreur cration utilisateur:', error);\r\n        showFormError(errorDiv, error.message);\r\n    } finally {\r\n        // Ractiver le bouton\r\n        submitBtn.disabled = false;\r\n        submitBtn.textContent = ' Crer l\\'utilisateur';\r\n    }\r\n}\r\n\r\n/**\r\n * Gnrer un mot de passe alatoire\r\n */\r\nfunction generateRandomPassword() {\r\n    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789@#$%&';\r\n    const length = 12;\r\n    let password = '';\r\n    \r\n    for (let i = 0; i < length; i++) {\r\n        password += chars.charAt(Math.floor(Math.random() * chars.length));\r\n    }\r\n    \r\n    // Remplir le champ\r\n    const passwordInput = document.querySelector('input[name=\"password\"]');\r\n    if (passwordInput) {\r\n        passwordInput.value = password;\r\n        passwordInput.type = 'text'; // Afficher le mot de passe gnr\r\n        \r\n        // Copier dans le presse-papier\r\n        navigator.clipboard.writeText(password).then(() => {\r\n            toast.success('Mot de passe gnr et copi ! Sauvegardez-le en lieu sr.', 5000);\r\n        }).catch(() => {\r\n            toast.warning(`Mot de passe gnr: ${password}\\n\\nCopiez-le manuellement.`, 7000);\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Afficher une erreur de formulaire\r\n */\r\nfunction showFormError(errorDiv, message) {\r\n    errorDiv.textContent = message;\r\n    errorDiv.classList.remove('hidden');\r\n    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\r\n}\r\n\r\n/**\r\n * Charger tous les utilisateurs\r\n */\r\nasync function loadUsers() {\r\n    try {\r\n        // Afficher skeleton pendant le chargement\r\n        const container = document.getElementById('users-list');\r\n        if (container) {\r\n            showSkeleton('users-list', createUserSkeleton(10));\r\n        }\r\n        \r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            console.log(' Mode dmo : Chargement des utilisateurs simuls...');\r\n            \r\n            // Simuler un dlai de chargement\r\n            await new Promise(resolve => setTimeout(resolve, 500));\r\n            \r\n            // Appliquer les filtres sur les donnes mockes\r\n            currentUsers = MOCK_USERS.filter(user => {\r\n                if (currentFilters.role && user.role !== currentFilters.role) return false;\r\n                \r\n                if (currentFilters.status !== 'all') {\r\n                    const oneWeekAgo = new Date();\r\n                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);\r\n                    const lastLoginDate = user.lastLogin;\r\n                    const isActive = lastLoginDate > oneWeekAgo;\r\n                    \r\n                    if (currentFilters.status === 'active' && !isActive) return false;\r\n                    if (currentFilters.status === 'inactive' && isActive) return false;\r\n                }\r\n                \r\n                return true;\r\n            });\r\n            \r\n            console.log(` ${currentUsers.length} utilisateurs simuls chargs`);\r\n            renderUsersList();\r\n            return;\r\n        }\r\n        \r\n        // Mode Firebase normal avec pagination\r\n        const filters = {};\r\n        if (currentFilters.role) {\r\n            filters.role = currentFilters.role;\r\n        }\r\n        \r\n        //  CORRECTION SECTION 7 : Pagination - Rinitialiser la pagination au chargement initial\r\n        paginationState.lastDoc = null;\r\n        paginationState.hasMore = false;\r\n        \r\n        const result = await getAllUsersPaginated(filters, paginationState.pageSize, null);\r\n        currentUsers = result.users;\r\n        paginationState.lastDoc = result.lastDoc;\r\n        paginationState.hasMore = result.hasMore;\r\n        \r\n        // Filtrer par statut actif/inactif ct client\r\n        if (currentFilters.status !== 'all') {\r\n            const oneWeekAgo = new Date();\r\n            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);\r\n            \r\n            currentUsers = currentUsers.filter(user => {\r\n                if (!user.lastLogin) return currentFilters.status === 'inactive';\r\n                \r\n                const lastLoginDate = user.lastLogin.toDate ? user.lastLogin.toDate() : new Date(user.lastLogin);\r\n                const isActive = lastLoginDate > oneWeekAgo;\r\n                \r\n                return currentFilters.status === 'active' ? isActive : !isActive;\r\n            });\r\n        }\r\n        \r\n        console.log(`Utilisateurs charges: ${currentUsers.length}`);\r\n        renderUsersList();\r\n        renderPaginationControls();\r\n    } catch (error) {\r\n        console.error('Erreur chargement utilisateurs:', error);\r\n        const container = document.getElementById('users-list');\r\n        if (container) {\r\n            //  CORRECTION SECTION 4 : Protection XSS - chapper le message d'erreur\r\n            const safeErrorMessage = escapeHtml(error.message);\r\n            container.innerHTML = `\r\n                <div class=\"text-center py-12 text-red-500\">\r\n                    <svg class=\"w-16 h-16 mx-auto mb-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                    <p class=\"text-lg font-medium\">Erreur lors du chargement</p>\r\n                    <p class=\"text-sm\">${safeErrorMessage}</p>\r\n                </div>\r\n            `;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Afficher la liste des utilisateurs\r\n */\r\nfunction renderUsersList() {\r\n    const container = document.getElementById('users-list');\r\n    if (!container) return;\r\n    \r\n    if (currentUsers.length === 0) {\r\n        container.innerHTML = `\r\n            <div class=\"text-center py-12 text-slate-500\">\r\n                <svg class=\"w-16 h-16 mx-auto mb-4 opacity-50\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\"></path>\r\n                </svg>\r\n                <p class=\"text-lg font-medium\">Aucun utilisateur trouve</p>\r\n            </div>\r\n        `;\r\n        return;\r\n    }\r\n    \r\n    container.innerHTML = currentUsers.map(user => renderUserCard(user)).join('');\r\n    \r\n    // Ajouter les event listeners\r\n    addUserActionListeners();\r\n}\r\n\r\n/**\r\n *  CORRECTION SECTION 7 : Pagination - Charger plus d'utilisateurs\r\n */\r\nasync function loadMoreUsers() {\r\n    if (paginationState.isLoading || !paginationState.hasMore) {\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        paginationState.isLoading = true;\r\n        \r\n        const filters = {};\r\n        if (currentFilters.role) {\r\n            filters.role = currentFilters.role;\r\n        }\r\n        \r\n        const result = await getAllUsersPaginated(filters, paginationState.pageSize, paginationState.lastDoc);\r\n        \r\n        // Filtrer par statut actif/inactif ct client\r\n        let newUsers = result.users;\r\n        if (currentFilters.status !== 'all') {\r\n            const oneWeekAgo = new Date();\r\n            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);\r\n            \r\n            newUsers = newUsers.filter(user => {\r\n                if (!user.lastLogin) return currentFilters.status === 'inactive';\r\n                \r\n                const lastLoginDate = user.lastLogin.toDate ? user.lastLogin.toDate() : new Date(user.lastLogin);\r\n                const isActive = lastLoginDate > oneWeekAgo;\r\n                \r\n                return currentFilters.status === 'active' ? isActive : !isActive;\r\n            });\r\n        }\r\n        \r\n        // Ajouter les nouveaux utilisateurs  la liste existante\r\n        currentUsers = [...currentUsers, ...newUsers];\r\n        paginationState.lastDoc = result.lastDoc;\r\n        paginationState.hasMore = result.hasMore;\r\n        \r\n        renderUsersList();\r\n        renderPaginationControls();\r\n        \r\n        console.log(` ${newUsers.length} utilisateurs supplmentaires chargs`);\r\n    } catch (error) {\r\n        console.error(' Erreur chargement utilisateurs supplmentaires:', error);\r\n        toast.error('Erreur lors du chargement des utilisateurs supplmentaires');\r\n    } finally {\r\n        paginationState.isLoading = false;\r\n    }\r\n}\r\n\r\n/**\r\n *  CORRECTION SECTION 7 : Pagination - Afficher les contrles de pagination\r\n */\r\nfunction renderPaginationControls() {\r\n    // Supprimer les contrles existants\r\n    const existingControls = document.getElementById('users-pagination-controls');\r\n    if (existingControls) {\r\n        existingControls.remove();\r\n    }\r\n    \r\n    // Si pas de pagination ncessaire, ne rien afficher\r\n    if (!paginationState.hasMore && currentUsers.length <= paginationState.pageSize) {\r\n        return;\r\n    }\r\n    \r\n    const container = document.getElementById('users-list');\r\n    if (!container) return;\r\n    \r\n    const paginationHTML = `\r\n        <div id=\"users-pagination-controls\" class=\"mt-6 flex justify-center items-center gap-4\">\r\n            ${paginationState.hasMore ? `\r\n                <button \r\n                    id=\"load-more-users-btn\" \r\n                    class=\"px-6 py-3 bg-ap-red-primary text-white rounded-lg hover:bg-ap-red-dark transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg transform hover:-translate-y-1\"\r\n                    ${paginationState.isLoading ? 'disabled' : ''}\r\n                >\r\n                    ${paginationState.isLoading ? `\r\n                        <svg class=\"animate-spin h-5 w-5 inline mr-2\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                            <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n                            <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n                        </svg>\r\n                        Chargement...\r\n                    ` : `\r\n                        <svg class=\"w-5 h-5 inline mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 4v16m8-8H4\"></path>\r\n                        </svg>\r\n                        Charger plus\r\n                    `}\r\n                </button>\r\n            ` : ''}\r\n            <span class=\"text-sm text-slate-600\">\r\n                ${currentUsers.length} utilisateur${currentUsers.length > 1 ? 's' : ''} affich${currentUsers.length > 1 ? 's' : ''}\r\n            </span>\r\n        </div>\r\n    `;\r\n    \r\n    container.insertAdjacentHTML('beforeend', paginationHTML);\r\n    \r\n    // Ajouter l'event listener pour le bouton \"Charger plus\"\r\n    const loadMoreBtn = document.getElementById('load-more-users-btn');\r\n    if (loadMoreBtn) {\r\n        loadMoreBtn.addEventListener('click', loadMoreUsers);\r\n    }\r\n}\r\n\r\n/**\r\n * Rendu d'une carte utilisateur\r\n */\r\nfunction renderUserCard(user) {\r\n    const isAdmin = user.role === 'admin';\r\n    const roleColor = isAdmin ? 'yellow' : 'blue';\r\n    const roleIcon = isAdmin ? '' : '';\r\n    \r\n    const lastLogin = user.lastLogin ? \r\n        (user.lastLogin.toDate ? user.lastLogin.toDate() : new Date(user.lastLogin)) : \r\n        null;\r\n    \r\n    const createdAt = user.createdAt ? \r\n        (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt)) : \r\n        null;\r\n    \r\n    const isActive = lastLogin && (new Date() - lastLogin) < (7 * 24 * 60 * 60 * 1000);\r\n    \r\n    const lastLoginText = lastLogin ? formatRelativeTime(lastLogin) : 'Jamais connecte';\r\n    \r\n    //  CORRECTION SECTION 4 : Protection XSS - chapper toutes les donnes utilisateur\r\n    const safeDisplayName = escapeHtml(user.displayName || 'Sans nom');\r\n    const safeEmail = escapeHtml(user.email || '');\r\n    const safeAvatarAlt = escapeHtml(user.displayName || 'User');\r\n    const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=667eea&color=fff&size=128`;\r\n    \r\n    return `\r\n        <div class=\"user-card bg-white rounded-xl shadow-md p-6 mb-4 hover:shadow-lg transition-shadow\" data-user-id=\"${user.uid}\">\r\n            <div class=\"flex items-start gap-4\">\r\n                <img src=\"${avatarUrl}\" alt=\"${safeAvatarAlt}\" class=\"w-16 h-16 rounded-full object-cover flex-shrink-0\" onerror=\"this.src='https://ui-avatars.com/api/?name=U&background=667eea&color=fff&size=128'\">\r\n                \r\n                <div class=\"flex-1 min-w-0\">\r\n                    <div class=\"flex items-center justify-between mb-2\">\r\n                        <div>\r\n                            <h4 class=\"text-lg font-bold text-slate-900 truncate\">${safeDisplayName}</h4>\r\n                            <p class=\"text-sm text-slate-600 truncate\">${safeEmail}</p>\r\n                        </div>\r\n                        <div class=\"flex gap-2 flex-shrink-0 ml-4\">\r\n                            <button class=\"edit-user-btn text-ap-red-primary hover:text-ap-red-dark p-2 rounded hover:bg-ap-red-50 transition\" data-user-id=\"${user.uid}\" data-user-email=\"${user.email}\" data-user-role=\"${user.role || 'user'}\" title=\"Modifier\">\r\n                                <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\"></path>\r\n                                </svg>\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"flex items-center gap-3 mb-3\">\r\n                        <span class=\"inline-flex items-center gap-1 bg-${roleColor}-100 text-${roleColor}-700 text-xs font-semibold px-3 py-1 rounded-full\">\r\n                            ${roleIcon} ${isAdmin ? 'Admin' : 'User'}\r\n                        </span>\r\n                        <span class=\"inline-flex items-center gap-1 ${isActive ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'} text-xs px-3 py-1 rounded-full\">\r\n                            <span class=\"w-2 h-2 rounded-full ${isActive ? 'bg-green-500' : 'bg-slate-400'}\"></span>\r\n                            ${isActive ? 'Actif' : 'Inactif'}\r\n                        </span>\r\n                    </div>\r\n                    \r\n                    <div class=\"grid grid-cols-2 gap-4 text-sm mb-3\">\r\n                        <div>\r\n                            <p class=\"text-slate-500\">Inscrit le:</p>\r\n                            <p class=\"font-medium text-slate-900\">${createdAt ? createdAt.toLocaleDateString('fr-FR') : 'N/A'}</p>\r\n                        </div>\r\n                        <div>\r\n                            <p class=\"text-slate-500\">Derniere connexion:</p>\r\n                            <p class=\"font-medium text-slate-900\">${lastLoginText}</p>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    ${!isAdmin ? renderUserStats(user) : ''}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Rendu des statistiques utilisateur\r\n */\r\nfunction renderUserStats(user) {\r\n    const totalQuizzes = user.totalQuizzes || 0;\r\n    const averageScore = user.averageScore || 0;\r\n    const currentStreak = user.currentStreak || 0;\r\n    \r\n    return `\r\n        <div class=\"mt-4 pt-4 border-t border-slate-200 grid grid-cols-3 gap-4 text-center\">\r\n            <div>\r\n                <p class=\"text-2xl font-bold text-ap-red-primary\">${averageScore}%</p>\r\n                <p class=\"text-xs text-slate-600\">Score moyen</p>\r\n            </div>\r\n            <div>\r\n                <p class=\"text-2xl font-bold text-ap-accent\">${totalQuizzes}</p>\r\n                <p class=\"text-xs text-slate-600\">Quiz completes</p>\r\n            </div>\r\n            <div>\r\n                <p class=\"text-2xl font-bold text-orange-600\"> ${currentStreak}</p>\r\n                <p class=\"text-xs text-slate-600\">Serie active</p>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Ajouter les event listeners\r\n */\r\nfunction addUserActionListeners() {\r\n    document.querySelectorAll('.edit-user-btn').forEach(btn => {\r\n        btn.addEventListener('click', (e) => {\r\n            const userId = e.currentTarget.dataset.userId;\r\n            const userEmail = e.currentTarget.dataset.userEmail;\r\n            const userRole = e.currentTarget.dataset.userRole;\r\n            openEditRoleModal(userId, userEmail, userRole);\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Ouvrir le modal d'dition du rle\r\n */\r\nfunction openEditRoleModal(userId, userEmail, currentRole) {\r\n    // Crer le modal\r\n    const modal = document.createElement('div');\r\n    modal.id = 'edit-role-modal';\r\n    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';\r\n    modal.innerHTML = `\r\n        <div class=\"bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-fade-in\">\r\n            <div class=\"flex items-center justify-between mb-6\">\r\n                <h3 class=\"text-2xl font-bold text-slate-900\">Modifier le role</h3>\r\n                <button id=\"close-modal-btn\" class=\"text-slate-400 hover:text-slate-600\">\r\n                    <svg class=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                    </svg>\r\n                </button>\r\n            </div>\r\n            \r\n            <div class=\"mb-6\">\r\n                <p class=\"text-slate-600 mb-1\">Utilisateur:</p>\r\n                <p class=\"font-semibold text-slate-900\">${escapeHtml(userEmail || '')}</p>\r\n            </div>\r\n            \r\n            <div class=\"mb-6\">\r\n                <p class=\"text-slate-700 font-medium mb-3\">Role actuel: <span class=\"text-ap-red-primary\">${currentRole === 'admin' ? 'Admin' : 'User'}</span></p>\r\n                \r\n                <p class=\"text-sm font-semibold text-slate-700 mb-2\">Modifier le role:</p>\r\n                <div class=\"space-y-3\">\r\n                    <label class=\"flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:border-ap-red-primary transition ${currentRole !== 'admin' ? 'border-ap-red-primary bg-ap-red-50' : 'border-slate-200'}\">\r\n                        <input type=\"radio\" name=\"role\" value=\"user\" ${currentRole !== 'admin' ? 'checked' : ''} class=\"mt-1\">\r\n                        <div>\r\n                            <p class=\"font-semibold text-slate-900\"> User (Utilisateur standard)</p>\r\n                            <p class=\"text-sm text-slate-600\">Acces uniquement au tableau de bord et aux quiz</p>\r\n                        </div>\r\n                    </label>\r\n                    \r\n                    <label class=\"flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:border-ap-red-primary transition ${currentRole === 'admin' ? 'border-ap-red-primary bg-ap-red-50' : 'border-slate-200'}\">\r\n                        <input type=\"radio\" name=\"role\" value=\"admin\" ${currentRole === 'admin' ? 'checked' : ''} class=\"mt-1\">\r\n                        <div>\r\n                            <p class=\"font-semibold text-slate-900\"> Admin (Administrateur)</p>\r\n                            <p class=\"text-sm text-slate-600\">Acces total: gestion questions et utilisateurs</p>\r\n                        </div>\r\n                    </label>\r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"bg-amber-50 border-l-4 border-amber-500 p-4 mb-6\">\r\n                <p class=\"text-sm text-amber-900\">\r\n                    <strong>Attention:</strong> En passant User  Admin, cette personne aura acces a toutes les fonctions d administration.\r\n                </p>\r\n            </div>\r\n            \r\n            <div class=\"flex gap-3\">\r\n                <button id=\"cancel-role-btn\" class=\"flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition\">\r\n                    Annuler\r\n                </button>\r\n                <button id=\"save-role-btn\" class=\"flex-1 bg-ap-red-primary hover:bg-ap-red-dark text-white font-semibold py-3 px-6 rounded-lg transition\">\r\n                    Enregistrer\r\n                </button>\r\n            </div>\r\n        </div>\r\n    `;\r\n    \r\n    document.body.appendChild(modal);\r\n    \r\n    // Event listeners\r\n    document.getElementById('close-modal-btn')?.addEventListener('click', () => modal.remove());\r\n    document.getElementById('cancel-role-btn')?.addEventListener('click', () => modal.remove());\r\n    document.getElementById('save-role-btn')?.addEventListener('click', async () => {\r\n        const newRole = modal.querySelector('input[name=\"role\"]:checked')?.value;\r\n        if (newRole) {\r\n            await handleUpdateRole(userId, userEmail, newRole);\r\n            modal.remove();\r\n        }\r\n    });\r\n    \r\n    // Fermer en cliquant sur le backdrop\r\n    modal.addEventListener('click', (e) => {\r\n        if (e.target === modal) modal.remove();\r\n    });\r\n}\r\n\r\n/**\r\n * Grer la mise  jour du rle\r\n */\r\nasync function handleUpdateRole(userId, userEmail, newRole) {\r\n    const saveBtn = document.getElementById('save-role-btn');\r\n    if (!saveBtn) return;\r\n    \r\n    const originalText = saveBtn.innerHTML;\r\n    const loadingToast = toast.showLoadingToast('Mise  jour du rle...');\r\n    \r\n    try {\r\n        saveBtn.disabled = true;\r\n        saveBtn.innerHTML = '<svg class=\"animate-spin h-5 w-5 inline\" fill=\"none\" viewBox=\"0 0 24 24\"><circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle></svg> Mise a jour...';\r\n        \r\n        await updateUserRole(userId, newRole);\r\n        \r\n        toast.updateLoadingToast(loadingToast, `Rle mis  jour pour ${userEmail}`, 'success');\r\n        showSuccess(`Role mis a jour pour ${userEmail}: ${newRole === 'admin' ? 'Admin' : 'User'}`);\r\n        \r\n        await loadUsers();\r\n        await loadStats();\r\n    } catch (error) {\r\n        console.error('Erreur mise a jour role:', error);\r\n        toast.updateLoadingToast(loadingToast, 'Erreur de mise  jour', 'error');\r\n        toast.error(`Erreur: ${error.message || 'Impossible de mettre a jour le role'}`, 4000);\r\n        saveBtn.disabled = false;\r\n        saveBtn.innerHTML = originalText;\r\n    }\r\n}\r\n\r\n/**\r\n * Grer le changement de filtres\r\n */\r\nasync function handleFilterChange(e) {\r\n    const filterName = e.target.id.replace('filter-user-', '').replace('-', '');\r\n    currentFilters[filterName] = e.target.value;\r\n    await loadUsers();\r\n}\r\n\r\n/**\r\n * Grer la recherche\r\n */\r\nfunction handleSearch(e) {\r\n    const searchTerm = e.target.value.toLowerCase();\r\n    \r\n    if (!searchTerm) {\r\n        renderUsersList();\r\n        return;\r\n    }\r\n    \r\n    const filtered = currentUsers.filter(u => \r\n        (u.displayName && u.displayName.toLowerCase().includes(searchTerm)) ||\r\n        (u.email && u.email.toLowerCase().includes(searchTerm))\r\n    );\r\n    \r\n    const container = document.getElementById('users-list');\r\n    if (!container) return;\r\n    \r\n    if (filtered.length === 0) {\r\n        //  CORRECTION SECTION 4 : Protection XSS - chapper le terme de recherche\r\n        const safeSearchTerm = escapeHtml(searchTerm);\r\n        container.innerHTML = `\r\n            <div class=\"text-center py-12 text-slate-500\">\r\n                <p class=\"text-lg\">Aucun resultat pour \"${safeSearchTerm}\"</p>\r\n            </div>\r\n        `;\r\n        return;\r\n    }\r\n    \r\n    // Afficher temporairement les rsultats filtrs\r\n    const temp = currentUsers;\r\n    currentUsers = filtered;\r\n    renderUsersList();\r\n    currentUsers = temp;\r\n}\r\n\r\n/**\r\n * Charger les statistiques\r\n */\r\nasync function loadStats() {\r\n    try {\r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            console.log(' Mode dmo : Chargement des stats utilisateurs simules...');\r\n            renderStats(MOCK_STATS);\r\n            return;\r\n        }\r\n        \r\n        // Mode Firebase normal\r\n        const stats = await getUsersStats();\r\n        renderStats(stats);\r\n    } catch (error) {\r\n        console.error('Erreur chargement stats:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Afficher les statistiques\r\n */\r\nfunction renderStats(stats) {\r\n    const container = document.getElementById('users-stats');\r\n    if (!container) return;\r\n    \r\n    const activePercentage = stats.total > 0 ? Math.round((stats.activeLastWeek / stats.total) * 100) : 0;\r\n    \r\n    container.innerHTML = `\r\n        <div class=\"bg-white rounded-xl shadow-md p-6\">\r\n            <h3 class=\"text-xl font-bold text-slate-900 mb-6\"> Statistiques Globales</h3>\r\n            \r\n            <div class=\"grid grid-cols-2 gap-4 mb-6\">\r\n                <div class=\"text-center p-4 bg-ap-red-50 rounded-lg\">\r\n                    <p class=\"text-3xl font-bold text-ap-red-primary mb-1\">${stats.total}</p>\r\n                    <p class=\"text-sm text-ap-red-dark font-medium\">Utilisateurs</p>\r\n                </div>\r\n                <div class=\"text-center p-4 bg-yellow-50 rounded-lg\">\r\n                    <p class=\"text-3xl font-bold text-yellow-600 mb-1\">${stats.admins}</p>\r\n                    <p class=\"text-sm text-yellow-700 font-medium\">Admins</p>\r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"space-y-4\">\r\n                <div>\r\n                    <div class=\"flex justify-between text-sm mb-2\">\r\n                        <span class=\"text-slate-700\">Actifs (7 derniers jours)</span>\r\n                        <span class=\"font-semibold\">${stats.activeLastWeek} (${activePercentage}%)</span>\r\n                    </div>\r\n                    <div class=\"bg-slate-200 rounded-full h-2\">\r\n                        <div class=\"bg-green-500 rounded-full h-2 transition-all\" style=\"width: ${activePercentage}%\"></div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"pt-4 border-t border-slate-200\">\r\n                    <p class=\"text-sm text-slate-600 mb-1\">Score moyen global:</p>\r\n                    <p class=\"text-2xl font-bold text-ap-red-primary\">${stats.averageScore}%</p>\r\n                </div>\r\n                \r\n                <div>\r\n                    <p class=\"text-sm text-slate-600 mb-1\">Total quiz completes:</p>\r\n                    <p class=\"text-2xl font-bold text-ap-accent\">${stats.totalQuizzes}</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Afficher un loader\r\n */\r\nfunction showLoading(containerId) {\r\n    const container = document.getElementById(containerId);\r\n    if (!container) return;\r\n    \r\n    container.innerHTML = `\r\n        <div class=\"text-center py-12\">\r\n            <svg class=\"animate-spin h-12 w-12 mx-auto text-ap-red-primary\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n                <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n            </svg>\r\n            <p class=\"text-slate-600 mt-4\">Chargement...</p>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Afficher une erreur\r\n */\r\nfunction showError(containerId, message) {\r\n    const container = document.getElementById(containerId);\r\n    if (!container) {\r\n        alert(`Erreur: ${message}`);\r\n        return;\r\n    }\r\n    \r\n    //  CORRECTION SECTION 4 : Protection XSS - chapper le message d'erreur\r\n    const safeMessage = escapeHtml(message);\r\n    container.innerHTML = `\r\n        <div class=\"bg-red-50 border-2 border-red-500 rounded-xl p-6 text-center\">\r\n            <svg class=\"w-12 h-12 mx-auto text-red-500 mb-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n            </svg>\r\n            <p class=\"text-red-900 font-semibold\">${safeMessage}</p>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Afficher un message de succs\r\n */\r\nfunction showSuccess(message) {\r\n    const toast = document.createElement('div');\r\n    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 animate-fade-in';\r\n        //  CORRECTION SECTION 4 : Protection XSS - chapper le message\r\n        const safeMessage = escapeHtml(message);\r\n        toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3\">\r\n            <svg class=\"w-6 h-6\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clip-rule=\"evenodd\"></path>\r\n            </svg>\r\n            <span class=\"font-semibold\">${safeMessage}</span>\r\n        </div>\r\n    `;\r\n    \r\n    document.body.appendChild(toast);\r\n    \r\n    setTimeout(() => {\r\n        toast.remove();\r\n    }, 3000);\r\n}\r\n\r\n/**\r\n * Formater le temps relatif\r\n */\r\nfunction formatRelativeTime(date) {\r\n    const now = new Date();\r\n    const diff = now - date;\r\n    const minutes = Math.floor(diff / 60000);\r\n    const hours = Math.floor(diff / 3600000);\r\n    const days = Math.floor(diff / 86400000);\r\n    \r\n    if (minutes < 1) return 'A l instant';\r\n    if (minutes < 60) return `Il y a ${minutes} min`;\r\n    if (hours < 24) return `Il y a ${hours}h`;\r\n    if (days === 1) return 'Hier';\r\n    if (days < 7) return `Il y a ${days} jours`;\r\n    if (days < 30) return `Il y a ${Math.floor(days / 7)} semaines`;\r\n    return date.toLocaleDateString('fr-FR');\r\n}\r\n\r\n//  CORRECTION SECTION 4 : Fonction escapeHtml() supprime - Utiliser celle de security.js\r\n","// Dashboard Admin Avanc - Statistiques globales et analytics\r\nimport { db, functions } from './firebase-config.js';\r\nimport { collection, query, getDocs, where, orderBy, limit, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';\r\nimport { toast } from './toast.js';\r\nimport { logger } from './logger.js';\r\nimport { isDemoMode } from './auth.js';\r\n// Import des fonctions de scurit (Section 4 - Scurit)\r\nimport { escapeHtml } from './security.js';\r\n//  CORRECTION SECTION 5 : StateManager - Centralisation des variables globales\r\nimport { stateManager } from './state-manager.js';\r\n//  P0 CRITIQUE: Import pour validation stricte du clientId\r\nimport { getCurrentClientId } from './client-manager.js';\r\nimport {\r\n    createStatsSkeleton,\r\n    createChartSkeleton,\r\n    createListSkeleton,\r\n    showSkeleton,\r\n    hideSkeleton\r\n} from './skeleton.js';\r\n\r\n//  Donnes simules pour le mode dmo\r\nconst MOCK_DATA = {\r\n    stats: {\r\n        totalUsers: 42,\r\n        totalQuizzes: 156,\r\n        totalQuestions: 240,\r\n        totalResources: 35,\r\n        avgScore: 78,\r\n        activeUsersToday: 8,\r\n        activeUsersWeek: 23,\r\n        quizzesToday: 12,\r\n        quizzesWeek: 67\r\n    },\r\n    topUsers: [\r\n        { id: '1', email: 'alice.dupont@example.com', displayName: 'Alice Dupont', totalQuizzes: 24, averageScore: 92 },\r\n        { id: '2', email: 'bob.martin@example.com', displayName: 'Bob Martin', totalQuizzes: 21, averageScore: 88 },\r\n        { id: '3', email: 'claire.bernard@example.com', displayName: 'Claire Bernard', totalQuizzes: 19, averageScore: 85 },\r\n        { id: '4', email: 'david.dubois@example.com', displayName: 'David Dubois', totalQuizzes: 18, averageScore: 83 },\r\n        { id: '5', email: 'emma.petit@example.com', displayName: 'Emma Petit', totalQuizzes: 16, averageScore: 81 },\r\n        { id: '6', email: 'francois.roux@example.com', displayName: 'Franois Roux', totalQuizzes: 15, averageScore: 79 },\r\n        { id: '7', email: 'julie.moreau@example.com', displayName: 'Julie Moreau', totalQuizzes: 14, averageScore: 76 },\r\n        { id: '8', email: 'lucas.simon@example.com', displayName: 'Lucas Simon', totalQuizzes: 13, averageScore: 74 },\r\n        { id: '9', email: 'marie.laurent@example.com', displayName: 'Marie Laurent', totalQuizzes: 12, averageScore: 72 },\r\n        { id: '10', email: 'nicolas.michel@example.com', displayName: 'Nicolas Michel', totalQuizzes: 11, averageScore: 70 }\r\n    ],\r\n    recentActivity: [\r\n        { id: '1', userName: 'Alice Dupont', module: 'Auto - Novembre', score: 95, completedAt: new Date(Date.now() - 300000) },\r\n        { id: '2', userName: 'Emma Petit', module: 'Loisir - Novembre', score: 90, completedAt: new Date(Date.now() - 720000) },\r\n        { id: '3', userName: 'Bob Martin', module: 'VR - Novembre', score: 88, completedAt: new Date(Date.now() - 1380000) },\r\n        { id: '4', userName: 'Claire Bernard', module: 'Auto - Octobre', score: 82, completedAt: new Date(Date.now() - 2700000) },\r\n        { id: '5', userName: 'David Dubois', module: 'Tracteur - Octobre', score: 79, completedAt: new Date(Date.now() - 3600000) }\r\n    ],\r\n    moduleStats: [\r\n        { module: 'Auto', questionsCount: 85, avgScore: 76, completions: 67 },\r\n        { module: 'Loisir', questionsCount: 62, avgScore: 81, completions: 45 },\r\n        { module: 'VR', questionsCount: 54, avgScore: 73, completions: 32 },\r\n        { module: 'Tracteur', questionsCount: 39, avgScore: 79, completions: 28 }\r\n    ]\r\n};\r\n\r\n//  CORRECTION SECTION 5 : StateManager - Migrer globalStats et chartProgress/Modules/Activity vers StateManager\r\n// Initialiser globalStats dans StateManager\r\nstateManager.set('globalStats', {\r\n    totalUsers: 0,\r\n    totalQuizzes: 0,\r\n    totalQuestions: 0,\r\n    totalResources: 0,\r\n    avgScore: 0,\r\n    activeUsersToday: 0,\r\n    activeUsersWeek: 0,\r\n    quizzesToday: 0,\r\n    quizzesWeek: 0\r\n});\r\n\r\n// Initialiser les graphiques dans StateManager\r\nstateManager.set('chartProgress', null);\r\nstateManager.set('chartModules', null);\r\nstateManager.set('chartActivity', null);\r\n\r\n/**\r\n * Initialiser le dashboard admin\r\n */\r\nexport async function initAdminDashboard() {\r\n    logger.info(' Initialisation du dashboard admin avanc');\r\n    \r\n    // Afficher loading\r\n    showLoadingState();\r\n    \r\n    try {\r\n        // Charger toutes les statistiques\r\n        await Promise.all([\r\n            loadGlobalStats(),\r\n            loadTopUsers(),\r\n            loadRecentActivity(),\r\n            loadModuleStats()\r\n        ]);\r\n        \r\n        // Crer les graphiques\r\n        createCharts();\r\n        \r\n        // Initialiser les event listeners\r\n        initEventListeners();\r\n        \r\n        hideLoadingState();\r\n        toast.success('Dashboard charg avec succs !', 3000);\r\n        \r\n    } catch (error) {\r\n    logger.error(' Erreur chargement dashboard:', error);\r\n        hideLoadingState();\r\n        toast.error('Erreur lors du chargement du dashboard', 4000);\r\n    }\r\n}\r\n\r\n/**\r\n * Charger les statistiques globales\r\n *  P1-2: Utilise Cloud Function si disponible, sinon fallback sur code client\r\n */\r\nasync function loadGlobalStats() {\r\n    try {\r\n        //  CORRECTION SECTION 5 : StateManager - Utiliser StateManager pour globalStats\r\n        let globalStats = stateManager.get('globalStats');\r\n        \r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            logger.info(' Mode dmo : Chargement des statistiques simules...');\r\n            globalStats = MOCK_DATA.stats;\r\n            stateManager.set('globalStats', globalStats);\r\n            renderGlobalStats();\r\n            logger.info(' Statistiques simules charges:', globalStats);\r\n            return;\r\n        }\r\n        \r\n        logger.info(' Chargement des statistiques globales...');\r\n        \r\n        //  P0 CRITIQUE: Rcuprer le clientId pour isolation multi-tenant\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        //  P1-2: Essayer d'utiliser la Cloud Function en premier\r\n        try {\r\n            const getGlobalStatsFunction = httpsCallable(functions, 'getGlobalStats');\r\n            const result = await getGlobalStatsFunction({ clientId });\r\n            \r\n            if (result.data && result.data.success) {\r\n                logger.info(' Statistiques charges via Cloud Function');\r\n                globalStats = result.data.stats;\r\n                stateManager.set('globalStats', globalStats);\r\n                renderGlobalStats();\r\n                return;\r\n            }\r\n        } catch (cloudFunctionError) {\r\n            // Si la Cloud Function n'est pas disponible ou choue, utiliser le fallback\r\n            logger.warn(' Cloud Function non disponible, utilisation du fallback:', cloudFunctionError.message);\r\n        }\r\n        \r\n        //  FALLBACK: Utiliser le code client existant si Cloud Function non disponible\r\n        //  P1 OPTIMISATION: Utiliser les services existants qui optimisent dj les requtes\r\n        const { getUsersStats } = await import('./firestore-service.js');\r\n        const { getQuestionsStats } = await import('./firestore-service.js');\r\n        \r\n        //  P1 OPTIMISATION: Utiliser getUsersStats() qui calcule dj les stats utilisateurs efficacement\r\n        const usersStats = await getUsersStats();\r\n        globalStats.totalUsers = usersStats.total || 0;\r\n        globalStats.activeUsersToday = usersStats.activeLastWeek || 0; // Approximation (sera amlior avec Cloud Function)\r\n        globalStats.activeUsersWeek = usersStats.activeLastWeek || 0;\r\n        \r\n        //  P1 OPTIMISATION: Utiliser les stats agrges des utilisateurs pour totalQuizzes et avgScore\r\n        globalStats.totalQuizzes = usersStats.totalQuizzes || 0;\r\n        globalStats.avgScore = usersStats.averageScore || 0;\r\n        \r\n        //  P1 OPTIMISATION: Utiliser getQuestionsStats() pour les questions\r\n        const questionsStats = await getQuestionsStats();\r\n        globalStats.totalQuestions = questionsStats.total || 0;\r\n        \r\n        // Compter les ressources (filtres par clientId) - Limiter  1000 pour viter les cots\r\n        const resourcesQuery = query(\r\n            collection(db, 'resources'), \r\n            where('clientId', '==', clientId),\r\n            limit(1000) //  P1 OPTIMISATION: Limiter pour viter les cots excessifs\r\n        );\r\n        const resourcesSnapshot = await getDocs(resourcesQuery);\r\n        globalStats.totalResources = resourcesSnapshot.size;\r\n        \r\n        //  P1 OPTIMISATION: Calculer les quiz aujourd'hui/semaine avec requte limite (30 derniers jours)\r\n        const today = new Date();\r\n        today.setHours(0, 0, 0, 0);\r\n        const thirtyDaysAgo = new Date();\r\n        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n        \r\n        const recentQuizzesQuery = query(\r\n            collection(db, 'quizResults'),\r\n            where('clientId', '==', clientId),\r\n            where('completedAt', '>=', Timestamp.fromDate(thirtyDaysAgo)),\r\n            orderBy('completedAt', 'desc'),\r\n            limit(1000) //  P1 OPTIMISATION: Limiter  1000 rsultats rcents\r\n        );\r\n        const recentQuizzesSnapshot = await getDocs(recentQuizzesQuery);\r\n        \r\n        // Calculer les quiz aujourd'hui et cette semaine depuis les rsultats rcents uniquement\r\n        const weekAgo = new Date();\r\n        weekAgo.setDate(weekAgo.getDate() - 7);\r\n        \r\n        let quizzesToday = 0;\r\n        let quizzesWeek = 0;\r\n        recentQuizzesSnapshot.forEach(doc => {\r\n            const completedAt = doc.data().completedAt?.toDate();\r\n            if (completedAt) {\r\n                if (completedAt >= today) {\r\n                    quizzesToday++;\r\n                }\r\n                if (completedAt >= weekAgo) {\r\n                    quizzesWeek++;\r\n                }\r\n            }\r\n        });\r\n        globalStats.quizzesToday = quizzesToday;\r\n        globalStats.quizzesWeek = quizzesWeek;\r\n        \r\n        //  CORRECTION SECTION 5 : StateManager - Sauvegarder globalStats dans StateManager\r\n        stateManager.set('globalStats', globalStats);\r\n        \r\n        // Afficher les statistiques\r\n        renderGlobalStats();\r\n        \r\n        logger.info(' Statistiques globales charges (fallback):', globalStats);\r\n        \r\n    } catch (error) {\r\n        logger.error(' Erreur chargement stats globales:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Charger le top 10 des utilisateurs\r\n */\r\nasync function loadTopUsers() {\r\n    try {\r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            logger.info(' Mode dmo : Chargement du top 10 simul...');\r\n            renderTopUsers(MOCK_DATA.topUsers);\r\n            logger.info(' Top 10 simul charg');\r\n            return;\r\n        }\r\n        \r\n    logger.info(' Chargement du top 10 utilisateurs...');\r\n        \r\n        //  P1 OPTIMISATION: Utiliser getLeaderboard() qui filtre dj par clientId et utilise les stats agrges\r\n        const { getLeaderboard } = await import('./firestore-service.js');\r\n        const topUsers = await getLeaderboard(10);\r\n        \r\n        // Transformer le format pour compatibilit avec renderTopUsers()\r\n        const formattedTopUsers = topUsers.map((user, index) => ({\r\n            id: user.uid || `user-${index}`,\r\n            email: user.email || '',\r\n            displayName: user.displayName || 'Utilisateur',\r\n            totalQuizzes: user.totalQuizzes || 0,\r\n            averageScore: user.averageScore || 0\r\n        }));\r\n        \r\n        // Afficher le top 10\r\n        renderTopUsers(formattedTopUsers);\r\n        \r\n    logger.info(' Top 10 utilisateurs charg:', topUsers);\r\n        \r\n    } catch (error) {\r\n    logger.error(' Erreur chargement top users:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Charger l'activit rcente\r\n */\r\nasync function loadRecentActivity() {\r\n    try {\r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            logger.info(' Mode dmo : Chargement de l\\'activit simule...');\r\n            renderRecentActivity(MOCK_DATA.recentActivity);\r\n            logger.info(' Activit simule charge');\r\n            return;\r\n        }\r\n        \r\n    logger.info(' Chargement de l\\'activit rcente...');\r\n        \r\n        // Rcuprer les 10 derniers quiz complts\r\n        const q = query(\r\n            collection(db, 'quizResults'),\r\n            orderBy('completedAt', 'desc'),\r\n            limit(10)\r\n        );\r\n        \r\n        const snapshot = await getDocs(q);\r\n        const activities = [];\r\n        \r\n        snapshot.forEach(doc => {\r\n            const data = doc.data();\r\n            activities.push({\r\n                id: doc.id,\r\n                userName: data.userName || 'Utilisateur',\r\n                module: data.module || 'Module',\r\n                score: data.score || 0,\r\n                completedAt: data.completedAt?.toDate() || new Date()\r\n            });\r\n        });\r\n        \r\n        // Afficher l'activit\r\n        renderRecentActivity(activities);\r\n        \r\n    logger.info(' Activit rcente charge:', activities);\r\n        \r\n    } catch (error) {\r\n    logger.error(' Erreur chargement activit:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Charger les statistiques par module\r\n *  P1-2: Utilise Cloud Function si disponible, sinon fallback sur code client\r\n */\r\nasync function loadModuleStats() {\r\n    try {\r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            logger.info(' Mode dmo : Chargement des stats modules simules...');\r\n            // Transformer les donnes mockes au format attendu\r\n            const mockStats = {\r\n                'Auto': { count: 85, totalScore: 6460, avgScore: 76 },\r\n                'Loisir': { count: 62, totalScore: 5022, avgScore: 81 },\r\n                'VR': { count: 54, totalScore: 3942, avgScore: 73 },\r\n                'Tracteur': { count: 39, totalScore: 3081, avgScore: 79 }\r\n            };\r\n            logger.info(' Stats modules simules charges:', mockStats);\r\n            return mockStats;\r\n        }\r\n        \r\n        logger.info(' Chargement des stats par module...');\r\n        \r\n        //  P0 CRITIQUE: Filtrer par clientId\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        //  P1-2: Essayer d'utiliser la Cloud Function en premier\r\n        try {\r\n            const getModuleStatsFunction = httpsCallable(functions, 'getModuleStats');\r\n            const result = await getModuleStatsFunction({ clientId });\r\n            \r\n            if (result.data && result.data.success) {\r\n                logger.info(' Stats par module charges via Cloud Function');\r\n                return result.data.moduleStats;\r\n            }\r\n        } catch (cloudFunctionError) {\r\n            // Si la Cloud Function n'est pas disponible ou choue, utiliser le fallback\r\n            logger.warn(' Cloud Function non disponible, utilisation du fallback:', cloudFunctionError.message);\r\n        }\r\n        \r\n        //  FALLBACK: Utiliser le code client existant si Cloud Function non disponible\r\n        const resultsQuery = query(collection(db, 'quizResults'), where('clientId', '==', clientId));\r\n        const resultsSnapshot = await getDocs(resultsQuery);\r\n        const moduleStats = {};\r\n        \r\n        resultsSnapshot.forEach(doc => {\r\n            const data = doc.data();\r\n            const module = data.module || 'Autre';\r\n            \r\n            if (!moduleStats[module]) {\r\n                moduleStats[module] = {\r\n                    count: 0,\r\n                    totalScore: 0,\r\n                    avgScore: 0\r\n                };\r\n            }\r\n            \r\n            moduleStats[module].count++;\r\n            moduleStats[module].totalScore += data.score || 0;\r\n        });\r\n        \r\n        // Calculer les moyennes\r\n        Object.values(moduleStats).forEach(stat => {\r\n            stat.avgScore = Math.round(stat.totalScore / stat.count);\r\n        });\r\n        \r\n        logger.info(' Stats par module charges (fallback):', moduleStats);\r\n        return moduleStats;\r\n        \r\n    } catch (error) {\r\n        logger.error(' Erreur chargement stats modules:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Afficher les statistiques globales\r\n */\r\nfunction renderGlobalStats() {\r\n    const container = document.getElementById('global-stats-cards');\r\n    if (!container) return;\r\n    \r\n    //  CORRECTION SECTION 5 : StateManager - Utiliser StateManager pour globalStats\r\n    const globalStats = stateManager.get('globalStats');\r\n    \r\n    container.innerHTML = `\r\n        <!-- Total Utilisateurs -->\r\n        <div class=\"bg-ap-gradient-primary rounded-xl p-6 text-white shadow-ap-lg hover:shadow-ap-xl transition-all\">\r\n            <div class=\"flex items-center justify-between mb-4\">\r\n                <div class=\"bg-white/20 p-3 rounded-lg backdrop-blur-sm\">\r\n                    <svg class=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\"></path>\r\n                    </svg>\r\n                </div>\r\n                <span class=\"text-sm font-semibold bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm\">Total</span>\r\n            </div>\r\n            <h3 class=\"text-4xl font-black mb-1\">${escapeHtml(String(globalStats.totalUsers))}</h3>\r\n            <p class=\"text-white/90 text-sm font-medium\">Utilisateurs inscrits</p>\r\n            <div class=\"mt-3 text-xs flex gap-2\">\r\n                <span class=\"bg-white/20 px-2 py-1 rounded backdrop-blur-sm\"> ${globalStats.activeUsersToday} aujourd'hui</span>\r\n                <span class=\"bg-white/20 px-2 py-1 rounded backdrop-blur-sm\"> ${globalStats.activeUsersWeek} cette semaine</span>\r\n            </div>\r\n        </div>\r\n        \r\n        <!-- Total Quiz -->\r\n        <div class=\"bg-ap-gradient-success rounded-xl p-6 text-white shadow-lg hover:shadow-xl transition-all\">\r\n            <div class=\"flex items-center justify-between mb-4\">\r\n                <div class=\"bg-white/20 p-3 rounded-lg backdrop-blur-sm\">\r\n                    <svg class=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n                    </svg>\r\n                </div>\r\n                <span class=\"text-sm font-semibold bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm\">Complts</span>\r\n            </div>\r\n            <h3 class=\"text-4xl font-black mb-1\">${globalStats.totalQuizzes}</h3>\r\n            <p class=\"text-white/90 text-sm font-medium\">Quiz raliss</p>\r\n            <div class=\"mt-3 text-xs flex gap-2\">\r\n                <span class=\"bg-white/20 px-2 py-1 rounded backdrop-blur-sm\"> ${globalStats.quizzesToday} aujourd'hui</span>\r\n                <span class=\"bg-white/20 px-2 py-1 rounded backdrop-blur-sm\"> ${globalStats.quizzesWeek} cette semaine</span>\r\n            </div>\r\n        </div>\r\n        \r\n        <!-- Score Moyen -->\r\n        <div class=\"bg-ap-gradient-silver rounded-xl p-6 text-white shadow-ap-silver-lg hover:shadow-ap-silver transition-all\" style=\"background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);\">\r\n            <div class=\"flex items-center justify-between mb-4\">\r\n                <div class=\"bg-white/20 p-3 rounded-lg backdrop-blur-sm\">\r\n                    <svg class=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\"></path>\r\n                    </svg>\r\n                </div>\r\n                <span class=\"text-sm font-semibold bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm\">Moyenne</span>\r\n            </div>\r\n            <h3 class=\"text-4xl font-black mb-1\">${globalStats.avgScore}%</h3>\r\n            <p class=\"text-white/90 text-sm font-medium\">Score moyen global</p>\r\n            <div class=\"mt-3\">\r\n                <div class=\"bg-white/20 rounded-full h-2.5\">\r\n                    <div class=\"bg-white rounded-full h-2.5 shadow-lg\" style=\"width: ${globalStats.avgScore}%\"></div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <!-- Total Questions -->\r\n        <div class=\"bg-ap-gradient-accent rounded-xl p-6 text-white shadow-ap-accent-lg hover:shadow-ap-accent transition-all\" style=\"background: linear-gradient(135deg, #718096 0%, #4A5568 100%);\">\r\n            <div class=\"flex items-center justify-between mb-4\">\r\n                <div class=\"bg-white/20 p-3 rounded-lg backdrop-blur-sm\">\r\n                    <svg class=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                </div>\r\n                <span class=\"text-sm font-semibold bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm\">Base</span>\r\n            </div>\r\n            <h3 class=\"text-4xl font-black mb-1\">${globalStats.totalQuestions}</h3>\r\n            <p class=\"text-white/90 text-sm font-medium\">Questions disponibles</p>\r\n            <div class=\"mt-3 text-xs\">\r\n                <span class=\"bg-white/20 px-2 py-1 rounded backdrop-blur-sm\"> ${globalStats.totalResources} ressources</span>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Afficher le top 10 utilisateurs\r\n */\r\nfunction renderTopUsers(users) {\r\n    const container = document.getElementById('top-users-list');\r\n    if (!container) return;\r\n    \r\n    if (users.length === 0) {\r\n        const empty = document.createElement('div');\r\n        empty.className = 'text-center py-8 text-slate-500';\r\n        empty.innerHTML = `\r\n            <svg class=\"w-12 h-12 mx-auto mb-2 text-slate-300\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\"></path>\r\n            </svg>\r\n            <p class=\"font-medium\">Aucun utilisateur</p>\r\n        `;\r\n        container.replaceChildren(empty);\r\n        return;\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    users.forEach((user, index) => {\r\n        const medal = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `${index + 1}.`;\r\n        const bgColor = index === 0 ? 'bg-ap-gold-light border-ap-gold' :\r\n            index === 1 ? 'bg-slate-50 border-slate-300' :\r\n            index === 2 ? 'bg-ap-warning-light border-ap-warning' :\r\n            'bg-white border-slate-200';\r\n    const rawUserName = user.userName || user.displayName || user.email || 'Utilisateur';\r\n    const userName = escapeHtml(rawUserName);\r\n        const totalQuizzes = Number.isFinite(user.totalQuizzes) ? user.totalQuizzes : 0;\r\n        const avgScore = Number.isFinite(user.avgScore) ? user.avgScore : 0;\r\n\r\n    const card = document.createElement('article');\r\n        card.className = `flex items-center justify-between p-4 rounded-lg border ${bgColor} hover:shadow-md transition-shadow`;\r\n        card.innerHTML = `\r\n            <div class=\"flex items-center gap-4\">\r\n                <span class=\"text-2xl font-bold w-8\">${escapeHtml(medal)}</span>\r\n                <div>\r\n                    <h4 class=\"font-semibold text-slate-900\">${userName}</h4>\r\n                    <p class=\"text-sm text-slate-600\">${escapeHtml(`${totalQuizzes} quiz complts`)}</p>\r\n                </div>\r\n            </div>\r\n            <div class=\"text-right\">\r\n                <div class=\"text-2xl font-bold text-ap-success\">${escapeHtml(`${avgScore}%`)}</div>\r\n                <div class=\"text-xs text-slate-500\">Score moyen</div>\r\n            </div>\r\n        `;\r\n        fragment.appendChild(card);\r\n    });\r\n\r\n    container.replaceChildren(fragment);\r\n}\r\n\r\n/**\r\n * Afficher l'activit rcente\r\n */\r\nfunction renderRecentActivity(activities) {\r\n    const container = document.getElementById('recent-activity-list');\r\n    if (!container) return;\r\n    \r\n    if (activities.length === 0) {\r\n        const empty = document.createElement('div');\r\n        empty.className = 'text-center py-8 text-slate-500';\r\n        empty.innerHTML = `\r\n            <svg class=\"w-12 h-12 mx-auto mb-2 text-slate-300\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n            </svg>\r\n            <p class=\"font-medium\">Aucune activit rcente</p>\r\n        `;\r\n        container.replaceChildren(empty);\r\n        return;\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    activities.forEach(activity => {\r\n    const rawTimeAgo = getTimeAgo(activity.completedAt);\r\n    const timeAgo = escapeHtml(rawTimeAgo);\r\n        const scoreColor = activity.score >= 80 ? 'text-green-600' :\r\n            activity.score >= 60 ? 'text-yellow-600' :\r\n            'text-red-600';\r\n    const rawUserName = activity.userName || 'Utilisateur';\r\n    const userName = escapeHtml(rawUserName);\r\n    const moduleName = escapeHtml(activity.module || 'Module');\r\n        const scoreDisplay = escapeHtml(`${Number.isFinite(activity.score) ? activity.score : 0}%`);\r\n    const avatarInitial = escapeHtml(rawUserName.charAt(0).toUpperCase());\r\n\r\n        const row = document.createElement('article');\r\n        row.className = 'flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg transition-colors';\r\n        row.innerHTML = `\r\n            <div class=\"flex items-center gap-3\">\r\n                <div class=\"w-10 h-10 bg-ap-red-100 rounded-full flex items-center justify-center\">\r\n                    <span class=\"text-lg font-bold text-ap-red-primary\">${avatarInitial}</span>\r\n                </div>\r\n                <div>\r\n                    <p class=\"font-medium text-slate-900\">${userName}</p>\r\n                    <p class=\"text-sm text-slate-600\">${moduleName}</p>\r\n                </div>\r\n            </div>\r\n            <div class=\"text-right\">\r\n                <div class=\"text-lg font-bold ${scoreColor}\">${scoreDisplay}</div>\r\n                <div class=\"text-xs text-slate-500\">${timeAgo}</div>\r\n            </div>\r\n        `;\r\n        fragment.appendChild(row);\r\n    });\r\n\r\n    container.replaceChildren(fragment);\r\n}\r\n\r\n/**\r\n * Crer les graphiques Chart.js\r\n */\r\nfunction createCharts() {\r\n    // Graphique de progression (Line Chart)\r\n    createProgressChart();\r\n    \r\n    // Graphique par modules (Doughnut Chart)\r\n    createModulesChart();\r\n    \r\n    // Graphique d'activit (Bar Chart)\r\n    createActivityChart();\r\n}\r\n\r\n/**\r\n * Crer le graphique de progression\r\n */\r\nasync function createProgressChart() {\r\n    const canvas = document.getElementById('chart-progress');\r\n    if (!canvas) return;\r\n    \r\n    try {\r\n        let labels, counts, avgScores;\r\n        \r\n        //  Mode dmo : Utiliser donnes simules\r\n        if (isDemoMode()) {\r\n            logger.info(' Mode dmo : Cration graphique progression simul...');\r\n            \r\n            // Gnrer 30 jours de donnes mockes\r\n            labels = [];\r\n            counts = [];\r\n            avgScores = [];\r\n            \r\n            for (let i = 29; i >= 0; i--) {\r\n                const date = new Date();\r\n                date.setDate(date.getDate() - i);\r\n                labels.push(date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }));\r\n                \r\n                // Donnes alatoires mais cohrentes\r\n                counts.push(Math.floor(Math.random() * 15) + 5);\r\n                avgScores.push(Math.floor(Math.random() * 20) + 70);\r\n            }\r\n        } else {\r\n            // Mode Firebase normal\r\n            // Rcuprer les quiz des 30 derniers jours\r\n            const thirtyDaysAgo = new Date();\r\n            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n            \r\n            //  P0 CRITIQUE: Filtrer par clientId\r\n            const clientId = await getCurrentClientId();\r\n            const resultsQuery = query(collection(db, 'quizResults'), where('clientId', '==', clientId));\r\n            const resultsSnapshot = await getDocs(resultsQuery);\r\n            const dailyData = {};\r\n            \r\n            // Initialiser les 30 derniers jours\r\n            for (let i = 0; i < 30; i++) {\r\n                const date = new Date();\r\n                date.setDate(date.getDate() - i);\r\n                const dateStr = date.toISOString().split('T')[0];\r\n                dailyData[dateStr] = { count: 0, totalScore: 0 };\r\n            }\r\n            \r\n            // Compter les quiz par jour\r\n            resultsSnapshot.forEach(doc => {\r\n                const data = doc.data();\r\n                const completedAt = data.completedAt?.toDate();\r\n                if (completedAt && completedAt >= thirtyDaysAgo) {\r\n                    const dateStr = completedAt.toISOString().split('T')[0];\r\n                    if (dailyData[dateStr]) {\r\n                        dailyData[dateStr].count++;\r\n                        dailyData[dateStr].totalScore += data.score || 0;\r\n                    }\r\n                }\r\n            });\r\n            \r\n            // Prparer les donnes pour le graphique\r\n            labels = Object.keys(dailyData).reverse().map(date => {\r\n                const d = new Date(date);\r\n                return d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });\r\n            });\r\n            \r\n            counts = Object.values(dailyData).reverse().map(d => d.count);\r\n            avgScores = Object.values(dailyData).reverse().map(d => \r\n                d.count > 0 ? Math.round(d.totalScore / d.count) : 0\r\n            );\r\n        }\r\n        \r\n        // Crer le graphique\r\n        //  CORRECTION SECTION 5 : StateManager - Utiliser StateManager pour chartProgress\r\n        const existingChart = stateManager.get('chartProgress');\r\n        if (existingChart) existingChart.destroy();\r\n        \r\n        const chartProgress = new Chart(canvas, {\r\n            type: 'line',\r\n            data: {\r\n                labels: labels,\r\n                datasets: [\r\n                    {\r\n                        label: 'Quiz complts',\r\n                        data: counts,\r\n                        borderColor: 'rgb(196, 30, 58)',          // Rouge Avantage Plus\r\n                        backgroundColor: 'rgba(196, 30, 58, 0.1)',\r\n                        tension: 0.4,\r\n                        yAxisID: 'y',\r\n                        pointBackgroundColor: 'rgb(196, 30, 58)',\r\n                        pointBorderColor: '#fff',\r\n                        pointBorderWidth: 2\r\n                    },\r\n                    {\r\n                        label: 'Score moyen (%)',\r\n                        data: avgScores,\r\n                        borderColor: 'rgb(212, 175, 55)',        // Dor Avantage Plus\r\n                        backgroundColor: 'rgba(212, 175, 55, 0.1)',\r\n                        tension: 0.4,\r\n                        yAxisID: 'y1',\r\n                        pointBackgroundColor: 'rgb(212, 175, 55)',\r\n                        pointBorderColor: '#fff',\r\n                        pointBorderWidth: 2\r\n                    }\r\n                ]\r\n            },\r\n            options: {\r\n                responsive: true,\r\n                maintainAspectRatio: false,\r\n                interaction: {\r\n                    mode: 'index',\r\n                    intersect: false\r\n                },\r\n                scales: {\r\n                    y: {\r\n                        type: 'linear',\r\n                        display: true,\r\n                        position: 'left',\r\n                        title: {\r\n                            display: true,\r\n                            text: 'Nombre de quiz'\r\n                        }\r\n                    },\r\n                    y1: {\r\n                        type: 'linear',\r\n                        display: true,\r\n                        position: 'right',\r\n                        title: {\r\n                            display: true,\r\n                            text: 'Score moyen (%)'\r\n                        },\r\n                        grid: {\r\n                            drawOnChartArea: false\r\n                        }\r\n                    }\r\n                },\r\n                plugins: {\r\n                    legend: {\r\n                        position: 'top'\r\n                    },\r\n                    title: {\r\n                        display: true,\r\n                        text: 'volution sur 30 jours'\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        \r\n        //  CORRECTION SECTION 5 : StateManager - Sauvegarder chartProgress dans StateManager\r\n        stateManager.set('chartProgress', chartProgress);\r\n        \r\n    } catch (error) {\r\n    logger.error(' Erreur cration graphique progression:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Crer le graphique par modules\r\n */\r\nasync function createModulesChart() {\r\n    const canvas = document.getElementById('chart-modules');\r\n    if (!canvas) return;\r\n    \r\n    try {\r\n        const moduleStats = await loadModuleStats();\r\n        \r\n        const labels = Object.keys(moduleStats);\r\n        const data = Object.values(moduleStats).map(s => s.count);\r\n        \r\n        const colors = [\r\n            'rgba(196, 30, 58, 0.9)',     // Rouge Avantage Plus\r\n            'rgba(212, 175, 55, 0.9)',    // Dor Avantage Plus\r\n            'rgba(40, 167, 69, 0.9)',     // Vert succs\r\n            'rgba(255, 159, 67, 0.9)',    // Orange pche\r\n            'rgba(139, 20, 41, 0.9)'      // Rouge fonc AP\r\n        ];\r\n        \r\n        //  CORRECTION SECTION 5 : StateManager - Utiliser StateManager pour chartModules\r\n        const existingChartModules = stateManager.get('chartModules');\r\n        if (existingChartModules) existingChartModules.destroy();\r\n        \r\n        const chartModules = new Chart(canvas, {\r\n            type: 'doughnut',\r\n            data: {\r\n                labels: labels,\r\n                datasets: [{\r\n                    data: data,\r\n                    backgroundColor: colors,\r\n                    borderWidth: 2,\r\n                    borderColor: '#fff'\r\n                }]\r\n            },\r\n            options: {\r\n                responsive: true,\r\n                maintainAspectRatio: false,\r\n                plugins: {\r\n                    legend: {\r\n                        position: 'bottom'\r\n                    },\r\n                    title: {\r\n                        display: true,\r\n                        text: 'Rpartition par module'\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        \r\n        //  CORRECTION SECTION 5 : StateManager - Sauvegarder chartModules dans StateManager\r\n        stateManager.set('chartModules', chartModules);\r\n        \r\n    } catch (error) {\r\n    logger.error(' Erreur cration graphique modules:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Crer le graphique d'activit\r\n */\r\nasync function createActivityChart() {\r\n    const canvas = document.getElementById('chart-activity');\r\n    if (!canvas) return;\r\n    \r\n    try {\r\n        // Activit des 7 derniers jours\r\n        const labels = [];\r\n        const data = [];\r\n        \r\n        for (let i = 6; i >= 0; i--) {\r\n            const date = new Date();\r\n            date.setDate(date.getDate() - i);\r\n            labels.push(date.toLocaleDateString('fr-FR', { weekday: 'short' }));\r\n            data.push(Math.floor(Math.random() * 20) + 5); // Donnes de dmo\r\n        }\r\n        \r\n        //  CORRECTION : Utiliser StateManager pour chartActivity\r\n        const existingChart = stateManager.get('chartActivity');\r\n        if (existingChart) existingChart.destroy();\r\n        \r\n        const chartActivity = new Chart(canvas, {\r\n            type: 'bar',\r\n            data: {\r\n                labels: labels,\r\n                datasets: [{\r\n                    label: 'Utilisateurs actifs',\r\n                    data: data,\r\n                    backgroundColor: 'rgba(196, 30, 58, 0.8)',  // Rouge Avantage Plus\r\n                    borderColor: 'rgb(196, 30, 58)',\r\n                    borderWidth: 2,\r\n                    borderRadius: 4,\r\n                    hoverBackgroundColor: 'rgba(196, 30, 58, 1)'\r\n                }]\r\n            },\r\n            options: {\r\n                responsive: true,\r\n                maintainAspectRatio: false,\r\n                plugins: {\r\n                    legend: {\r\n                        display: false\r\n                    },\r\n                    title: {\r\n                        display: true,\r\n                        text: 'Activit des 7 derniers jours'\r\n                    }\r\n                },\r\n                scales: {\r\n                    y: {\r\n                        beginAtZero: true,\r\n                        ticks: {\r\n                            stepSize: 5\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        \r\n        //  CORRECTION SECTION 5 : StateManager - Sauvegarder chartActivity dans StateManager\r\n        stateManager.set('chartActivity', chartActivity);\r\n        \r\n    } catch (error) {\r\n    logger.error(' Erreur cration graphique activit:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Exporter en PDF\r\n */\r\nexport async function exportToPDF() {\r\n    const loadingToast = toast.showLoadingToast('Gnration du PDF...');\r\n    \r\n    try {\r\n        // Importer jsPDF dynamiquement\r\n        const { jsPDF } = window.jspdf;\r\n        const doc = new jsPDF();\r\n        \r\n        // Titre\r\n        doc.setFontSize(20);\r\n        doc.text('Dashboard Admin - QuizPro', 20, 20);\r\n        \r\n        // Date\r\n        doc.setFontSize(10);\r\n        doc.text(`Gnr le ${new Date().toLocaleDateString('fr-FR')}`, 20, 30);\r\n        \r\n        // Statistiques globales\r\n        doc.setFontSize(14);\r\n        doc.text('Statistiques Globales', 20, 45);\r\n        \r\n        doc.setFontSize(10);\r\n        let y = 55;\r\n        doc.text(`Total Utilisateurs: ${globalStats.totalUsers}`, 25, y);\r\n        y += 7;\r\n        doc.text(`Total Quiz: ${globalStats.totalQuizzes}`, 25, y);\r\n        y += 7;\r\n        doc.text(`Score Moyen: ${globalStats.avgScore}%`, 25, y);\r\n        y += 7;\r\n        doc.text(`Questions: ${globalStats.totalQuestions}`, 25, y);\r\n        y += 7;\r\n        doc.text(`Ressources: ${globalStats.totalResources}`, 25, y);\r\n        \r\n        // Sauvegarder\r\n        doc.save(`dashboard-admin-${new Date().toISOString().split('T')[0]}.pdf`);\r\n        \r\n        toast.updateLoadingToast(loadingToast, 'PDF gnr avec succs !', 'success');\r\n        \r\n    } catch (error) {\r\n        logger.error(' Erreur export PDF:', error);\r\n        toast.updateLoadingToast(loadingToast, 'Erreur d\\'export PDF', 'error');\r\n        toast.error('Erreur: Assurez-vous que jsPDF est charg', 4000);\r\n    }\r\n}\r\n\r\n/**\r\n * Exporter en CSV avanc\r\n */\r\nexport async function exportToAdvancedCSV() {\r\n    const loadingToast = toast.showLoadingToast('Gnration du CSV...');\r\n    \r\n    try {\r\n        //  P0 CRITIQUE: Filtrer par clientId\r\n        const clientId = await getCurrentClientId();\r\n        const resultsQuery = query(collection(db, 'quizResults'), where('clientId', '==', clientId));\r\n        const resultsSnapshot = await getDocs(resultsQuery);\r\n        \r\n        const headers = ['Date', 'Utilisateur', 'Module', 'Mois', 'Anne', 'Score (%)', 'Bonnes rponses', 'Total questions', 'Temps (s)'];\r\n        const rows = [];\r\n        \r\n        resultsSnapshot.forEach(doc => {\r\n            const data = doc.data();\r\n            const date = data.completedAt?.toDate().toLocaleString('fr-FR') || 'N/A';\r\n            \r\n            rows.push([\r\n                date,\r\n                data.userName || 'Inconnu',\r\n                data.module || 'N/A',\r\n                data.month || 'N/A',\r\n                data.year || 'N/A',\r\n                data.score || 0,\r\n                data.correctAnswers || 0,\r\n                data.totalQuestions || 0,\r\n                data.timeSpent || 0\r\n            ]);\r\n        });\r\n        \r\n        const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');\r\n        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\r\n        const link = document.createElement('a');\r\n        link.href = URL.createObjectURL(blob);\r\n        link.download = `dashboard-complet-${new Date().toISOString().split('T')[0]}.csv`;\r\n        link.click();\r\n        \r\n        toast.updateLoadingToast(loadingToast, 'CSV gnr avec succs !', 'success');\r\n        \r\n    } catch (error) {\r\n        logger.error(' Erreur export CSV:', error);\r\n        toast.updateLoadingToast(loadingToast, 'Erreur d\\'export CSV', 'error');\r\n        toast.error('Erreur lors de l\\'export CSV', 4000);\r\n    }\r\n}\r\n\r\n/**\r\n * Initialiser les event listeners\r\n */\r\nfunction initEventListeners() {\r\n    // Boutons d'export\r\n    document.getElementById('export-pdf-btn')?.addEventListener('click', exportToPDF);\r\n    document.getElementById('export-csv-btn')?.addEventListener('click', exportToAdvancedCSV);\r\n    \r\n    // Filtres de priode ( implmenter)\r\n    document.getElementById('period-filter')?.addEventListener('change', handlePeriodChange);\r\n    \r\n    // Rafrachir\r\n    document.getElementById('refresh-dashboard-btn')?.addEventListener('click', () => {\r\n        toast.info('Actualisation du dashboard...', 2000);\r\n        initAdminDashboard();\r\n    });\r\n}\r\n\r\n/**\r\n * Grer le changement de priode\r\n */\r\nasync function handlePeriodChange(e) {\r\n    const period = e.target.value;\r\n    toast.info(`Filtrage: ${period}`, 2000);\r\n    // TODO: Filtrer les donnes selon la priode\r\n}\r\n\r\n//  CORRECTION SECTION 4 : Fonction escapeHtml() supprime - Utiliser celle de security.js\r\n\r\n/**\r\n * Afficher l'tat de chargement\r\n */\r\nfunction showLoadingState() {\r\n    // Skeletons pour les stats\r\n    const statsContainer = document.getElementById('global-stats-cards');\r\n    if (statsContainer) {\r\n        showSkeleton('global-stats-cards', createStatsSkeleton(4));\r\n    }\r\n    \r\n    // Skeletons pour les top users\r\n    const topUsersContainer = document.getElementById('top-users-list');\r\n    if (topUsersContainer) {\r\n        showSkeleton('top-users-list', createListSkeleton(10));\r\n    }\r\n    \r\n    // Skeletons pour l'activit rcente\r\n    const activityContainer = document.getElementById('recent-activity-list');\r\n    if (activityContainer) {\r\n        showSkeleton('recent-activity-list', createListSkeleton(8));\r\n    }\r\n    \r\n    // Skeletons pour les graphiques\r\n    const progressChartContainer = document.getElementById('progress-chart');\r\n    if (progressChartContainer) {\r\n        progressChartContainer.innerHTML = createChartSkeleton();\r\n    }\r\n    \r\n    const modulesChartContainer = document.getElementById('modules-chart');\r\n    if (modulesChartContainer) {\r\n        modulesChartContainer.innerHTML = createChartSkeleton();\r\n    }\r\n    \r\n    const activityChartContainer = document.getElementById('activity-chart');\r\n    if (activityChartContainer) {\r\n        activityChartContainer.innerHTML = createChartSkeleton();\r\n    }\r\n}\r\n\r\n/**\r\n * Cacher l'tat de chargement\r\n */\r\nfunction hideLoadingState() {\r\n    // Les conteneurs sont mis  jour par les fonctions de rendu\r\n}\r\n\r\n/**\r\n * Temps relatif\r\n */\r\nfunction getTimeAgo(date) {\r\n    const now = new Date();\r\n    const diff = now - date;\r\n    const seconds = Math.floor(diff / 1000);\r\n    const minutes = Math.floor(seconds / 60);\r\n    const hours = Math.floor(minutes / 60);\r\n    const days = Math.floor(hours / 24);\r\n    \r\n    if (days > 0) return `Il y a ${days}j`;\r\n    if (hours > 0) return `Il y a ${hours}h`;\r\n    if (minutes > 0) return `Il y a ${minutes}min`;\r\n    return ' l\\'instant';\r\n}\r\n"],"file":"admin-BqW1z8Wp.js"}