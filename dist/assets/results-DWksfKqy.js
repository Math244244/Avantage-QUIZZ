import{t as re,g as le,v as b,n as X,w as y,x as p,y as de}from"./auth-8l3HJMhR.js";import{s as Z,c as ie,a as ce,b as me}from"./skeleton-bh2HAV7A.js";import{query as J,collection as K,where as _,orderBy as ee,getDocs as te}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";let h=[],c=[],E=1;const z=10;let Q=null,q=null;const S={auto:"AT-AVE-AVEX",loisir:"VTT, Motoneige, etc.",vr:"V√©hicules R√©cr√©atifs",tracteur:"√âquipement Agricole"},ue={auto:"#C41E3A",loisir:"#D4AF37",vr:"#FF9F43",tracteur:"#28A745"};document.addEventListener("DOMContentLoaded",async()=>{re(async t=>{if(!t){window.location.href="/index.html";return}pe(t);const n=await le(t.uid);n&&n.role==="admin"&&(document.getElementById("nav-admin-item")?.classList.remove("hidden"),document.getElementById("admin-badge-nav")?.classList.remove("hidden")),await ge(t.uid)}),document.getElementById("logout-btn")?.addEventListener("click",se),document.getElementById("signout-link")?.addEventListener("click",se),document.getElementById("filter-module")?.addEventListener("change",$),document.getElementById("filter-period")?.addEventListener("change",$),document.getElementById("filter-sort")?.addEventListener("change",$),document.getElementById("reset-filters-btn")?.addEventListener("click",Ce),document.getElementById("prev-page-btn")?.addEventListener("click",()=>ne(-1)),document.getElementById("next-page-btn")?.addEventListener("click",()=>ne(1)),document.getElementById("export-results-btn")?.addEventListener("click",we);const e=document.getElementById("results-list");e&&!e.dataset.eventsBound&&(e.addEventListener("click",be),e.dataset.eventsBound="true")});function pe(e){document.getElementById("user-name")&&(document.getElementById("user-name").textContent=e.displayName||e.email),document.getElementById("user-photo")&&(document.getElementById("user-photo").src=e.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.displayName||e.email)}`),document.getElementById("user-display-name")&&(document.getElementById("user-display-name").textContent=e.displayName||e.email),document.getElementById("user-avatar")&&(document.getElementById("user-avatar").src=e.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.displayName||e.email)}`)}async function ge(e){b.info("üì• Chargement des r√©sultats pour:",e);try{const t=document.getElementById("global-stats"),n=document.getElementById("results-list"),o=document.getElementById("progress-chart-container");t&&Z("global-stats",ie(4)),n&&Z("results-list",ce(5)),o&&(o.innerHTML=me());let s=J(K(X,"quizResults"),_("userId","==",e),ee("completedAt","desc")),a=await te(s);a.empty&&(s=J(K(X,"quizResults"),_("userId","==",e),ee("date","desc")),a=await te(s)),h=[],a.forEach(r=>{const d=r.data();let i=null;if(d.completedAt&&typeof d.completedAt.toDate=="function")i=d.completedAt.toDate();else if(d.date&&typeof d.date.toDate=="function")i=d.date.toDate();else if(d.date&&typeof d.date=="string"){const l=new Date(d.date);isNaN(l.getTime())||(i=l)}h.push({id:r.id,...d,completedAt:i})}),b.info(`‚úÖ ${h.length} r√©sultats charg√©s`),h.length===0?P():(c=[...h],oe())}catch(t){b.error("‚ùå Erreur lors du chargement des r√©sultats:",t),t.code==="permission-denied"?y.error("Permissions insuffisantes pour consulter vos r√©sultats. Contactez un administrateur."):y.error("Erreur lors du chargement des r√©sultats"),P()}}function oe(){if(c.length===0){document.getElementById("results-container")?.classList.add("hidden"),P();return}document.getElementById("no-results")?.classList.add("hidden"),fe(),he(),ae(),document.getElementById("results-loading")?.classList.add("hidden"),document.getElementById("results-container")?.classList.remove("hidden")}function fe(){const e=document.getElementById("global-stats"),t=c.length,n=t>0?Math.round(c.reduce((i,l)=>i+l.score,0)/t):0,o=c.reduce((i,l)=>i+l.totalQuestions,0),s=c.reduce((i,l)=>i+l.correctAnswers,0),a=c.reduce((i,l)=>i+(l.timeSpent||0),0),r=t>0?Math.round(a/t):0,d=p(U(r));e.innerHTML=`
        <div class="bg-white rounded-xl shadow-md p-6 fade-in hover:shadow-lg transition-all">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg bg-ap-red-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-ap-red-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Quiz compl√©t√©s</p>
                    <p class="text-3xl font-bold text-ap-red-primary">${t}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-md p-6 fade-in hover:shadow-lg transition-all">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg bg-ap-success-light flex items-center justify-center">
                    <svg class="w-6 h-6 text-ap-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Score moyen</p>
                    <p class="text-3xl font-bold text-ap-success">${n}%</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-md p-6 fade-in hover:shadow-lg transition-all">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg bg-ap-gold-light flex items-center justify-center">
                    <svg class="w-6 h-6 text-ap-gold-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Questions r√©pondues</p>
                    <p class="text-3xl font-bold text-ap-gold-dark">${s}/${o}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-md p-6 fade-in hover:shadow-lg transition-all">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg bg-ap-warning-light flex items-center justify-center">
                    <svg class="w-6 h-6 text-ap-warning-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Temps moyen</p>
                    <p class="text-3xl font-bold text-ap-warning-dark">${d}</p>
                </div>
            </div>
        </div>
    `}function he(){xe(),ve()}function xe(){const e=document.getElementById("progress-chart");if(!e)return;const t=[...c].reverse().slice(-10),n=t.map((s,a)=>{const r=s.completedAt;return r?`${r.getDate()}/${r.getMonth()+1}`:`Quiz ${a+1}`}),o=t.map(s=>s.score);Q&&Q.destroy(),Q=new Chart(e,{type:"line",data:{labels:n,datasets:[{label:"Score (%)",data:o,borderColor:"#C41E3A",backgroundColor:"rgba(196, 30, 58, 0.1)",tension:.4,fill:!0,pointRadius:5,pointHoverRadius:7,pointBackgroundColor:"#C41E3A",pointBorderColor:"#fff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,max:100,ticks:{callback:s=>s+"%"}}}}})}function ve(){const e=document.getElementById("module-chart");if(!e)return;const t={};c.forEach(a=>{t[a.module]=(t[a.module]||0)+1});const n=Object.keys(t).map(a=>S[a]||a),o=Object.values(t),s=Object.keys(t).map(a=>ue[a]||"#C41E3A");q&&q.destroy(),q=new Chart(e,{type:"doughnut",data:{labels:n,datasets:[{data:o,backgroundColor:s,borderWidth:2,borderColor:"#ffffff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}function ae(){const e=document.getElementById("results-list");if(!e)return;const t=(E-1)*z,n=t+z,o=c.slice(t,n);if(o.length===0){e.replaceChildren();return}const s=document.createDocumentFragment();o.forEach(a=>{s.appendChild(ye(a))}),e.replaceChildren(s),Ee()}function ye(e){const t=document.createElement("article");t.className="p-6 hover:bg-slate-50 transition-colors",t.dataset.resultId=e.id;const n=e.completedAt instanceof Date?e.completedAt:null,o=n?`${n.getDate().toString().padStart(2,"0")}/${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getFullYear()} √† ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`:"Date inconnue",s=e.score>=80?"text-green-600":e.score>=60?"text-yellow-600":"text-red-600",a=p(S[e.module]||e.module||"Module"),r=e.month?String(e.month).trim():"",d=e.year?String(e.year).trim():"",i=p([r,d].filter(Boolean).join(" ").trim()),l=Number.isFinite(e.score)?e.score:0,x=Number.isFinite(e.correctAnswers)?e.correctAnswers:0,C=Number.isFinite(e.totalQuestions)?e.totalQuestions:0,w=p(`${l}%`),B=p(`${x}/${C}`),f=p(U(e.timeSpent||0)),I=p(o);return t.innerHTML=`
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-lg font-bold text-slate-900">${a}</h3>
                    <span class="px-3 py-1 text-xs font-medium bg-slate-100 text-slate-600 rounded-full">
                        ${i}
                    </span>
                </div>
                <p class="text-sm text-slate-500">${I}</p>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-center">
                    <p class="text-sm text-slate-500 mb-1">Score</p>
                    <p class="${s} text-3xl font-bold">${w}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500 mb-1">R√©ponses</p>
                    <p class="text-slate-700 font-semibold">${B}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500 mb-1">Temps</p>
                    <p class="text-slate-700 font-semibold">${f}</p>
                </div>
                <button class="result-details-btn px-4 py-2 bg-ap-red-primary text-white rounded-lg hover:bg-ap-red-dark transition-all transform hover:-translate-y-0.5 font-medium shadow-sm hover:shadow-md" data-result-id="${e.id}">
                    D√©tails
                </button>
            </div>
        </div>
    `,t}function be(e){const t=e.target.closest(".result-details-btn");if(!t)return;const{resultId:n}=t.dataset;n&&Be(n)}function Ee(){const e=Math.ceil(c.length/z),t=document.getElementById("page-info");t&&(t.textContent=`Page ${E} sur ${e||1}`);const n=document.getElementById("prev-page-btn"),o=document.getElementById("next-page-btn");n&&(n.disabled=E===1),o&&(o.disabled=E===e||e===0)}function ne(e){E+=e,ae(),window.scrollTo({top:0,behavior:"smooth"})}function $(){const e=document.getElementById("filter-module").value,t=document.getElementById("filter-period").value,n=document.getElementById("filter-sort").value;if(c=e?h.filter(o=>o.module===e):[...h],t!=="all"){const o=new Date,s=new Date;t==="week"?s.setDate(o.getDate()-7):t==="month"?s.setDate(o.getDate()-30):t==="year"&&(s.setFullYear(o.getFullYear()),s.setMonth(0),s.setDate(1)),c=c.filter(a=>a.completedAt>=s)}c.sort((o,s)=>n==="date-desc"?s.completedAt-o.completedAt:n==="date-asc"?o.completedAt-s.completedAt:n==="score-desc"?s.score-o.score:n==="score-asc"?o.score-s.score:0),E=1,oe()}function Ce(){document.getElementById("filter-module").value="",document.getElementById("filter-period").value="all",document.getElementById("filter-sort").value="date-desc",$()}function we(){if(c.length===0){y.warning("Aucun r√©sultat √† exporter");return}const e=y.showLoadingToast("G√©n√©ration du fichier CSV...");try{const t=["Date","Module","Mois","Ann√©e","Score (%)","Bonnes r√©ponses","Total questions","Temps (s)"],n=c.map(r=>[r.completedAt?r.completedAt.toLocaleString("fr-FR"):"N/A",S[r.module]||r.module,r.month,r.year,r.score,r.correctAnswers,r.totalQuestions,r.timeSpent||0]),o=[t,...n].map(r=>r.join(",")).join(`
`),s=new Blob([o],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(s),a.download=`mes-resultats-${new Date().toISOString().split("T")[0]}.csv`,a.click(),y.updateLoadingToast(e,"Export CSV r√©ussi !","success"),b.info("‚úÖ Export CSV r√©ussi")}catch(t){y.updateLoadingToast(e,"Erreur d'export","error"),y.error("Erreur lors de l'export CSV",4e3),b.error("‚ùå Erreur export CSV:",t)}}function Be(e){const t=h.find(m=>m.id===e);if(!t)return;const n=p(S[t.module]||t.module||"Module"),o=p([t.month,t.year].filter(Boolean).join(" ")),s=Number.isFinite(t.score)?t.score:0,a=Number.isFinite(t.correctAnswers)?t.correctAnswers:0,r=Number.isFinite(t.totalQuestions)?t.totalQuestions:0,d=p(U(t.timeSpent||0)),i=Array.isArray(t.answers)?t.answers:[],l=document.createElement("div");l.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4";const x=document.createElement("div");x.className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto flex flex-col",l.appendChild(x);const C=document.createElement("div");C.className="px-8 py-6 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white";const w=document.createElement("h2");w.className="text-2xl font-bold",w.textContent="D√©tails du quiz";const B=document.createElement("p");B.className="text-indigo-100 mt-1",B.textContent=o?`${n} - ${o}`:n,C.append(w,B),x.appendChild(C);const f=document.createElement("div");f.className="p-8",x.appendChild(f);const I=document.createElement("div");I.className="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8",f.appendChild(I);const D=(m,k,u="")=>{const L=document.createElement("div");L.className="text-center p-4 bg-slate-50 rounded-lg";const v=document.createElement("p");v.className="text-sm text-slate-500 mb-1",v.textContent=m;const g=document.createElement("p");return g.className=`text-3xl font-bold ${u}`.trim(),g.textContent=k,L.append(v,g),L};if(I.append(D("Score",`${s}%`,"text-indigo-600"),D("Bonnes r√©ponses",`${a}/${r}`,"text-slate-900"),D("Temps total",d,"text-slate-900")),i.length>0){const m=document.createElement("h3");m.className="text-xl font-bold text-slate-900 mb-4",m.textContent="R√©ponses d√©taill√©es",f.appendChild(m);const k=document.createElement("div");k.className="space-y-3 max-h-96 overflow-y-auto",f.appendChild(k),i.forEach((u,L)=>{const v=document.createElement("div");v.className=`p-4 rounded-lg border ${u.isCorrect?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`;const g=document.createElement("div");g.className="flex items-start gap-3",v.appendChild(g);const T=document.createElement("span");T.className="text-2xl",T.textContent=u.isCorrect?"‚úÖ":"‚ùå",g.appendChild(T);const N=document.createElement("div");N.className="flex-1",g.appendChild(N);const M=document.createElement("p");M.className="font-semibold text-slate-900 mb-1",M.textContent=`Question ${L+1}`,N.appendChild(M);const F=document.createElement("p");if(F.className="text-sm text-slate-700 mb-2",F.textContent=u.question||"Question indisponible",N.appendChild(F),!u.isCorrect){const V=document.createElement("div");V.className="text-xs text-slate-600 space-y-1";const O=document.createElement("p"),G=document.createElement("strong");G.textContent="Votre r√©ponse :",O.append(G,document.createTextNode(` ${u.selectedAnswer||"N/A"}`));const Y=document.createElement("p"),W=document.createElement("strong");W.textContent="Bonne r√©ponse :",Y.append(W,document.createTextNode(` ${u.correctAnswer||"N/A"}`)),V.append(O,Y),N.appendChild(V)}const j=document.createElement("span");j.className="text-sm text-slate-500",j.textContent=`${Number.isFinite(u.timeSpent)?u.timeSpent:0}s`,g.appendChild(j),k.appendChild(v)})}else{const m=document.createElement("p");m.className="text-slate-500 text-center py-8",m.textContent="D√©tails des r√©ponses non disponibles",f.appendChild(m)}const R=document.createElement("div");R.className="px-8 py-6 bg-slate-50 border-t border-gray-200 flex justify-end";const A=document.createElement("button");A.id="close-modal-btn",A.className="px-6 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors font-medium",A.textContent="Fermer",R.appendChild(A),x.appendChild(R),document.body.appendChild(l);const H=()=>{l.parentNode&&l.parentNode.removeChild(l)};A.addEventListener("click",H),l.addEventListener("click",m=>{m.target===l&&H()})}function P(){document.getElementById("results-loading")?.classList.add("hidden"),document.getElementById("no-results")?.classList.remove("hidden"),document.getElementById("results-container")?.classList.add("hidden")}function U(e){const t=Math.floor(e/60),n=e%60;return`${t}:${n.toString().padStart(2,"0")}`}async function se(){try{await de(),window.location.href="/"}catch(e){b.error("Erreur lors de la d√©connexion:",e)}}
//# sourceMappingURL=results-DWksfKqy.js.map
