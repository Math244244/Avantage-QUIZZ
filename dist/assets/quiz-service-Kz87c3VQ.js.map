{"version":3,"mappings":"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","names":["MONTH_NAMES","MONTH_NAMES_LOWERCASE","getCurrentMonthIndex","getCurrentMonthNumber","getCurrentYear","normalizeMonthFormat","month","year","monthName","monthLower","monthIndex","m","parts","monthPart","monthIdx","yearPart","createMonthlyProgressId","userId","normalizedMonth","extractYearFromMonth","COLLECTIONS","saveQuizResult","quizData","user","auth","score","clientId","getCurrentClientId","resultData","Timestamp","resultRef","safeFirestoreWrite","addDoc","collection","db","updateUserStats","__vitePreload","n","updateMonthlyProgress","invalidateCache","buildCacheKey","error","getUserQuizResults","uid","limitCount","cacheKey","cached","getCachedValue","q","query","where","orderBy","limit","querySnapshot","safeFirestoreRead","getDocs","results","doc","setCachedValue","progressId","progressRef","progressData","setDoc","getAnnualProgress","progress","data","dataYear"],"ignoreList":[],"sources":["../../js/month-utils.js","../../js/services/quiz-service.js"],"sourcesContent":["/**\r\n * Utilitaires pour la gestion des mois (Section 2 - Logique M√©tier)\r\n * \r\n * Ce module fournit des fonctions pour normaliser et g√©rer les formats de mois\r\n * afin d'√©viter les incoh√©rences entre dashboard et quiz.\r\n */\r\n\r\n/**\r\n * Noms des mois en fran√ßais (premi√®re lettre majuscule)\r\n */\r\nexport const MONTH_NAMES = [\r\n    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\r\n    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\r\n];\r\n\r\n/**\r\n * Noms des mois en minuscules (pour compatibilit√©)\r\n */\r\nexport const MONTH_NAMES_LOWERCASE = [\r\n    'janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',\r\n    'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'\r\n];\r\n\r\n/**\r\n * Obtient l'index du mois actuel (0-11)\r\n * @returns {number} Index du mois actuel (0 = Janvier, 11 = D√©cembre)\r\n */\r\nexport function getCurrentMonthIndex() {\r\n    const now = new Date();\r\n    return now.getMonth(); // 0-11\r\n}\r\n\r\n/**\r\n * Obtient le num√©ro du mois actuel (1-12)\r\n * @returns {number} Num√©ro du mois actuel (1 = Janvier, 12 = D√©cembre)\r\n */\r\nexport function getCurrentMonthNumber() {\r\n    return getCurrentMonthIndex() + 1;\r\n}\r\n\r\n/**\r\n * Obtient l'ann√©e actuelle\r\n * @returns {number} Ann√©e actuelle\r\n */\r\nexport function getCurrentYear() {\r\n    return new Date().getFullYear();\r\n}\r\n\r\n/**\r\n * Normalise le format d'un mois pour garantir la coh√©rence\r\n * \r\n * Format de sortie garanti : \"Novembre 2025\" (premi√®re lettre majuscule, espace, ann√©e)\r\n * \r\n * @param {string|number} month - Mois (texte ou num√©ro 1-12)\r\n * @param {number} year - Ann√©e (optionnel, utilise l'ann√©e actuelle par d√©faut)\r\n * @returns {string} Mois normalis√© au format \"Novembre 2025\"\r\n */\r\nexport function normalizeMonthFormat(month, year = getCurrentYear()) {\r\n    let monthName;\r\n    \r\n    // Si c'est un num√©ro (1-12)\r\n    if (typeof month === 'number') {\r\n        if (month < 1 || month > 12) {\r\n            throw new Error(`Num√©ro de mois invalide: ${month}. Doit √™tre entre 1 et 12.`);\r\n        }\r\n        monthName = MONTH_NAMES[month - 1];\r\n    }\r\n    // Si c'est une cha√Æne\r\n    else if (typeof month === 'string') {\r\n        // Normaliser la casse\r\n        const monthLower = month.toLowerCase().trim();\r\n        \r\n        // Chercher dans la liste des mois en minuscules\r\n        const monthIndex = MONTH_NAMES_LOWERCASE.findIndex(m => m === monthLower);\r\n        if (monthIndex !== -1) {\r\n            monthName = MONTH_NAMES[monthIndex];\r\n        } else {\r\n            // Essayer de parser un format comme \"novembre 2025\" ou \"Novembre 2025\"\r\n            const parts = month.split(' ');\r\n            if (parts.length >= 1) {\r\n                const monthPart = parts[0].toLowerCase();\r\n                const monthIdx = MONTH_NAMES_LOWERCASE.findIndex(m => m === monthPart);\r\n                if (monthIdx !== -1) {\r\n                    monthName = MONTH_NAMES[monthIdx];\r\n                    // Si l'ann√©e est dans la cha√Æne, l'utiliser\r\n                    if (parts.length >= 2) {\r\n                        const yearPart = parseInt(parts[1]);\r\n                        if (!isNaN(yearPart)) {\r\n                            year = yearPart;\r\n                        }\r\n                    }\r\n                } else {\r\n                    throw new Error(`Format de mois invalide: ${month}`);\r\n                }\r\n            } else {\r\n                throw new Error(`Format de mois invalide: ${month}`);\r\n            }\r\n        }\r\n    } else {\r\n        throw new Error(`Type de mois invalide: ${typeof month}`);\r\n    }\r\n    \r\n    return `${monthName} ${year}`;\r\n}\r\n\r\n/**\r\n * Cr√©e un ID de document Firestore pour monthlyProgress\r\n * Remplace les espaces par des underscores pour √©viter les probl√®mes\r\n * \r\n * @param {string} userId - ID de l'utilisateur\r\n * @param {string|number} month - Mois (texte ou num√©ro)\r\n * @param {number} year - Ann√©e (optionnel)\r\n * @returns {string} ID du document au format \"userId_Novembre_2025\"\r\n */\r\nexport function createMonthlyProgressId(userId, month, year = getCurrentYear()) {\r\n    const normalizedMonth = normalizeMonthFormat(month, year);\r\n    // Remplacer les espaces par des underscores pour l'ID Firestore\r\n    return `${userId}_${normalizedMonth.replace(/\\s+/g, '_')}`;\r\n}\r\n\r\n/**\r\n * Extrait l'ann√©e d'une cha√Æne de mois normalis√©e\r\n * \r\n * @param {string} normalizedMonth - Mois normalis√© au format \"Novembre 2025\"\r\n * @returns {number} Ann√©e extraite\r\n */\r\nexport function extractYearFromMonth(normalizedMonth) {\r\n    const parts = normalizedMonth.split(' ');\r\n    if (parts.length >= 2) {\r\n        const year = parseInt(parts[parts.length - 1]);\r\n        if (!isNaN(year)) {\r\n            return year;\r\n        }\r\n    }\r\n    return getCurrentYear();\r\n}\r\n\r\n/**\r\n * Valide qu'un format de mois est correct\r\n * \r\n * @param {string} month - Mois √† valider\r\n * @returns {boolean} True si le format est valide\r\n */\r\nexport function isValidMonthFormat(month) {\r\n    try {\r\n        normalizeMonthFormat(month);\r\n        return true;\r\n    } catch (e) {\r\n        return false;\r\n    }\r\n}\r\n\r\nexport default {\r\n    MONTH_NAMES,\r\n    MONTH_NAMES_LOWERCASE,\r\n    getCurrentMonthIndex,\r\n    getCurrentMonthNumber,\r\n    getCurrentYear,\r\n    normalizeMonthFormat,\r\n    createMonthlyProgressId,\r\n    extractYearFromMonth,\r\n    isValidMonthFormat\r\n};\r\n\r\n\r\n","/**\r\n * Service de Gestion des Quiz et R√©sultats\r\n * \r\n * ‚úÖ CORRECTION SECTION 5 : Refactorisation - Extraction des fonctions quiz\r\n */\r\n\r\nimport { db, auth } from '../firebase-config.js';\r\nimport { \r\n    collection, \r\n    doc, \r\n    getDocs, \r\n    addDoc,\r\n    setDoc,\r\n    query,\r\n    where,\r\n    orderBy,\r\n    limit,\r\n    startAfter,\r\n    Timestamp\r\n} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';\r\nimport { safeFirestoreRead, safeFirestoreWrite } from '../rate-limiter.js';\r\nimport { getCurrentClientId } from '../client-manager.js';\r\nimport { normalizeMonthFormat, createMonthlyProgressId, extractYearFromMonth } from '../month-utils.js';\r\nimport { buildCacheKey, getCachedValue, setCachedValue, invalidateCache } from './cache-service.js';\r\n\r\nconst COLLECTIONS = {\r\n    quizResults: 'quizResults',\r\n    monthlyProgress: 'monthlyProgress'\r\n};\r\n\r\n/**\r\n * Sauvegarder un r√©sultat de quiz\r\n */\r\nexport async function saveQuizResult(quizData) {\r\n    try {\r\n        const user = auth.currentUser;\r\n        if (!user) throw new Error('Utilisateur non connect√©');\r\n        \r\n        const score = quizData.score;\r\n        if (isNaN(score) || score < 0 || score > 100) {\r\n            throw new Error(`Score invalide: ${score}. Doit √™tre entre 0 et 100.`);\r\n        }\r\n        \r\n        if (!quizData.totalQuestions || quizData.totalQuestions <= 0) {\r\n            throw new Error(`Nombre total de questions invalide: ${quizData.totalQuestions}`);\r\n        }\r\n        if (quizData.correctAnswers < 0 || quizData.correctAnswers > quizData.totalQuestions) {\r\n            throw new Error(`Nombre de bonnes r√©ponses invalide: ${quizData.correctAnswers}`);\r\n        }\r\n        \r\n        const normalizedMonth = normalizeMonthFormat(quizData.month || new Date().getMonth() + 1, quizData.year || new Date().getFullYear());\r\n        const year = extractYearFromMonth(normalizedMonth);\r\n        \r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const resultData = {\r\n            userId: user.uid,\r\n            userEmail: user.email,\r\n            moduleId: quizData.moduleId,\r\n            moduleName: quizData.moduleName,\r\n            score: score,\r\n            correctAnswers: quizData.correctAnswers,\r\n            totalQuestions: quizData.totalQuestions,\r\n            timeElapsed: quizData.timeElapsed,\r\n            answers: quizData.answers,\r\n            date: Timestamp.now(),\r\n            completedAt: Timestamp.now(),\r\n            month: normalizedMonth,\r\n            year: year,\r\n            clientId: clientId\r\n        };\r\n        \r\n        const resultRef = await safeFirestoreWrite(() => \r\n            addDoc(collection(db, COLLECTIONS.quizResults), resultData)\r\n        );\r\n        console.log('‚úÖ R√©sultat de quiz sauvegard√©:', resultRef.id);\r\n        \r\n        // Import dynamique pour √©viter d√©pendance circulaire\r\n        const { updateUserStats } = await import('./user-service.js');\r\n        await updateUserStats(user.uid, quizData.score);\r\n        await updateMonthlyProgress(user.uid, quizData.month, quizData.score);\r\n\r\n        invalidateCache(buildCacheKey(['quizResults', user.uid]));\r\n        invalidateCache(buildCacheKey(['monthlyResults', user.uid]));\r\n        invalidateCache(buildCacheKey(['annualProgress', user.uid]));\r\n        invalidateCache('users');\r\n        invalidateCache('users-stats');\r\n        \r\n        return resultRef.id;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur sauvegarde r√©sultat:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√©rer tous les r√©sultats d'un utilisateur (sans pagination - pour compatibilit√©)\r\n */\r\nexport async function getUserQuizResults(uid, limitCount = 50) {\r\n    const cacheKey = buildCacheKey(['quizResults', uid, limitCount]);\r\n    const cached = getCachedValue(cacheKey);\r\n    if (cached) {\r\n        return cached;\r\n    }\r\n\r\n    try {\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const q = query(\r\n            collection(db, COLLECTIONS.quizResults),\r\n            where('userId', '==', uid),\r\n            where('clientId', '==', clientId),\r\n            orderBy('date', 'desc'),\r\n            limit(limitCount)\r\n        );\r\n        \r\n        const querySnapshot = await safeFirestoreRead(() => getDocs(q));\r\n        const results = [];\r\n        \r\n        querySnapshot.forEach((doc) => {\r\n            results.push({ id: doc.id, ...doc.data() });\r\n        });\r\n        \r\n        console.log(`üìä ${results.length} r√©sultats charg√©s`);\r\n        setCachedValue(cacheKey, results, 'quizResults');\r\n        return results;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration r√©sultats:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * ‚úÖ CORRECTION SECTION 7 : Pagination - R√©cup√©rer les r√©sultats d'un utilisateur avec pagination\r\n * @param {string} uid - ID de l'utilisateur\r\n * @param {number} pageSize - Nombre d'√©l√©ments par page (d√©faut: 20)\r\n * @param {QueryDocumentSnapshot|null} lastDoc - Document de d√©part pour la pagination\r\n * @returns {Promise<{results: Array, lastDoc: QueryDocumentSnapshot|null, hasMore: boolean}>}\r\n */\r\nexport async function getUserQuizResultsPaginated(uid, pageSize = 20, lastDoc = null) {\r\n    try {\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const constraints = [\r\n            where('userId', '==', uid),\r\n            where('clientId', '==', clientId),\r\n            orderBy('date', 'desc'),\r\n            limit(pageSize + 1) // +1 pour d√©tecter s'il y a plus de r√©sultats\r\n        ];\r\n        \r\n        let q = query(collection(db, COLLECTIONS.quizResults), ...constraints);\r\n        \r\n        // Si on a un document de d√©part, commencer apr√®s\r\n        if (lastDoc) {\r\n            q = query(q, startAfter(lastDoc));\r\n        }\r\n        \r\n        const querySnapshot = await safeFirestoreRead(() => getDocs(q));\r\n        const results = [];\r\n        let newLastDoc = null;\r\n        let hasMore = false;\r\n        \r\n        querySnapshot.forEach((doc, index) => {\r\n            if (index < pageSize) {\r\n                results.push({ id: doc.id, ...doc.data() });\r\n            } else {\r\n                hasMore = true;\r\n            }\r\n        });\r\n        \r\n        if (querySnapshot.docs.length > 0 && results.length === pageSize) {\r\n            newLastDoc = querySnapshot.docs[pageSize - 1];\r\n        }\r\n        \r\n        console.log(`üìä ${results.length} r√©sultats charg√©s (pagination)`);\r\n        return {\r\n            results,\r\n            lastDoc: newLastDoc,\r\n            hasMore\r\n        };\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration r√©sultats pagin√©s:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√©rer les r√©sultats d'un mois sp√©cifique\r\n */\r\nexport async function getMonthlyResults(uid, month) {\r\n    const cacheKey = buildCacheKey(['monthlyResults', uid, month]);\r\n    const cached = getCachedValue(cacheKey);\r\n    if (cached) {\r\n        return cached;\r\n    }\r\n\r\n    try {\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const q = query(\r\n            collection(db, COLLECTIONS.quizResults),\r\n            where('userId', '==', uid),\r\n            where('month', '==', month),\r\n            where('clientId', '==', clientId),\r\n            orderBy('date', 'desc')\r\n        );\r\n        \r\n        const querySnapshot = await safeFirestoreRead(() => getDocs(q));\r\n        const results = [];\r\n        \r\n        querySnapshot.forEach((doc) => {\r\n            results.push({ id: doc.id, ...doc.data() });\r\n        });\r\n        \r\n        setCachedValue(cacheKey, results, 'monthlyProgress');\r\n        return results;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration r√©sultats mensuels:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Mettre √† jour la progression mensuelle\r\n */\r\nexport async function updateMonthlyProgress(uid, month, score) {\r\n    try {\r\n        const normalizedMonth = normalizeMonthFormat(month);\r\n        const year = extractYearFromMonth(normalizedMonth);\r\n        \r\n        const progressId = createMonthlyProgressId(uid, normalizedMonth);\r\n        const progressRef = doc(db, COLLECTIONS.monthlyProgress, progressId);\r\n        \r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const progressData = {\r\n            userId: uid,\r\n            month: normalizedMonth,\r\n            year: year,\r\n            score: score,\r\n            completed: true,\r\n            completedAt: Timestamp.now(),\r\n            updatedAt: Timestamp.now(),\r\n            clientId: clientId\r\n        };\r\n        \r\n        await safeFirestoreWrite(() => setDoc(progressRef, progressData, { merge: true }));\r\n        console.log('‚úÖ Progression mensuelle mise √† jour');\r\n\r\n        invalidateCache(buildCacheKey(['monthlyResults', uid]));\r\n        invalidateCache(buildCacheKey(['annualProgress', uid, year]));\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur mise √† jour progression:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√©rer la progression annuelle\r\n */\r\nexport async function getAnnualProgress(uid, year = new Date().getFullYear()) {\r\n    const cacheKey = buildCacheKey(['annualProgress', uid, year]);\r\n    const cached = getCachedValue(cacheKey);\r\n    if (cached) {\r\n        return cached;\r\n    }\r\n\r\n    try {\r\n        const clientId = await getCurrentClientId();\r\n        \r\n        const q = query(\r\n            collection(db, COLLECTIONS.monthlyProgress),\r\n            where('userId', '==', uid),\r\n            where('clientId', '==', clientId)\r\n        );\r\n        \r\n        const querySnapshot = await safeFirestoreRead(() => getDocs(q));\r\n        const progress = {};\r\n        \r\n        querySnapshot.forEach((doc) => {\r\n            const data = doc.data();\r\n            const dataYear = data.year || extractYearFromMonth(data.month);\r\n            if (dataYear === year) {\r\n                const normalizedMonth = normalizeMonthFormat(data.month, dataYear);\r\n                progress[normalizedMonth] = {\r\n                    ...data,\r\n                    month: normalizedMonth,\r\n                    year: dataYear\r\n                };\r\n            }\r\n        });\r\n        \r\n        console.log('üìÖ Progression annuelle charg√©e');\r\n        setCachedValue(cacheKey, progress, 'annualProgress');\r\n        return progress;\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur r√©cup√©ration progression:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n"],"file":"quiz-service-Kz87c3VQ.js"}