import{initializeApp as $}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as B,GoogleAuthProvider as F,signInWithPopup as K,signOut as j,onAuthStateChanged as J}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getFirestore as _,doc as p,Timestamp as l,getDoc as x,setDoc as N,collection as g,where as w,orderBy as C,query as S,getDocs as q,addDoc as U,deleteDoc as W,updateDoc as I,limit as G}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{getDatabase as Y}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();function A(e,t="info",r=3e3){const o=T(),s=V(e,t);return o.appendChild(s),setTimeout(()=>s.classList.add("show"),10),r>0&&setTimeout(()=>{L(s)},r),s}function T(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.className="fixed top-4 right-4 z-50 flex flex-col gap-3",document.body.appendChild(e)),e}function V(e,t){const r=document.createElement("div");r.className=`toast toast-${t} transform translate-x-full transition-all duration-300`;const o=P(t);return r.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${o.borderColor} p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                ${o.icon}
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${e}</p>
            </div>
            <button class="toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `,r.querySelector(".toast-close").addEventListener("click",()=>L(r)),r}function P(e){const t={success:{borderColor:"border-green-500",icon:`<div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>`},error:{borderColor:"border-red-500",icon:`<div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>`},warning:{borderColor:"border-yellow-500",icon:`<div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>`},info:{borderColor:"border-blue-500",icon:`<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>`}};return t[e]||t.info}function L(e){e.classList.remove("show"),e.classList.add("translate-x-full"),setTimeout(()=>{e.remove();const t=document.getElementById("toast-container");t&&t.children.length===0&&t.remove()},300)}const de={success:(e,t)=>A(e,"success",t),error:(e,t)=>A(e,"error",t),warning:(e,t)=>A(e,"warning",t),info:(e,t)=>A(e,"info",t)};function me(e){const t=T(),r=document.createElement("div");return r.className="toast toast-loading transform translate-x-full transition-all duration-300",r.setAttribute("data-loading","true"),r.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 border-indigo-500 p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${e}</p>
            </div>
        </div>
    `,t.appendChild(r),setTimeout(()=>r.classList.add("show"),10),r}function he(e,t,r="success"){if(!e||!e.getAttribute("data-loading"))return;const o=P(r),s=e.classList.contains("show");e.className=`toast toast-${r} transform transition-all duration-300${s?" show":""}`,e.innerHTML=`
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-lg border-l-4 ${o.borderColor} p-4 min-w-[320px] max-w-md">
            <div class="flex-shrink-0">
                ${o.icon}
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">${t}</p>
            </div>
            <button class="toast-close flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `,e.removeAttribute("data-loading"),e.querySelector(".toast-close").addEventListener("click",()=>L(e)),setTimeout(()=>L(e),3e3)}if(typeof document<"u"){const e=document.createElement("style");e.textContent=`
        .toast.show {
            transform: translateX(0) !important;
        }
        
        @media (max-width: 640px) {
            #toast-container {
                left: 1rem;
                right: 1rem;
                top: 1rem;
            }
            
            .toast > div {
                min-width: auto !important;
                width: 100%;
            }
        }
    `,document.head.appendChild(e)}const f=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="192.168.1.1"||window.location.port==="3200",z={log:(...e)=>{f&&console.log(...e)},error:(...e)=>{console.error(...e)},warn:(...e)=>{f&&console.warn(...e)},info:(...e)=>{f&&console.info(...e)},group:(...e)=>{f&&console.group(...e)},groupEnd:()=>{f&&console.groupEnd()},table:(...e)=>{f&&console.table(...e)}};console.log(f?"üîß Mode d√©veloppement - Logs activ√©s":"üöÄ Mode production - Logs d√©sactiv√©s (sauf erreurs)");const Q={apiKey:"AIzaSyD8w7Em_xdMGplscfGLrnM72vmm4z5ZTr0",authDomain:"avantage-quizz.firebaseapp.com",databaseURL:"https://avantage-quizz-default-rtdb.firebaseio.com",projectId:"avantage-quizz",storageBucket:"avantage-quizz.firebasestorage.app",messagingSenderId:"919472910099",appId:"1:919472910099:web:e17d4c1cdc7a04c6cab4e6"},M=$(Q),m=B(M),u=_(M);Y(M);z.log("‚úÖ Firebase initialis√© avec succ√®s");z.log("üìä Projet:",Q.projectId);z.log("üîê Services: Authentication, Firestore, Realtime Database");const d={users:"users",quizResults:"quizResults",monthlyProgress:"monthlyProgress",questions:"questions"},E=new Map;function h(e=[]){return e.filter(Boolean).join("::")}function y(e){const t=E.get(e);return t?Date.now()>t.expireAt?(E.delete(e),null):t.value:null}function v(e,t,r=300*1e3){E.set(e,{value:t,expireAt:Date.now()+r})}function c(e){E.forEach((t,r)=>{r.startsWith(e)&&E.delete(r)})}async function H(e){try{const t=p(u,d.users,e.uid),r={uid:e.uid,email:e.email,displayName:e.displayName,photoURL:e.photoURL,lastLogin:l.now(),updatedAt:l.now()};return(await x(t)).exists()||(r.createdAt=l.now(),r.totalQuizzes=0,r.averageScore=0,r.currentStreak=0,r.longestStreak=0,r.role="user",console.log("üë§ Cr√©ation du profil utilisateur:",e.email)),await N(t,r,{merge:!0}),console.log("‚úÖ Profil utilisateur sauvegard√©"),r}catch(t){throw console.error("‚ùå Erreur cr√©ation utilisateur:",t),t}}async function ge(e){try{const t=p(u,d.users,e),r=await x(t);return r.exists()?r.data():null}catch(t){throw console.error("‚ùå Erreur r√©cup√©ration profil:",t),t}}async function fe(e){try{const t=m.currentUser;if(!t)throw new Error("Utilisateur non connect√©");const r={userId:t.uid,userEmail:t.email,moduleId:e.moduleId,moduleName:e.moduleName,score:e.score,correctAnswers:e.correctAnswers,totalQuestions:e.totalQuestions,timeElapsed:e.timeElapsed,answers:e.answers,date:l.now(),completedAt:l.now(),month:e.month||new Date().toLocaleDateString("fr-FR",{month:"long",year:"numeric"})},o=await U(g(u,d.quizResults),r);return console.log("‚úÖ R√©sultat de quiz sauvegard√©:",o.id),await D(t.uid,e.score),await Z(t.uid,e.month,e.score),c(h(["quizResults",t.uid])),c(h(["monthlyResults",t.uid])),c(h(["annualProgress",t.uid])),c("users"),c("users-stats"),o.id}catch(t){throw console.error("‚ùå Erreur sauvegarde r√©sultat:",t),t}}async function X(e,t=50){const r=h(["quizResults",e,t]),o=y(r);if(o)return o;try{const s=S(g(u,d.quizResults),w("userId","==",e),C("date","desc"),G(t)),n=await q(s),i=[];return n.forEach(a=>{i.push({id:a.id,...a.data()})}),console.log(`üìä ${i.length} r√©sultats charg√©s`),v(r,i),i}catch(s){throw console.error("‚ùå Erreur r√©cup√©ration r√©sultats:",s),s}}async function Z(e,t,r){try{const o=p(u,d.monthlyProgress,`${e}_${t}`),s={userId:e,month:t,score:r,completed:!0,completedAt:l.now(),updatedAt:l.now()};await N(o,s,{merge:!0}),console.log("‚úÖ Progression mensuelle mise √† jour"),c(h(["monthlyResults",e])),c(h(["annualProgress",e]))}catch(o){throw console.error("‚ùå Erreur mise √† jour progression:",o),o}}async function pe(e,t=new Date().getFullYear()){const r=h(["annualProgress",e,t]),o=y(r);if(o)return o;try{const s=S(g(u,d.monthlyProgress),w("userId","==",e)),n=await q(s),i={};return n.forEach(a=>{const b=a.data();i[b.month]=b}),console.log("üìÖ Progression annuelle charg√©e"),v(r,i),i}catch(s){throw console.error("‚ùå Erreur r√©cup√©ration progression:",s),s}}async function D(e,t){try{const r=p(u,d.users,e),o=await x(r);if(o.exists()){const s=o.data(),n=(s.totalQuizzes||0)+1,a=((s.averageScore||0)*(n-1)+t)/n;await I(r,{totalQuizzes:n,averageScore:Math.round(a),lastQuizDate:l.now(),updatedAt:l.now()}),console.log("üìä Statistiques mises √† jour"),c("users"),c("users-stats")}}catch(r){throw console.error("‚ùå Erreur mise √† jour statistiques:",r),r}}async function we(e){try{const t=await X(e,12);let r=0;const o=new Set;for(const a of t)a.score>=60&&o.add(a.month);const s=Array.from(o).sort().reverse();for(let a=0;a<s.length&&(r++,a<s.length-1);a++);const n=p(u,d.users,e),i=await x(n);if(i.exists()){const a=i.data(),b=Math.max(r,a.longestStreak||0);await I(n,{currentStreak:r,longestStreak:b,updatedAt:l.now()}),console.log(`üî• S√©rie mise √† jour: ${r} mois`),c("users"),c("users-stats")}return r}catch(t){throw console.error("‚ùå Erreur mise √† jour s√©rie:",t),t}}async function ee(e={}){const t=h(["questions",JSON.stringify(e||{})]),r=y(t);if(r)return r;try{let o=g(u,d.questions);const s=[];e.module&&s.push(w("module","==",e.module)),e.month&&s.push(w("month","==",e.month)),e.year&&s.push(w("year","==",e.year)),s.push(C("createdAt","desc")),s.length>0&&(o=S(o,...s));const n=await q(o),i=[];return n.forEach(a=>{i.push({id:a.id,...a.data()})}),console.log(`üìö ${i.length} questions charg√©es`),v(t,i),i}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration questions:",o),o}}async function te(e){try{const t=m.currentUser;if(!t)throw new Error("Utilisateur non connect√©");if(!e.question||e.question.length<10)throw new Error("La question doit contenir au moins 10 caract√®res");if(!e.options||e.options.length!==4)throw new Error("La question doit avoir exactement 4 options");if(e.correctAnswer===void 0||e.correctAnswer<0||e.correctAnswer>3)throw new Error("La r√©ponse correcte doit √™tre entre 0 et 3");if(!e.explanation||e.explanation.length<20)throw new Error("L'explication doit contenir au moins 20 caract√®res");if(!["auto","loisir","vr","tracteur"].includes(e.module))throw new Error("Module invalide");if(!e.month||e.month<1||e.month>12)throw new Error("Mois invalide");const r={question:e.question.trim(),options:e.options.map(s=>s.trim()),correctAnswer:parseInt(e.correctAnswer),explanation:e.explanation.trim(),module:e.module,month:parseInt(e.month),year:e.year||new Date().getFullYear(),createdAt:l.now(),createdBy:t.uid,updatedAt:l.now()},o=await U(g(u,d.questions),r);return console.log("‚úÖ Question cr√©√©e:",o.id),await R({action:"CREATE_QUESTION",questionId:o.id,adminId:t.uid,adminEmail:t.email}),c("questions"),c("questions-stats"),o.id}catch(t){throw console.error("‚ùå Erreur cr√©ation question:",t),t}}async function ye(e){try{const t=m.currentUser;if(!t)throw new Error("Utilisateur non connect√©");const r=p(u,d.questions,e),s=(await x(r)).data();return await W(r),console.log("üóëÔ∏è Question supprim√©e:",e),await R({action:"DELETE_QUESTION",questionId:e,adminId:t.uid,adminEmail:t.email,deletedData:s}),c("questions"),c("questions-stats"),!0}catch(t){throw console.error("‚ùå Erreur suppression question:",t),t}}async function ve(e){try{const t=m.currentUser;if(!t)throw new Error("Utilisateur non connect√©");if(!e.module||!e.month||!e.year||!e.questions)throw new Error("Format JSON invalide - champs obligatoires manquants");if(!Array.isArray(e.questions)||e.questions.length===0)throw new Error("Le fichier JSON doit contenir au moins une question");const r=[],o=[];for(let s=0;s<e.questions.length;s++){const n=e.questions[s];try{const i={question:n.question,options:n.options,correctAnswer:n.correctAnswer,explanation:n.explanation,module:e.module,month:e.month,year:e.year},a=await te(i);r.push(a)}catch(i){o.push({index:s,error:i.message}),console.error(`‚ùå Erreur question ${s+1}:`,i.message)}}return await oe({importedBy:t.uid,module:e.module,month:e.month,year:e.year,totalQuestions:e.questions.length,successCount:r.length,errorCount:o.length,status:o.length===0?"success":"partial"}),console.log(`‚úÖ Import termin√©: ${r.length}/${e.questions.length} questions import√©es`),c("questions"),c("questions-stats"),{success:r.length,total:e.questions.length,errors:o,ids:r}}catch(t){throw console.error("‚ùå Erreur import JSON:",t),t}}async function re(e={}){const t=h(["users",JSON.stringify(e||{})]),r=y(t);if(r)return r;try{let o=g(u,d.users);const s=[];e.role&&s.push(w("role","==",e.role)),s.push(C("createdAt","desc")),s.length>0&&(o=S(o,...s));const n=await q(o),i=[];return n.forEach(a=>{i.push({id:a.id,...a.data()})}),console.log(`üë• ${i.length} utilisateurs charg√©s`),v(t,i),i}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration utilisateurs:",o),o}}async function Ee(e,t){try{const r=m.currentUser;if(!r)throw new Error("Utilisateur non connect√©");if(!["user","admin"].includes(t))throw new Error('R√¥le invalide - doit √™tre "user" ou "admin"');const o=p(u,d.users,e);return await I(o,{role:t,updatedAt:l.now()}),console.log(`‚úÖ R√¥le mis √† jour pour ${e}: ${t}`),await R({action:"UPDATE_USER_ROLE",targetUserId:e,newRole:t,adminId:r.uid,adminEmail:r.email}),c("users"),c("users-stats"),!0}catch(r){throw console.error("‚ùå Erreur mise √† jour r√¥le:",r),r}}async function oe(e){try{const t={...e,importedAt:l.now()};await U(g(u,"importLogs"),t),console.log("Log import cree")}catch(t){console.error("Erreur creation log import:",t)}}async function R(e){try{const t={...e,timestamp:l.now()};await U(g(u,"auditLogs"),t),console.log("Log audit cree")}catch(t){console.error("Erreur creation log audit:",t)}}async function xe(){const e="questions-stats",t=y(e);if(t)return t;try{const r=await ee(),o={total:r.length,byModule:{},byMonth:{},byYear:{}};return r.forEach(s=>{o.byModule[s.module]=(o.byModule[s.module]||0)+1,o.byMonth[s.month]=(o.byMonth[s.month]||0)+1,o.byYear[s.year]=(o.byYear[s.year]||0)+1}),v(e,o,120*1e3),o}catch(r){throw console.error("‚ùå Erreur statistiques questions:",r),r}}async function be(){const e="users-stats",t=y(e);if(t)return t;try{const r=await re(),o={total:r.length,admins:r.filter(n=>n.role==="admin").length,regularUsers:r.filter(n=>n.role!=="admin").length,activeLastWeek:0,averageScore:0,totalQuizzes:0},s=new Date;return s.setDate(s.getDate()-7),r.forEach(n=>{n.lastLogin&&n.lastLogin.toDate()>s&&o.activeLastWeek++,o.totalQuizzes+=n.totalQuizzes||0,o.averageScore+=n.averageScore||0}),o.averageScore=o.total>0?Math.round(o.averageScore/o.total):0,v(e,o,120*1e3),o}catch(r){throw console.error("‚ùå Erreur statistiques utilisateurs:",r),r}}const O=new F;O.setCustomParameters({prompt:"select_account"});let k=!1;async function Ae(){if(k)return console.warn("‚ö†Ô∏è Connexion d√©j√† en cours, veuillez patienter..."),null;k=!0;try{console.log("üîê Tentative de connexion Google...");const t=(await K(m,O)).user;return console.log("‚úÖ Authentification r√©ussie:",t.displayName),console.log("üìß Email:",t.email),await H(t),t}catch(e){console.error("‚ùå Erreur de connexion:",e);let t="Erreur lors de la connexion. Veuillez r√©essayer.";if(e.code==="auth/popup-closed-by-user")t="Connexion annul√©e. Veuillez r√©essayer.";else if(e.code==="auth/popup-blocked")t="Pop-up bloqu√©e. Autorisez les pop-ups pour ce site.";else if(e.code==="auth/unauthorized-domain")t="Domaine non autoris√©. Configurez Firebase Authentication.";else if(e.code==="auth/cancelled-popup-request")return console.warn("‚ö†Ô∏è Requ√™te de popup annul√©e (clic multiple)"),null;throw e.code!=="auth/cancelled-popup-request"&&alert(t),e}finally{setTimeout(()=>{k=!1},2e3)}}async function Le(){try{const e=m.currentUser?.displayName||"Utilisateur";await j(m),console.log("‚úÖ D√©connexion r√©ussie:",e)}catch(e){throw console.error("‚ùå Erreur de d√©connexion:",e),e}}function Se(e){return J(m,t=>{t?console.log("üë§ Utilisateur connect√©:",t.email):console.log("üë§ Aucun utilisateur connect√©"),e(t)})}function se(){return m.currentUser}async function qe(e){if(!e)return;if(e.role==="admin"){const r=document.getElementById("nav-admin-item");r&&r.classList.remove("hidden");const o=document.getElementById("admin-badge-nav");o&&o.classList.remove("hidden"),console.log("Admin UI elements shown")}}function ne(){return localStorage.getItem("authMode")==="demo"}function ie(){try{const e=localStorage.getItem("demoUser");return e?JSON.parse(e):null}catch(e){return console.error("‚ùå Erreur lecture utilisateur d√©mo:",e),null}}function Ue(){return ne()?ie():se()}export{Ae as a,fe as b,Le as c,u as d,ge as e,qe as f,Ue as g,pe as h,ne as i,we as j,ie as k,m as l,ee as m,xe as n,Se as o,te as p,ye as q,ve as r,me as s,de as t,he as u,re as v,be as w,Ee as x,z as y,se as z};
//# sourceMappingURL=auth-VsLOkEMq.js.map
