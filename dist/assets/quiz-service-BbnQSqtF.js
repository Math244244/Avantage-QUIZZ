const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/auth-CNPNPDyq.js","assets/auth-EZ5nrVZC.css"])))=>i.map(i=>d[i]);
import{p as j,r as p,q as N,n as y,_ as Q,m as l,k as u,l as P,o as R,s as A}from"./auth-CNPNPDyq.js";import{Timestamp as g,addDoc as T,collection as M,doc as x,setDoc as L,query as S,where as f,getDocs as C,orderBy as U,limit as Y}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";const w=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"],b=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];function $(){return new Date().getMonth()}function J(){return $()+1}function I(){return new Date().getFullYear()}function h(e,r=I()){let t;if(typeof e=="number"){if(e<1||e>12)throw new Error(`Num√©ro de mois invalide: ${e}. Doit √™tre entre 1 et 12.`);t=w[e-1]}else if(typeof e=="string"){const o=e.toLowerCase().trim(),s=b.findIndex(a=>a===o);if(s!==-1)t=w[s];else{const a=e.split(" ");if(a.length>=1){const i=a[0].toLowerCase(),n=b.findIndex(c=>c===i);if(n!==-1){if(t=w[n],a.length>=2){const c=parseInt(a[1]);isNaN(c)||(r=c)}}else throw new Error(`Format de mois invalide: ${e}`)}else throw new Error(`Format de mois invalide: ${e}`)}}else throw new Error(`Type de mois invalide: ${typeof e}`);return`${t} ${r}`}function O(e,r,t=I()){const o=h(r,t);return`${e}_${o.replace(/\s+/g,"_")}`}function v(e){const r=e.split(" ");if(r.length>=2){const t=parseInt(r[r.length-1]);if(!isNaN(t))return t}return I()}const B=Object.freeze(Object.defineProperty({__proto__:null,MONTH_NAMES:w,MONTH_NAMES_LOWERCASE:b,createMonthlyProgressId:O,extractYearFromMonth:v,getCurrentMonthIndex:$,getCurrentMonthNumber:J,getCurrentYear:I,normalizeMonthFormat:h},Symbol.toStringTag,{value:"Module"})),E={quizResults:"quizResults",monthlyProgress:"monthlyProgress"};async function K(e){try{const r=j.currentUser;if(!r)throw new Error("Utilisateur non connect√©");const t=e.score;if(isNaN(t)||t<0||t>100)throw new Error(`Score invalide: ${t}. Doit √™tre entre 0 et 100.`);if(!e.totalQuestions||e.totalQuestions<=0)throw new Error(`Nombre total de questions invalide: ${e.totalQuestions}`);if(e.correctAnswers<0||e.correctAnswers>e.totalQuestions)throw new Error(`Nombre de bonnes r√©ponses invalide: ${e.correctAnswers}`);const o=h(e.month||new Date().getMonth()+1,e.year||new Date().getFullYear()),s=v(o),a=await p(),i={userId:r.uid,userEmail:r.email,moduleId:e.moduleId,moduleName:e.moduleName,score:t,correctAnswers:e.correctAnswers,totalQuestions:e.totalQuestions,timeElapsed:e.timeElapsed,answers:e.answers,date:g.now(),completedAt:g.now(),month:o,year:s,clientId:a},n=await N(()=>T(M(y,E.quizResults),i));console.log("‚úÖ R√©sultat de quiz sauvegard√©:",n.id);const{updateUserStats:c}=await Q(async()=>{const{updateUserStats:d}=await import("./auth-CNPNPDyq.js").then(m=>m.J);return{updateUserStats:d}},__vite__mapDeps([0,1]));return await c(r.uid,e.score),await F(r.uid,e.month,e.score),l(u(["quizResults",r.uid])),l(u(["monthlyResults",r.uid])),l(u(["annualProgress",r.uid])),l("users"),l("users-stats"),n.id}catch(r){throw console.error("‚ùå Erreur sauvegarde r√©sultat:",r),r}}async function V(e,r=50){const t=u(["quizResults",e,r]),o=P(t);if(o)return o;try{const s=await p(),a=S(M(y,E.quizResults),f("userId","==",e),f("clientId","==",s),U("date","desc"),Y(r)),i=await R(()=>C(a)),n=[];return i.forEach(c=>{n.push({id:c.id,...c.data()})}),console.log(`üìä ${n.length} r√©sultats charg√©s`),A(t,n,"quizResults"),n}catch(s){throw console.error("‚ùå Erreur r√©cup√©ration r√©sultats:",s),s}}async function F(e,r,t){try{const o=h(r),s=v(o),a=O(e,o),i=x(y,E.monthlyProgress,a),n=await p(),c={userId:e,month:o,year:s,score:t,completed:!0,completedAt:g.now(),updatedAt:g.now(),clientId:n};await N(()=>L(i,c,{merge:!0})),console.log("‚úÖ Progression mensuelle mise √† jour"),l(u(["monthlyResults",e])),l(u(["annualProgress",e,s]))}catch(o){throw console.error("‚ùå Erreur mise √† jour progression:",o),o}}async function H(e,r=new Date().getFullYear()){const t=u(["annualProgress",e,r]),o=P(t);if(o)return o;try{const s=await p(),a=S(M(y,E.monthlyProgress),f("userId","==",e),f("clientId","==",s)),i=await R(()=>C(a)),n={};return i.forEach(c=>{const d=c.data(),m=d.year||v(d.month);if(m===r){const _=h(d.month,m);n[_]={...d,month:_,year:m}}}),console.log("üìÖ Progression annuelle charg√©e"),A(t,n,"annualProgress"),n}catch(s){throw console.error("‚ùå Erreur r√©cup√©ration progression:",s),s}}const z=Object.freeze(Object.defineProperty({__proto__:null,getAnnualProgress:H,getUserQuizResults:V,saveQuizResult:K,updateMonthlyProgress:F},Symbol.toStringTag,{value:"Module"}));export{w as M,H as a,$ as b,I as c,V as g,B as m,h as n,z as q,K as s,F as u};
//# sourceMappingURL=quiz-service-BbnQSqtF.js.map
