import{a as _,d as l,_ as B}from"./admin-BqW1z8Wp.js";import{doc as E,getDoc as L,Timestamp as h,addDoc as O,collection as w,runTransaction as ge,setDoc as k,query as A,where as f,orderBy as U,limit as Y,getDocs as N,startAfter as pe,updateDoc as G,deleteDoc as we}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{s as g,a as y}from"./quiz-DC566aXg.js";const F="default";let z=null,W=0;const ye=300*1e3;async function p(t=null){const e=t||_.currentUser;if(!e)return console.warn("‚ö†Ô∏è Aucun utilisateur connect√©, utilisation du clientId par d√©faut"),F;const r=Date.now();if(z&&r<W)return z;try{const s=E(l,"users",e.uid),o=await g(()=>L(s));if(o.exists()){let i=o.data().clientId;return i||(i=$(e.email)),z=i,W=r+ye,i}else{const n=$(e.email);return console.log("üîÑ Profil utilisateur non trouv√©, clientId d√©termin√© √† partir de l'email:",n),n}}catch(s){return console.error("‚ùå Erreur r√©cup√©ration clientId:",s),$(e.email)}}function $(t){if(!t)return F;const e=t.split("@")[1];return{}[e]||F}const b=new Map,j={users:600*1e3,quizResults:300*1e3,questions:1800*1e3,stats:120*1e3,monthlyProgress:600*1e3,annualProgress:900*1e3,default:300*1e3};function Ee(t){return j[t]||j.default}function m(t=[]){return t.filter(Boolean).join("::")}function I(t){const e=b.get(t);return e?Date.now()>e.expireAt?(b.delete(t),null):e.value:null}function S(t,e,r=j.default){const s=typeof r=="string"?Ee(r):r;b.set(t,{value:e,expireAt:Date.now()+s,dataType:typeof r=="string"?r:null})}function u(t){b.forEach((e,r)=>{r.startsWith(t)&&b.delete(r)})}function X(t){b.forEach((e,r)=>{(e.dataType===t||r.includes(t))&&b.delete(r)})}const qe=Object.freeze(Object.defineProperty({__proto__:null,buildCacheKey:m,getCachedValue:I,invalidateByDataType:X,invalidateCache:u,setCachedValue:S},Symbol.toStringTag,{value:"Module"}));async function Z(t){try{const e={...t,importedAt:h.now()};await y(()=>O(w(l,"importLogs"),e)),console.log("Log import cree")}catch(e){console.error("Erreur creation log import:",e)}}async function R(t){try{const e={...t,timestamp:h.now()};await y(()=>O(w(l,"auditLogs"),e)),console.log("Log audit cree")}catch(e){console.error("Erreur creation log audit:",e)}}const v={users:"users"};async function ee(t){try{const e=E(l,v.users,t.uid),r=await p(t),s={uid:t.uid,email:t.email,displayName:t.displayName,photoURL:t.photoURL,lastLogin:h.now(),updatedAt:h.now(),clientId:r},o=await g(()=>L(e));return o.exists()?o.data().clientId||(s.clientId=r,console.log("üîÑ Migration: Ajout du clientId au profil utilisateur existant")):(s.createdAt=h.now(),s.totalQuizzes=0,s.averageScore=0,s.currentStreak=0,s.longestStreak=0,s.role="user",console.log("üë§ Cr√©ation du profil utilisateur:",t.email)),await y(()=>k(e,s,{merge:!0})),console.log("‚úÖ Profil utilisateur sauvegard√©"),s}catch(e){throw console.error("‚ùå Erreur cr√©ation utilisateur:",e),e}}async function H(t){try{const e=E(l,v.users,t),r=await g(()=>L(e));return r.exists()?r.data():null}catch(e){throw console.error("‚ùå Erreur r√©cup√©ration profil:",e),e}}async function te(t,e){if(isNaN(e)||e<0||e>100)throw console.error("‚ùå Score invalide pour mise √† jour des stats:",e),new Error(`Score invalide: ${e}. Doit √™tre entre 0 et 100.`);try{await ge(l,async r=>{const s=E(l,v.users,t),o=await r.get(s);if(!o.exists())throw new Error("Utilisateur non trouv√©");const n=o.data(),i=(n.totalQuizzes||0)+1,c=((n.averageScore||0)*(i-1)+e)/i,d=Math.round(c);if(isNaN(d)||d<0||d>100)throw console.error("‚ùå Moyenne calcul√©e invalide:",d),new Error(`Erreur de calcul de la moyenne: ${d}`);r.update(s,{totalQuizzes:i,averageScore:d,lastQuizDate:h.now(),updatedAt:h.now()})}),console.log("üìä Statistiques mises √† jour"),u("users"),u("users-stats")}catch(r){throw console.error("‚ùå Erreur mise √† jour statistiques:",r),r}}async function re(t){const{getUserQuizResults:e}=await B(async()=>{const{getUserQuizResults:r}=await Promise.resolve().then(()=>ve);return{getUserQuizResults:r}},void 0);try{const r=await e(t,12);let s=0;const o=new Set;for(const c of r)c.score>=60&&o.add(c.month);const n=Array.from(o).sort().reverse();for(let c=0;c<n.length&&(s++,c<n.length-1);c++);const i=E(l,v.users,t),a=await g(()=>L(i));if(a.exists()){const c=a.data(),d=Math.max(s,c.longestStreak||0);await y(()=>G(i,{currentStreak:s,longestStreak:d,updatedAt:h.now()})),console.log(`üî• S√©rie mise √† jour: ${s} mois`),u("users"),u("users-stats")}return s}catch(r){throw console.error("‚ùå Erreur mise √† jour s√©rie:",r),r}}async function se(t=10){try{const e=await p(),r=A(w(l,v.users),f("clientId","==",e),U("averageScore","desc"),U("totalQuizzes","desc"),Y(t)),s=await g(()=>N(r)),o=[];return s.forEach(n=>{const i=n.data();o.push({uid:n.id,displayName:i.displayName,photoURL:i.photoURL,averageScore:i.averageScore,totalQuizzes:i.totalQuizzes,currentStreak:i.currentStreak})}),console.log("üèÜ Classement charg√©"),o}catch(e){throw console.error("‚ùå Erreur r√©cup√©ration classement:",e),e}}async function oe(){try{const t=_.currentUser;return t?(await H(t.uid))?.role==="admin":!1}catch(t){return console.error("‚ùå Erreur v√©rification admin:",t),!1}}async function K(t={}){const e=m(["users",JSON.stringify(t||{})]),r=I(e);if(r)return r;try{const s=await p(),o=[f("clientId","==",s)];t.role&&o.push(f("role","==",t.role)),o.push(U("createdAt","desc"));const n=A(w(l,v.users),...o),i=await g(()=>N(n)),a=[];return i.forEach(c=>{a.push({id:c.id,...c.data()})}),console.log(`üë• ${a.length} utilisateurs charg√©s`),S(e,a,"users"),a}catch(s){throw console.error("‚ùå Erreur r√©cup√©ration utilisateurs:",s),s}}async function ne(t={},e=20,r=null){try{const s=await p(),o=[f("clientId","==",s)];t.role&&o.push(f("role","==",t.role)),o.push(U("createdAt","desc")),o.push(Y(e+1));let n=A(w(l,v.users),...o);r&&(n=A(n,pe(r)));const i=await g(()=>N(n)),a=[];let c=null,d=!1;return i.forEach((M,P)=>{P<e?a.push({id:M.id,...M.data()}):d=!0}),i.docs.length>0&&a.length===e&&(c=i.docs[e-1]),console.log(`üë• ${a.length} utilisateurs charg√©s (pagination)`),{users:a,lastDoc:c,hasMore:d}}catch(s){throw console.error("‚ùå Erreur r√©cup√©ration utilisateurs pagin√©s:",s),s}}async function ie(t,e){try{const r=_.currentUser;if(!r)throw new Error("Utilisateur non connect√©");if(!["user","admin"].includes(e))throw new Error('R√¥le invalide - doit √™tre "user" ou "admin"');const s=E(l,v.users,t);return await y(()=>G(s,{role:e,updatedAt:h.now()})),console.log(`‚úÖ R√¥le mis √† jour pour ${t}: ${e}`),await R({action:"UPDATE_USER_ROLE",targetUserId:t,newRole:e,adminId:r.uid,adminEmail:r.email}),u("users"),u("users-stats"),!0}catch(r){throw console.error("‚ùå Erreur mise √† jour r√¥le:",r),r}}async function ae(){const t=await p(),e=m(["users-stats",t]),r=I(e);if(r)return r;try{const s=await K(),o={total:s.length,admins:s.filter(i=>i.role==="admin").length,regularUsers:s.filter(i=>i.role!=="admin").length,activeLastWeek:0,averageScore:0,totalQuizzes:0},n=new Date;return n.setDate(n.getDate()-7),s.forEach(i=>{i.lastLogin&&i.lastLogin.toDate()>n&&o.activeLastWeek++,o.totalQuizzes+=i.totalQuizzes||0,o.averageScore+=i.averageScore||0}),o.averageScore=o.total>0?Math.round(o.averageScore/o.total):0,S(e,o,"stats"),o}catch(s){throw console.error("‚ùå Erreur statistiques utilisateurs:",s),s}}const Ie=Object.freeze(Object.defineProperty({__proto__:null,createOrUpdateUser:ee,getAllUsers:K,getAllUsersPaginated:ne,getLeaderboard:se,getUserProfile:H,getUsersStats:ae,isCurrentUserAdmin:oe,updateStreak:re,updateUserRole:ie,updateUserStats:te},Symbol.toStringTag,{value:"Module"})),Q=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"],J=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];function ce(){return new Date().getMonth()}function Se(){return ce()+1}function x(){return new Date().getFullYear()}function q(t,e=x()){let r;if(typeof t=="number"){if(t<1||t>12)throw new Error(`Num√©ro de mois invalide: ${t}. Doit √™tre entre 1 et 12.`);r=Q[t-1]}else if(typeof t=="string"){const s=t.toLowerCase().trim(),o=J.findIndex(n=>n===s);if(o!==-1)r=Q[o];else{const n=t.split(" ");if(n.length>=1){const i=n[0].toLowerCase(),a=J.findIndex(c=>c===i);if(a!==-1){if(r=Q[a],n.length>=2){const c=parseInt(n[1]);isNaN(c)||(e=c)}}else throw new Error(`Format de mois invalide: ${t}`)}else throw new Error(`Format de mois invalide: ${t}`)}}else throw new Error(`Type de mois invalide: ${typeof t}`);return`${r} ${e}`}function ue(t,e,r=x()){const s=q(e,r);return`${t}_${s.replace(/\s+/g,"_")}`}function C(t){const e=t.split(" ");if(e.length>=2){const r=parseInt(e[e.length-1]);if(!isNaN(r))return r}return x()}const Pe=Object.freeze(Object.defineProperty({__proto__:null,MONTH_NAMES:Q,MONTH_NAMES_LOWERCASE:J,createMonthlyProgressId:ue,extractYearFromMonth:C,getCurrentMonthIndex:ce,getCurrentMonthNumber:Se,getCurrentYear:x,normalizeMonthFormat:q},Symbol.toStringTag,{value:"Module"})),T={quizResults:"quizResults",monthlyProgress:"monthlyProgress"};async function le(t){try{const e=_.currentUser;if(!e)throw new Error("Utilisateur non connect√©");const r=t.score;if(isNaN(r)||r<0||r>100)throw new Error(`Score invalide: ${r}. Doit √™tre entre 0 et 100.`);if(!t.totalQuestions||t.totalQuestions<=0)throw new Error(`Nombre total de questions invalide: ${t.totalQuestions}`);if(t.correctAnswers<0||t.correctAnswers>t.totalQuestions)throw new Error(`Nombre de bonnes r√©ponses invalide: ${t.correctAnswers}`);const s=q(t.month||new Date().getMonth()+1,t.year||new Date().getFullYear()),o=C(s),n=await p(),i={userId:e.uid,userEmail:e.email,moduleId:t.moduleId,moduleName:t.moduleName,score:r,correctAnswers:t.correctAnswers,totalQuestions:t.totalQuestions,timeElapsed:t.timeElapsed,answers:t.answers,date:h.now(),completedAt:h.now(),month:s,year:o,clientId:n},a=await y(()=>O(w(l,T.quizResults),i));console.log("‚úÖ R√©sultat de quiz sauvegard√©:",a.id);const{updateUserStats:c}=await B(async()=>{const{updateUserStats:d}=await Promise.resolve().then(()=>Ie);return{updateUserStats:d}},void 0);return await c(e.uid,t.score),await D(e.uid,t.month,t.score),u(m(["quizResults",e.uid])),u(m(["monthlyResults",e.uid])),u(m(["annualProgress",e.uid])),u("users"),u("users-stats"),a.id}catch(e){throw console.error("‚ùå Erreur sauvegarde r√©sultat:",e),e}}async function de(t,e=50){const r=m(["quizResults",t,e]),s=I(r);if(s)return s;try{const o=await p(),n=A(w(l,T.quizResults),f("userId","==",t),f("clientId","==",o),U("date","desc"),Y(e)),i=await g(()=>N(n)),a=[];return i.forEach(c=>{a.push({id:c.id,...c.data()})}),console.log(`üìä ${a.length} r√©sultats charg√©s`),S(r,a,"quizResults"),a}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration r√©sultats:",o),o}}async function D(t,e,r){try{const s=q(e),o=C(s),n=ue(t,s),i=E(l,T.monthlyProgress,n),a=await p(),c={userId:t,month:s,year:o,score:r,completed:!0,completedAt:h.now(),updatedAt:h.now(),clientId:a};await y(()=>k(i,c,{merge:!0})),console.log("‚úÖ Progression mensuelle mise √† jour:",{userId:t,month:s,score:r,progressId:n}),u(m(["monthlyResults",t])),u(m(["annualProgress",t,o])),u(m(["annualProgress",t])),console.log("üóëÔ∏è Cache invalid√© pour:",{uid:t,year:o})}catch(s){throw console.error("‚ùå Erreur mise √† jour progression:",s),s}}async function he(t,e=new Date().getFullYear()){const r=m(["annualProgress",t,e]),s=I(r);if(s)return s;try{const o=await p(),n=A(w(l,T.monthlyProgress),f("userId","==",t),f("clientId","==",o)),i=await g(()=>N(n)),a={};return i.forEach(c=>{const d=c.data(),M=d.year||C(d.month);if(M===e){const P=q(d.month,M);a[P]={...d,month:P,year:M}}}),console.log("üìÖ Progression annuelle charg√©e"),S(r,a,"annualProgress"),a}catch(o){throw console.error("‚ùå Erreur r√©cup√©ration progression:",o),o}}const ve=Object.freeze(Object.defineProperty({__proto__:null,getAnnualProgress:he,getUserQuizResults:de,saveQuizResult:le,updateMonthlyProgress:D},Symbol.toStringTag,{value:"Module"})),V={questions:"questions"};async function fe(t={}){const e=m(["questions",JSON.stringify(t||{})]),r=I(e);if(r)return r;try{const s=await p();let o=w(l,V.questions);const n=[f("clientId","==",s)];t.module&&n.push(f("module","==",t.module)),t.month&&n.push(f("month","==",t.month)),t.year&&n.push(f("year","==",t.year)),n.push(U("createdAt","desc")),o=A(o,...n);const i=await g(()=>N(o)),a=[];return i.forEach(c=>{a.push({id:c.id,...c.data()})}),console.log(`üìö ${a.length} questions charg√©es`),S(e,a,"questions"),a}catch(s){throw console.error("‚ùå Erreur r√©cup√©ration questions:",s),s}}async function me(t){try{const e=_.currentUser;if(!e)throw new Error("Utilisateur non connect√©");if(!t.question||t.question.length<10)throw new Error("La question doit contenir au moins 10 caract√®res");if(!t.options||t.options.length!==4)throw new Error("La question doit avoir exactement 4 options");if(t.correctAnswer===void 0||t.correctAnswer<0||t.correctAnswer>3)throw new Error("La r√©ponse correcte doit √™tre entre 0 et 3");if(!t.explanation||t.explanation.length<20)throw new Error("L'explication doit contenir au moins 20 caract√®res");if(!["auto","loisir","vr","tracteur"].includes(t.module))throw new Error("Module invalide");if(!t.month||t.month<1||t.month>12)throw new Error("Mois invalide");const r=await p(),s={question:t.question.trim(),options:t.options.map(n=>n.trim()),correctAnswer:parseInt(t.correctAnswer),explanation:t.explanation.trim(),module:t.module,month:parseInt(t.month),year:t.year||new Date().getFullYear(),clientId:r,createdAt:h.now(),createdBy:e.uid,updatedAt:h.now()},o=await y(()=>O(w(l,V.questions),s));return console.log("‚úÖ Question cr√©√©e:",o.id),await R({action:"CREATE_QUESTION",questionId:o.id,adminId:e.uid,adminEmail:e.email}),u("questions"),u("questions-stats"),o.id}catch(e){throw console.error("‚ùå Erreur cr√©ation question:",e),e}}async function Ae(t){try{const e=_.currentUser;if(!e)throw new Error("Utilisateur non connect√©");const r=E(l,V.questions,t),o=(await g(()=>L(r))).data();return await y(()=>we(r)),console.log("üóëÔ∏è Question supprim√©e:",t),await R({action:"DELETE_QUESTION",questionId:t,adminId:e.uid,adminEmail:e.email,deletedData:o}),u("questions"),u("questions-stats"),!0}catch(e){throw console.error("‚ùå Erreur suppression question:",e),e}}async function be(t){try{const e=_.currentUser;if(!e)throw new Error("Utilisateur non connect√©");if(!t.module||!t.month||!t.year||!t.questions)throw new Error("Format JSON invalide - champs obligatoires manquants");if(!Array.isArray(t.questions)||t.questions.length===0)throw new Error("Le fichier JSON doit contenir au moins une question");const r=[],s=[];for(let o=0;o<t.questions.length;o++){const n=t.questions[o];try{const i={question:n.question,options:n.options,correctAnswer:n.correctAnswer,explanation:n.explanation,module:t.module,month:t.month,year:t.year},a=await me(i);r.push(a)}catch(i){s.push({index:o,error:i.message}),console.error(`‚ùå Erreur question ${o+1}:`,i.message)}}return await Z({importedBy:e.uid,module:t.module,month:t.month,year:t.year,totalQuestions:t.questions.length,successCount:r.length,errorCount:s.length,status:s.length===0?"success":"partial"}),console.log(`‚úÖ Import termin√©: ${r.length}/${t.questions.length} questions import√©es`),u("questions"),u("questions-stats"),{success:r.length,total:t.questions.length,errors:s,ids:r}}catch(e){throw console.error("‚ùå Erreur import JSON:",e),e}}async function _e(){const t="questions-stats",e=I(t);if(e)return e;try{const r=await fe(),s={total:r.length,byModule:{},byMonth:{},byYear:{}};return r.forEach(o=>{s.byModule[o.module]=(s.byModule[o.module]||0)+1,s.byMonth[o.month]=(s.byMonth[o.month]||0)+1,s.byYear[o.year]=(s.byYear[o.year]||0)+1}),S(t,s,"stats"),s}catch(r){throw console.error("‚ùå Erreur statistiques questions:",r),r}}const Qe=Object.freeze(Object.defineProperty({__proto__:null,buildCacheKey:m,createAuditLog:R,createImportLog:Z,createOrUpdateUser:ee,createQuestion:me,deleteQuestion:Ae,getAllUsers:K,getAllUsersPaginated:ne,getAnnualProgress:he,getCachedValue:I,getLeaderboard:se,getQuestions:fe,getQuestionsStats:_e,getUserProfile:H,getUserQuizResults:de,getUsersStats:ae,importQuestionsFromJSON:be,invalidateByDataType:X,invalidateCache:u,isCurrentUserAdmin:oe,saveQuizResult:le,setCachedValue:S,updateMonthlyProgress:D,updateStreak:re,updateUserRole:ie,updateUserStats:te},Symbol.toStringTag,{value:"Module"}));class Me{constructor(){this.state={currentQuiz:null,currentQuestionIndex:0,userAnswers:[],startTime:null,timerInterval:null,questionStartTime:null,pausedDuration:0,isPaused:!1,currentModule:null,currentMonth:null,currentYear:null,currentStreak:0,monthsData:[],currentMonthIndex:null,annualProgress:{},userProfile:null,globalStats:null,topUsers:[],recentActivity:[],allUsers:[],questionsStats:null,usersStats:null,currentUser:null,isDemoMode:!1,clientId:null,isLoading:!1,error:null,notifications:[]},this.listeners=new Map,this.history=[],this.maxHistorySize=50}get(e){if(e.includes(".")){const r=e.split(".");let s=this.state;for(const o of r){if(s==null)return;s=s[o]}return s}return this.state[e]}set(e,r,s=!1){const o=this.get(e);if(e.includes(".")){const n=e.split("."),i=n.pop();let a=this.state;for(const c of n)(!a[c]||typeof a[c]!="object")&&(a[c]={}),a=a[c];a[i]=r}else this.state[e]=r;this.addToHistory(e,r,o),s||this.notify(e,r,o)}update(e){Object.keys(e).forEach(r=>{this.set(r,e[r],!0)}),Object.keys(e).forEach(r=>{this.notify(r,e[r],this.get(r))})}subscribe(e,r){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(r),()=>{const s=this.listeners.get(e);if(s){const o=s.indexOf(r);o>-1&&s.splice(o,1)}}}notify(e,r,s){(this.listeners.get(e)||[]).forEach(n=>{try{n(r,s,e)}catch(i){console.error(`‚ùå Erreur dans listener pour ${e}:`,i)}})}resetQuiz(){this.update({currentQuiz:null,currentQuestionIndex:0,userAnswers:[],startTime:null,timerInterval:null,questionStartTime:null,pausedDuration:0,isPaused:!1,currentModule:null,currentMonth:null,currentYear:null})}resetDashboard(){this.update({monthsData:[],currentMonthIndex:null,annualProgress:{}})}resetAdmin(){this.update({globalStats:null,topUsers:[],recentActivity:[],allUsers:[],questionsStats:null,usersStats:null})}reset(){this.resetQuiz(),this.resetDashboard(),this.resetAdmin(),this.set("error",null),this.set("isLoading",!1)}addToHistory(e,r,s){this.history.push({key:e,newValue:r,oldValue:s,timestamp:Date.now()}),this.history.length>this.maxHistorySize&&this.history.shift()}getHistory(e=null){return e?this.history.filter(r=>r.key===e):[...this.history]}getSnapshot(){return JSON.parse(JSON.stringify(this.state))}restoreSnapshot(e){this.state=JSON.parse(JSON.stringify(e)),Object.keys(e).forEach(r=>{this.notify(r,e[r],this.get(r))})}has(e){if(e.includes(".")){const r=e.split(".");let s=this.state;for(const o of r){if(s==null||!(o in s))return!1;s=s[o]}return!0}return e in this.state}delete(e){const r=this.get(e);if(e.includes(".")){const s=e.split("."),o=s.pop();let n=this.state;for(const i of s){if(!n[i]||typeof n[i]!="object")return;n=n[i]}delete n[o]}else delete this.state[e];this.addToHistory(e,void 0,r),this.notify(e,void 0,r)}}const Oe=new Me;export{Q as M,fe as a,_e as b,ee as c,me as d,Ae as e,ne as f,H as g,ae as h,be as i,p as j,le as k,ce as l,he as m,x as n,q as o,re as p,qe as q,Pe as r,Oe as s,Qe as t,ie as u};
//# sourceMappingURL=services-CfagOv0X.js.map
