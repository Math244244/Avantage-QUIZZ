{"version":3,"file":"state-manager-w7-wWzCS.js","sources":["../../js/state-manager.js"],"sourcesContent":["/**\n * Gestionnaire d'État Centralisé\n * \n * ✅ CORRECTION SECTION 5 : Centralisation des variables globales\n * \n * Remplace toutes les variables globales éparpillées dans :\n * - js/quiz.js\n * - js/dashboard.js\n * - js/admin-dashboard.js\n * - etc.\n * \n * Avantages :\n * - État centralisé et traçable\n * - Pas de conflits de noms\n * - Tests facilités\n * - Reset automatique possible\n */\n\nclass StateManager {\n    constructor() {\n        // État initial\n        this.state = {\n            // Quiz state\n            currentQuiz: null,\n            currentQuestionIndex: 0,\n            userAnswers: [],\n            startTime: null,\n            timerInterval: null,\n            questionStartTime: null,\n            pausedDuration: 0,\n            isPaused: false,\n            currentModule: null,\n            currentMonth: null,\n            currentYear: null,\n            currentStreak: 0,\n            \n            // Dashboard state\n            monthsData: [],\n            currentMonthIndex: null,\n            annualProgress: {},\n            userProfile: null,\n            \n            // Admin state\n            globalStats: null,\n            topUsers: [],\n            recentActivity: [],\n            allUsers: [],\n            questionsStats: null,\n            usersStats: null,\n            \n            // Auth state\n            currentUser: null,\n            isDemoMode: false,\n            clientId: null,\n            \n            // UI state\n            isLoading: false,\n            error: null,\n            notifications: []\n        };\n        \n        // Listeners pour les changements d'état\n        this.listeners = new Map();\n        \n        // Historique pour le debug (optionnel)\n        this.history = [];\n        this.maxHistorySize = 50;\n    }\n    \n    /**\n     * Obtenir une valeur de l'état\n     * @param {string} key - Clé de l'état\n     * @returns {*} Valeur de l'état\n     */\n    get(key) {\n        if (key.includes('.')) {\n            // Support pour les clés imbriquées (ex: 'quiz.currentQuestionIndex')\n            const keys = key.split('.');\n            let value = this.state;\n            for (const k of keys) {\n                if (value == null) return undefined;\n                value = value[k];\n            }\n            return value;\n        }\n        return this.state[key];\n    }\n    \n    /**\n     * Définir une valeur dans l'état\n     * @param {string} key - Clé de l'état\n     * @param {*} value - Nouvelle valeur\n     * @param {boolean} silent - Si true, ne déclenche pas les listeners\n     */\n    set(key, value, silent = false) {\n        const oldValue = this.get(key);\n        \n        if (key.includes('.')) {\n            // Support pour les clés imbriquées\n            const keys = key.split('.');\n            const lastKey = keys.pop();\n            let target = this.state;\n            for (const k of keys) {\n                if (!target[k] || typeof target[k] !== 'object') {\n                    target[k] = {};\n                }\n                target = target[k];\n            }\n            target[lastKey] = value;\n        } else {\n            this.state[key] = value;\n        }\n        \n        // Ajouter à l'historique\n        this.addToHistory(key, value, oldValue);\n        \n        // Notifier les listeners\n        if (!silent) {\n            this.notify(key, value, oldValue);\n        }\n    }\n    \n    /**\n     * Mettre à jour plusieurs valeurs en une fois\n     * @param {Object} updates - Objet avec les clés/valeurs à mettre à jour\n     */\n    update(updates) {\n        Object.keys(updates).forEach(key => {\n            this.set(key, updates[key], true);\n        });\n        // Notifier une seule fois pour toutes les mises à jour\n        Object.keys(updates).forEach(key => {\n            this.notify(key, updates[key], this.get(key));\n        });\n    }\n    \n    /**\n     * S'abonner aux changements d'une clé\n     * @param {string} key - Clé à écouter\n     * @param {Function} callback - Fonction appelée lors du changement\n     * @returns {Function} Fonction de désabonnement\n     */\n    subscribe(key, callback) {\n        if (!this.listeners.has(key)) {\n            this.listeners.set(key, []);\n        }\n        this.listeners.get(key).push(callback);\n        \n        // Retourner fonction de désabonnement\n        return () => {\n            const callbacks = this.listeners.get(key);\n            if (callbacks) {\n                const index = callbacks.indexOf(callback);\n                if (index > -1) {\n                    callbacks.splice(index, 1);\n                }\n            }\n        };\n    }\n    \n    /**\n     * Notifier les listeners d'un changement\n     * @param {string} key - Clé modifiée\n     * @param {*} newValue - Nouvelle valeur\n     * @param {*} oldValue - Ancienne valeur\n     */\n    notify(key, newValue, oldValue) {\n        const callbacks = this.listeners.get(key) || [];\n        callbacks.forEach(callback => {\n            try {\n                callback(newValue, oldValue, key);\n            } catch (error) {\n                console.error(`❌ Erreur dans listener pour ${key}:`, error);\n            }\n        });\n    }\n    \n    /**\n     * Réinitialiser l'état du quiz\n     */\n    resetQuiz() {\n        this.update({\n            currentQuiz: null,\n            currentQuestionIndex: 0,\n            userAnswers: [],\n            startTime: null,\n            timerInterval: null,\n            questionStartTime: null,\n            pausedDuration: 0,\n            isPaused: false,\n            currentModule: null,\n            currentMonth: null,\n            currentYear: null\n        });\n    }\n    \n    /**\n     * Réinitialiser l'état du dashboard\n     */\n    resetDashboard() {\n        this.update({\n            monthsData: [],\n            currentMonthIndex: null,\n            annualProgress: {}\n        });\n    }\n    \n    /**\n     * Réinitialiser l'état admin\n     */\n    resetAdmin() {\n        this.update({\n            globalStats: null,\n            topUsers: [],\n            recentActivity: [],\n            allUsers: [],\n            questionsStats: null,\n            usersStats: null\n        });\n    }\n    \n    /**\n     * Réinitialiser tout l'état (sauf auth)\n     */\n    reset() {\n        this.resetQuiz();\n        this.resetDashboard();\n        this.resetAdmin();\n        this.set('error', null);\n        this.set('isLoading', false);\n    }\n    \n    /**\n     * Ajouter une entrée à l'historique\n     * @param {string} key - Clé modifiée\n     * @param {*} newValue - Nouvelle valeur\n     * @param {*} oldValue - Ancienne valeur\n     */\n    addToHistory(key, newValue, oldValue) {\n        this.history.push({\n            key,\n            newValue,\n            oldValue,\n            timestamp: Date.now()\n        });\n        \n        // Limiter la taille de l'historique\n        if (this.history.length > this.maxHistorySize) {\n            this.history.shift();\n        }\n    }\n    \n    /**\n     * Obtenir l'historique des changements\n     * @param {string} key - Filtrer par clé (optionnel)\n     * @returns {Array} Historique\n     */\n    getHistory(key = null) {\n        if (key) {\n            return this.history.filter(entry => entry.key === key);\n        }\n        return [...this.history];\n    }\n    \n    /**\n     * Obtenir un snapshot de l'état complet\n     * @returns {Object} Copie de l'état\n     */\n    getSnapshot() {\n        return JSON.parse(JSON.stringify(this.state));\n    }\n    \n    /**\n     * Restaurer un snapshot de l'état\n     * @param {Object} snapshot - Snapshot à restaurer\n     */\n    restoreSnapshot(snapshot) {\n        this.state = JSON.parse(JSON.stringify(snapshot));\n        // Notifier tous les listeners\n        Object.keys(snapshot).forEach(key => {\n            this.notify(key, snapshot[key], this.get(key));\n        });\n    }\n    \n    /**\n     * Vérifier si une clé existe dans l'état\n     * @param {string} key - Clé à vérifier\n     * @returns {boolean} True si la clé existe\n     */\n    has(key) {\n        if (key.includes('.')) {\n            const keys = key.split('.');\n            let value = this.state;\n            for (const k of keys) {\n                if (value == null || !(k in value)) return false;\n                value = value[k];\n            }\n            return true;\n        }\n        return key in this.state;\n    }\n    \n    /**\n     * Supprimer une clé de l'état\n     * @param {string} key - Clé à supprimer\n     */\n    delete(key) {\n        const oldValue = this.get(key);\n        \n        if (key.includes('.')) {\n            const keys = key.split('.');\n            const lastKey = keys.pop();\n            let target = this.state;\n            for (const k of keys) {\n                if (!target[k] || typeof target[k] !== 'object') {\n                    return; // Clé non trouvée\n                }\n                target = target[k];\n            }\n            delete target[lastKey];\n        } else {\n            delete this.state[key];\n        }\n        \n        this.addToHistory(key, undefined, oldValue);\n        this.notify(key, undefined, oldValue);\n    }\n}\n\n// Export singleton\nexport const stateManager = new StateManager();\n\n// Export de la classe pour les tests\nexport { StateManager };\n\n// Helpers pour faciliter l'utilisation\nexport const state = {\n    get: (key) => stateManager.get(key),\n    set: (key, value) => stateManager.set(key, value),\n    update: (updates) => stateManager.update(updates),\n    subscribe: (key, callback) => stateManager.subscribe(key, callback),\n    reset: () => stateManager.reset(),\n    resetQuiz: () => stateManager.resetQuiz(),\n    resetDashboard: () => stateManager.resetDashboard(),\n    resetAdmin: () => stateManager.resetAdmin()\n};\n\n"],"names":["StateManager","key","keys","value","k","silent","oldValue","lastKey","target","updates","callback","callbacks","index","newValue","error","entry","snapshot","stateManager"],"mappings":"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"}