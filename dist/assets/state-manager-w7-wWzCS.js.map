{"version":3,"file":"state-manager-w7-wWzCS.js","sources":["../../js/state-manager.js"],"sourcesContent":["/**\r\n * Gestionnaire d'État Centralisé\r\n * \r\n * ✅ CORRECTION SECTION 5 : Centralisation des variables globales\r\n * \r\n * Remplace toutes les variables globales éparpillées dans :\r\n * - js/quiz.js\r\n * - js/dashboard.js\r\n * - js/admin-dashboard.js\r\n * - etc.\r\n * \r\n * Avantages :\r\n * - État centralisé et traçable\r\n * - Pas de conflits de noms\r\n * - Tests facilités\r\n * - Reset automatique possible\r\n */\r\n\r\nclass StateManager {\r\n    constructor() {\r\n        // État initial\r\n        this.state = {\r\n            // Quiz state\r\n            currentQuiz: null,\r\n            currentQuestionIndex: 0,\r\n            userAnswers: [],\r\n            startTime: null,\r\n            timerInterval: null,\r\n            questionStartTime: null,\r\n            pausedDuration: 0,\r\n            isPaused: false,\r\n            currentModule: null,\r\n            currentMonth: null,\r\n            currentYear: null,\r\n            currentStreak: 0,\r\n            \r\n            // Dashboard state\r\n            monthsData: [],\r\n            currentMonthIndex: null,\r\n            annualProgress: {},\r\n            userProfile: null,\r\n            \r\n            // Admin state\r\n            globalStats: null,\r\n            topUsers: [],\r\n            recentActivity: [],\r\n            allUsers: [],\r\n            questionsStats: null,\r\n            usersStats: null,\r\n            \r\n            // Auth state\r\n            currentUser: null,\r\n            isDemoMode: false,\r\n            clientId: null,\r\n            \r\n            // UI state\r\n            isLoading: false,\r\n            error: null,\r\n            notifications: []\r\n        };\r\n        \r\n        // Listeners pour les changements d'état\r\n        this.listeners = new Map();\r\n        \r\n        // Historique pour le debug (optionnel)\r\n        this.history = [];\r\n        this.maxHistorySize = 50;\r\n    }\r\n    \r\n    /**\r\n     * Obtenir une valeur de l'état\r\n     * @param {string} key - Clé de l'état\r\n     * @returns {*} Valeur de l'état\r\n     */\r\n    get(key) {\r\n        if (key.includes('.')) {\r\n            // Support pour les clés imbriquées (ex: 'quiz.currentQuestionIndex')\r\n            const keys = key.split('.');\r\n            let value = this.state;\r\n            for (const k of keys) {\r\n                if (value == null) return undefined;\r\n                value = value[k];\r\n            }\r\n            return value;\r\n        }\r\n        return this.state[key];\r\n    }\r\n    \r\n    /**\r\n     * Définir une valeur dans l'état\r\n     * @param {string} key - Clé de l'état\r\n     * @param {*} value - Nouvelle valeur\r\n     * @param {boolean} silent - Si true, ne déclenche pas les listeners\r\n     */\r\n    set(key, value, silent = false) {\r\n        const oldValue = this.get(key);\r\n        \r\n        if (key.includes('.')) {\r\n            // Support pour les clés imbriquées\r\n            const keys = key.split('.');\r\n            const lastKey = keys.pop();\r\n            let target = this.state;\r\n            for (const k of keys) {\r\n                if (!target[k] || typeof target[k] !== 'object') {\r\n                    target[k] = {};\r\n                }\r\n                target = target[k];\r\n            }\r\n            target[lastKey] = value;\r\n        } else {\r\n            this.state[key] = value;\r\n        }\r\n        \r\n        // Ajouter à l'historique\r\n        this.addToHistory(key, value, oldValue);\r\n        \r\n        // Notifier les listeners\r\n        if (!silent) {\r\n            this.notify(key, value, oldValue);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Mettre à jour plusieurs valeurs en une fois\r\n     * @param {Object} updates - Objet avec les clés/valeurs à mettre à jour\r\n     */\r\n    update(updates) {\r\n        Object.keys(updates).forEach(key => {\r\n            this.set(key, updates[key], true);\r\n        });\r\n        // Notifier une seule fois pour toutes les mises à jour\r\n        Object.keys(updates).forEach(key => {\r\n            this.notify(key, updates[key], this.get(key));\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * S'abonner aux changements d'une clé\r\n     * @param {string} key - Clé à écouter\r\n     * @param {Function} callback - Fonction appelée lors du changement\r\n     * @returns {Function} Fonction de désabonnement\r\n     */\r\n    subscribe(key, callback) {\r\n        if (!this.listeners.has(key)) {\r\n            this.listeners.set(key, []);\r\n        }\r\n        this.listeners.get(key).push(callback);\r\n        \r\n        // Retourner fonction de désabonnement\r\n        return () => {\r\n            const callbacks = this.listeners.get(key);\r\n            if (callbacks) {\r\n                const index = callbacks.indexOf(callback);\r\n                if (index > -1) {\r\n                    callbacks.splice(index, 1);\r\n                }\r\n            }\r\n        };\r\n    }\r\n    \r\n    /**\r\n     * Notifier les listeners d'un changement\r\n     * @param {string} key - Clé modifiée\r\n     * @param {*} newValue - Nouvelle valeur\r\n     * @param {*} oldValue - Ancienne valeur\r\n     */\r\n    notify(key, newValue, oldValue) {\r\n        const callbacks = this.listeners.get(key) || [];\r\n        callbacks.forEach(callback => {\r\n            try {\r\n                callback(newValue, oldValue, key);\r\n            } catch (error) {\r\n                console.error(`❌ Erreur dans listener pour ${key}:`, error);\r\n            }\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Réinitialiser l'état du quiz\r\n     */\r\n    resetQuiz() {\r\n        this.update({\r\n            currentQuiz: null,\r\n            currentQuestionIndex: 0,\r\n            userAnswers: [],\r\n            startTime: null,\r\n            timerInterval: null,\r\n            questionStartTime: null,\r\n            pausedDuration: 0,\r\n            isPaused: false,\r\n            currentModule: null,\r\n            currentMonth: null,\r\n            currentYear: null\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Réinitialiser l'état du dashboard\r\n     */\r\n    resetDashboard() {\r\n        this.update({\r\n            monthsData: [],\r\n            currentMonthIndex: null,\r\n            annualProgress: {}\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Réinitialiser l'état admin\r\n     */\r\n    resetAdmin() {\r\n        this.update({\r\n            globalStats: null,\r\n            topUsers: [],\r\n            recentActivity: [],\r\n            allUsers: [],\r\n            questionsStats: null,\r\n            usersStats: null\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Réinitialiser tout l'état (sauf auth)\r\n     */\r\n    reset() {\r\n        this.resetQuiz();\r\n        this.resetDashboard();\r\n        this.resetAdmin();\r\n        this.set('error', null);\r\n        this.set('isLoading', false);\r\n    }\r\n    \r\n    /**\r\n     * Ajouter une entrée à l'historique\r\n     * @param {string} key - Clé modifiée\r\n     * @param {*} newValue - Nouvelle valeur\r\n     * @param {*} oldValue - Ancienne valeur\r\n     */\r\n    addToHistory(key, newValue, oldValue) {\r\n        this.history.push({\r\n            key,\r\n            newValue,\r\n            oldValue,\r\n            timestamp: Date.now()\r\n        });\r\n        \r\n        // Limiter la taille de l'historique\r\n        if (this.history.length > this.maxHistorySize) {\r\n            this.history.shift();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Obtenir l'historique des changements\r\n     * @param {string} key - Filtrer par clé (optionnel)\r\n     * @returns {Array} Historique\r\n     */\r\n    getHistory(key = null) {\r\n        if (key) {\r\n            return this.history.filter(entry => entry.key === key);\r\n        }\r\n        return [...this.history];\r\n    }\r\n    \r\n    /**\r\n     * Obtenir un snapshot de l'état complet\r\n     * @returns {Object} Copie de l'état\r\n     */\r\n    getSnapshot() {\r\n        return JSON.parse(JSON.stringify(this.state));\r\n    }\r\n    \r\n    /**\r\n     * Restaurer un snapshot de l'état\r\n     * @param {Object} snapshot - Snapshot à restaurer\r\n     */\r\n    restoreSnapshot(snapshot) {\r\n        this.state = JSON.parse(JSON.stringify(snapshot));\r\n        // Notifier tous les listeners\r\n        Object.keys(snapshot).forEach(key => {\r\n            this.notify(key, snapshot[key], this.get(key));\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Vérifier si une clé existe dans l'état\r\n     * @param {string} key - Clé à vérifier\r\n     * @returns {boolean} True si la clé existe\r\n     */\r\n    has(key) {\r\n        if (key.includes('.')) {\r\n            const keys = key.split('.');\r\n            let value = this.state;\r\n            for (const k of keys) {\r\n                if (value == null || !(k in value)) return false;\r\n                value = value[k];\r\n            }\r\n            return true;\r\n        }\r\n        return key in this.state;\r\n    }\r\n    \r\n    /**\r\n     * Supprimer une clé de l'état\r\n     * @param {string} key - Clé à supprimer\r\n     */\r\n    delete(key) {\r\n        const oldValue = this.get(key);\r\n        \r\n        if (key.includes('.')) {\r\n            const keys = key.split('.');\r\n            const lastKey = keys.pop();\r\n            let target = this.state;\r\n            for (const k of keys) {\r\n                if (!target[k] || typeof target[k] !== 'object') {\r\n                    return; // Clé non trouvée\r\n                }\r\n                target = target[k];\r\n            }\r\n            delete target[lastKey];\r\n        } else {\r\n            delete this.state[key];\r\n        }\r\n        \r\n        this.addToHistory(key, undefined, oldValue);\r\n        this.notify(key, undefined, oldValue);\r\n    }\r\n}\r\n\r\n// Export singleton\r\nexport const stateManager = new StateManager();\r\n\r\n// Export de la classe pour les tests\r\nexport { StateManager };\r\n\r\n// Helpers pour faciliter l'utilisation\r\nexport const state = {\r\n    get: (key) => stateManager.get(key),\r\n    set: (key, value) => stateManager.set(key, value),\r\n    update: (updates) => stateManager.update(updates),\r\n    subscribe: (key, callback) => stateManager.subscribe(key, callback),\r\n    reset: () => stateManager.reset(),\r\n    resetQuiz: () => stateManager.resetQuiz(),\r\n    resetDashboard: () => stateManager.resetDashboard(),\r\n    resetAdmin: () => stateManager.resetAdmin()\r\n};\r\n\r\n"],"names":["StateManager","key","keys","value","k","silent","oldValue","lastKey","target","updates","callback","callbacks","index","newValue","error","entry","snapshot","stateManager"],"mappings":"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"}