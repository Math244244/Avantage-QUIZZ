const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/admin-B91asJY5.js","assets/services-DC78fAiO.js","assets/main-DHR9FbbX.js","assets/sidebar-mobile-DByD8RDs.js","assets/sidebar-mobile-Bz3_lA1a.css","assets/main-CkpSfDvD.css"])))=>i.map(i=>d[i]);
import{a as $,b as qe,i as C,l as z,t as g,_ as v,s as ze,u as I,e as x,d as X,g as _e}from"./admin-B91asJY5.js";import{query as Z,collection as J,where as y,getDocs as ee}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{s as u,k as te}from"./services-DC78fAiO.js";import{getAnalytics as Me,setUserId as Te,setUserProperties as ke,logEvent as j}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";const Ce={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},M=typeof window<"u",Re=typeof document<"u",Se=typeof navigator<"u",De=typeof import.meta<"u"&&!!import.meta.vitest,Le=typeof import.meta<"u"&&Ce&&!1,ne=De||Le,$e=Se&&"serviceWorker"in navigator;let f=null;function se(){return M&&window.location?{path:window.location.pathname,href:window.location.href}:{path:"/test",href:"https://localhost/test"}}function oe(){try{return f||(M&&$e||ne?(f=Me(qe),console.log("‚úÖ Firebase Analytics initialis√©")):console.warn("‚ö†Ô∏è Firebase Analytics non disponible dans cet environnement"),f)}catch(e){return console.error("‚ùå Erreur initialisation Analytics:",e),null}}function U(e,t={}){if(!f){console.log(`[Analytics] ${e}`,t);return}try{const{path:r}=se();j(f,e,{...t,timestamp:Date.now(),page:r}),console.log(`üìä Event tracked: ${e}`,t)}catch(r){console.error("‚ùå Erreur tracking √©v√©nement:",r)}}function Ie(e,t={}){if(!f){console.error("[Analytics Error]",e,t);return}try{j(f,"exception",{description:e.message||"Unknown error",fatal:!1,error_type:e.name||"Error",error_stack:e.stack?.substring(0,500)||"",...t}),console.error("üìä Error tracked:",e.message)}catch(r){console.error("‚ùå Erreur tracking erreur:",r)}}function ae(e){if(f)try{Te(f,e),console.log("‚úÖ Analytics user set:",e)}catch(t){console.error("‚ùå Erreur d√©finition utilisateur Analytics:",t)}}function ie(e){if(f)try{ke(f,e),console.log("‚úÖ Analytics user properties set:",e)}catch(t){console.error("‚ùå Erreur d√©finition propri√©t√©s utilisateur:",t)}}function Be(e,t){if(!f){console.log(`[Analytics PageView] ${e} - ${t}`);return}try{const{path:r,href:n}=se();j(f,"page_view",{page_title:e,page_location:n,page_path:t||r}),console.log(`üìä Page view tracked: ${e}`)}catch(r){console.error("‚ùå Erreur tracking page view:",r)}}function le(e,t){U("quiz_start",{module_id:e,month:t})}function ce(e,t,r,n){U("quiz_complete",{module_id:e,score:t,time_elapsed:r,total_questions:n,passed:t>=60})}const Qe=M||ne;if(Qe){const e=()=>{try{oe(),$&&typeof $.onAuthStateChanged=="function"&&$.onAuthStateChanged(t=>{t&&(ae(t.uid),ie({email:t.email||"",display_name:t.displayName||""}))})}catch(t){console.warn("‚ö†Ô∏è Analytics auto-init skipped:",t.message)}};Re&&document.readyState==="loading"&&M?document.addEventListener("DOMContentLoaded",e):M&&setTimeout(e,0)}const Pe=Object.freeze(Object.defineProperty({__proto__:null,initAnalytics:oe,setAnalyticsUser:ae,setAnalyticsUserProperties:ie,trackError:Ie,trackEvent:U,trackPageView:Be,trackQuizComplete:ce,trackQuizStart:le},Symbol.toStringTag,{value:"Module"}));var Oe={};class O extends Error{constructor(t){super(`Trop de requ√™tes. Veuillez patienter ${Math.ceil(t/1e3)} secondes.`),this.name="RateLimitError",this.waitTimeMs=t}}class ue{constructor(t,r){this.maxRequests=t,this.windowMs=r,this.requests=[]}_cleanup(t=Date.now()){this.requests=this.requests.filter(r=>t-r<this.windowMs)}canExecute(){const t=Date.now();return this._cleanup(t),this.requests.length<this.maxRequests?(this.requests.push(t),!0):!1}getRemainingTime(){const t=Date.now();if(this._cleanup(t),this.requests.length===0)return 0;const r=this.requests[0];return Math.max(0,this.windowMs-(t-r))}async check(){if(this.canExecute())return;const t=this.getRemainingTime()||this.windowMs;throw new O(t)}reset(){this.requests=[]}getRemainingRequests(){return this._cleanup(),Math.max(0,this.maxRequests-this.requests.length)}}const Ve=()=>typeof window<"u"&&typeof window.happyDOM<"u",Ne=()=>typeof globalThis<"u"&&!!globalThis.__vitest_worker__;function de(){return!!(Ve()||Ne()||typeof navigator<"u"&&/happy\s?dom|jsdom/i.test(navigator.userAgent||"")||typeof globalThis<"u"&&globalThis.__vitest_browser__||typeof import.meta<"u"&&import.meta.vitest||typeof process<"u"&&Oe?.npm_lifecycle_event==="test")}function me(){return de()?1e3:6e4}let B=null,Q=null;function je(){return B||(B=new ue(100,me())),B}function Ue(){return Q||(Q=new ue(50,me())),Q}function Fe(e){return e<=0?Promise.resolve():new Promise(t=>setTimeout(t,e))}async function pe(e,t={}){const r=t.isWrite?Ue():je(),n=t.maxRetry??5;let s=0;const a=de();for(;s<=n;)try{return await r.check(),await e()}catch(o){if(o instanceof O){console.warn("‚ö†Ô∏è Rate limit atteint:",o.message),s+=1;const l=a?Math.min(o.waitTimeMs,1e3):o.waitTimeMs;await Fe(l);continue}throw o}throw new O(r.getRemainingTime()||r.windowMs)}async function Rt(e){return pe(e,{isWrite:!1})}async function St(e){return pe(e,{isWrite:!0})}const h={NETWORK:"NETWORK",FIRESTORE:"FIRESTORE",AUTH:"AUTH",VALIDATION:"VALIDATION",UNKNOWN:"UNKNOWN"};class We{constructor(){this.errorLog=[],this.maxLogSize=100,this.setupGlobalHandlers()}setupGlobalHandlers(){window.addEventListener("error",t=>{this.handleError({message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,error:t.error,type:h.UNKNOWN},"Global error handler")}),window.addEventListener("unhandledrejection",t=>{this.handleError({message:t.reason?.message||"Unhandled promise rejection",error:t.reason,type:h.UNKNOWN},"Unhandled promise rejection")})}handleError(t,r="Unknown",n={}){const s=this.normalizeError(t,r,n);return this.logError(s),n.showToUser!==!1&&this.showUserMessage(s,n),n.critical&&!C()&&this.sendToFirestore(s).catch(a=>{z.error("Impossible d'envoyer l'erreur √† Firestore:",a)}),s}normalizeError(t,r,n){const s={message:t?.message||String(t)||"Erreur inconnue",stack:t?.stack,context:r,type:this.detectErrorType(t),timestamp:new Date().toISOString(),url:window.location.href,userAgent:navigator.userAgent,...n.metadata};return t?.code&&(s.code=t.code),t?.name&&(s.name=t.name),s}detectErrorType(t){if(!t)return h.UNKNOWN;const r=(t.message||"").toLowerCase(),n=t.code||"";return n==="unavailable"||n==="deadline-exceeded"||r.includes("network")||r.includes("fetch")?h.NETWORK:n==="permission-denied"||n==="unauthenticated"||r.includes("auth")?h.AUTH:n==="invalid-argument"||n==="failed-precondition"||r.includes("validation")?h.VALIDATION:r.includes("firestore")||n.startsWith("firestore")?h.FIRESTORE:h.UNKNOWN}logError(t){this.errorLog.push(t),this.errorLog.length>this.maxLogSize&&this.errorLog.shift();const r=`[${t.type}] ${t.context}: ${t.message}`;t.type===h.NETWORK?z.warn(r,t):z.error(r,t)}showUserMessage(t,r){let n=r.userMessage;if(!n)switch(t.type){case h.NETWORK:n="Probl√®me de connexion. V√©rifiez votre connexion internet.";break;case h.AUTH:n="Erreur d'authentification. Veuillez vous reconnecter.";break;case h.VALIDATION:n="Donn√©es invalides. Veuillez v√©rifier vos informations.";break;case h.FIRESTORE:n="Erreur lors de l'acc√®s aux donn√©es. Veuillez r√©essayer.";break;default:n="Une erreur est survenue. Veuillez r√©essayer."}const s=r.duration||(t.type===h.NETWORK?8e3:5e3);g.error(n,s)}async sendToFirestore(t){try{const{trackError:r}=await v(async()=>{const{trackError:n}=await Promise.resolve().then(()=>Pe);return{trackError:n}},void 0);r(new Error(t.message),{error_type:t.type,error_source:t.source,user_id:t.userId||"anonymous"})}catch{console.warn("Analytics non disponible pour tracking erreur")}try{const{db:r}=await v(async()=>{const{db:i}=await import("./admin-B91asJY5.js").then(c=>c.y);return{db:i}},__vite__mapDeps([0,1])),{collection:n,addDoc:s,Timestamp:a}=await v(async()=>{const{collection:i,addDoc:c,Timestamp:d}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{collection:i,addDoc:c,Timestamp:d}},[]),{isCurrentUserAdmin:o}=await v(async()=>{const{isCurrentUserAdmin:i}=await import("./services-DC78fAiO.js").then(c=>c.t);return{isCurrentUserAdmin:i}},__vite__mapDeps([1,0]));if(!await o())return;await s(n(r,"errorLogs"),{...t,timestamp:a.now()})}catch(r){console.error("Impossible d'envoyer l'erreur √† Firestore:",r)}}getRecentErrors(t=10){return this.errorLog.slice(-t)}clearErrorLog(){this.errorLog=[]}}const He=new We,Ke={maxRetries:3,initialDelay:1e3,maxDelay:3e4,backoffMultiplier:2,retryableErrors:["unavailable","deadline-exceeded","internal","aborted"],onRetry:null};function re(e,t){if(!e)return!1;const r=e.code||"",n=(e.message||"").toLowerCase();return r==="unavailable"||r==="deadline-exceeded"||n.includes("network")||n.includes("fetch failed")?!0:t.some(s=>r===s||n.includes(s.toLowerCase()))}function Ye(e,t,r,n){const s=t*Math.pow(n,e);return Math.min(s,r)}function Ge(e){return new Promise(t=>setTimeout(t,e))}async function Xe(e,t={}){const r={...Ke,...t};let n;try{return await e()}catch(s){if(n=s,!re(s,r.retryableErrors))throw s}for(let s=0;s<r.maxRetries;s++){const a=Ye(s,r.initialDelay,r.maxDelay,r.backoffMultiplier);r.onRetry?r.onRetry(s+1,a,n):z.warn(`Nouvelle tentative ${s+1}/${r.maxRetries} dans ${a}ms...`),await Ge(a);try{return await e()}catch(o){if(n=o,!re(o,r.retryableErrors))throw o;if(s===r.maxRetries-1)throw He.handleError(o,"Retry handler - Max retries reached",{showToUser:!0,userMessage:`√âchec apr√®s ${r.maxRetries} tentatives. Veuillez r√©essayer plus tard.`}),o}}throw n}async function Ze(e,t={}){return Xe(e,{...t,retryableErrors:["unavailable","deadline-exceeded","internal","aborted","resource-exhausted"],onRetry:t.onRetry||((r,n)=>{z.warn(`Retry Firestore ${r}/${t.maxRetries||3} dans ${n}ms...`)})})}function Je(){const e=document.createElement("canvas");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="9999",document.body.appendChild(e);const t=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const r=[],n=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#F7DC6F","#BB8FCE","#85C1E2"];for(let a=0;a<150;a++)r.push({x:Math.random()*e.width,y:e.height+Math.random()*100,size:Math.random()*8+4,speedY:-(Math.random()*3+3),speedX:Math.random()*6-3,color:n[Math.floor(Math.random()*n.length)],rotation:Math.random()*360,rotationSpeed:Math.random()*10-5,gravity:.15,opacity:1});function s(){t.clearRect(0,0,e.width,e.height);let a=0;r.forEach((o,l)=>{o.speedY+=o.gravity,o.y+=o.speedY,o.x+=o.speedX,o.rotation+=o.rotationSpeed,o.y>e.height-100&&(o.opacity-=.02),o.opacity>0&&o.y<e.height+50&&(a++,t.save(),t.translate(o.x,o.y),t.rotate(o.rotation*Math.PI/180),t.globalAlpha=o.opacity,t.fillStyle=o.color,t.fillRect(-o.size/2,-o.size/2,o.size,o.size),t.restore())}),a>0?requestAnimationFrame(s):e.remove()}s()}const V={auto:{name:"AT-AVE-AVEX",color:"indigo",label:"Auto"},loisir:{name:"VTT, Motoneige, etc.",color:"cyan",label:"Loisir"},vr:{name:"V√©hicules R√©cr√©atifs",color:"orange",label:"VR"},tracteur:{name:"√âquipement Agricole",color:"green",label:"Tracteur"}},b=()=>u.get("currentQuiz"),et=e=>u.set("currentQuiz",e),T=()=>u.get("currentQuestionIndex"),ge=e=>u.set("currentQuestionIndex",e),E=()=>u.get("userAnswers"),he=e=>u.set("userAnswers",e),N=()=>u.get("startTime"),tt=e=>u.set("startTime",e),rt=()=>u.get("timerInterval"),fe=e=>u.set("timerInterval",e),nt=()=>u.get("questionStartTime"),ve=e=>u.set("questionStartTime",e),st=()=>u.get("currentStreak"),xe=e=>u.set("currentStreak",e),F=()=>u.get("isPaused"),k=e=>u.set("isPaused",e),W=()=>u.get("pausedDuration"),R=e=>u.set("pausedDuration",e),H=()=>u.get("pauseStartedAt"),q=e=>u.set("pauseStartedAt",e),_=()=>u.get("currentModule"),ot=e=>u.set("currentModule",e),A=()=>u.get("currentMonth"),at=e=>u.set("currentMonth",e),P=()=>u.get("currentYear"),it=e=>u.set("currentYear",e),lt=()=>u.get("hasCurrentQuestionBeenAnswered"),S=e=>u.set("hasCurrentQuestionBeenAnswered",e),ct=()=>u.get("quizEventDelegationInitialized"),ut=e=>u.set("quizEventDelegationInitialized",e),K={indigo:{bg:"bg-ap-red-primary",text:"text-ap-red-primary",border:"border-ap-red-primary"},cyan:{bg:"bg-ap-gold",text:"text-ap-gold",border:"border-ap-gold"},orange:{bg:"bg-orange-600",text:"text-orange-600",border:"border-orange-600"},green:{bg:"bg-green-600",text:"text-green-600",border:"border-green-600"}};async function dt(e,t,r){console.log(`üì• Chargement des questions: module=${e}, mois=${t}, ann√©e=${r}`);const n=s=>{const a=s.data();return{id:s.id,question:a.question,options:a.options.map((o,l)=>({id:String.fromCharCode(65+l),text:o,correct:l===a.correctAnswer})),explanation:a.explanation||"Pas d'explication disponible",reference:a.reference||"",tags:a.tags||[]}};if(C()){console.log("üìù Mode d√©mo : Chargement des questions simul√©es pour le quiz...");const a=localStorage.getItem("avantage-quizz-demo-questions");let o=[];if(a)try{const l=JSON.parse(a);console.log(`üíæ ${l.length} questions charg√©es depuis localStorage`),o=l.map(i=>({id:i.id,question:i.question,options:i.options.map((c,d)=>({id:String.fromCharCode(65+d),text:c,correct:d===i.correctAnswer})),explanation:i.explanation||"Pas d'explication disponible",reference:i.reference||"",tags:i.tags||[]})),o=o.filter(i=>{const c=!e||l.find(m=>m.id===i.id)?.module===e,d=!t||l.find(m=>m.id===i.id)?.month===t;return c&&d})}catch{console.warn("‚ö†Ô∏è Erreur lecture localStorage, utilisation questions par d√©faut")}return o.length===0&&(console.log("üì¶ Utilisation questions par d√©faut (aucune en localStorage)"),o=[{id:"demo-1",question:"Quelle est la vitesse maximale autoris√©e sur une autoroute au Qu√©bec ?",options:[{id:"A",text:"100 km/h",correct:!1},{id:"B",text:"110 km/h",correct:!1},{id:"C",text:"120 km/h",correct:!1},{id:"D",text:"100 km/h (conditions normales)",correct:!0}],explanation:"La vitesse maximale sur autoroute au Qu√©bec est de 100 km/h, sauf indication contraire.",reference:"Code de la s√©curit√© routi√®re du Qu√©bec",tags:["vitesse","autoroute"]},{id:"demo-2",question:"√Ä quelle distance minimale devez-vous vous arr√™ter derri√®re un autobus scolaire dont les feux clignotent ?",options:[{id:"A",text:"3 m√®tres",correct:!1},{id:"B",text:"5 m√®tres",correct:!0},{id:"C",text:"10 m√®tres",correct:!1},{id:"D",text:"15 m√®tres",correct:!1}],explanation:"Vous devez vous arr√™ter √† au moins 5 m√®tres d'un autobus scolaire.",reference:"Article 460 CSR",tags:["autobus","s√©curit√©"]},{id:"demo-3",question:"Quel est le taux d'alcool√©mie maximal pour conduire au Qu√©bec ?",options:[{id:"A",text:"0.05",correct:!1},{id:"B",text:"0.08",correct:!0},{id:"C",text:"0.10",correct:!1},{id:"D",text:"0.00",correct:!1}],explanation:"Le taux maximal est de 0.08 pour conducteurs exp√©riment√©s.",reference:"Code criminel du Canada",tags:["alcool","s√©curit√©"]},{id:"demo-4",question:"Combien de points d'inaptitude entra√Æne un exc√®s de vitesse de 30 km/h ?",options:[{id:"A",text:"2 points",correct:!1},{id:"B",text:"3 points",correct:!0},{id:"C",text:"4 points",correct:!1},{id:"D",text:"5 points",correct:!1}],explanation:"Un exc√®s de 21 √† 30 km/h entra√Æne 3 points.",reference:"SAAQ",tags:["vitesse","points"]},{id:"demo-5",question:"Quelle est la distance de s√©curit√© recommand√©e entre v√©hicules ?",options:[{id:"A",text:"1 seconde",correct:!1},{id:"B",text:"2 secondes",correct:!0},{id:"C",text:"3 secondes",correct:!1},{id:"D",text:"5 secondes",correct:!1}],explanation:"La r√®gle des 2 secondes est recommand√©e.",reference:"Guide SAAQ",tags:["distance","s√©curit√©"]}]),console.log(`‚úÖ ${o.length} questions d√©mo charg√©es pour le quiz`),o}try{let s=Z(J(X,"questions"),y("module","==",e),y("month","==",t),y("year","==",r)),a=await ee(s);if(!a.empty){const d=[];return a.forEach(m=>d.push(n(m))),console.log(`‚úÖ ${d.length} questions (mois num√©rique)`),d}const l=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"][t-1],i=l.charAt(0).toUpperCase()+l.slice(1).toLowerCase();let c=Z(J(X,"questions"),y("module","==",e),y("month","==",i),y("year","==",r));if(a=await ee(c),!a.empty){const d=[];return a.forEach(m=>d.push(n(m))),console.log(`‚úÖ ${d.length} questions (mois texte)`),d}return console.warn("‚ö†Ô∏è Aucune question trouv√©e pour ces crit√®res (num√©rique/texte)"),[]}catch(s){throw console.error("‚ùå Erreur lors du chargement des questions:",s),s}}async function mt(e,t,r){try{const n=await fetch("/test-questions-valides.json");if(!n.ok)return[];const s=await n.json(),o=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"][t-1];return s.filter(i=>i.module===e&&i.year===r&&(i.month===o||i.month===t)).map((i,c)=>({id:`demo-${e}-${c}`,question:i.question,options:i.options.map((d,m)=>({id:String.fromCharCode(65+m),text:d,correct:m===i.correctAnswer})),explanation:i.explanation||"Pas d'explication disponible",reference:i.reference||"",tags:i.tags||[]}))}catch(n){return console.warn("Demo questions fallback error:",n),[]}}async function pt(e){const t=V[e];if(!t){console.error("Module de quiz non trouv√©:",e),g.error("Module non trouv√©. Veuillez r√©essayer.");return}const r=ze(`Chargement du quiz ${t.label}...`);gt(t.label);try{const{getCurrentMonthNumber:n,getCurrentYear:s,normalizeMonthFormat:a}=await v(async()=>{const{getCurrentMonthNumber:m,getCurrentYear:D,normalizeMonthFormat:L}=await import("./services-DC78fAiO.js").then(p=>p.r);return{getCurrentMonthNumber:m,getCurrentYear:D,normalizeMonthFormat:L}},__vite__mapDeps([1,0])),o=n(),l=s(),i=a(o,l);at(i),it(l),ot(e);try{window.__QUIZ_ACTIVE=!0}catch{}let c=await dt(e,o,l);if(c.length===0&&C()&&(console.log("‚ÑπÔ∏è Mode D√©mo: chargement des questions locales de test"),c=await mt(e,o,l)),c.length===0){I(r,"Aucune question disponible","error");const m=A();g.error(`Aucune question trouv√©e pour ${t.label} en ${m}.

Contactez l'administrateur.`,5e3);return}const d=A();et({name:`Quiz ${t.label} - ${d}`,module:t.name,color:t.color,questions:c}),ge(0),he([]),tt(Date.now()),ve(Date.now()),le(e,A()),xe(0),k(!1),R(0),q(null),S(!1),ht(),be(),Et(),G(),Y(),I(r,`${c.length} questions charg√©es !`,"success")}catch(n){w(),console.error("‚ùå Erreur lors du d√©marrage du quiz:",n),I(r,"Erreur de chargement","error"),g.error("Erreur lors du chargement du quiz. Veuillez r√©essayer.",4e3)}}function gt(e){const t=we();t.innerHTML=`
        <!-- Banni√®re de Marque Avantage Plus -->
        <div class="brand-banner">
            <img src="assets/images/logos/Bandeau AVEX.png" alt="Protection M√©canique Exceptionnelle - Avantage Plus" class="banner-image">
        </div>
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-ap-red-primary mx-auto mb-6"></div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Chargement du quiz ${x(e)}</h2>
                <p class="text-slate-600">R√©cup√©ration des questions...</p>
            </div>
        </div>
    `,t.classList.remove("view-hidden")}function ht(){document.getElementById("dashboard-view")?.classList.add("view-hidden"),document.getElementById("module-selection-view")?.classList.add("view-hidden"),document.getElementById("login-view")?.classList.add("view-hidden"),we().classList.remove("view-hidden")}function we(){let e=document.getElementById("quiz-view");if(!e){e=document.createElement("div"),e.id="quiz-view",e.style.cssText="margin: 0; padding: 0; width: 100%; height: 100%;";const t=document.createElement("div");t.className="brand-banner",t.innerHTML='<img src="assets/images/logos/Bandeau AVEX.png" alt="Protection M√©canique Exceptionnelle - Avantage Plus" class="banner-image">',e.appendChild(t),document.querySelector("main").appendChild(e)}return ft(e),e}function ft(e){ct()||!e||(e.addEventListener("click",t=>{const r=t.target.closest(".option-button");if(r&&!r.disabled){const l=r.dataset.optionId;l&&vt(l);return}if(t.target.closest("#next-question-btn")){t.preventDefault(),wt();return}if(t.target.closest("#quit-quiz-btn")){t.preventDefault(),confirm("Voulez-vous vraiment quitter le quiz ? Votre progression sera perdue.")&&ye();return}if(t.target.closest("#focus-mode-btn")){t.preventDefault(),At();return}if(t.target.closest("#pause-btn")){t.preventDefault(),qt();return}}),ut(!0))}function be(){const e=b(),t=T(),r=e.questions[t],n=document.getElementById("quiz-view"),s=K[e.color];S(!1),n.innerHTML=`
        <!-- Banni√®re de Marque Avantage Plus -->
        <div class="brand-banner">
            <img src="assets/images/logos/Bandeau AVEX.png" alt="Protection M√©canique Exceptionnelle - Avantage Plus" class="banner-image">
        </div>
        <!-- En-t√™te du quiz -->
        <div class="bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-5xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-bold text-slate-900">${x(e.name)}</h1>
                        <p class="text-sm text-slate-500">Question ${t+1} sur ${e.questions.length}</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <button id="focus-mode-btn" class="text-sm font-medium text-slate-600 hover:text-slate-900 flex items-center gap-1" aria-pressed="false" aria-label="Activer le mode focus">
                            <svg aria-hidden="true" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            Focus
                        </button>
                        <button id="pause-btn" class="text-sm font-medium text-slate-600 hover:text-slate-900 flex items-center gap-1" aria-pressed="false" aria-label="Mettre le quiz en pause">
                            <svg aria-hidden="true" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Pause
                        </button>
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-ap-red-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="quiz-score" class="text-sm font-bold text-ap-red-primary">Score: 0%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="quiz-timer" class="text-sm font-medium text-slate-600">0:00</span>
                        </div>
                        <button id="quit-quiz-btn" class="text-sm font-medium text-slate-600 hover:text-slate-900">
                            Quitter
                        </button>
                    </div>
                </div>
                
                <!-- Barre de progression - ROUGE AVANTAGE PLUS PROFESSIONNEL AVEC ANIMATIONS -->
                <div class="mt-4 w-full bg-gray-300 rounded-full h-5 overflow-hidden border-2 border-gray-700 shadow-lg relative" style="background-color: #D1D5DB !important; border-color: #374151 !important; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);">
                    <div id="quiz-progress-bar" class="h-full rounded-full transition-all duration-600 ease-out relative overflow-hidden" style="background: linear-gradient(135deg, #C41E3A 0%, #A01A2E 50%, #8B1429 100%) !important; width: ${Math.max(0,Math.min(100,(t+1)/e.questions.length*100))}%; box-shadow: 0 2px 8px rgba(196, 30, 58, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer" style="animation: shimmer 2s infinite; transform: translateX(-100%);"></div>
                    </div>
                    <div id="quiz-progress-percent" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold text-gray-700 pointer-events-none" style="z-index: 10;">${Math.round((t+1)/e.questions.length*100)}%</div>
                </div>
            </div>
        </div>

        <!-- Contenu de la question -->
        <div class="max-w-5xl mx-auto px-6 py-8">
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                
                <!-- En-t√™te de question -->
                <div class="px-8 py-6 bg-gradient-to-r from-slate-50 to-white border-b border-gray-100">
                    <div class="mb-4">
                        <span class="text-sm font-medium ${s.text}">Question ${t+1} sur ${e.questions.length}</span>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-slate-900 leading-relaxed">
                        ${x(r.question)}
                    </h2>
                    
                    <!-- Tags -->
                    ${r.tags&&r.tags.length>0?`
                        <div class="flex flex-wrap gap-2 mt-4">
                            ${r.tags.map(a=>`
                                <span class="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-medium rounded-full">
                                    ${x(a)}
                                </span>
                            `).join("")}
                        </div>
                    `:""}
                </div>

                <!-- Options de r√©ponse -->
                <div class="p-8">
                    <div class="space-y-3">
                        ${r.options.map(a=>`
                            <button data-option-id="${x(a.id)}" 
                                    class="option-button w-full text-left px-6 py-5 rounded-xl border-2 border-gray-200 hover:border-ap-red-primary hover:bg-ap-red-50 transition-all duration-200 group">
                                <div class="flex items-center gap-4">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-ap-red-100 flex items-center justify-center group-hover:bg-ap-red-primary group-hover:text-white transition-all">
                                        <span class="text-lg font-bold text-ap-red-primary group-hover:text-white">${x(a.id)}</span>
                                    </div>
                                    <span class="text-lg text-slate-700 group-hover:text-slate-900 font-medium">
                                        ${x(a.text)}
                                    </span>
                                </div>
                            </button>
                        `).join("")}
                    </div>
                </div>

                <!-- Zone d'explication (cach√©e initialement) -->
                <div id="explanation-area" class="hidden px-8 py-6 bg-slate-50 border-t border-gray-200">
                    <!-- Sera rempli apr√®s la r√©ponse -->
                </div>

                <!-- Bouton suivant (cach√© initialement) -->
                <div id="next-button-area" class="hidden px-8 py-6 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-slate-500">Question suivante dans quelques secondes...</p>
                        <button id="next-question-btn" class="bg-ap-red-primary hover:bg-ap-red-dark text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-ap-md hover:shadow-ap-lg transform hover:-translate-y-1">
                            Question suivante
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,G(),Y()}function Y(){const e=b();if(!e||!e.questions||e.questions.length===0)return;const t=T(),r=e.questions.length,n=Math.max(0,Math.min(100,(t+1)/r*100)),s=document.getElementById("quiz-progress-bar"),a=document.getElementById("quiz-progress-percent");s&&(s.style.width=`${n}%`,s.style.background="linear-gradient(135deg, #C41E3A 0%, #A01A2E 50%, #8B1429 100%)",s.style.setProperty("background","linear-gradient(135deg, #C41E3A 0%, #A01A2E 50%, #8B1429 100%)","important"),a&&(a.textContent=`${Math.round(n)}%`),console.log(`üìä Barre de progression mise √† jour: ${n.toFixed(1)}% (Question ${t+1}/${r})`))}function vt(e){if(lt())return;const t=b(),r=T(),n=nt(),s=t.questions[r],a=s.options.find(c=>c.id===e),o=Math.floor((Date.now()-n)/1e3);S(!0);const l=E();l.push({questionId:s.id,question:s.question,selectedAnswer:e,correctAnswer:s.options.find(c=>c.correct).id,isCorrect:a.correct,timeSpent:o}),he(l);let i=st();a.correct?i++:i=0,xe(i),document.querySelectorAll(".option-button").forEach(c=>{c.disabled=!0,c.classList.remove("hover:border-ap-red-primary","hover:bg-ap-red-50")}),xt(e,a.correct,s),G(),setTimeout(()=>{document.getElementById("next-button-area")?.classList.remove("hidden")},1e3)}function xt(e,t,r){const n=b();K[n.color];const s=r.options.find(o=>o.correct);document.querySelectorAll(".option-button").forEach(o=>{const l=o.dataset.optionId;l===s.id?(o.classList.add("border-green-500","bg-green-50"),o.classList.remove("border-gray-200")):l===e&&!t&&(o.classList.add("border-red-500","bg-red-50"),o.classList.remove("border-gray-200"))});const a=document.getElementById("explanation-area");a&&(a.innerHTML=`
            <div class="flex items-start gap-4">
                ${t?'<div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-100 flex items-center justify-center"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>':'<div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center"><svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>'}
                <div class="flex-1">
                    <h3 class="text-lg font-bold ${t?"text-green-700":"text-red-700"} mb-2">
                        ${t?"‚úÖ Bonne r√©ponse !":"‚ùå R√©ponse incorrecte"}
                    </h3>
                    <p class="text-slate-700 mb-2"><strong>Explication :</strong> ${x(r.explanation)}</p>
                    ${r.reference?`<p class="text-sm text-slate-500"><strong>R√©f√©rence :</strong> ${x(r.reference)}</p>`:""}
                </div>
            </div>
        `,a.classList.remove("hidden"))}function wt(){ve(Date.now());const e=T();ge(e+1);const t=b();T()<t.questions.length?(be(),Y()):bt()}async function bt(){w();try{window.__QUIZ_ACTIVE=!1}catch{}const e=E();if(e.length===0){console.error("‚ùå Aucune r√©ponse enregistr√©e - quiz invalide"),g.error("Aucune r√©ponse enregistr√©e. Le quiz ne peut pas √™tre compl√©t√©.");return}const{calculateScore:t}=await v(async()=>{const{calculateScore:p}=await Promise.resolve().then(()=>Ee);return{calculateScore:p}},void 0),r=t(e);if(isNaN(r)||r<0||r>100){console.error("‚ùå Score invalide calcul√©:",r),g.error("Erreur de calcul du score. Contactez le support.");return}const n=W(),s=F(),a=H();let o=n;s&&a&&(o+=Date.now()-a);const l=N(),i=Math.max(0,Math.floor((Date.now()-l-o)/1e3));k(!1),q(null),R(0);const c=Math.floor(i/60),d=i%60;yt(r,i);const m=b();if(!m){console.error("‚ùå currentQuiz non d√©fini dans showResults"),g.error("Erreur: Impossible d'afficher les r√©sultats. Veuillez r√©essayer.");return}K[m.color];const D=document.getElementById("quiz-view");D.innerHTML=`
        <!-- Banni√®re de Marque Avantage Plus -->
        <div class="brand-banner">
            <img src="assets/images/logos/Bandeau AVEX.png" alt="Protection M√©canique Exceptionnelle - Avantage Plus" class="banner-image">
        </div>
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 py-12 px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Carte de r√©sultat principale -->
                <div class="bg-white rounded-3xl shadow-2xl overflow-hidden mb-8 border-t-4 border-ap-gold">
                    <!-- Header avec score - GRADIENT AVANTAGE PLUS -->
                    <div class="px-8 py-12 text-center text-white" style="background: ${r>=80?"linear-gradient(135deg, #28A745 0%, #D4AF37 100%)":"var(--ap-gradient-primary)"};">
                        <h1 class="text-4xl font-bold mb-4">Quiz Termin√© ! üéâ</h1>
                        <div class="text-8xl font-bold mb-4" style="text-shadow: 0 4px 20px rgba(0,0,0,0.2);">${r}%</div>
                        <p class="text-xl opacity-90">${e.filter(p=>p.isCorrect).length} / ${e.length} bonnes r√©ponses</p>
                        <p class="text-lg opacity-75 mt-2">Temps total : ${c}:${d.toString().padStart(2,"0")}</p>
                    </div>
                    
                    <!-- Message de feedback -->
                    <div class="px-8 py-8 text-center border-b border-gray-200">
                        ${r>=90?'<h2 class="text-3xl font-bold text-green-600 mb-2">üèÜ Excellent !</h2><p class="text-slate-600 text-lg">Performance exceptionnelle ! Vous ma√Ætrisez parfaitement ce module.</p>':r>=75?'<h2 class="text-3xl font-bold text-blue-600 mb-2">üëè Tr√®s bien !</h2><p class="text-slate-600 text-lg">Bon travail ! Quelques r√©visions et vous serez au top.</p>':r>=60?`<h2 class="text-3xl font-bold text-yellow-600 mb-2">üìö Pas mal !</h2><p class="text-slate-600 text-lg">C'est un bon d√©but. Continuez √† r√©viser pour am√©liorer votre score.</p>`:'<h2 class="text-3xl font-bold text-red-600 mb-2">üí™ Continuez !</h2><p class="text-slate-600 text-lg">Ne vous d√©couragez pas. R√©visez les points faibles et r√©essayez !</p>'}
                    </div>
                    
                    <!-- D√©tails des r√©ponses -->
                    <div class="px-8 py-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">D√©tails de vos r√©ponses :</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${e.map((p,Ae)=>`
                                <div class="flex items-center justify-between p-4 rounded-lg ${p.isCorrect?"bg-green-50":"bg-red-50"}">
                                    <div class="flex items-center gap-3 flex-1">
                                        <span class="${p.isCorrect?"text-green-600":"text-red-600"} text-2xl">
                                            ${p.isCorrect?"‚úÖ":"‚ùå"}
                                        </span>
                                        <div class="flex-1">
                                            <p class="font-medium text-slate-900">Question ${Ae+1}</p>
                                            <p class="text-sm text-slate-600">${p.question}</p>
                                            ${p.isCorrect?"":`<p class="text-xs text-slate-500 mt-1">Votre r√©ponse : ${p.selectedAnswer} | Correcte : ${p.correctAnswer}</p>`}
                                        </div>
                                    </div>
                                    <span class="text-sm text-slate-500">${p.timeSpent}s</span>
                                </div>
                            `).join("")}
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="px-8 py-6 flex gap-4">
                        <button id="retry-quiz-btn" class="flex-1 bg-ap-red-primary hover:bg-ap-red-dark text-white px-6 py-3 rounded-xl font-semibold transition-all transform hover:-translate-y-1 shadow-ap-md hover:shadow-ap-lg">
                            Refaire le quiz
                        </button>
                        <button id="return-dashboard-btn" class="flex-1 border-2 border-ap-red-primary text-ap-red-primary px-6 py-3 rounded-xl font-semibold hover:bg-ap-red-50 transition-all">
                            Retour au tableau de bord
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,r>=80&&setTimeout(()=>Je(),500);const L=Math.floor((Date.now()-N())/1e3);ce(_(),r,L,m?.questions?.length||0),document.getElementById("retry-quiz-btn")?.addEventListener("click",()=>{const p=_();p?pt(p):g.error("Erreur: Impossible de red√©marrer le quiz.")}),document.getElementById("return-dashboard-btn")?.addEventListener("click",ye)}async function yt(e,t){try{if(!_e()){console.log("Aucun utilisateur - r√©sultat non sauvegard√©"),w();return}if(C()){console.log("Mode d√©mo - r√©sultat non sauvegard√© dans Firestore"),g.info("Mode D√©mo : les r√©sultats ne sont pas sauvegard√©s"),w();return}const n=_(),s=A(),a=P(),o=b(),l=E(),i=V[n]||{},c={moduleId:n,moduleName:i.name||o.module||n,score:e,correctAnswers:l.filter(d=>d.isCorrect).length,totalQuestions:o.questions.length,timeElapsed:t,answers:l,month:s,year:a};await Ze(()=>te(c),{maxRetries:3,onRetry:(d,m)=>{g.info(`Nouvelle tentative de sauvegarde ${d}/3...`,3e3)}}),g.success("R√©sultat sauvegard√© avec succ√®s !",3e3),console.log("‚úÖ R√©sultat sauvegard√© dans Firestore")}catch(r){console.error("‚ùå Erreur lors de la sauvegarde:",r),w(),g.error("Erreur lors de la sauvegarde. Le r√©sultat sera sauvegard√© localement et synchronis√© plus tard.",8e3);try{const n=_(),s=A(),a=P(),o=E(),l={moduleId:n,moduleName:V[n]?.name||n,score:e,correctAnswers:o.filter(c=>c.isCorrect).length,totalQuestions:o.length,timeElapsed:t,answers:o,month:s,year:a},{syncQueue:i}=await v(async()=>{const{syncQueue:c}=await import("./main-DHR9FbbX.js").then(d=>d.s);return{syncQueue:c}},__vite__mapDeps([2,3,4,0,1,5]));await i.add("quizResult",async c=>{await te(c)},l),console.log("‚úÖ R√©sultat ajout√© √† la file d'attente de synchronisation")}catch(n){console.error("‚ùå Erreur ajout √† la file d'attente:",n);try{const s=`quiz_result_${Date.now()}`;localStorage.setItem(s,JSON.stringify({score:e,totalTime:t,moduleId:_(),month:A(),year:P(),userAnswers:E(),timestamp:Date.now()}))}catch(s){console.error("‚ùå Erreur sauvegarde locale de secours:",s)}}}}function Et(){w();const e=setInterval(()=>{const t=N();if(t===null)return;const r=W(),n=F(),s=H();let a=r;n&&s&&(a+=Date.now()-s);const o=Date.now()-t-a,l=Math.max(0,Math.floor(o/1e3)),i=Math.floor(l/60),c=l%60,d=document.getElementById("quiz-timer");d&&(d.textContent=`${i}:${c.toString().padStart(2,"0")}`)},1e3);fe(e)}function w(){const e=rt();e&&(clearInterval(e),fe(null)),q(null)}window.addEventListener("beforeunload",()=>{w()});document.addEventListener("visibilitychange",()=>{});async function G(){const e=E();if(e.length===0)return;const{calculateScore:t}=await v(async()=>{const{calculateScore:s}=await Promise.resolve().then(()=>Ee);return{calculateScore:s}},void 0),r=t(e),n=document.getElementById("quiz-score");n&&(n.textContent=`Score: ${r}%`)}function At(){document.body.classList.toggle("focus-mode")}function qt(){const e=document.getElementById("pause-btn");if(!e)return;if(!F())k(!0),q(Date.now()),e.setAttribute("aria-pressed","true"),e.setAttribute("aria-label","Reprendre le quiz"),e.innerHTML='<svg aria-hidden="true" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Reprendre',g.warning('Quiz en pause. Cliquez sur "Reprendre" pour continuer.',3e3);else{k(!1);const r=H();if(r){const n=W();R(n+(Date.now()-r))}q(null),e.setAttribute("aria-pressed","false"),e.setAttribute("aria-label","Mettre le quiz en pause"),e.innerHTML='<svg aria-hidden="true" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Pause',g.success("Quiz repris !",2e3)}}function ye(){w();try{window.__QUIZ_ACTIVE=!1}catch{}k(!1),R(0),q(null),S(!1),document.getElementById("quiz-view")?.classList.add("view-hidden"),document.getElementById("dashboard-view")?.classList.remove("view-hidden"),document.querySelectorAll(".nav-link").forEach(e=>{e.classList.remove("bg-ap-red-dark","text-white"),e.classList.add("text-white")}),document.getElementById("nav-dashboard")?.classList.add("bg-ap-red-dark","text-white"),g.info("Retour au tableau de bord",2e3),setTimeout(async()=>{try{console.log("üîÑ D√©but rechargement dashboard apr√®s quiz...");const{invalidateByDataType:e}=await v(async()=>{const{invalidateByDataType:r}=await import("./services-DC78fAiO.js").then(n=>n.q);return{invalidateByDataType:r}},__vite__mapDeps([1,0]));e("annualProgress"),e("monthlyProgress"),e("quizResults"),console.log("üóëÔ∏è Cache invalid√©");const{initializeDashboard:t}=await v(async()=>{const{initializeDashboard:r}=await import("./main-DHR9FbbX.js").then(n=>n.d);return{initializeDashboard:r}},__vite__mapDeps([2,3,4,0,1,5]));typeof t=="function"&&(await t(),console.log("‚úÖ Dashboard recharg√© apr√®s quiz"))}catch(e){console.error("‚ùå Erreur rechargement dashboard:",e),window.location.reload()}},1500)}function zt(e){if(!e||e.length===0)return 0;const t=e.filter(n=>n.isCorrect).length,r=Math.round(t/e.length*100);return isNaN(r)||r<0||r>100?(console.error("‚ùå Score invalide calcul√©:",r),0):r}function _t(e,t,r=null){return e<t?r!==null?"completed":"incomplete":e===t?r!==null?"completed":"active":"locked"}const Ee=Object.freeze(Object.defineProperty({__proto__:null,calculateScore:zt,getMonthlyQuizStatus:_t},Symbol.toStringTag,{value:"Module"}));export{St as a,pt as b,Ee as q,Rt as s,Be as t};
//# sourceMappingURL=quiz-DqivFJfI.js.map
