rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ✅ P0 CRITIQUE: Helper pour récupérer le clientId de l'utilisateur actuel
    function getCurrentUserClientId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.get('clientId', 'default');
    }
    
    // ✅ P0 CRITIQUE: Helper pour vérifier que deux utilisateurs sont du même client
    function sameClient(userId) {
      let currentUserDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      let targetUserDoc = get(/databases/$(database)/documents/users/$(userId));
      return currentUserDoc.data.clientId == targetUserDoc.data.clientId;
    }
    
    // Collection: users
    match /users/{userId} {
      // ✅ P0 CRITIQUE: Lecture - Isolation multi-tenant stricte
      // L'utilisateur peut lire son propre profil OU les admins peuvent lire les utilisateurs du même client uniquement
      allow get: if isOwner(userId) || 
                    (isAdmin() && sameClient(userId)) ||
                    (isAuthenticated() && resource.data.clientId == getCurrentUserClientId());
      
      // ✅ P0 CRITIQUE: Liste - Permettre aux admins de lire TOUS les utilisateurs du même client (sans contrainte de query)
      allow list: if isAdmin();
      
      // ✅ P0 CRITIQUE: Écriture - Isolation multi-tenant stricte
      // NOUVEAU: Permettre la création initiale du profil utilisateur
      allow create: if isOwner(userId) && 
                       request.resource.data.email is string &&
                       request.resource.data.clientId is string;
      
      // L'utilisateur peut mettre à jour son propre profil (sauf le rôle et clientId)
      // Les admins peuvent créer/modifier uniquement les utilisateurs du même client
      allow update: if (isOwner(userId) && 
                          (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'clientId']))) ||
                       (isAdmin() && sameClient(userId));
      
      // Empêcher les users de modifier leur propre rôle
      allow update: if isOwner(userId) && 
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
                       (isAdmin() && sameClient(userId));
      
      // ✅ P0 CRITIQUE: Suppression - Seulement les admins du même client
      allow delete: if isAdmin() && sameClient(userId);
    }
    
    // Collection: questions (SANS champ difficulty)
    match /questions/{questionId} {
      // ✅ P0 CRITIQUE: Lecture - Seulement les utilisateurs authentifiés
      // Temporairement permissif pour permettre le chargement initial
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // ✅ P0 CRITIQUE: Écriture - Seulement les admins du même client
      allow create, update, delete: if isAdmin() && 
                                        request.resource.data.clientId == getCurrentUserClientId();
      
      // Validation des données lors de la création/modification
      allow create, update: if isAdmin() &&
        request.resource.data.clientId == getCurrentUserClientId() &&
        request.resource.data.question is string &&
        request.resource.data.question.size() >= 10 &&
        request.resource.data.options is list &&
        request.resource.data.options.size() == 4 &&
        request.resource.data.correctAnswer is int &&
        request.resource.data.correctAnswer >= 0 &&
        request.resource.data.correctAnswer <= 3 &&
        request.resource.data.explanation is string &&
        request.resource.data.explanation.size() >= 20 &&
        request.resource.data.module in ['auto', 'loisir', 'vr', 'tracteur'] &&
        request.resource.data.month is int &&
        request.resource.data.month >= 1 &&
        request.resource.data.month <= 12;
    }
    
    // Collection: quizResults
    match /quizResults/{resultId} {
      // ✅ P0 CRITIQUE: Lecture - Isolation multi-tenant stricte
      // Seulement ses propres résultats OU utilisateurs authentifiés
      allow get: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      
      // ✅ P0 CRITIQUE: Liste - Utilisateurs authentifiés
      allow list: if isAuthenticated();
      
      // ✅ P0 CRITIQUE: Écriture - Validation stricte
      allow create: if isAuthenticated() && 
                   request.resource.data.userId == request.auth.uid &&
                   // Validation du score (0-100, entier)
                   request.resource.data.score is int &&
                   request.resource.data.score >= 0 &&
                   request.resource.data.score <= 100 &&
                   // Validation du nombre total de questions
                   request.resource.data.totalQuestions is int &&
                   request.resource.data.totalQuestions > 0 &&
                   // Validation des bonnes réponses
                   request.resource.data.correctAnswers is int &&
                   request.resource.data.correctAnswers >= 0 &&
                   request.resource.data.correctAnswers <= request.resource.data.totalQuestions &&
                   // Validation du module
                   request.resource.data.moduleId is string &&
                   request.resource.data.moduleId in ['auto', 'loisir', 'vr', 'tracteur'];
      
      // ✅ P0 CRITIQUE: Modification/Suppression - Seulement les admins du même client
      allow update, delete: if isAdmin() && sameClient(resource.data.userId);
    }
    
    // Collection: monthlyProgress
    match /monthlyProgress/{progressId} {
      // ✅ P0 CRITIQUE: Lecture - Isolation multi-tenant stricte
      // Seulement sa propre progression OU admins
      allow get: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      
      // ✅ P0 CRITIQUE: Liste - Utilisateurs authentifiés
      allow list: if isAuthenticated();
      
      // ✅ P0 CRITIQUE: Écriture - Validation stricte
      allow create, update: if isAuthenticated() && 
                               request.resource.data.userId == request.auth.uid;
      
      // ✅ P0 CRITIQUE: Suppression - Seulement les admins du même client
      allow delete: if isAdmin() && sameClient(resource.data.userId);
    }
    
    // Collection: resources
    match /resources/{resourceId} {
      // ✅ P0 CRITIQUE: Lecture - Utilisateurs authentifiés
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // ✅ P0 CRITIQUE: Écriture - Seulement les admins du même client
      allow create, update, delete: if isAdmin() && 
                                        request.resource.data.clientId == getCurrentUserClientId();
    }
    
    // Collection: importLogs (logs d'import JSON)
    match /importLogs/{logId} {
      // ✅ P0 CRITIQUE: Lecture - Seulement les admins du même client
      allow get: if isAdmin() && 
                    resource.data.clientId == getCurrentUserClientId();
      allow list: if isAdmin() && 
                     request.query.where('clientId', '==', getCurrentUserClientId());
      
      // ✅ P0 CRITIQUE: Écriture - Seulement les admins du même client
      allow create: if isAdmin() && 
                      request.resource.data.clientId == getCurrentUserClientId();
      
      // Modification/Suppression: interdite (logs immuables)
      allow update, delete: if false;
    }
    
    // Collection: auditLogs (logs d'actions admin)
    match /auditLogs/{logId} {
      // ✅ P0 CRITIQUE: Lecture - Seulement les admins du même client
      allow get: if isAdmin() && 
                    resource.data.clientId == getCurrentUserClientId();
      allow list: if isAdmin() && 
                     request.query.where('clientId', '==', getCurrentUserClientId());
      
      // ✅ P0 CRITIQUE: Écriture - Seulement les admins du même client
      allow create: if isAdmin() && 
                      request.resource.data.clientId == getCurrentUserClientId();
      
      // Modification/Suppression: interdite (logs immuables)
      allow update, delete: if false;
    }
  }
}
