rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Collection: users
    match /users/{userId} {
      // Helper: Récupérer le clientId de l'utilisateur
      function getUserClientId() {
        let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
        return userDoc.data.get('clientId', 'default');
      }
      
      // Lecture: l'utilisateur peut lire son propre profil, les admins peuvent tout lire
      // ✅ CORRECTION SECTION 1 : Les admins peuvent lire tous les utilisateurs, mais les users ne voient que leur client
      allow get: if isOwner(userId) || isAdmin() || 
                    (isAuthenticated() && resource.data.clientId == getUserClientId());
      allow list: if isAdmin();
      
      // Écriture: l'utilisateur peut mettre à jour son propre profil (sauf le rôle et clientId)
      // Les admins peuvent tout créer/modifier
      // ✅ CORRECTION SECTION 1 : Empêcher la modification du clientId par les users
      allow create, update: if (isOwner(userId) && 
                                  request.resource.data.clientId == getUserClientId() &&
                                  (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'clientId']))) ||
                             isAdmin();
      
      // Empêcher les users de modifier leur propre rôle
      allow update: if isOwner(userId) && 
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
                       isAdmin();
      
      // Suppression: seulement les admins
      allow delete: if isAdmin();
    }
    
    // Collection: questions (SANS champ difficulty)
    match /questions/{questionId} {
      // Lecture: tous les utilisateurs authentifiés
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // Écriture: seulement les admins
      allow create, update, delete: if isAdmin();
      
      // Validation des données lors de la création/modification
      allow create, update: if isAdmin() &&
        request.resource.data.question is string &&
        request.resource.data.question.size() >= 10 &&
        request.resource.data.options is list &&
        request.resource.data.options.size() == 4 &&
        request.resource.data.correctAnswer is int &&
        request.resource.data.correctAnswer >= 0 &&
        request.resource.data.correctAnswer <= 3 &&
        request.resource.data.explanation is string &&
        request.resource.data.explanation.size() >= 20 &&
        request.resource.data.module in ['auto', 'loisir', 'vr', 'tracteur'] &&
        request.resource.data.month is int &&
        request.resource.data.month >= 1 &&
        request.resource.data.month <= 12;
    }
    
    // Collection: quizResults
    match /quizResults/{resultId} {
      // Helper: Récupérer le clientId de l'utilisateur
      function getUserClientId() {
        let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
        return userDoc.data.get('clientId', 'default');
      }
      
      // Lecture: l'utilisateur peut lire ses propres résultats du même client, les admins peuvent tout lire
      allow get: if (isOwner(resource.data.userId) && resource.data.clientId == getUserClientId()) || isAdmin();
      allow list: if isAdmin() || 
                     (isAuthenticated() && request.query.limitToClient == true);
      
      // Écriture: l'utilisateur peut créer ses propres résultats avec son clientId
      // ✅ CORRECTION SECTION 2 : Validation des données côté serveur
      // ✅ CORRECTION SECTION 1 : Validation du clientId pour isolation
      allow create: if isAuthenticated() && 
                   request.resource.data.userId == request.auth.uid &&
                   request.resource.data.clientId == getUserClientId() &&
                   // Validation du score (0-100, entier)
                   request.resource.data.score is int &&
                   request.resource.data.score >= 0 &&
                   request.resource.data.score <= 100 &&
                   // Validation du nombre total de questions
                   request.resource.data.totalQuestions is int &&
                   request.resource.data.totalQuestions > 0 &&
                   // Validation des bonnes réponses
                   request.resource.data.correctAnswers is int &&
                   request.resource.data.correctAnswers >= 0 &&
                   request.resource.data.correctAnswers <= request.resource.data.totalQuestions &&
                   // Validation du module
                   request.resource.data.moduleId is string &&
                   request.resource.data.moduleId in ['auto', 'loisir', 'vr', 'tracteur'];
      
      // Modification/Suppression: seulement les admins
      allow update, delete: if isAdmin();
    }
    
    // Collection: monthlyProgress
    match /monthlyProgress/{progressId} {
      // Helper: Récupérer le clientId de l'utilisateur
      function getUserClientId() {
        let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
        return userDoc.data.get('clientId', 'default');
      }
      
      // Lecture: l'utilisateur peut lire sa propre progression du même client, les admins peuvent tout lire
      allow get: if (isAuthenticated() && resource.data.clientId == getUserClientId()) || isAdmin();
      allow list: if isAdmin() || 
                     (isAuthenticated() && request.query.limitToClient == true);
      
      // Écriture: l'utilisateur peut créer/modifier sa propre progression avec son clientId
      // ✅ CORRECTION SECTION 1 : Validation du clientId pour isolation
      allow create, update: if isAuthenticated() && 
                               request.resource.data.userId == request.auth.uid &&
                               request.resource.data.clientId == getUserClientId();
      
      // Suppression: seulement les admins
      allow delete: if isAdmin();
    }
    
    // Collection: resources
    match /resources/{resourceId} {
      // Lecture: tous les utilisateurs authentifiés peuvent lire les ressources
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // Écriture: seulement les admins
      allow create, update, delete: if isAdmin();
    }
    
    // Collection: importLogs (logs d'import JSON)
    match /importLogs/{logId} {
      // Lecture: seulement les admins
      allow get: if isAdmin();
      allow list: if isAdmin();
      
      // Écriture: seulement les admins
      allow create: if isAdmin();
      
      // Modification/Suppression: interdite (logs immuables)
      allow update, delete: if false;
    }
    
    // Collection: auditLogs (logs d'actions admin)
    match /auditLogs/{logId} {
      // Lecture: seulement les admins
      allow get: if isAdmin();
      allow list: if isAdmin();
      
      // Écriture: seulement les admins
      allow create: if isAdmin();
      
      // Modification/Suppression: interdite (logs immuables)
      allow update, delete: if false;
    }
  }
}
